# é«˜å¹¶å‘æ¶æ„è®¾è®¡ å®Œæ•´æ•™ç¨‹

## ğŸ“‹ ç›®å½•
- [æŠ€æœ¯æ¦‚è¿°](#æŠ€æœ¯æ¦‚è¿°)
- [å­¦ä¹ ç›®æ ‡](#å­¦ä¹ ç›®æ ‡)
- [é«˜å¹¶å‘æ ¸å¿ƒæ¦‚å¿µ](#é«˜å¹¶å‘æ ¸å¿ƒæ¦‚å¿µ)
- [ç¼“å­˜æ¶æ„è®¾è®¡](#ç¼“å­˜æ¶æ„è®¾è®¡)
- [æ•°æ®åº“ä¼˜åŒ–](#æ•°æ®åº“ä¼˜åŒ–)
- [æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°](#æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°)
- [é™æµé™çº§ç†”æ–­](#é™æµé™çº§ç†”æ–­)
- [ç§’æ€ç³»ç»Ÿè®¾è®¡](#ç§’æ€ç³»ç»Ÿè®¾è®¡)
- [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

## ğŸ“š æŠ€æœ¯æ¦‚è¿°
- **é€‚ç”¨åœºæ™¯**: é«˜å¹¶å‘ã€å¤§æµé‡ç³»ç»Ÿ
- **å­¦ä¹ éš¾åº¦**: â­â­â­â­â­ (5æ˜Ÿ)
- **é‡è¦ç¨‹åº¦**: â­â­â­â­â­ (5æ˜Ÿ)
- **å‰ç½®çŸ¥è¯†**: JavaåŸºç¡€ã€Spring Bootã€Redisã€MySQLã€æ¶ˆæ¯é˜Ÿåˆ—
- **æ›´æ–°æ—¶é—´**: 2024-01-04
- **ä½œè€…**: erik.zhou

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- [ ] ç†è§£é«˜å¹¶å‘ç³»ç»Ÿçš„æ ¸å¿ƒåŸåˆ™
- [ ] æŒæ¡ç¼“å­˜æ¶æ„è®¾è®¡
- [ ] æŒæ¡æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ
- [ ] ç†è§£é™æµé™çº§ç†”æ–­æœºåˆ¶
- [ ] èƒ½å¤Ÿè®¾è®¡ç§’æ€ç³»ç»Ÿ
- [ ] æŒæ¡æ€§èƒ½ä¼˜åŒ–æŠ€å·§

## ğŸ“– é«˜å¹¶å‘æ ¸å¿ƒæ¦‚å¿µ

### 1.1 é«˜å¹¶å‘çš„å®šä¹‰

**å¹¶å‘é‡çº§**:
- ä½å¹¶å‘: < 1000 QPS
- ä¸­å¹¶å‘: 1000-10000 QPS
- é«˜å¹¶å‘: 10000-100000 QPS
- è¶…é«˜å¹¶å‘: > 100000 QPS

### 1.2 é«˜å¹¶å‘è®¾è®¡åŸåˆ™

**æ ¸å¿ƒåŸåˆ™**:
1. **æ— çŠ¶æ€**: åº”ç”¨æœåŠ¡å™¨æ— çŠ¶æ€ï¼Œä¾¿äºæ°´å¹³æ‰©å±•
2. **ç¼“å­˜**: å¤šçº§ç¼“å­˜ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
3. **å¼‚æ­¥**: å¼‚æ­¥å¤„ç†ï¼Œæé«˜å“åº”é€Ÿåº¦
4. **æ‹†åˆ†**: æœåŠ¡æ‹†åˆ†ï¼Œæ•°æ®åº“æ‹†åˆ†
5. **é™æµ**: ä¿æŠ¤ç³»ç»Ÿï¼Œé˜²æ­¢é›ªå´©

## ğŸ”¥ ç¼“å­˜æ¶æ„è®¾è®¡

### 2.1 å¤šçº§ç¼“å­˜æ¶æ„

```java
/**
 * å¤šçº§ç¼“å­˜å®ç°
 * @author erik.zhou
 */
@Service
public class MultiLevelCacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    // æœ¬åœ°ç¼“å­˜(Caffeine)
    private Cache<String, Object> localCache = Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(5, TimeUnit.MINUTES)
            .build();
    
    /**
     * è·å–æ•°æ® - å¤šçº§ç¼“å­˜
     */
    public Object getData(String key) {
        // 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
        Object value = localCache.getIfPresent(key);
        if (value != null) {
            return value;
        }
        
        // 2. æŸ¥è¯¢Redisç¼“å­˜
        value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
            return value;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        value = getFromDatabase(key);
        if (value != null) {
            // å›å†™Redis
            redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);
            // å›å†™æœ¬åœ°ç¼“å­˜
            localCache.put(key, value);
        }
        
        return value;
    }
    
    private Object getFromDatabase(String key) {
        // ä»æ•°æ®åº“æŸ¥è¯¢
        return null;
    }
}
```

### 2.2 ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆ - å¸ƒéš†è¿‡æ»¤å™¨
 * @author erik.zhou
 */
@Component
public class BloomFilterCache {
    
    private BloomFilter<String> bloomFilter;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼Œé¢„è®¡100ä¸‡æ•°æ®ï¼Œè¯¯åˆ¤ç‡0.01
        bloomFilter = BloomFilter.create(
            Funnels.stringFunnel(Charset.defaultCharset()),
            1000000,
            0.01
        );
        
        // å°†æ‰€æœ‰æœ‰æ•ˆçš„keyåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
        loadAllKeysToBloomFilter();
    }
    
    public Object get(String key) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!bloomFilter.mightContain(key)) {
            return null; // ä¸€å®šä¸å­˜åœ¨
        }
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        Object value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            return value;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        value = queryFromDB(key);
        if (value != null) {
            redisTemplate.opsForValue().set(key, value, 30, TimeUnit.MINUTES);
        } else {
            // ç¼“å­˜ç©ºå€¼ï¼Œé˜²æ­¢ç©¿é€
            redisTemplate.opsForValue().set(key, "", 5, TimeUnit.MINUTES);
        }
        
        return value;
    }
    
    private void loadAllKeysToBloomFilter() {
        // åŠ è½½æ‰€æœ‰æœ‰æ•ˆkeyåˆ°å¸ƒéš†è¿‡æ»¤å™¨
    }
    
    private Object queryFromDB(String key) {
        // æŸ¥è¯¢æ•°æ®åº“
        return null;
    }
}
```

### 2.3 ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜å‡»ç©¿è§£å†³æ–¹æ¡ˆ - åˆ†å¸ƒå¼é”
 * @author erik.zhou
 */
@Service
public class CacheBreakdownService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    /**
     * è·å–çƒ­ç‚¹æ•°æ® - ä½¿ç”¨åˆ†å¸ƒå¼é”
     */
    public Object getHotData(String key) {
        // 1. æŸ¥è¯¢ç¼“å­˜
        Object value = redisTemplate.opsForValue().get(key);
        if (value != null) {
            return value;
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”
        String lockKey = "lock:" + key;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                try {
                    // åŒé‡æ£€æŸ¥
                    value = redisTemplate.opsForValue().get(key);
                    if (value != null) {
                        return value;
                    }
                    
                    // æŸ¥è¯¢æ•°æ®åº“
                    value = queryFromDB(key);
                    if (value != null) {
                        // è®¾ç½®ç¼“å­˜ï¼Œæ°¸ä¸è¿‡æœŸæˆ–è®¾ç½®è¾ƒé•¿è¿‡æœŸæ—¶é—´
                        redisTemplate.opsForValue().set(key, value, 1, TimeUnit.HOURS);
                    }
                    
                    return value;
                } finally {
                    lock.unlock();
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        return null;
    }
    
    private Object queryFromDB(String key) {
        // æŸ¥è¯¢æ•°æ®åº“
        return null;
    }
}
```

### 2.4 ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆ

```java
/**
 * ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆ
 * @author erik.zhou
 */
@Service
public class CacheAvalancheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private Random random = new Random();
    
    /**
     * è®¾ç½®ç¼“å­˜ - éšæœºè¿‡æœŸæ—¶é—´
     */
    public void setCache(String key, Object value, long baseExpireTime) {
        // åœ¨åŸºç¡€è¿‡æœŸæ—¶é—´ä¸Šå¢åŠ éšæœºå€¼ï¼Œé¿å…åŒæ—¶è¿‡æœŸ
        long randomExpire = baseExpireTime + random.nextInt(300);
        redisTemplate.opsForValue().set(key, value, randomExpire, TimeUnit.SECONDS);
    }
    
    /**
     * è·å–æ•°æ® - æ°¸ä¸è¿‡æœŸç­–ç•¥
     */
    public Object getDataNeverExpire(String key) {
        // æŸ¥è¯¢ç¼“å­˜
        String cacheKey = "cache:" + key;
        Object value = redisTemplate.opsForValue().get(cacheKey);
        
        if (value != null) {
            return value;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œå¼‚æ­¥æ›´æ–°
        CompletableFuture.runAsync(() -> {
            Object newValue = queryFromDB(key);
            if (newValue != null) {
                redisTemplate.opsForValue().set(cacheKey, newValue);
            }
        });
        
        // è¿”å›æ—§å€¼æˆ–é»˜è®¤å€¼
        return getDefaultValue();
    }
    
    private Object queryFromDB(String key) {
        return null;
    }
    
    private Object getDefaultValue() {
        return null;
    }
}
```

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

## ğŸ”¥ æ•°æ®åº“ä¼˜åŒ–

### 3.1 è¯»å†™åˆ†ç¦»

```java
/**
 * è¯»å†™åˆ†ç¦»é…ç½®
 * @author erik.zhou
 */
@Configuration
public class DataSourceConfig {
    
    @Bean
    @ConfigurationProperties("spring.datasource.master")
    public DataSource masterDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    @ConfigurationProperties("spring.datasource.slave")
    public DataSource slaveDataSource() {
        return DataSourceBuilder.create().build();
    }
    
    @Bean
    public DataSource routingDataSource(
            @Qualifier("masterDataSource") DataSource masterDataSource,
            @Qualifier("slaveDataSource") DataSource slaveDataSource) {
        
        Map<Object, Object> targetDataSources = new HashMap<>();
        targetDataSources.put("master", masterDataSource);
        targetDataSources.put("slave", slaveDataSource);
        
        DynamicRoutingDataSource routingDataSource = new DynamicRoutingDataSource();
        routingDataSource.setDefaultTargetDataSource(masterDataSource);
        routingDataSource.setTargetDataSources(targetDataSources);
        
        return routingDataSource;
    }
}

/**
 * åŠ¨æ€æ•°æ®æºè·¯ç”±
 * @author erik.zhou
 */
public class DynamicRoutingDataSource extends AbstractRoutingDataSource {
    
    @Override
    protected Object determineCurrentLookupKey() {
        return DataSourceContextHolder.getDataSourceType();
    }
}

/**
 * æ•°æ®æºä¸Šä¸‹æ–‡
 * @author erik.zhou
 */
public class DataSourceContextHolder {
    
    private static final ThreadLocal<String> CONTEXT_HOLDER = new ThreadLocal<>();
    
    public static void setDataSourceType(String dataSourceType) {
        CONTEXT_HOLDER.set(dataSourceType);
    }
    
    public static String getDataSourceType() {
        return CONTEXT_HOLDER.get();
    }
    
    public static void clearDataSourceType() {
        CONTEXT_HOLDER.remove();
    }
}

/**
 * è¯»å†™åˆ†ç¦»æ³¨è§£
 * @author erik.zhou
 */
@Target({ElementType.METHOD, ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
public @interface DataSource {
    String value() default "master";
}

/**
 * è¯»å†™åˆ†ç¦»åˆ‡é¢
 * @author erik.zhou
 */
@Aspect
@Component
public class DataSourceAspect {
    
    @Around("@annotation(dataSource)")
    public Object around(ProceedingJoinPoint point, DataSource dataSource) throws Throwable {
        try {
            DataSourceContextHolder.setDataSourceType(dataSource.value());
            return point.proceed();
        } finally {
            DataSourceContextHolder.clearDataSourceType();
        }
    }
}
```

### 3.2 åˆ†åº“åˆ†è¡¨

```java
/**
 * åˆ†åº“åˆ†è¡¨ç­–ç•¥
 * @author erik.zhou
 */
@Component
public class ShardingStrategy {
    
    private static final int DB_COUNT = 4;  // 4ä¸ªæ•°æ®åº“
    private static final int TABLE_COUNT = 8; // æ¯ä¸ªåº“8å¼ è¡¨
    
    /**
     * æ ¹æ®ç”¨æˆ·IDè®¡ç®—æ•°æ®åº“ç´¢å¼•
     */
    public int getDbIndex(Long userId) {
        return (int) (userId % DB_COUNT);
    }
    
    /**
     * æ ¹æ®ç”¨æˆ·IDè®¡ç®—è¡¨ç´¢å¼•
     */
    public int getTableIndex(Long userId) {
        return (int) (userId % TABLE_COUNT);
    }
    
    /**
     * è·å–å®Œæ•´çš„è¡¨å
     */
    public String getTableName(String baseTableName, Long userId) {
        int tableIndex = getTableIndex(userId);
        return baseTableName + "_" + tableIndex;
    }
}

/**
 * ShardingSphereé…ç½®ç¤ºä¾‹
 * @author erik.zhou
 */
@Configuration
public class ShardingSphereConfig {
    
    @Bean
    public DataSource dataSource() throws SQLException {
        // é…ç½®çœŸå®æ•°æ®æº
        Map<String, DataSource> dataSourceMap = new HashMap<>();
        dataSourceMap.put("ds0", createDataSource("jdbc:mysql://localhost:3306/db0"));
        dataSourceMap.put("ds1", createDataSource("jdbc:mysql://localhost:3306/db1"));
        dataSourceMap.put("ds2", createDataSource("jdbc:mysql://localhost:3306/db2"));
        dataSourceMap.put("ds3", createDataSource("jdbc:mysql://localhost:3306/db3"));
        
        // é…ç½®åˆ†ç‰‡è§„åˆ™
        ShardingRuleConfiguration shardingRuleConfig = new ShardingRuleConfiguration();
        shardingRuleConfig.getTableRuleConfigs().add(getOrderTableRuleConfiguration());
        shardingRuleConfig.setDefaultDatabaseShardingStrategyConfig(
            new InlineShardingStrategyConfiguration("user_id", "ds${user_id % 4}")
        );
        
        return ShardingDataSourceFactory.createDataSource(dataSourceMap, shardingRuleConfig, new Properties());
    }
    
    private TableRuleConfiguration getOrderTableRuleConfiguration() {
        TableRuleConfiguration result = new TableRuleConfiguration("t_order", "ds${0..3}.t_order_${0..7}");
        result.setTableShardingStrategyConfig(
            new InlineShardingStrategyConfiguration("user_id", "t_order_${user_id % 8}")
        );
        return result;
    }
    
    private DataSource createDataSource(String url) {
        HikariDataSource dataSource = new HikariDataSource();
        dataSource.setJdbcUrl(url);
        dataSource.setUsername("root");
        dataSource.setPassword("password");
        return dataSource;
    }
}
```

## ğŸ”¥ æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°

### 4.1 å¼‚æ­¥å¤„ç†è®¢å•

```java
/**
 * è®¢å•å¼‚æ­¥å¤„ç†
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * åˆ›å»ºè®¢å• - å¼‚æ­¥å¤„ç†
     */
    @Transactional
    public String createOrder(OrderDTO orderDTO) {
        // 1. ç”Ÿæˆè®¢å•å·
        String orderNo = generateOrderNo();
        
        // 2. é¢„æ‰£åº“å­˜ï¼ˆRedisï¼‰
        boolean success = deductStock(orderDTO.getProductId(), orderDTO.getQuantity());
        if (!success) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        // 3. åˆ›å»ºè®¢å•è®°å½•ï¼ˆçŠ¶æ€ï¼šå¾…å¤„ç†ï¼‰
        Order order = new Order();
        order.setOrderNo(orderNo);
        order.setStatus(OrderStatus.PENDING);
        order.setUserId(orderDTO.getUserId());
        order.setProductId(orderDTO.getProductId());
        order.setQuantity(orderDTO.getQuantity());
        // ä¿å­˜åˆ°æ•°æ®åº“...
        
        // 4. å‘é€æ¶ˆæ¯åˆ°MQï¼Œå¼‚æ­¥å¤„ç†
        OrderMessage message = new OrderMessage();
        message.setOrderNo(orderNo);
        message.setUserId(orderDTO.getUserId());
        message.setProductId(orderDTO.getProductId());
        message.setQuantity(orderDTO.getQuantity());
        
        rabbitTemplate.convertAndSend("order.exchange", "order.create", message);
        
        return orderNo;
    }
    
    /**
     * é¢„æ‰£åº“å­˜
     */
    private boolean deductStock(Long productId, Integer quantity) {
        String stockKey = "stock:" + productId;
        Long stock = redisTemplate.opsForValue().decrement(stockKey, quantity);
        if (stock < 0) {
            // å›æ»š
            redisTemplate.opsForValue().increment(stockKey, quantity);
            return false;
        }
        return true;
    }
    
    private String generateOrderNo() {
        return "ORDER" + System.currentTimeMillis() + new Random().nextInt(1000);
    }
}

/**
 * è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…
 * @author erik.zhou
 */
@Component
public class OrderMessageConsumer {
    
    @Autowired
    private OrderService orderService;
    
    @RabbitListener(queues = "order.queue")
    public void handleOrderMessage(OrderMessage message) {
        try {
            // å¤„ç†è®¢å•
            processOrder(message);
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
            throw new AmqpRejectAndDontRequeueException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    
    private void processOrder(OrderMessage message) {
        // 1. æ‰£å‡æ•°æ®åº“åº“å­˜
        // 2. æ›´æ–°è®¢å•çŠ¶æ€
        // 3. å‘é€é€šçŸ¥
    }
}
```

### 4.2 æµé‡å‰Šå³°é…ç½®

```java
/**
 * RabbitMQå‰Šå³°é…ç½®
 * @author erik.zhou
 */
@Configuration
public class RabbitMQConfig {
    
    /**
     * ç§’æ€é˜Ÿåˆ—é…ç½® - é™æµ
     */
    @Bean
    public Queue seckillQueue() {
        Map<String, Object> args = new HashMap<>();
        // è®¾ç½®é˜Ÿåˆ—æœ€å¤§é•¿åº¦
        args.put("x-max-length", 10000);
        // é˜Ÿåˆ—æ»¡äº†ä¹‹åçš„ç­–ç•¥ï¼šæ‹’ç»æ–°æ¶ˆæ¯
        args.put("x-overflow", "reject-publish");
        // æ¶ˆæ¯TTL
        args.put("x-message-ttl", 60000);
        
        return new Queue("seckill.queue", true, false, false, args);
    }
    
    @Bean
    public DirectExchange seckillExchange() {
        return new DirectExchange("seckill.exchange");
    }
    
    @Bean
    public Binding seckillBinding() {
        return BindingBuilder
                .bind(seckillQueue())
                .to(seckillExchange())
                .with("seckill");
    }
}
```

---

**ä½œè€…**: erik.zhou

## ğŸ”¥ é™æµé™çº§ç†”æ–­

### 5.1 é™æµå®ç°

```java
/**
 * åŸºäºRedisçš„é™æµå™¨
 * @author erik.zhou
 */
@Component
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * å›ºå®šçª—å£é™æµ
     * @param key é™æµkey
     * @param limit é™æµé˜ˆå€¼
     * @param window æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
     */
    public boolean tryAcquire(String key, int limit, int window) {
        String limitKey = "rate_limit:" + key;
        Long count = redisTemplate.opsForValue().increment(limitKey);
        
        if (count == 1) {
            redisTemplate.expire(limitKey, window, TimeUnit.SECONDS);
        }
        
        return count <= limit;
    }
    
    /**
     * æ»‘åŠ¨çª—å£é™æµ
     */
    public boolean tryAcquireSliding(String key, int limit, int window) {
        String limitKey = "rate_limit:sliding:" + key;
        long now = System.currentTimeMillis();
        long windowStart = now - window * 1000;
        
        // ç§»é™¤çª—å£å¤–çš„æ•°æ®
        redisTemplate.opsForZSet().removeRangeByScore(limitKey, 0, windowStart);
        
        // è·å–å½“å‰çª—å£å†…çš„è¯·æ±‚æ•°
        Long count = redisTemplate.opsForZSet().zCard(limitKey);
        
        if (count < limit) {
            // æ·»åŠ å½“å‰è¯·æ±‚
            redisTemplate.opsForZSet().add(limitKey, UUID.randomUUID().toString(), now);
            redisTemplate.expire(limitKey, window, TimeUnit.SECONDS);
            return true;
        }
        
        return false;
    }
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµï¼ˆä½¿ç”¨Luaè„šæœ¬ï¼‰
     */
    public boolean tryAcquireTokenBucket(String key, int capacity, int rate) {
        String script = 
            "local key = KEYS[1]\n" +
            "local capacity = tonumber(ARGV[1])\n" +
            "local rate = tonumber(ARGV[2])\n" +
            "local now = tonumber(ARGV[3])\n" +
            "\n" +
            "local bucket = redis.call('hmget', key, 'tokens', 'last_time')\n" +
            "local tokens = tonumber(bucket[1])\n" +
            "local last_time = tonumber(bucket[2])\n" +
            "\n" +
            "if tokens == nil then\n" +
            "    tokens = capacity\n" +
            "    last_time = now\n" +
            "end\n" +
            "\n" +
            "local delta = math.max(0, now - last_time)\n" +
            "local new_tokens = math.min(capacity, tokens + delta * rate)\n" +
            "\n" +
            "if new_tokens >= 1 then\n" +
            "    redis.call('hmset', key, 'tokens', new_tokens - 1, 'last_time', now)\n" +
            "    redis.call('expire', key, 60)\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>(script, Long.class);
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList("token_bucket:" + key),
            capacity,
            rate,
            System.currentTimeMillis() / 1000
        );
        
        return result != null && result == 1;
    }
}

/**
 * é™æµæ³¨è§£
 * @author erik.zhou
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    String key() default "";
    int limit() default 100;
    int window() default 1;
    RateLimitType type() default RateLimitType.FIXED_WINDOW;
}

enum RateLimitType {
    FIXED_WINDOW,
    SLIDING_WINDOW,
    TOKEN_BUCKET
}

/**
 * é™æµåˆ‡é¢
 * @author erik.zhou
 */
@Aspect
@Component
public class RateLimitAspect {
    
    @Autowired
    private RedisRateLimiter rateLimiter;
    
    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint point, RateLimit rateLimit) throws Throwable {
        String key = rateLimit.key();
        if (key.isEmpty()) {
            key = point.getSignature().toString();
        }
        
        boolean acquired = false;
        switch (rateLimit.type()) {
            case FIXED_WINDOW:
                acquired = rateLimiter.tryAcquire(key, rateLimit.limit(), rateLimit.window());
                break;
            case SLIDING_WINDOW:
                acquired = rateLimiter.tryAcquireSliding(key, rateLimit.limit(), rateLimit.window());
                break;
            case TOKEN_BUCKET:
                acquired = rateLimiter.tryAcquireTokenBucket(key, rateLimit.limit(), rateLimit.window());
                break;
        }
        
        if (!acquired) {
            throw new RateLimitException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        return point.proceed();
    }
}
```

### 5.2 ç†”æ–­é™çº§

```java
/**
 * ç†”æ–­å™¨å®ç°
 * @author erik.zhou
 */
@Component
public class CircuitBreaker {
    
    private final AtomicInteger failureCount = new AtomicInteger(0);
    private final AtomicInteger successCount = new AtomicInteger(0);
    private volatile CircuitBreakerState state = CircuitBreakerState.CLOSED;
    private volatile long openTime = 0;
    
    private static final int FAILURE_THRESHOLD = 5; // å¤±è´¥é˜ˆå€¼
    private static final long TIMEOUT = 60000; // ç†”æ–­è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    
    public <T> T execute(Supplier<T> supplier, Function<Exception, T> fallback) {
        if (state == CircuitBreakerState.OPEN) {
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›å…¥åŠå¼€çŠ¶æ€
            if (System.currentTimeMillis() - openTime > TIMEOUT) {
                state = CircuitBreakerState.HALF_OPEN;
            } else {
                // ç†”æ–­ä¸­ï¼Œæ‰§è¡Œé™çº§é€»è¾‘
                return fallback.apply(new CircuitBreakerOpenException("ç†”æ–­å™¨æ‰“å¼€"));
            }
        }
        
        try {
            T result = supplier.get();
            onSuccess();
            return result;
        } catch (Exception e) {
            onFailure();
            return fallback.apply(e);
        }
    }
    
    private void onSuccess() {
        failureCount.set(0);
        if (state == CircuitBreakerState.HALF_OPEN) {
            state = CircuitBreakerState.CLOSED;
        }
    }
    
    private void onFailure() {
        int failures = failureCount.incrementAndGet();
        if (failures >= FAILURE_THRESHOLD) {
            state = CircuitBreakerState.OPEN;
            openTime = System.currentTimeMillis();
        }
    }
    
    enum CircuitBreakerState {
        CLOSED,    // å…³é—­çŠ¶æ€ï¼Œæ­£å¸¸è¯·æ±‚
        OPEN,      // æ‰“å¼€çŠ¶æ€ï¼Œæ‹’ç»è¯·æ±‚
        HALF_OPEN  // åŠå¼€çŠ¶æ€ï¼Œå°è¯•æ¢å¤
    }
}

/**
 * ä½¿ç”¨Sentinelå®ç°ç†”æ–­é™çº§
 * @author erik.zhou
 */
@Service
public class ProductService {
    
    /**
     * æŸ¥è¯¢å•†å“è¯¦æƒ… - å¸¦ç†”æ–­é™çº§
     */
    @SentinelResource(
        value = "getProductDetail",
        blockHandler = "handleBlock",
        fallback = "handleFallback"
    )
    public ProductDTO getProductDetail(Long productId) {
        // è°ƒç”¨è¿œç¨‹æœåŠ¡
        return remoteProductService.getDetail(productId);
    }
    
    /**
     * é™æµé™çº§å¤„ç†
     */
    public ProductDTO handleBlock(Long productId, BlockException ex) {
        log.warn("è¯·æ±‚è¢«é™æµ: productId={}", productId);
        return getDefaultProduct();
    }
    
    /**
     * å¼‚å¸¸é™çº§å¤„ç†
     */
    public ProductDTO handleFallback(Long productId, Throwable ex) {
        log.error("æœåŠ¡å¼‚å¸¸é™çº§: productId={}", productId, ex);
        return getDefaultProduct();
    }
    
    private ProductDTO getDefaultProduct() {
        ProductDTO product = new ProductDTO();
        product.setName("å•†å“æš‚æ—¶æ— æ³•æŸ¥çœ‹");
        return product;
    }
}
```

## ğŸ”¥ ç§’æ€ç³»ç»Ÿè®¾è®¡

### 6.1 ç§’æ€æ¥å£è®¾è®¡

```java
/**
 * ç§’æ€æœåŠ¡
 * @author erik.zhou
 */
@Service
public class SeckillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    /**
     * ç§’æ€æ¥å£ - é«˜å¹¶å‘ä¼˜åŒ–ç‰ˆæœ¬
     */
    @RateLimit(key = "seckill", limit = 10000, window = 1)
    public SeckillResult seckill(Long userId, Long productId) {
        // 1. å‚æ•°æ ¡éªŒ
        if (userId == null || productId == null) {
            return SeckillResult.fail("å‚æ•°é”™è¯¯");
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦åœ¨ç§’æ€æ—¶é—´å†…
        if (!checkSeckillTime(productId)) {
            return SeckillResult.fail("ä¸åœ¨ç§’æ€æ—¶é—´å†…");
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç§’æ€è¿‡ï¼ˆRedis Setï¼‰
        String userKey = "seckill:user:" + productId;
        Boolean added = redisTemplate.opsForSet().add(userKey, userId);
        if (Boolean.FALSE.equals(added)) {
            return SeckillResult.fail("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
        }
        
        // 4. é¢„æ‰£åº“å­˜ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        boolean stockSuccess = deductStockByLua(productId);
        if (!stockSuccess) {
            // å›æ»šç”¨æˆ·ç§’æ€è®°å½•
            redisTemplate.opsForSet().remove(userKey, userId);
            return SeckillResult.fail("å•†å“å·²å”®ç½„");
        }
        
        // 5. ç”Ÿæˆç§’æ€è®¢å•å·
        String orderNo = generateSeckillOrderNo(userId, productId);
        
        // 6. å‘é€MQæ¶ˆæ¯ï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillMessage message = new SeckillMessage();
        message.setUserId(userId);
        message.setProductId(productId);
        message.setOrderNo(orderNo);
        rabbitTemplate.convertAndSend("seckill.exchange", "seckill.order", message);
        
        // 7. è¿”å›ç»“æœ
        return SeckillResult.success(orderNo);
    }
    
    /**
     * ä½¿ç”¨Luaè„šæœ¬æ‰£å‡åº“å­˜
     */
    private boolean deductStockByLua(Long productId) {
        String script = 
            "local stock = redis.call('get', KEYS[1])\n" +
            "if stock and tonumber(stock) > 0 then\n" +
            "    redis.call('decr', KEYS[1])\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        DefaultRedisScript<Long> redisScript = new DefaultRedisScript<>(script, Long.class);
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList("seckill:stock:" + productId)
        );
        
        return result != null && result == 1;
    }
    
    /**
     * æ£€æŸ¥ç§’æ€æ—¶é—´
     */
    private boolean checkSeckillTime(Long productId) {
        String timeKey = "seckill:time:" + productId;
        Long startTime = (Long) redisTemplate.opsForHash().get(timeKey, "startTime");
        Long endTime = (Long) redisTemplate.opsForHash().get(timeKey, "endTime");
        
        if (startTime == null || endTime == null) {
            return false;
        }
        
        long now = System.currentTimeMillis();
        return now >= startTime && now <= endTime;
    }
    
    private String generateSeckillOrderNo(Long userId, Long productId) {
        return "SK" + productId + "_" + userId + "_" + System.currentTimeMillis();
    }
}
```

---

**ä½œè€…**: erik.zhou

# ç›‘æ§å‘Šè­¦ç³»ç»Ÿ-å®Œæ•´å®æˆ˜

> @author erik.zhou  
> éš¾åº¦: â­â­â­â­â­  
> æŠ€æœ¯æ ˆ: Spring Boot + Prometheus + Grafana + SkyWalking + AlertManager

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ä¸šåŠ¡åœºæ™¯
æ„å»ºä¸€ä¸ªä¼ä¸šçº§çš„ç›‘æ§å‘Šè­¦ç³»ç»Ÿï¼Œå®ç°å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¨æ–¹ä½ç›‘æ§ï¼ŒåŒ…æ‹¬ï¼š
- **åº”ç”¨ç›‘æ§**: JVMã€æ¥å£æ€§èƒ½ã€ä¸šåŠ¡æŒ‡æ ‡
- **é“¾è·¯è¿½è¸ª**: åˆ†å¸ƒå¼è°ƒç”¨é“¾è·¯åˆ†æ
- **å®æ—¶å‘Šè­¦**: å¤šæ¸ é“å‘Šè­¦é€šçŸ¥ï¼ˆé’‰é’‰ã€é‚®ä»¶ã€çŸ­ä¿¡ï¼‰
- **å¯è§†åŒ–**: å®æ—¶ç›‘æ§å¤§å±å’ŒæŠ¥è¡¨

### æ ¸å¿ƒéš¾ç‚¹
1. **æµ·é‡æŒ‡æ ‡é‡‡é›†ä¸å­˜å‚¨** - æ¯ç§’ç™¾ä¸‡çº§æŒ‡æ ‡æ•°æ®çš„é‡‡é›†å’Œå­˜å‚¨
2. **åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª** - è·¨æœåŠ¡è°ƒç”¨é“¾è·¯çš„å®Œæ•´è¿½è¸ªå’Œæ€§èƒ½åˆ†æ
3. **æ™ºèƒ½å‘Šè­¦é™å™ª** - é¿å…å‘Šè­¦é£æš´ï¼Œå®ç°å‘Šè­¦èšåˆå’ŒæŠ‘åˆ¶

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹1: æµ·é‡æŒ‡æ ‡é‡‡é›†ä¸å­˜å‚¨

### é—®é¢˜åœºæ™¯
- 100+ä¸ªå¾®æœåŠ¡å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹æ¯ç§’äº§ç”Ÿ1000+ä¸ªæŒ‡æ ‡
- æŒ‡æ ‡æ•°æ®éœ€è¦å®æ—¶é‡‡é›†ã€å­˜å‚¨ã€æŸ¥è¯¢
- å†å²æ•°æ®éœ€è¦ä¿ç•™30å¤©ä»¥ä¸Š
- æŸ¥è¯¢å“åº”æ—¶é—´è¦æ±‚åœ¨1ç§’å†…

### è§£å†³æ–¹æ¡ˆ

#### 1. æŒ‡æ ‡é‡‡é›†æ¶æ„

```java
/**
 * æŒ‡æ ‡é‡‡é›†é…ç½®
 * @author erik.zhou
 */
@Configuration
public class MetricsConfig {
    
    /**
     * é…ç½®Micrometeræ³¨å†Œè¡¨
     * ä½¿ç”¨Prometheusä½œä¸ºæŒ‡æ ‡å­˜å‚¨
     */
    @Bean
    public MeterRegistry meterRegistry() {
        PrometheusMeterRegistry registry = new PrometheusMeterRegistry(
            PrometheusConfig.DEFAULT
        );
        
        // æ·»åŠ é€šç”¨æ ‡ç­¾
        registry.config()
            .commonTags(
                "application", "order-service",
                "instance", getInstanceId(),
                "env", getEnvironment()
            );
        
        return registry;
    }
    
    /**
     * è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡é‡‡é›†
     */
    @Component
    public class BusinessMetricsCollector {
        
        private final MeterRegistry registry;
        private final Counter orderCounter;
        private final Timer orderProcessTimer;
        private final Gauge activeOrderGauge;
        
        public BusinessMetricsCollector(MeterRegistry registry) {
            this.registry = registry;
            
            // è®¢å•è®¡æ•°å™¨
            this.orderCounter = Counter.builder("business.order.total")
                .description("è®¢å•æ€»æ•°")
                .tag("type", "create")
                .register(registry);
            
            // è®¢å•å¤„ç†è€—æ—¶
            this.orderProcessTimer = Timer.builder("business.order.process.time")
                .description("è®¢å•å¤„ç†è€—æ—¶")
                .publishPercentiles(0.5, 0.95, 0.99)
                .register(registry);
            
            // æ´»è·ƒè®¢å•æ•°ï¼ˆå®æ—¶ï¼‰
            this.activeOrderGauge = Gauge.builder("business.order.active", 
                this, BusinessMetricsCollector::getActiveOrderCount)
                .description("æ´»è·ƒè®¢å•æ•°")
                .register(registry);
        }
        
        /**
         * è®°å½•è®¢å•åˆ›å»º
         */
        public void recordOrderCreate() {
            orderCounter.increment();
        }
        
        /**
         * è®°å½•è®¢å•å¤„ç†è€—æ—¶
         */
        public void recordOrderProcess(Runnable task) {
            orderProcessTimer.record(task);
        }
        
        /**
         * è·å–æ´»è·ƒè®¢å•æ•°
         */
        private double getActiveOrderCount() {
            // ä»Redisæˆ–æ•°æ®åº“è·å–å®æ—¶æ•°æ®
            return redisTemplate.opsForValue().get("active:order:count");
        }
    }
}

```

#### 2. æ—¶åºæ•°æ®åº“ä¼˜åŒ–

```yaml
# Prometheusé…ç½®ä¼˜åŒ–
# prometheus.yml
global:
  scrape_interval: 15s      # é‡‡é›†é—´éš”
  evaluation_interval: 15s  # è§„åˆ™è¯„ä¼°é—´éš”
  
  # å¤–éƒ¨æ ‡ç­¾
  external_labels:
    cluster: 'production'
    region: 'cn-beijing'

# é‡‡é›†é…ç½®
scrape_configs:
  - job_name: 'spring-boot-apps'
    # æœåŠ¡å‘ç°ï¼ˆä»Consul/Eurekaè·å–å®ä¾‹ï¼‰
    consul_sd_configs:
      - server: 'consul:8500'
        services: ['order-service', 'user-service']
    
    # é‡æ–°æ ‡è®°
    relabel_configs:
      - source_labels: [__meta_consul_service]
        target_label: service
      - source_labels: [__meta_consul_node]
        target_label: instance
    
    # æŒ‡æ ‡è·¯å¾„
    metrics_path: '/actuator/prometheus'
    
    # é‡‡é›†è¶…æ—¶
    scrape_timeout: 10s

# å­˜å‚¨é…ç½®
storage:
  tsdb:
    path: /prometheus/data
    retention.time: 30d        # ä¿ç•™30å¤©
    retention.size: 100GB      # æœ€å¤§100GB
    
    # å‹ç¼©é…ç½®
    min-block-duration: 2h
    max-block-duration: 24h
```

#### 3. æŒ‡æ ‡èšåˆä¸é™é‡‡æ ·

```java
/**
 * æŒ‡æ ‡èšåˆæœåŠ¡
 * å¯¹é«˜é¢‘æŒ‡æ ‡è¿›è¡Œé¢„èšåˆï¼Œå‡å°‘å­˜å‚¨å’ŒæŸ¥è¯¢å‹åŠ›
 * @author erik.zhou
 */
@Service
public class MetricsAggregationService {
    
    @Scheduled(fixedRate = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œ
    public void aggregateMetrics() {
        // 1. èšåˆQPSæŒ‡æ ‡ï¼ˆ1åˆ†é’Ÿç²’åº¦ï¼‰
        aggregateQpsMetrics();
        
        // 2. èšåˆå“åº”æ—¶é—´æŒ‡æ ‡
        aggregateResponseTimeMetrics();
        
        // 3. èšåˆé”™è¯¯ç‡æŒ‡æ ‡
        aggregateErrorRateMetrics();
    }
    
    /**
     * èšåˆQPSæŒ‡æ ‡
     * å°†ç§’çº§æ•°æ®èšåˆä¸ºåˆ†é’Ÿçº§
     */
    private void aggregateQpsMetrics() {
        String query = "sum(rate(http_requests_total[1m])) by (service, endpoint)";
        
        // æŸ¥è¯¢Prometheus
        PrometheusResponse response = prometheusClient.query(query);
        
        // å­˜å‚¨åˆ°MySQLï¼ˆç”¨äºé•¿æœŸè¶‹åŠ¿åˆ†æï¼‰
        List<MetricsAggregation> aggregations = response.getData().stream()
            .map(this::convertToAggregation)
            .collect(Collectors.toList());
        
        metricsAggregationMapper.batchInsert(aggregations);
    }
    
    /**
     * èšåˆå“åº”æ—¶é—´æŒ‡æ ‡
     * è®¡ç®—P50ã€P95ã€P99
     */
    private void aggregateResponseTimeMetrics() {
        // P50
        String p50Query = "histogram_quantile(0.5, " +
            "sum(rate(http_request_duration_seconds_bucket[1m])) by (le, service))";
        
        // P95
        String p95Query = "histogram_quantile(0.95, " +
            "sum(rate(http_request_duration_seconds_bucket[1m])) by (le, service))";
        
        // P99
        String p99Query = "histogram_quantile(0.99, " +
            "sum(rate(http_request_duration_seconds_bucket[1m])) by (le, service))";
        
        // æ‰¹é‡æŸ¥è¯¢å¹¶å­˜å‚¨
        CompletableFuture.allOf(
            CompletableFuture.runAsync(() -> queryAndStore(p50Query, "p50")),
            CompletableFuture.runAsync(() -> queryAndStore(p95Query, "p95")),
            CompletableFuture.runAsync(() -> queryAndStore(p99Query, "p99"))
        ).join();
    }
}
```

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹2: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

### é—®é¢˜åœºæ™¯
- ä¸€ä¸ªç”¨æˆ·è¯·æ±‚å¯èƒ½ç»è¿‡10+ä¸ªå¾®æœåŠ¡
- éœ€è¦è¿½è¸ªå®Œæ•´çš„è°ƒç”¨é“¾è·¯å’Œæ¯ä¸ªèŠ‚ç‚¹çš„è€—æ—¶
- éœ€è¦å®šä½æ€§èƒ½ç“¶é¢ˆå’Œå¼‚å¸¸èŠ‚ç‚¹
- è¿½è¸ªæ•°æ®é‡å¤§ï¼Œä¸èƒ½å½±å“ä¸šåŠ¡æ€§èƒ½

### è§£å†³æ–¹æ¡ˆ

#### 1. SkyWalkingé›†æˆ

```java
/**
 * é“¾è·¯è¿½è¸ªé…ç½®
 * @author erik.zhou
 */
@Configuration
public class TracingConfig {
    
    /**
     * è‡ªå®šä¹‰Spanæ ‡ç­¾
     */
    @Component
    public class CustomSpanTags {
        
        @Around("@annotation(com.example.annotation.Traced)")
        public Object addCustomTags(ProceedingJoinPoint pjp) throws Throwable {
            // è·å–å½“å‰Span
            AbstractSpan span = ContextManager.activeSpan();
            
            if (span != null) {
                // æ·»åŠ ä¸šåŠ¡æ ‡ç­¾
                MethodSignature signature = (MethodSignature) pjp.getSignature();
                Traced traced = signature.getMethod().getAnnotation(Traced.class);
                
                span.tag("business.type", traced.businessType());
                span.tag("business.id", traced.businessId());
                
                // æ·»åŠ ç”¨æˆ·ä¿¡æ¯
                String userId = UserContext.getCurrentUserId();
                if (userId != null) {
                    span.tag("user.id", userId);
                }
            }
            
            return pjp.proceed();
        }
    }
    
    /**
     * è·¨çº¿ç¨‹è¿½è¸ª
     */
    @Bean
    public Executor tracedExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("traced-");
        
        // åŒ…è£…Executorï¼Œä¼ é€’TraceContext
        return new TraceContextExecutor(executor);
    }
    
    /**
     * TraceContextä¼ é€’Executor
     */
    static class TraceContextExecutor implements Executor {
        private final Executor delegate;
        
        public TraceContextExecutor(Executor delegate) {
            this.delegate = delegate;
        }
        
        @Override
        public void execute(Runnable command) {
            // æ•è·å½“å‰TraceContext
            ContextSnapshot snapshot = ContextManager.capture();
            
            delegate.execute(() -> {
                try {
                    // æ¢å¤TraceContext
                    ContextManager.continued(snapshot);
                    command.run();
                } finally {
                    ContextManager.stopSpan();
                }
            });
        }
    }
}
```

#### 2. é“¾è·¯åˆ†ææœåŠ¡

```java
/**
 * é“¾è·¯åˆ†ææœåŠ¡
 * @author erik.zhou
 */
@Service
public class TraceAnalysisService {
    
    @Autowired
    private SkyWalkingClient skyWalkingClient;
    
    /**
     * åˆ†ææ…¢é“¾è·¯
     * æ‰¾å‡ºå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼çš„é“¾è·¯
     */
    public List<SlowTrace> analyzeSlowTraces(long thresholdMs) {
        // æŸ¥è¯¢æœ€è¿‘1å°æ—¶çš„é“¾è·¯æ•°æ®
        TraceQuery query = TraceQuery.builder()
            .startTime(System.currentTimeMillis() - 3600000)
            .endTime(System.currentTimeMillis())
            .minDuration(thresholdMs)
            .build();
        
        List<Trace> traces = skyWalkingClient.queryTraces(query);
        
        return traces.stream()
            .map(this::analyzeTrace)
            .collect(Collectors.toList());
    }
    
    /**
     * åˆ†æå•ä¸ªé“¾è·¯
     * æ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆ
     */
    private SlowTrace analyzeTrace(Trace trace) {
        SlowTrace slowTrace = new SlowTrace();
        slowTrace.setTraceId(trace.getTraceId());
        slowTrace.setTotalDuration(trace.getDuration());
        
        // æ‰¾å‡ºæœ€æ…¢çš„Span
        Span slowestSpan = trace.getSpans().stream()
            .max(Comparator.comparing(Span::getDuration))
            .orElse(null);
        
        if (slowestSpan != null) {
            slowTrace.setBottleneckService(slowestSpan.getServiceName());
            slowTrace.setBottleneckOperation(slowestSpan.getOperationName());
            slowTrace.setBottleneckDuration(slowestSpan.getDuration());
            
            // è®¡ç®—ç“¶é¢ˆå æ¯”
            double percentage = (double) slowestSpan.getDuration() / trace.getDuration() * 100;
            slowTrace.setBottleneckPercentage(percentage);
        }
        
        // åˆ†æé”™è¯¯
        List<Span> errorSpans = trace.getSpans().stream()
            .filter(Span::isError)
            .collect(Collectors.toList());
        
        if (!errorSpans.isEmpty()) {
            slowTrace.setHasError(true);
            slowTrace.setErrorSpans(errorSpans);
        }
        
        return slowTrace;
    }
    
    /**
     * ç”ŸæˆæœåŠ¡ä¾èµ–æ‹“æ‰‘å›¾
     */
    public ServiceTopology generateTopology(long startTime, long endTime) {
        // æŸ¥è¯¢æœåŠ¡è°ƒç”¨å…³ç³»
        List<ServiceRelation> relations = skyWalkingClient
            .queryServiceRelations(startTime, endTime);
        
        ServiceTopology topology = new ServiceTopology();
        
        // æ„å»ºèŠ‚ç‚¹
        Set<String> services = new HashSet<>();
        relations.forEach(r -> {
            services.add(r.getSource());
            services.add(r.getTarget());
        });
        
        services.forEach(service -> {
            ServiceNode node = new ServiceNode();
            node.setServiceName(service);
            
            // æŸ¥è¯¢æœåŠ¡æŒ‡æ ‡
            ServiceMetrics metrics = skyWalkingClient
                .queryServiceMetrics(service, startTime, endTime);
            
            node.setQps(metrics.getQps());
            node.setAvgResponseTime(metrics.getAvgResponseTime());
            node.setErrorRate(metrics.getErrorRate());
            
            topology.addNode(node);
        });
        
        // æ„å»ºè¾¹
        relations.forEach(relation -> {
            ServiceEdge edge = new ServiceEdge();
            edge.setSource(relation.getSource());
            edge.setTarget(relation.getTarget());
            edge.setCallCount(relation.getCallCount());
            edge.setAvgResponseTime(relation.getAvgResponseTime());
            
            topology.addEdge(edge);
        });
        
        return topology;
    }
}
```

#### 3. é‡‡æ ·ç­–ç•¥ä¼˜åŒ–

```java
/**
 * æ™ºèƒ½é‡‡æ ·ç­–ç•¥
 * æ ¹æ®è¯·æ±‚ç‰¹å¾åŠ¨æ€è°ƒæ•´é‡‡æ ·ç‡
 * @author erik.zhou
 */
@Component
public class AdaptiveSamplingStrategy {
    
    /**
     * åŠ¨æ€é‡‡æ ·å†³ç­–
     */
    public boolean shouldSample(HttpServletRequest request) {
        // 1. é”™è¯¯è¯·æ±‚100%é‡‡æ ·
        if (isErrorRequest(request)) {
            return true;
        }
        
        // 2. æ…¢è¯·æ±‚100%é‡‡æ ·
        if (isSlowRequest(request)) {
            return true;
        }
        
        // 3. é‡è¦æ¥å£é«˜é‡‡æ ·ç‡ï¼ˆ50%ï¼‰
        if (isImportantEndpoint(request)) {
            return ThreadLocalRandom.current().nextDouble() < 0.5;
        }
        
        // 4. æ™®é€šè¯·æ±‚ä½é‡‡æ ·ç‡ï¼ˆ1%ï¼‰
        return ThreadLocalRandom.current().nextDouble() < 0.01;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºé”™è¯¯è¯·æ±‚
     */
    private boolean isErrorRequest(HttpServletRequest request) {
        Integer statusCode = (Integer) request.getAttribute("statusCode");
        return statusCode != null && statusCode >= 400;
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºæ…¢è¯·æ±‚
     */
    private boolean isSlowRequest(HttpServletRequest request) {
        Long duration = (Long) request.getAttribute("duration");
        return duration != null && duration > 1000; // è¶…è¿‡1ç§’
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºé‡è¦æ¥å£
     */
    private boolean isImportantEndpoint(HttpServletRequest request) {
        String uri = request.getRequestURI();
        return uri.contains("/order/") || 
               uri.contains("/payment/") ||
               uri.contains("/user/login");
    }
}
```

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹3: æ™ºèƒ½å‘Šè­¦é™å™ª

### é—®é¢˜åœºæ™¯
- å‘Šè­¦è§„åˆ™è¿‡å¤šï¼Œå®¹æ˜“äº§ç”Ÿå‘Šè­¦é£æš´
- åŒä¸€é—®é¢˜äº§ç”Ÿå¤§é‡é‡å¤å‘Šè­¦
- å‘Šè­¦ä¿¡æ¯ä¸å¤Ÿç²¾å‡†ï¼Œè¯¯æŠ¥ç‡é«˜
- å‘Šè­¦é€šçŸ¥æ¸ é“å•ä¸€ï¼Œæ— æ³•åˆ†çº§å¤„ç†

### è§£å†³æ–¹æ¡ˆ

#### 1. å‘Šè­¦è§„åˆ™é…ç½®

```yaml
# AlertManageré…ç½®
# alertmanager.yml
global:
  resolve_timeout: 5m
  
# å‘Šè­¦è·¯ç”±
route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s        # ç­‰å¾…10ç§’æ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 10s    # åŒç»„å‘Šè­¦é—´éš”10ç§’
  repeat_interval: 1h    # é‡å¤å‘Šè­¦é—´éš”1å°æ—¶
  
  receiver: 'default'
  
  # å­è·¯ç”±
  routes:
    # P0çº§åˆ«å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 5m
      
    # P1çº§åˆ«å‘Šè­¦ - 5åˆ†é’Ÿåé€šçŸ¥
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 5m
      repeat_interval: 30m
      
    # ä¸šåŠ¡å‘Šè­¦
    - match:
        type: business
      receiver: 'business-alerts'

# å‘Šè­¦æ¥æ”¶å™¨
receivers:
  - name: 'default'
    webhook_configs:
      - url: 'http://alert-service:8080/webhook'
  
  - name: 'critical-alerts'
    webhook_configs:
      - url: 'http://alert-service:8080/webhook/critical'
    # é’‰é’‰é€šçŸ¥
    webhook_configs:
      - url: 'https://oapi.dingtalk.com/robot/send?access_token=xxx'
    # çŸ­ä¿¡é€šçŸ¥
    webhook_configs:
      - url: 'http://sms-service:8080/send'
  
  - name: 'warning-alerts'
    webhook_configs:
      - url: 'http://alert-service:8080/webhook/warning'
  
  - name: 'business-alerts'
    webhook_configs:
      - url: 'http://alert-service:8080/webhook/business'

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœèŠ‚ç‚¹å®•æœºï¼ŒæŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
  
  # å¦‚æœæœåŠ¡ä¸å¯ç”¨ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„æ€§èƒ½å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighResponseTime'
    equal: ['service']
```

#### 2. å‘Šè­¦èšåˆæœåŠ¡

```java
/**
 * å‘Šè­¦èšåˆæœåŠ¡
 * å¯¹å‘Šè­¦è¿›è¡Œæ™ºèƒ½èšåˆå’Œé™å™ª
 * @author erik.zhou
 */
@Service
public class AlertAggregationService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private AlertNotificationService notificationService;
    
    /**
     * å¤„ç†å‘Šè­¦
     * è¿›è¡Œèšåˆå’Œé™å™ª
     */
    public void processAlert(Alert alert) {
        // 1. æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤å‘Šè­¦
        if (isDuplicateAlert(alert)) {
            log.info("é‡å¤å‘Šè­¦ï¼Œå¿½ç•¥: {}", alert);
            return;
        }
        
        // 2. å‘Šè­¦èšåˆ
        String aggregationKey = getAggregationKey(alert);
        aggregateAlert(aggregationKey, alert);
        
        // 3. æ£€æŸ¥æ˜¯å¦è¾¾åˆ°èšåˆé˜ˆå€¼
        if (shouldSendAggregatedAlert(aggregationKey)) {
            sendAggregatedAlert(aggregationKey);
        }
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºé‡å¤å‘Šè­¦
     * ä½¿ç”¨æ»‘åŠ¨çª—å£å»é‡
     */
    private boolean isDuplicateAlert(Alert alert) {
        String dedupeKey = String.format("alert:dedupe:%s:%s",
            alert.getAlertName(), alert.getInstance());
        
        // æ£€æŸ¥æœ€è¿‘5åˆ†é’Ÿæ˜¯å¦æœ‰ç›¸åŒå‘Šè­¦
        Boolean exists = redisTemplate.opsForValue()
            .setIfAbsent(dedupeKey, "1", 5, TimeUnit.MINUTES);
        
        return !Boolean.TRUE.equals(exists);
    }
    
    /**
     * è·å–èšåˆKey
     * ç›¸åŒæœåŠ¡ã€ç›¸åŒå‘Šè­¦ç±»å‹èšåˆåœ¨ä¸€èµ·
     */
    private String getAggregationKey(Alert alert) {
        return String.format("alert:agg:%s:%s",
            alert.getService(), alert.getAlertName());
    }
    
    /**
     * èšåˆå‘Šè­¦
     */
    private void aggregateAlert(String key, Alert alert) {
        // æ·»åŠ åˆ°èšåˆåˆ—è¡¨
        redisTemplate.opsForList().rightPush(key, alert);
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰
        redisTemplate.expire(key, 10, TimeUnit.MINUTES);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åº”è¯¥å‘é€èšåˆå‘Šè­¦
     */
    private boolean shouldSendAggregatedAlert(String key) {
        Long count = redisTemplate.opsForList().size(key);
        
        // 1. è¾¾åˆ°æ•°é‡é˜ˆå€¼ï¼ˆ10ä¸ªï¼‰
        if (count != null && count >= 10) {
            return true;
        }
        
        // 2. è¾¾åˆ°æ—¶é—´é˜ˆå€¼ï¼ˆ5åˆ†é’Ÿï¼‰
        String timeKey = key + ":time";
        Boolean isFirst = redisTemplate.opsForValue()
            .setIfAbsent(timeKey, "1", 5, TimeUnit.MINUTES);
        
        return !Boolean.TRUE.equals(isFirst);
    }
    
    /**
     * å‘é€èšåˆå‘Šè­¦
     */
    private void sendAggregatedAlert(String key) {
        // è·å–æ‰€æœ‰èšåˆçš„å‘Šè­¦
        List<Object> alerts = redisTemplate.opsForList().range(key, 0, -1);
        
        if (alerts == null || alerts.isEmpty()) {
            return;
        }
        
        // æ„å»ºèšåˆå‘Šè­¦æ¶ˆæ¯
        AggregatedAlert aggregated = new AggregatedAlert();
        aggregated.setCount(alerts.size());
        aggregated.setAlerts(alerts.stream()
            .map(obj -> (Alert) obj)
            .collect(Collectors.toList()));
        
        // æå–å…¬å…±ä¿¡æ¯
        Alert first = (Alert) alerts.get(0);
        aggregated.setService(first.getService());
        aggregated.setAlertName(first.getAlertName());
        aggregated.setSeverity(first.getSeverity());
        
        // å‘é€é€šçŸ¥
        notificationService.sendAggregatedAlert(aggregated);
        
        // æ¸…ç©ºèšåˆåˆ—è¡¨
        redisTemplate.delete(key);
    }
}
```


#### 3. å¤šæ¸ é“å‘Šè­¦é€šçŸ¥

```java
/**
 * å‘Šè­¦é€šçŸ¥æœåŠ¡
 * æ”¯æŒå¤šæ¸ é“é€šçŸ¥
 * @author erik.zhou
 */
@Service
public class AlertNotificationService {
    
    @Autowired
    private DingTalkClient dingTalkClient;
    
    @Autowired
    private EmailClient emailClient;
    
    @Autowired
    private SmsClient smsClient;
    
    /**
     * å‘é€å‘Šè­¦é€šçŸ¥
     * æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
     */
    public void sendAlert(Alert alert) {
        switch (alert.getSeverity()) {
            case CRITICAL:
                // P0çº§åˆ«ï¼šé’‰é’‰ + çŸ­ä¿¡ + é‚®ä»¶
                sendDingTalkAlert(alert);
                sendSmsAlert(alert);
                sendEmailAlert(alert);
                break;
                
            case WARNING:
                // P1çº§åˆ«ï¼šé’‰é’‰ + é‚®ä»¶
                sendDingTalkAlert(alert);
                sendEmailAlert(alert);
                break;
                
            case INFO:
                // P2çº§åˆ«ï¼šä»…é’‰é’‰
                sendDingTalkAlert(alert);
                break;
        }
    }
    
    /**
     * å‘é€é’‰é’‰å‘Šè­¦
     */
    private void sendDingTalkAlert(Alert alert) {
        DingTalkMessage message = DingTalkMessage.builder()
            .msgtype("markdown")
            .markdown(DingTalkMarkdown.builder()
                .title(String.format("[%s] %s", alert.getSeverity(), alert.getAlertName()))
                .text(buildDingTalkContent(alert))
                .build())
            .at(DingTalkAt.builder()
                .isAtAll(alert.getSeverity() == Severity.CRITICAL)
                .build())
            .build();
        
        dingTalkClient.send(message);
    }
    
    /**
     * æ„å»ºé’‰é’‰æ¶ˆæ¯å†…å®¹
     */
    private String buildDingTalkContent(Alert alert) {
        return String.format(
            "### å‘Šè­¦é€šçŸ¥\n\n" +
            "**å‘Šè­¦åç§°**: %s\n\n" +
            "**å‘Šè­¦çº§åˆ«**: %s\n\n" +
            "**æœåŠ¡åç§°**: %s\n\n" +
            "**å®ä¾‹**: %s\n\n" +
            "**å‘Šè­¦æ—¶é—´**: %s\n\n" +
            "**å‘Šè­¦è¯¦æƒ…**: %s\n\n" +
            "**å½“å‰å€¼**: %s\n\n" +
            "**é˜ˆå€¼**: %s\n\n" +
            "[æŸ¥çœ‹è¯¦æƒ…](%s)",
            alert.getAlertName(),
            alert.getSeverity(),
            alert.getService(),
            alert.getInstance(),
            formatTime(alert.getTimestamp()),
            alert.getDescription(),
            alert.getCurrentValue(),
            alert.getThreshold(),
            alert.getDashboardUrl()
        );
    }
    
    /**
     * å‘é€çŸ­ä¿¡å‘Šè­¦
     * ä»…ç”¨äºP0çº§åˆ«å‘Šè­¦
     */
    private void sendSmsAlert(Alert alert) {
        // è·å–å€¼ç­äººå‘˜æ‰‹æœºå·
        List<String> phones = getOnCallPhones();
        
        String content = String.format(
            "[å‘Šè­¦] %sæœåŠ¡%sï¼Œå½“å‰å€¼%sï¼Œè¯·åŠæ—¶å¤„ç†",
            alert.getService(),
            alert.getAlertName(),
            alert.getCurrentValue()
        );
        
        phones.forEach(phone -> smsClient.send(phone, content));
    }
    
    /**
     * å‘é€é‚®ä»¶å‘Šè­¦
     */
    private void sendEmailAlert(Alert alert) {
        List<String> recipients = getAlertRecipients(alert);
        
        EmailMessage email = EmailMessage.builder()
            .to(recipients)
            .subject(String.format("[%s] %s - %s", 
                alert.getSeverity(), alert.getService(), alert.getAlertName()))
            .content(buildEmailContent(alert))
            .build();
        
        emailClient.send(email);
    }
    
    /**
     * è·å–å‘Šè­¦æ¥æ”¶äºº
     */
    private List<String> getAlertRecipients(Alert alert) {
        // ä»é…ç½®ä¸­å¿ƒè·å–æœåŠ¡è´Ÿè´£äºº
        ServiceOwner owner = configService.getServiceOwner(alert.getService());
        
        List<String> recipients = new ArrayList<>();
        recipients.add(owner.getEmail());
        
        // P0çº§åˆ«å‘Šè­¦æŠ„é€å›¢é˜Ÿè´Ÿè´£äºº
        if (alert.getSeverity() == Severity.CRITICAL) {
            recipients.add(owner.getTeamLeaderEmail());
        }
        
        return recipients;
    }
}
```

#### 4. å‘Šè­¦è‡ªæ„ˆ

```java
/**
 * å‘Šè­¦è‡ªæ„ˆæœåŠ¡
 * å¯¹æŸäº›å‘Šè­¦è‡ªåŠ¨æ‰§è¡Œä¿®å¤æ“ä½œ
 * @author erik.zhou
 */
@Service
public class AlertSelfHealingService {
    
    @Autowired
    private KubernetesClient k8sClient;
    
    @Autowired
    private ServiceRegistry serviceRegistry;
    
    /**
     * å¤„ç†å‘Šè­¦è‡ªæ„ˆ
     */
    public void handleAlert(Alert alert) {
        switch (alert.getAlertName()) {
            case "HighMemoryUsage":
                // å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ - é‡å¯Pod
                restartPod(alert);
                break;
                
            case "ServiceDown":
                // æœåŠ¡ä¸å¯ç”¨ - ä»æ³¨å†Œä¸­å¿ƒæ‘˜é™¤
                deregisterService(alert);
                break;
                
            case "HighErrorRate":
                // é”™è¯¯ç‡è¿‡é«˜ - é™çº§å¤„ç†
                degradeService(alert);
                break;
                
            case "DiskSpaceLow":
                // ç£ç›˜ç©ºé—´ä¸è¶³ - æ¸…ç†æ—¥å¿—
                cleanupLogs(alert);
                break;
        }
    }
    
    /**
     * é‡å¯Pod
     */
    private void restartPod(Alert alert) {
        String podName = alert.getInstance();
        String namespace = alert.getNamespace();
        
        log.info("è‡ªåŠ¨é‡å¯Pod: {}/{}", namespace, podName);
        
        try {
            // åˆ é™¤Podï¼Œè®©K8sè‡ªåŠ¨é‡å»º
            k8sClient.pods()
                .inNamespace(namespace)
                .withName(podName)
                .delete();
            
            // è®°å½•è‡ªæ„ˆæ“ä½œ
            recordHealingAction(alert, "é‡å¯Pod", true, null);
            
        } catch (Exception e) {
            log.error("é‡å¯Podå¤±è´¥", e);
            recordHealingAction(alert, "é‡å¯Pod", false, e.getMessage());
        }
    }
    
    /**
     * ä»æ³¨å†Œä¸­å¿ƒæ‘˜é™¤æœåŠ¡
     */
    private void deregisterService(Alert alert) {
        String serviceId = alert.getInstance();
        
        log.info("ä»æ³¨å†Œä¸­å¿ƒæ‘˜é™¤æœåŠ¡: {}", serviceId);
        
        try {
            serviceRegistry.deregister(serviceId);
            recordHealingAction(alert, "æ‘˜é™¤æœåŠ¡", true, null);
            
        } catch (Exception e) {
            log.error("æ‘˜é™¤æœåŠ¡å¤±è´¥", e);
            recordHealingAction(alert, "æ‘˜é™¤æœåŠ¡", false, e.getMessage());
        }
    }
    
    /**
     * æœåŠ¡é™çº§
     */
    private void degradeService(Alert alert) {
        String service = alert.getService();
        
        log.info("æœåŠ¡é™çº§: {}", service);
        
        try {
            // æ›´æ–°Sentinelé™çº§è§„åˆ™
            DegradeRule rule = new DegradeRule();
            rule.setResource(service);
            rule.setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType());
            rule.setCount(0.5); // é”™è¯¯ç‡50%
            rule.setTimeWindow(60); // é™çº§60ç§’
            
            DegradeRuleManager.loadRules(Collections.singletonList(rule));
            
            recordHealingAction(alert, "æœåŠ¡é™çº§", true, null);
            
        } catch (Exception e) {
            log.error("æœåŠ¡é™çº§å¤±è´¥", e);
            recordHealingAction(alert, "æœåŠ¡é™çº§", false, e.getMessage());
        }
    }
    
    /**
     * æ¸…ç†æ—¥å¿—
     */
    private void cleanupLogs(Alert alert) {
        String instance = alert.getInstance();
        
        log.info("æ¸…ç†æ—¥å¿—: {}", instance);
        
        try {
            // æ‰§è¡Œæ¸…ç†è„šæœ¬
            String command = "find /var/log -name '*.log' -mtime +7 -delete";
            executeRemoteCommand(instance, command);
            
            recordHealingAction(alert, "æ¸…ç†æ—¥å¿—", true, null);
            
        } catch (Exception e) {
            log.error("æ¸…ç†æ—¥å¿—å¤±è´¥", e);
            recordHealingAction(alert, "æ¸…ç†æ—¥å¿—", false, e.getMessage());
        }
    }
    
    /**
     * è®°å½•è‡ªæ„ˆæ“ä½œ
     */
    private void recordHealingAction(Alert alert, String action, 
                                     boolean success, String errorMsg) {
        HealingRecord record = new HealingRecord();
        record.setAlertId(alert.getId());
        record.setAction(action);
        record.setSuccess(success);
        record.setErrorMsg(errorMsg);
        record.setTimestamp(System.currentTimeMillis());
        
        healingRecordMapper.insert(record);
    }
}
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- æœåŠ¡å™¨: 8æ ¸16G * 3å°
- Prometheus: å•æœºéƒ¨ç½²
- SkyWalking: é›†ç¾¤éƒ¨ç½²ï¼ˆ3èŠ‚ç‚¹ï¼‰
- AlertManager: å•æœºéƒ¨ç½²

### æµ‹è¯•ç»“æœ

#### 1. æŒ‡æ ‡é‡‡é›†æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| é‡‡é›†å®ä¾‹æ•° | 100ä¸ª |
| æ¯å®ä¾‹æŒ‡æ ‡æ•° | 1000ä¸ª |
| é‡‡é›†é—´éš” | 15ç§’ |
| æ€»æŒ‡æ ‡æ•°/ç§’ | 6666ä¸ª |
| Prometheus CPU | 30% |
| Prometheus å†…å­˜ | 4GB |
| æŸ¥è¯¢å“åº”æ—¶é—´ | <500ms |

#### 2. é“¾è·¯è¿½è¸ªæ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| è¯·æ±‚QPS | 10000 |
| é‡‡æ ·ç‡ | 1% |
| å®é™…è¿½è¸ªQPS | 100 |
| è¿½è¸ªæ•°æ®å»¶è¿Ÿ | <3ç§’ |
| ä¸šåŠ¡æ€§èƒ½å½±å“ | <1% |
| å­˜å‚¨ç©ºé—´/å¤© | 50GB |

#### 3. å‘Šè­¦å¤„ç†æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å‘Šè­¦è§„åˆ™æ•° | 200ä¸ª |
| å‘Šè­¦è§¦å‘é¢‘ç‡ | 100æ¬¡/åˆ†é’Ÿ |
| å‘Šè­¦èšåˆç‡ | 80% |
| å®é™…é€šçŸ¥æ•° | 20æ¬¡/åˆ†é’Ÿ |
| å‘Šè­¦å»¶è¿Ÿ | <10ç§’ |
| è¯¯æŠ¥ç‡ | <5% |

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æŒ‡æ ‡è®¾è®¡åŸåˆ™

```java
/**
 * æŒ‡æ ‡è®¾è®¡æœ€ä½³å®è·µ
 * @author erik.zhou
 */
public class MetricsBestPractices {
    
    // âœ… å¥½çš„æŒ‡æ ‡å‘½å
    // æ ¼å¼: <namespace>_<subsystem>_<name>_<unit>
    Counter orderCreatedTotal = Counter.builder("business_order_created_total")
        .description("è®¢å•åˆ›å»ºæ€»æ•°")
        .register(registry);
    
    Timer orderProcessDurationSeconds = Timer.builder("business_order_process_duration_seconds")
        .description("è®¢å•å¤„ç†è€—æ—¶")
        .register(registry);
    
    // âŒ ä¸å¥½çš„æŒ‡æ ‡å‘½å
    Counter orders = Counter.builder("orders").register(registry);
    Timer time = Timer.builder("time").register(registry);
    
    // âœ… åˆç†ä½¿ç”¨æ ‡ç­¾
    Counter httpRequests = Counter.builder("http_requests_total")
        .tag("method", "GET")
        .tag("endpoint", "/api/orders")
        .tag("status", "200")
        .register(registry);
    
    // âŒ æ ‡ç­¾å€¼è¿‡å¤šï¼ˆé«˜åŸºæ•°é—®é¢˜ï¼‰
    Counter requests = Counter.builder("requests_total")
        .tag("user_id", userId) // ç”¨æˆ·IDå¯èƒ½æœ‰ç™¾ä¸‡çº§
        .register(registry);
    
    // âœ… ä½¿ç”¨ç›´æ–¹å›¾è®°å½•åˆ†å¸ƒ
    Timer.builder("http_request_duration_seconds")
        .publishPercentiles(0.5, 0.95, 0.99) // P50, P95, P99
        .publishPercentileHistogram()
        .register(registry);
}
```

### 2. å‘Šè­¦è§„åˆ™è®¾è®¡

```yaml
# Prometheuså‘Šè­¦è§„åˆ™æœ€ä½³å®è·µ
groups:
  - name: service-alerts
    interval: 30s
    rules:
      # âœ… å¥½çš„å‘Šè­¦è§„åˆ™
      # 1. æ˜ç¡®çš„å‘Šè­¦åç§°
      # 2. åˆç†çš„é˜ˆå€¼
      # 3. é€‚å½“çš„æŒç»­æ—¶é—´
      # 4. è¯¦ç»†çš„æè¿°å’Œå¤„ç†å»ºè®®
      - alert: HighErrorRate
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
          /
          sum(rate(http_requests_total[5m])) by (service)
          > 0.05
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "æœåŠ¡ {{ $labels.service }} é”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡: {{ $value | humanizePercentage }}"
          runbook: "https://wiki.example.com/runbook/high-error-rate"
          dashboard: "https://grafana.example.com/d/service-overview"
      
      # âœ… å¤šçº§å‘Šè­¦
      - alert: HighResponseTime-Warning
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 1
        for: 5m
        labels:
          severity: warning
      
      - alert: HighResponseTime-Critical
        expr: |
          histogram_quantile(0.95, 
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, service)
          ) > 3
        for: 5m
        labels:
          severity: critical
      
      # âŒ ä¸å¥½çš„å‘Šè­¦è§„åˆ™
      # 1. é˜ˆå€¼è¿‡äºæ•æ„Ÿ
      # 2. æ²¡æœ‰æŒç»­æ—¶é—´
      # 3. ç¼ºå°‘æè¿°
      - alert: BadAlert
        expr: http_requests_total > 100
        labels:
          severity: critical
```

### 3. ç›‘æ§å¤§å±è®¾è®¡

```java
/**
 * ç›‘æ§å¤§å±æ•°æ®æœåŠ¡
 * @author erik.zhou
 */
@Service
public class MonitoringDashboardService {
    
    /**
     * è·å–ç³»ç»Ÿæ¦‚è§ˆæ•°æ®
     */
    public SystemOverview getSystemOverview() {
        SystemOverview overview = new SystemOverview();
        
        // 1. æœåŠ¡å¥åº·åº¦
        overview.setHealthyServices(getHealthyServiceCount());
        overview.setTotalServices(getTotalServiceCount());
        
        // 2. æ€»ä½“QPS
        overview.setTotalQps(getTotalQps());
        
        // 3. å¹³å‡å“åº”æ—¶é—´
        overview.setAvgResponseTime(getAvgResponseTime());
        
        // 4. é”™è¯¯ç‡
        overview.setErrorRate(getErrorRate());
        
        // 5. æ´»è·ƒå‘Šè­¦æ•°
        overview.setActiveAlerts(getActiveAlertCount());
        
        return overview;
    }
    
    /**
     * è·å–æœåŠ¡TOPæ¦œ
     */
    public ServiceTopList getServiceTopList() {
        ServiceTopList topList = new ServiceTopList();
        
        // QPS TOP10
        topList.setTopQpsServices(getTopServicesByQps(10));
        
        // å“åº”æ—¶é—´ TOP10
        topList.setTopResponseTimeServices(getTopServicesByResponseTime(10));
        
        // é”™è¯¯ç‡ TOP10
        topList.setTopErrorRateServices(getTopServicesByErrorRate(10));
        
        return topList;
    }
    
    /**
     * è·å–å®æ—¶è°ƒç”¨é“¾è·¯
     */
    public List<RealtimeTrace> getRealtimeTraces(int limit) {
        // ä»SkyWalkingè·å–æœ€æ–°çš„é“¾è·¯æ•°æ®
        return skyWalkingClient.queryRecentTraces(limit);
    }
}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æµ·é‡æŒ‡æ ‡é‡‡é›†**
   - ä½¿ç”¨Prometheusæ—¶åºæ•°æ®åº“
   - åˆç†è®¾è®¡æŒ‡æ ‡å’Œæ ‡ç­¾
   - å®æ–½æŒ‡æ ‡èšåˆå’Œé™é‡‡æ ·
   - æ§åˆ¶æŒ‡æ ‡åŸºæ•°

2. **åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª**
   - ä½¿ç”¨SkyWalkingå®ç°æ— ä¾µå…¥è¿½è¸ª
   - å®æ–½æ™ºèƒ½é‡‡æ ·ç­–ç•¥
   - è·¨çº¿ç¨‹å’Œè·¨è¿›ç¨‹ä¼ é€’TraceContext
   - å®šæœŸåˆ†ææ…¢é“¾è·¯å’Œæ€§èƒ½ç“¶é¢ˆ

3. **æ™ºèƒ½å‘Šè­¦é™å™ª**
   - è®¾è®¡åˆç†çš„å‘Šè­¦è§„åˆ™
   - å®æ–½å‘Šè­¦èšåˆå’Œå»é‡
   - å¤šçº§å‘Šè­¦å’Œå¤šæ¸ é“é€šçŸ¥
   - å‘Šè­¦è‡ªæ„ˆæœºåˆ¶

### æŠ€æœ¯æ”¶è·

- æŒæ¡äº†Prometheus + Grafanaç›‘æ§ä½“ç³»
- ç†è§£äº†SkyWalkingé“¾è·¯è¿½è¸ªåŸç†
- å­¦ä¼šäº†è®¾è®¡æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ
- ç§¯ç´¯äº†å¤§è§„æ¨¡ç›‘æ§ç³»ç»Ÿç»éªŒ

### ç”Ÿäº§ç»éªŒ

- ç›‘æ§æŒ‡æ ‡è¦æœ‰ä¸šåŠ¡æ„ä¹‰
- å‘Šè­¦è§„åˆ™è¦æŒç»­ä¼˜åŒ–
- é“¾è·¯è¿½è¸ªè¦æ§åˆ¶æ€§èƒ½å½±å“
- ç›‘æ§ç³»ç»Ÿæœ¬èº«ä¹Ÿè¦ç›‘æ§

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

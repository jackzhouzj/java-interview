# ç§’æ€ç³»ç»Ÿ å®Œæ•´å®æˆ˜

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
- [æ ¸å¿ƒåŠŸèƒ½å®ç°](#æ ¸å¿ƒåŠŸèƒ½å®ç°)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [å‹åŠ›æµ‹è¯•](#å‹åŠ›æµ‹è¯•)
- [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)

## ğŸ“š é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®èƒŒæ™¯
è®¾è®¡ä¸€ä¸ªèƒ½å¤Ÿæ”¯æŒ10ä¸‡+å¹¶å‘çš„ç§’æ€ç³»ç»Ÿï¼Œè¦æ±‚ï¼š
- é«˜å¹¶å‘ï¼šæ”¯æŒ10ä¸‡QPS
- é«˜å¯ç”¨ï¼š99.99%å¯ç”¨æ€§
- æ•°æ®ä¸€è‡´æ€§ï¼šåº“å­˜ä¸è¶…å–
- ç”¨æˆ·ä½“éªŒï¼šå“åº”æ—¶é—´<100ms

### ä¸šåŠ¡æµç¨‹
1. ç”¨æˆ·è¿›å…¥ç§’æ€é¡µé¢
2. ç‚¹å‡»ç§’æ€æŒ‰é’®
3. ç³»ç»Ÿæ ¡éªŒåº“å­˜
4. æ‰£å‡åº“å­˜
5. åˆ›å»ºè®¢å•
6. è¿”å›ç»“æœ

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
ç”¨æˆ· â†’ CDN â†’ Nginx â†’ ç½‘å…³ â†’ ç§’æ€æœåŠ¡ â†’ Redis/MySQL
                              â†“
                           æ¶ˆæ¯é˜Ÿåˆ—
                              â†“
                          è®¢å•æœåŠ¡
```

### æŠ€æœ¯æ¶æ„
- **æ¥å…¥å±‚**: CDN + Nginx
- **ç½‘å…³å±‚**: Spring Cloud Gateway
- **æœåŠ¡å±‚**: Spring Bootå¾®æœåŠ¡
- **ç¼“å­˜å±‚**: Redisé›†ç¾¤
- **æ•°æ®å±‚**: MySQLä¸»ä» + åˆ†åº“åˆ†è¡¨
- **æ¶ˆæ¯å±‚**: RabbitMQ/Kafka

## ğŸ”§ æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | ç‰ˆæœ¬ |
|------|------|------|
| å¼€å‘æ¡†æ¶ | Spring Boot | 3.2.x |
| ç¼“å­˜ | Redis | 7.2.x |
| æ•°æ®åº“ | MySQL | 8.0.x |
| æ¶ˆæ¯é˜Ÿåˆ— | RabbitMQ | 3.12.x |
| åˆ†å¸ƒå¼é” | Redisson | 3.25.x |
| é™æµ | Sentinel | 1.8.x |

## ğŸ”¥ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç§’æ€å•†å“é¢„çƒ­

```java
/**
 * ç§’æ€å•†å“é¢„çƒ­æœåŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class SeckillWarmUpService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private SeckillProductMapper seckillProductMapper;
    
    /**
     * é¢„çƒ­ç§’æ€å•†å“åˆ°Redis
     */
    @Scheduled(cron = "0 0 0 * * ?") // æ¯å¤©å‡Œæ™¨æ‰§è¡Œ
    public void warmUpSeckillProducts() {
        log.info("å¼€å§‹é¢„çƒ­ç§’æ€å•†å“");
        
        // 1. æŸ¥è¯¢ä»Šå¤©çš„ç§’æ€å•†å“
        LocalDate today = LocalDate.now();
        List<SeckillProduct> products = seckillProductMapper
            .selectBySeckillDate(today);
        
        for (SeckillProduct product : products) {
            // 2. å•†å“ä¿¡æ¯å­˜å…¥Redis
            String productKey = "seckill:product:" + product.getId();
            redisTemplate.opsForValue().set(
                productKey,
                product,
                24,
                TimeUnit.HOURS
            );
            
            // 3. åº“å­˜å­˜å…¥Redis
            String stockKey = "seckill:stock:" + product.getId();
            redisTemplate.opsForValue().set(
                stockKey,
                product.getStock(),
                24,
                TimeUnit.HOURS
            );
            
            // 4. ç§’æ€æ—¶é—´å­˜å…¥Redis
            String timeKey = "seckill:time:" + product.getId();
            Map<String, Long> timeMap = new HashMap<>();
            timeMap.put("startTime", product.getStartTime().getTime());
            timeMap.put("endTime", product.getEndTime().getTime());
            redisTemplate.opsForHash().putAll(timeKey, timeMap);
            redisTemplate.expire(timeKey, 24, TimeUnit.HOURS);
            
            log.info("é¢„çƒ­å•†å“: id={}, name={}, stock={}", 
                product.getId(), product.getName(), product.getStock());
        }
        
        log.info("é¢„çƒ­å®Œæˆï¼Œå…±{}ä¸ªå•†å“", products.size());
    }
}
```

### 2. ç§’æ€æ¥å£å®ç°

```java
/**
 * ç§’æ€æ§åˆ¶å™¨
 * @author erik.zhou
 */
@RestController
@RequestMapping("/api/seckill")
@Slf4j
public class SeckillController {
    
    @Autowired
    private SeckillService seckillService;
    
    /**
     * ç§’æ€æ¥å£
     */
    @PostMapping("/kill/{productId}")
    @RateLimit(key = "seckill", limit = 10000, window = 1)
    public Result<String> seckill(
            @PathVariable Long productId,
            @RequestHeader("User-Id") Long userId) {
        
        try {
            String orderNo = seckillService.doSeckill(userId, productId);
            return Result.success(orderNo);
        } catch (SeckillException e) {
            return Result.fail(e.getMessage());
        }
    }
    
    /**
     * æŸ¥è¯¢ç§’æ€ç»“æœ
     */
    @GetMapping("/result/{orderNo}")
    public Result<SeckillOrder> getResult(@PathVariable String orderNo) {
        SeckillOrder order = seckillService.getOrderByNo(orderNo);
        return Result.success(order);
    }
}

/**
 * ç§’æ€æœåŠ¡å®ç°
 * @author erik.zhou
 */
@Service
@Slf4j
public class SeckillServiceImpl implements SeckillService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    @Override
    public String doSeckill(Long userId, Long productId) {
        // 1. å‚æ•°æ ¡éªŒ
        if (userId == null || productId == null) {
            throw new SeckillException("å‚æ•°é”™è¯¯");
        }
        
        // 2. æ£€æŸ¥ç§’æ€æ—¶é—´
        if (!checkSeckillTime(productId)) {
            throw new SeckillException("ä¸åœ¨ç§’æ€æ—¶é—´å†…");
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç§’æ€è¿‡
        String userKey = "seckill:user:" + productId;
        Boolean added = redisTemplate.opsForSet().add(userKey, userId);
        if (Boolean.FALSE.equals(added)) {
            throw new SeckillException("æ‚¨å·²ç»å‚ä¸è¿‡è¯¥å•†å“çš„ç§’æ€");
        }
        
        // 4. æ‰£å‡åº“å­˜ï¼ˆLuaè„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
        boolean stockSuccess = deductStock(productId);
        if (!stockSuccess) {
            // å›æ»šç”¨æˆ·ç§’æ€è®°å½•
            redisTemplate.opsForSet().remove(userKey, userId);
            throw new SeckillException("å•†å“å·²å”®ç½„");
        }
        
        // 5. ç”Ÿæˆè®¢å•å·
        String orderNo = generateOrderNo(userId, productId);
        
        // 6. å‘é€MQæ¶ˆæ¯ï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillMessage message = SeckillMessage.builder()
            .userId(userId)
            .productId(productId)
            .orderNo(orderNo)
            .timestamp(System.currentTimeMillis())
            .build();
        
        rabbitTemplate.convertAndSend(
            "seckill.exchange",
            "seckill.order",
            message
        );
        
        log.info("ç§’æ€æˆåŠŸ: userId={}, productId={}, orderNo={}", 
            userId, productId, orderNo);
        
        return orderNo;
    }
    
    /**
     * ä½¿ç”¨Luaè„šæœ¬æ‰£å‡åº“å­˜
     */
    private boolean deductStock(Long productId) {
        String script = 
            "local stock = redis.call('get', KEYS[1])\n" +
            "if stock and tonumber(stock) > 0 then\n" +
            "    redis.call('decr', KEYS[1])\n" +
            "    return 1\n" +
            "else\n" +
            "    return 0\n" +
            "end";
        
        DefaultRedisScript<Long> redisScript = 
            new DefaultRedisScript<>(script, Long.class);
        
        Long result = redisTemplate.execute(
            redisScript,
            Collections.singletonList("seckill:stock:" + productId)
        );
        
        return result != null && result == 1;
    }
    
    /**
     * æ£€æŸ¥ç§’æ€æ—¶é—´
     */
    private boolean checkSeckillTime(Long productId) {
        String timeKey = "seckill:time:" + productId;
        Long startTime = (Long) redisTemplate.opsForHash()
            .get(timeKey, "startTime");
        Long endTime = (Long) redisTemplate.opsForHash()
            .get(timeKey, "endTime");
        
        if (startTime == null || endTime == null) {
            return false;
        }
        
        long now = System.currentTimeMillis();
        return now >= startTime && now <= endTime;
    }
    
    /**
     * ç”Ÿæˆè®¢å•å·
     */
    private String generateOrderNo(Long userId, Long productId) {
        return String.format("SK%d_%d_%d", 
            productId, userId, System.currentTimeMillis());
    }
}
```

### 3. è®¢å•å¼‚æ­¥å¤„ç†

```java
/**
 * ç§’æ€è®¢å•æ¶ˆè´¹è€…
 * @author erik.zhou
 */
@Component
@Slf4j
public class SeckillOrderConsumer {
    
    @Autowired
    private SeckillOrderService orderService;
    
    @Autowired
    private ProductService productService;
    
    @RabbitListener(queues = "seckill.order.queue")
    public void handleSeckillOrder(SeckillMessage message) {
        log.info("æ”¶åˆ°ç§’æ€è®¢å•æ¶ˆæ¯: {}", message);
        
        try {
            // 1. åˆ›å»ºè®¢å•
            SeckillOrder order = createOrder(message);
            
            // 2. æ‰£å‡æ•°æ®åº“åº“å­˜
            boolean success = productService.deductStock(
                message.getProductId(), 1
            );
            
            if (!success) {
                // åº“å­˜æ‰£å‡å¤±è´¥ï¼Œå–æ¶ˆè®¢å•
                order.setStatus(OrderStatus.CANCELLED);
                orderService.updateOrder(order);
                
                // å›æ»šRedisåº“å­˜
                rollbackStock(message.getProductId());
                
                log.error("åº“å­˜æ‰£å‡å¤±è´¥: {}", message);
                return;
            }
            
            // 3. æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(OrderStatus.SUCCESS);
            orderService.updateOrder(order);
            
            // 4. å‘é€é€šçŸ¥
            sendNotification(message.getUserId(), order);
            
            log.info("è®¢å•å¤„ç†æˆåŠŸ: {}", order.getOrderNo());
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¤±è´¥: {}", message, e);
            // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
            throw new AmqpRejectAndDontRequeueException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    
    private SeckillOrder createOrder(SeckillMessage message) {
        SeckillOrder order = new SeckillOrder();
        order.setOrderNo(message.getOrderNo());
        order.setUserId(message.getUserId());
        order.setProductId(message.getProductId());
        order.setStatus(OrderStatus.PENDING);
        order.setCreateTime(new Date());
        
        return orderService.saveOrder(order);
    }
    
    private void rollbackStock(Long productId) {
        String stockKey = "seckill:stock:" + productId;
        redisTemplate.opsForValue().increment(stockKey);
    }
    
    private void sendNotification(Long userId, SeckillOrder order) {
        // å‘é€é€šçŸ¥é€»è¾‘
    }
}
```

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 4.1 é¡µé¢é™æ€åŒ–

```java
/**
 * ç§’æ€é¡µé¢é™æ€åŒ–
 * @author erik.zhou
 */
@Service
public class PageStaticService {
    
    @Autowired
    private TemplateEngine templateEngine;
    
    /**
     * ç”Ÿæˆé™æ€HTMLé¡µé¢
     */
    public void generateStaticPage(Long productId) {
        // 1. æŸ¥è¯¢å•†å“ä¿¡æ¯
        SeckillProduct product = getProduct(productId);
        
        // 2. å‡†å¤‡æ¨¡æ¿æ•°æ®
        Context context = new Context();
        context.setVariable("product", product);
        
        // 3. æ¸²æŸ“æ¨¡æ¿
        String html = templateEngine.process("seckill", context);
        
        // 4. ä¿å­˜åˆ°æ–‡ä»¶æˆ–CDN
        saveToFile(productId, html);
    }
    
    private void saveToFile(Long productId, String html) {
        String fileName = "seckill_" + productId + ".html";
        Path path = Paths.get("/static/seckill/", fileName);
        
        try {
            Files.write(path, html.getBytes(StandardCharsets.UTF_8));
        } catch (IOException e) {
            log.error("ä¿å­˜é™æ€é¡µé¢å¤±è´¥", e);
        }
    }
}
```

### 4.2 æ¥å£é˜²åˆ·

```java
/**
 * æ¥å£é˜²åˆ·æ‹¦æˆªå™¨
 * @author erik.zhou
 */
@Component
public class AntiSpamInterceptor implements HandlerInterceptor {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                            HttpServletResponse response, 
                            Object handler) throws Exception {
        
        String userId = request.getHeader("User-Id");
        if (userId == null) {
            return true;
        }
        
        // 1. æ£€æŸ¥è®¿é—®é¢‘ç‡ï¼ˆ1ç§’å†…æœ€å¤š5æ¬¡ï¼‰
        String key = "anti_spam:" + userId;
        Long count = redisTemplate.opsForValue().increment(key);
        
        if (count == 1) {
            redisTemplate.expire(key, 1, TimeUnit.SECONDS);
        }
        
        if (count > 5) {
            response.setStatus(429);
            response.getWriter().write("è¯·æ±‚è¿‡äºé¢‘ç¹");
            return false;
        }
        
        // 2. æ£€æŸ¥éªŒè¯ç 
        String captcha = request.getHeader("Captcha");
        if (!verifyCaptcha(userId, captcha)) {
            response.setStatus(400);
            response.getWriter().write("éªŒè¯ç é”™è¯¯");
            return false;
        }
        
        return true;
    }
    
    private boolean verifyCaptcha(String userId, String captcha) {
        String key = "captcha:" + userId;
        String stored = (String) redisTemplate.opsForValue().get(key);
        
        if (stored != null && stored.equals(captcha)) {
            redisTemplate.delete(key);
            return true;
        }
        
        return false;
    }
}
```

### 4.3 æ•°æ®åº“ä¼˜åŒ–

```sql
-- ç§’æ€å•†å“è¡¨
CREATE TABLE `seckill_product` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT 'å•†å“åç§°',
  `price` decimal(10,2) NOT NULL COMMENT 'ç§’æ€ä»·æ ¼',
  `stock` int NOT NULL COMMENT 'åº“å­˜',
  `start_time` datetime NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `end_time` datetime NOT NULL COMMENT 'ç»“æŸæ—¶é—´',
  `version` int NOT NULL DEFAULT '0' COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_start_time` (`start_time`),
  KEY `idx_end_time` (`end_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç§’æ€å•†å“è¡¨';

-- ç§’æ€è®¢å•è¡¨ï¼ˆåˆ†è¡¨ï¼‰
CREATE TABLE `seckill_order_0` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `order_no` varchar(50) NOT NULL COMMENT 'è®¢å•å·',
  `user_id` bigint NOT NULL COMMENT 'ç”¨æˆ·ID',
  `product_id` bigint NOT NULL COMMENT 'å•†å“ID',
  `status` tinyint NOT NULL COMMENT 'è®¢å•çŠ¶æ€',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_product_id` (`product_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç§’æ€è®¢å•è¡¨0';
```

```java
/**
 * ä¹è§‚é”æ‰£å‡åº“å­˜
 * @author erik.zhou
 */
@Mapper
public interface SeckillProductMapper {
    
    /**
     * ä½¿ç”¨ä¹è§‚é”æ‰£å‡åº“å­˜
     */
    @Update("UPDATE seckill_product " +
            "SET stock = stock - 1, version = version + 1 " +
            "WHERE id = #{productId} " +
            "AND stock > 0 " +
            "AND version = #{version}")
    int deductStockWithOptimisticLock(
        @Param("productId") Long productId,
        @Param("version") Integer version
    );
}
```

### 4.4 é™æµé…ç½®

```java
/**
 * Sentinelé™æµé…ç½®
 * @author erik.zhou
 */
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initFlowRules() {
        List<FlowRule> rules = new ArrayList<>();
        
        // ç§’æ€æ¥å£é™æµè§„åˆ™
        FlowRule rule1 = new FlowRule();
        rule1.setResource("seckill");
        rule1.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule1.setCount(10000); // QPSé˜ˆå€¼
        rule1.setStrategy(RuleConstant.STRATEGY_DIRECT);
        rule1.setControlBehavior(RuleConstant.CONTROL_BEHAVIOR_DEFAULT);
        rules.add(rule1);
        
        // æŸ¥è¯¢æ¥å£é™æµè§„åˆ™
        FlowRule rule2 = new FlowRule();
        rule2.setResource("query");
        rule2.setGrade(RuleConstant.FLOW_GRADE_QPS);
        rule2.setCount(50000);
        rules.add(rule2);
        
        FlowRuleManager.loadRules(rules);
    }
    
    @PostConstruct
    public void initDegradeRules() {
        List<DegradeRule> rules = new ArrayList<>();
        
        // ç†”æ–­é™çº§è§„åˆ™
        DegradeRule rule = new DegradeRule();
        rule.setResource("seckill");
        rule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_RATIO);
        rule.setCount(0.5); // å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼
        rule.setTimeWindow(10); // ç†”æ–­æ—¶é•¿ï¼ˆç§’ï¼‰
        rule.setMinRequestAmount(5); // æœ€å°è¯·æ±‚æ•°
        rules.add(rule);
        
        DegradeRuleManager.loadRules(rules);
    }
}
```

## ğŸ“Š å‹åŠ›æµ‹è¯•

### 5.1 JMeteræµ‹è¯•è„šæœ¬

```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan>
      <stringProp name="TestPlan.comments">ç§’æ€ç³»ç»Ÿå‹åŠ›æµ‹è¯•</stringProp>
      <boolProp name="TestPlan.functional_mode">false</boolProp>
      <boolProp name="TestPlan.serialize_threadgroups">false</boolProp>
    </TestPlan>
    <hashTree>
      <!-- çº¿ç¨‹ç»„é…ç½® -->
      <ThreadGroup>
        <stringProp name="ThreadGroup.num_threads">10000</stringProp>
        <stringProp name="ThreadGroup.ramp_time">10</stringProp>
        <stringProp name="ThreadGroup.duration">60</stringProp>
      </ThreadGroup>
      <hashTree>
        <!-- HTTPè¯·æ±‚ -->
        <HTTPSamplerProxy>
          <stringProp name="HTTPSampler.domain">localhost</stringProp>
          <stringProp name="HTTPSampler.port">8080</stringProp>
          <stringProp name="HTTPSampler.path">/api/seckill/kill/1</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
        </HTTPSamplerProxy>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

### 5.2 å‹æµ‹ç»“æœåˆ†æ

```java
/**
 * å‹æµ‹ç»“æœç»Ÿè®¡
 * @author erik.zhou
 */
@Component
@Slf4j
public class PerformanceMonitor {
    
    private final AtomicLong totalRequests = new AtomicLong(0);
    private final AtomicLong successRequests = new AtomicLong(0);
    private final AtomicLong failedRequests = new AtomicLong(0);
    private final ConcurrentHashMap<String, Long> responseTimes = new ConcurrentHashMap<>();
    
    /**
     * è®°å½•è¯·æ±‚
     */
    public void recordRequest(boolean success, long responseTime) {
        totalRequests.incrementAndGet();
        
        if (success) {
            successRequests.incrementAndGet();
        } else {
            failedRequests.incrementAndGet();
        }
        
        responseTimes.put(
            Thread.currentThread().getName(),
            responseTime
        );
    }
    
    /**
     * æ‰“å°ç»Ÿè®¡ä¿¡æ¯
     */
    @Scheduled(fixedRate = 5000)
    public void printStatistics() {
        long total = totalRequests.get();
        long success = successRequests.get();
        long failed = failedRequests.get();
        
        double successRate = total > 0 ? (double) success / total * 100 : 0;
        
        List<Long> times = new ArrayList<>(responseTimes.values());
        times.sort(Long::compareTo);
        
        long avgTime = times.stream()
            .mapToLong(Long::longValue)
            .sum() / Math.max(times.size(), 1);
        
        long p95Time = times.isEmpty() ? 0 : 
            times.get((int) (times.size() * 0.95));
        
        long p99Time = times.isEmpty() ? 0 : 
            times.get((int) (times.size() * 0.99));
        
        log.info("=== æ€§èƒ½ç»Ÿè®¡ ===");
        log.info("æ€»è¯·æ±‚æ•°: {}", total);
        log.info("æˆåŠŸæ•°: {}", success);
        log.info("å¤±è´¥æ•°: {}", failed);
        log.info("æˆåŠŸç‡: {:.2f}%", successRate);
        log.info("å¹³å‡å“åº”æ—¶é—´: {}ms", avgTime);
        log.info("P95å“åº”æ—¶é—´: {}ms", p95Time);
        log.info("P99å“åº”æ—¶é—´: {}ms", p99Time);
        log.info("QPS: {}", total / 5);
        
        // é‡ç½®è®¡æ•°å™¨
        totalRequests.set(0);
        successRequests.set(0);
        failedRequests.set(0);
        responseTimes.clear();
    }
}
```

### 5.3 æ€§èƒ½æŒ‡æ ‡

**æµ‹è¯•ç¯å¢ƒ**:
- æœåŠ¡å™¨: 4æ ¸8G * 3å°
- Redis: ä¸»ä» + å“¨å…µ
- MySQL: ä¸»ä» + è¯»å†™åˆ†ç¦»
- RabbitMQ: é›†ç¾¤

**æµ‹è¯•ç»“æœ**:
- QPS: 10ä¸‡+
- å¹³å‡å“åº”æ—¶é—´: 50ms
- P95å“åº”æ—¶é—´: 80ms
- P99å“åº”æ—¶é—´: 120ms
- æˆåŠŸç‡: 99.9%
- CPUä½¿ç”¨ç‡: 70%
- å†…å­˜ä½¿ç”¨ç‡: 60%

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### 6.1 Dockeréƒ¨ç½²

```dockerfile
# Dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/seckill-system.jar app.jar

EXPOSE 8080

ENV JAVA_OPTS="-Xms2g -Xmx2g -XX:+UseG1GC"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
```

```yaml
# docker-compose.yml
version: '3.8'

services:
  seckill-app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - REDIS_HOST=redis
      - MYSQL_HOST=mysql
      - RABBITMQ_HOST=rabbitmq
    depends_on:
      - redis
      - mysql
      - rabbitmq
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '2'
          memory: 4G
  
  redis:
    image: redis:7.2
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
  
  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root123
      - MYSQL_DATABASE=seckill
    volumes:
      - mysql-data:/var/lib/mysql
  
  rabbitmq:
    image: rabbitmq:3.12-management
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq

volumes:
  redis-data:
  mysql-data:
  rabbitmq-data:
```

### 6.2 Kuberneteséƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: seckill-app
spec:
  replicas: 5
  selector:
    matchLabels:
      app: seckill
  template:
    metadata:
      labels:
        app: seckill
    spec:
      containers:
      - name: seckill
        image: seckill-system:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            memory: "2Gi"
            cpu: "1"
          limits:
            memory: "4Gi"
            cpu: "2"
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: seckill-service
spec:
  selector:
    app: seckill
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8080
  type: LoadBalancer
```

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒä¼˜åŒ–ç‚¹
1. **ç¼“å­˜é¢„çƒ­**: æå‰å°†å•†å“ä¿¡æ¯å’Œåº“å­˜åŠ è½½åˆ°Redis
2. **é™æµä¿æŠ¤**: å¤šå±‚é™æµï¼Œä¿æŠ¤ç³»ç»Ÿä¸è¢«æ‰“å®
3. **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥åˆ›å»ºè®¢å•
4. **åº“å­˜æ‰£å‡**: ä½¿ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§
5. **é˜²æ­¢è¶…å–**: Redisé¢„æ‰£åº“å­˜ + æ•°æ®åº“ä¹è§‚é”
6. **é¡µé¢é™æ€åŒ–**: å‡å°‘æœåŠ¡å™¨å‹åŠ›
7. **æ¥å£é˜²åˆ·**: éªŒè¯ç  + é¢‘ç‡é™åˆ¶

### æŠ€æœ¯äº®ç‚¹
- æ”¯æŒ10ä¸‡+QPS
- å“åº”æ—¶é—´<100ms
- åº“å­˜ä¸è¶…å–
- é«˜å¯ç”¨æ¶æ„
- å®Œå–„çš„ç›‘æ§å‘Šè­¦

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

# æ”¯ä»˜ç³»ç»Ÿ å®Œæ•´å®æˆ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ä¸šåŠ¡åœºæ™¯
æ„å»ºä¸€ä¸ªå®‰å…¨å¯é çš„æ”¯ä»˜ç³»ç»Ÿï¼Œæ”¯æŒï¼š
- å¤šç§æ”¯ä»˜æ–¹å¼ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è¡Œå¡ï¼‰
- è®¢å•æ”¯ä»˜
- é€€æ¬¾å¤„ç†
- å¯¹è´¦ç³»ç»Ÿ
- èµ„é‡‘æ¸…ç®—

### æŠ€æœ¯æŒ‘æˆ˜ âš ï¸

#### éš¾ç‚¹1: åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
**é—®é¢˜æè¿°**:
- æ”¯ä»˜æˆåŠŸä½†è®¢å•çŠ¶æ€æœªæ›´æ–°
- æ‰£æ¬¾æˆåŠŸä½†ç§¯åˆ†æœªå¢åŠ 
- é€€æ¬¾æˆåŠŸä½†åº“å­˜æœªå›æ»š
- å¦‚ä½•ä¿è¯èµ„é‡‘å®‰å…¨ï¼Ÿ

**ä¸šåŠ¡å½±å“**:
- ç”¨æˆ·é‡å¤æ”¯ä»˜
- èµ„é‡‘æŸå¤±
- è´¢åŠ¡å¯¹è´¦å›°éš¾
- ç”¨æˆ·æŠ•è¯‰

#### éš¾ç‚¹2: å¹‚ç­‰æ€§ä¿è¯
**é—®é¢˜æè¿°**:
- ç”¨æˆ·é‡å¤ç‚¹å‡»æ”¯ä»˜æŒ‰é’®
- ç½‘ç»œè¶…æ—¶å¯¼è‡´é‡å¤è¯·æ±‚
- ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒé‡å¤
- å¦‚ä½•é˜²æ­¢é‡å¤æ‰£æ¬¾ï¼Ÿ

**ä¸šåŠ¡å½±å“**:
- ç”¨æˆ·è¢«é‡å¤æ‰£æ¬¾
- è®¢å•çŠ¶æ€æ··ä¹±
- è´¢åŠ¡æ•°æ®ä¸å‡†ç¡®

#### éš¾ç‚¹3: å¯¹è´¦ç³»ç»Ÿ
**é—®é¢˜æè¿°**:
- å¦‚ä½•ä¸ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°å¯¹è´¦ï¼Ÿ
- å¦‚ä½•å¤„ç†é•¿è´¦å’ŒçŸ­è´¦ï¼Ÿ
- å¦‚ä½•ä¿è¯å¯¹è´¦çš„å‡†ç¡®æ€§ï¼Ÿ
- å¯¹è´¦å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ

**ä¸šåŠ¡å½±å“**:
- èµ„é‡‘æŸå¤±
- è´¢åŠ¡é£é™©
- ç›‘ç®¡é—®é¢˜

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„
```
ç”¨æˆ· â†’ APIç½‘å…³ â†’ æ”¯ä»˜æœåŠ¡ â†’ ç¬¬ä¸‰æ–¹æ”¯ä»˜
                    â†“
              [è®¢å•æœåŠ¡ã€è´¦æˆ·æœåŠ¡]
                    â†“
                 MySQL + Redis
                    â†“
                 å¯¹è´¦æœåŠ¡
```

### æŠ€æœ¯é€‰å‹
- **æ¡†æ¶**: Spring Boot 3.2.x
- **æ•°æ®åº“**: MySQL 8.0ï¼ˆåˆ†åº“åˆ†è¡¨ï¼‰
- **ç¼“å­˜**: Redis 7.2
- **æ¶ˆæ¯é˜Ÿåˆ—**: RocketMQ
- **åˆ†å¸ƒå¼äº‹åŠ¡**: Seata
- **å®šæ—¶ä»»åŠ¡**: XXL-Job

## ğŸ”¥ æ ¸å¿ƒå®ç°

### 1. æ”¯ä»˜æ¥å£è®¾è®¡

```java
/**
 * æ”¯ä»˜æœåŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class PaymentService {
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    @Autowired
    private WeChatPayService weChatPayService;
    
    @Autowired
    private AlipayService alipayService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    /**
     * åˆ›å»ºæ”¯ä»˜è®¢å•
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. å¹‚ç­‰æ€§ä¿è¯ï¼ˆä½¿ç”¨Redisåˆ†å¸ƒå¼é”ï¼‰
     * 2. è®¢å•å·å…¨å±€å”¯ä¸€
     * 3. æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å…³é—­
     */
    @Transactional(rollbackFor = Exception.class)
    public PaymentResult createPayment(PaymentRequest request) {
        log.info("åˆ›å»ºæ”¯ä»˜è®¢å•: {}", request);
        
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥
        String idempotentKey = "payment:idempotent:" + request.getBusinessOrderNo();
        Boolean locked = redisTemplate.opsForValue()
            .setIfAbsent(idempotentKey, "1", 5, TimeUnit.MINUTES);
        
        if (Boolean.FALSE.equals(locked)) {
            // æŸ¥è¯¢å·²å­˜åœ¨çš„æ”¯ä»˜è®¢å•
            PaymentOrder existOrder = paymentOrderMapper
                .selectByBusinessOrderNo(request.getBusinessOrderNo());
            
            if (existOrder != null) {
                log.info("æ”¯ä»˜è®¢å•å·²å­˜åœ¨: paymentNo={}", existOrder.getPaymentNo());
                return buildResult(existOrder);
            }
        }
        
        try {
            // 2. å‚æ•°æ ¡éªŒ
            validateRequest(request);
            
            // 3. ç”Ÿæˆæ”¯ä»˜è®¢å•å·
            String paymentNo = generatePaymentNo();
            
            // 4. åˆ›å»ºæ”¯ä»˜è®¢å•
            PaymentOrder order = buildPaymentOrder(request, paymentNo);
            paymentOrderMapper.insert(order);
            
            // 5. è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
            ThirdPartyPayResult payResult = callThirdPartyPay(order);
            
            // 6. æ›´æ–°è®¢å•çŠ¶æ€
            order.setThirdPartyOrderNo(payResult.getOrderNo());
            order.setStatus(PaymentStatus.PAYING);
            paymentOrderMapper.updateById(order);
            
            // 7. è®¾ç½®æ”¯ä»˜è¶…æ—¶ï¼ˆ30åˆ†é’Ÿï¼‰
            schedulePaymentTimeout(paymentNo);
            
            log.info("æ”¯ä»˜è®¢å•åˆ›å»ºæˆåŠŸ: paymentNo={}", paymentNo);
            
            return PaymentResult.builder()
                .paymentNo(paymentNo)
                .payUrl(payResult.getPayUrl())
                .qrCode(payResult.getQrCode())
                .build();
            
        } finally {
            // é‡Šæ”¾é”
            redisTemplate.delete(idempotentKey);
        }
    }
    
    /**
     * å¤„ç†æ”¯ä»˜å›è°ƒ
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. éªŒè¯ç­¾åé˜²æ­¢ä¼ªé€ 
     * 2. å¹‚ç­‰æ€§å¤„ç†é˜²æ­¢é‡å¤å›è°ƒ
     * 3. å¼‚æ­¥é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
     * 4. è®°å½•å›è°ƒæ—¥å¿—ä¾¿äºæ’æŸ¥
     */
    @Transactional(rollbackFor = Exception.class)
    public String handlePaymentCallback(PaymentCallback callback) {
        log.info("æ”¶åˆ°æ”¯ä»˜å›è°ƒ: {}", callback);
        
        try {
            // 1. éªŒè¯ç­¾å
            if (!verifySign(callback)) {
                log.error("ç­¾åéªŒè¯å¤±è´¥: {}", callback);
                return "FAIL";
            }
            
            // 2. æŸ¥è¯¢æ”¯ä»˜è®¢å•
            PaymentOrder order = paymentOrderMapper
                .selectByThirdPartyOrderNo(callback.getOrderNo());
            
            if (order == null) {
                log.error("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨: orderNo={}", callback.getOrderNo());
                return "FAIL";
            }
            
            // 3. å¹‚ç­‰æ€§æ£€æŸ¥
            if (PaymentStatus.SUCCESS.equals(order.getStatus())) {
                log.info("è®¢å•å·²æ”¯ä»˜æˆåŠŸï¼Œè·³è¿‡: paymentNo={}", order.getPaymentNo());
                return "SUCCESS";
            }
            
            // 4. ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘
            String lockKey = "payment:callback:" + order.getPaymentNo();
            RLock lock = redissonClient.getLock(lockKey);
            
            try {
                if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                    // å†æ¬¡æ£€æŸ¥çŠ¶æ€
                    order = paymentOrderMapper.selectById(order.getId());
                    if (PaymentStatus.SUCCESS.equals(order.getStatus())) {
                        return "SUCCESS";
                    }
                    
                    // 5. æ›´æ–°è®¢å•çŠ¶æ€
                    order.setStatus(PaymentStatus.SUCCESS);
                    order.setPayTime(new Date());
                    order.setThirdPartyPayTime(callback.getPayTime());
                    order.setUpdateTime(new Date());
                    
                    int updated = paymentOrderMapper.updateById(order);
                    if (updated == 0) {
                        log.error("æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: paymentNo={}", order.getPaymentNo());
                        return "FAIL";
                    }
                    
                    // 6. è®°å½•å›è°ƒæ—¥å¿—
                    saveCallbackLog(order, callback);
                    
                    // 7. å¼‚æ­¥é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
                    notifyBusiness(order);
                    
                    log.info("æ”¯ä»˜å›è°ƒå¤„ç†æˆåŠŸ: paymentNo={}", order.getPaymentNo());
                    return "SUCCESS";
                }
            } finally {
                if (lock.isHeldByCurrentThread()) {
                    lock.unlock();
                }
            }
            
            return "FAIL";
            
        } catch (Exception e) {
            log.error("å¤„ç†æ”¯ä»˜å›è°ƒå¤±è´¥", e);
            return "FAIL";
        }
    }
    
    /**
     * ç”Ÿæˆæ”¯ä»˜è®¢å•å·
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. å…¨å±€å”¯ä¸€
     * 2. æœ‰åºé€’å¢
     * 3. åŒ…å«ä¸šåŠ¡ä¿¡æ¯
     */
    private String generatePaymentNo() {
        // æ ¼å¼: PAY + æ—¥æœŸ + é›ªèŠ±ID
        String date = new SimpleDateFormat("yyyyMMdd").format(new Date());
        long snowflakeId = snowflakeIdGenerator.nextId();
        return "PAY" + date + snowflakeId;
    }
    
    /**
     * è°ƒç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜
     */
    private ThirdPartyPayResult callThirdPartyPay(PaymentOrder order) {
        switch (order.getPayChannel()) {
            case WECHAT:
                return weChatPayService.createOrder(order);
            case ALIPAY:
                return alipayService.createOrder(order);
            default:
                throw new BusinessException("ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼");
        }
    }
    
    /**
     * å¼‚æ­¥é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
     */
    private void notifyBusiness(PaymentOrder order) {
        PaymentNotifyMessage message = PaymentNotifyMessage.builder()
            .paymentNo(order.getPaymentNo())
            .businessOrderNo(order.getBusinessOrderNo())
            .amount(order.getAmount())
            .status(order.getStatus())
            .build();
        
        rocketMQTemplate.sendOneWay(
            "payment-notify-topic",
            message
        );
    }
}
```

### 2. é€€æ¬¾å¤„ç†

```java
/**
 * é€€æ¬¾æœåŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class RefundService {
    
    @Autowired
    private RefundOrderMapper refundOrderMapper;
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    @Autowired
    private WeChatPayService weChatPayService;
    
    @Autowired
    private AlipayService alipayService;
    
    /**
     * åˆ›å»ºé€€æ¬¾è®¢å•
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. æ ¡éªŒé€€æ¬¾é‡‘é¢ä¸è¶…è¿‡æ”¯ä»˜é‡‘é¢
     * 2. æ”¯æŒéƒ¨åˆ†é€€æ¬¾
     * 3. é˜²æ­¢é‡å¤é€€æ¬¾
     * 4. é€€æ¬¾å¤±è´¥è‡ªåŠ¨é‡è¯•
     */
    @Transactional(rollbackFor = Exception.class)
    public RefundResult createRefund(RefundRequest request) {
        log.info("åˆ›å»ºé€€æ¬¾è®¢å•: {}", request);
        
        // 1. æŸ¥è¯¢æ”¯ä»˜è®¢å•
        PaymentOrder paymentOrder = paymentOrderMapper
            .selectByPaymentNo(request.getPaymentNo());
        
        if (paymentOrder == null) {
            throw new BusinessException("æ”¯ä»˜è®¢å•ä¸å­˜åœ¨");
        }
        
        if (!PaymentStatus.SUCCESS.equals(paymentOrder.getStatus())) {
            throw new BusinessException("æ”¯ä»˜è®¢å•çŠ¶æ€ä¸æ­£ç¡®");
        }
        
        // 2. æ ¡éªŒé€€æ¬¾é‡‘é¢
        BigDecimal refundedAmount = getRefundedAmount(request.getPaymentNo());
        BigDecimal totalRefundAmount = refundedAmount.add(request.getRefundAmount());
        
        if (totalRefundAmount.compareTo(paymentOrder.getAmount()) > 0) {
            throw new BusinessException("é€€æ¬¾é‡‘é¢è¶…è¿‡æ”¯ä»˜é‡‘é¢");
        }
        
        // 3. å¹‚ç­‰æ€§æ£€æŸ¥
        RefundOrder existOrder = refundOrderMapper
            .selectByBusinessRefundNo(request.getBusinessRefundNo());
        
        if (existOrder != null) {
            log.info("é€€æ¬¾è®¢å•å·²å­˜åœ¨: refundNo={}", existOrder.getRefundNo());
            return buildRefundResult(existOrder);
        }
        
        // 4. ç”Ÿæˆé€€æ¬¾è®¢å•å·
        String refundNo = generateRefundNo();
        
        // 5. åˆ›å»ºé€€æ¬¾è®¢å•
        RefundOrder refundOrder = buildRefundOrder(request, refundNo, paymentOrder);
        refundOrderMapper.insert(refundOrder);
        
        // 6. è°ƒç”¨ç¬¬ä¸‰æ–¹é€€æ¬¾
        try {
            ThirdPartyRefundResult result = callThirdPartyRefund(refundOrder, paymentOrder);
            
            // 7. æ›´æ–°é€€æ¬¾çŠ¶æ€
            refundOrder.setThirdPartyRefundNo(result.getRefundNo());
            refundOrder.setStatus(RefundStatus.SUCCESS);
            refundOrder.setRefundTime(new Date());
            refundOrderMapper.updateById(refundOrder);
            
            // 8. å¼‚æ­¥é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
            notifyBusinessRefund(refundOrder);
            
            log.info("é€€æ¬¾æˆåŠŸ: refundNo={}", refundNo);
            
            return RefundResult.success(refundNo);
            
        } catch (Exception e) {
            log.error("é€€æ¬¾å¤±è´¥: refundNo={}", refundNo, e);
            
            // æ›´æ–°ä¸ºé€€æ¬¾å¤±è´¥
            refundOrder.setStatus(RefundStatus.FAILED);
            refundOrder.setErrorMsg(e.getMessage());
            refundOrderMapper.updateById(refundOrder);
            
            // åŠ å…¥é‡è¯•é˜Ÿåˆ—
            addToRetryQueue(refundOrder);
            
            throw new BusinessException("é€€æ¬¾å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * é€€æ¬¾é‡è¯•
     */
    @Scheduled(fixedDelay = 60000) // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void retryFailedRefunds() {
        // æŸ¥è¯¢å¤±è´¥çš„é€€æ¬¾è®¢å•
        List<RefundOrder> failedOrders = refundOrderMapper
            .selectFailedOrders(100);
        
        for (RefundOrder order : failedOrders) {
            // æ£€æŸ¥é‡è¯•æ¬¡æ•°
            if (order.getRetryCount() >= 5) {
                log.error("é€€æ¬¾é‡è¯•æ¬¡æ•°è¶…é™: refundNo={}", order.getRefundNo());
                // å‘é€å‘Šè­¦
                sendAlert(order);
                continue;
            }
            
            try {
                // æŸ¥è¯¢æ”¯ä»˜è®¢å•
                PaymentOrder paymentOrder = paymentOrderMapper
                    .selectByPaymentNo(order.getPaymentNo());
                
                // é‡è¯•é€€æ¬¾
                ThirdPartyRefundResult result = callThirdPartyRefund(order, paymentOrder);
                
                // æ›´æ–°çŠ¶æ€
                order.setStatus(RefundStatus.SUCCESS);
                order.setThirdPartyRefundNo(result.getRefundNo());
                order.setRefundTime(new Date());
                order.setRetryCount(order.getRetryCount() + 1);
                refundOrderMapper.updateById(order);
                
                // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
                notifyBusinessRefund(order);
                
                log.info("é€€æ¬¾é‡è¯•æˆåŠŸ: refundNo={}", order.getRefundNo());
                
            } catch (Exception e) {
                log.error("é€€æ¬¾é‡è¯•å¤±è´¥: refundNo={}", order.getRefundNo(), e);
                
                // æ›´æ–°é‡è¯•æ¬¡æ•°
                order.setRetryCount(order.getRetryCount() + 1);
                order.setErrorMsg(e.getMessage());
                refundOrderMapper.updateById(order);
            }
        }
    }
}
```

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04


### 3. å¯¹è´¦ç³»ç»Ÿ

```java
/**
 * å¯¹è´¦æœåŠ¡
 * @author erik.zhou
 * 
 * éš¾ç‚¹è§£å†³ï¼š
 * 1. æ¯æ—¥è‡ªåŠ¨å¯¹è´¦
 * 2. å¤„ç†é•¿è´¦å’ŒçŸ­è´¦
 * 3. å¯¹è´¦å·®å¼‚è‡ªåŠ¨å¤„ç†
 * 4. å¯¹è´¦æŠ¥å‘Šç”Ÿæˆ
 */
@Service
@Slf4j
public class ReconciliationService {
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    @Autowired
    private WeChatPayService weChatPayService;
    
    @Autowired
    private AlipayService alipayService;
    
    @Autowired
    private ReconciliationRecordMapper reconciliationRecordMapper;
    
    /**
     * æ‰§è¡Œå¯¹è´¦
     */
    @Scheduled(cron = "0 0 1 * * ?") // æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œ
    public void reconcile() {
        LocalDate yesterday = LocalDate.now().minusDays(1);
        log.info("å¼€å§‹å¯¹è´¦: date={}", yesterday);
        
        try {
            // 1. å¾®ä¿¡å¯¹è´¦
            reconcileChannel(PayChannel.WECHAT, yesterday);
            
            // 2. æ”¯ä»˜å®å¯¹è´¦
            reconcileChannel(PayChannel.ALIPAY, yesterday);
            
            log.info("å¯¹è´¦å®Œæˆ: date={}", yesterday);
            
        } catch (Exception e) {
            log.error("å¯¹è´¦å¤±è´¥: date={}", yesterday, e);
            // å‘é€å‘Šè­¦
            sendAlert("å¯¹è´¦å¤±è´¥", e.getMessage());
        }
    }
    
    /**
     * å¯¹è´¦å•ä¸ªæ¸ é“
     */
    private void reconcileChannel(PayChannel channel, LocalDate date) {
        log.info("å¼€å§‹å¯¹è´¦: channel={}, date={}", channel, date);
        
        // 1. ä¸‹è½½ç¬¬ä¸‰æ–¹å¯¹è´¦å•
        List<ThirdPartyOrder> thirdPartyOrders = downloadBill(channel, date);
        
        // 2. æŸ¥è¯¢æœ¬åœ°è®¢å•
        List<PaymentOrder> localOrders = paymentOrderMapper
            .selectByChannelAndDate(channel, date);
        
        // 3. å¯¹è´¦
        ReconciliationResult result = doReconcile(localOrders, thirdPartyOrders);
        
        // 4. ä¿å­˜å¯¹è´¦è®°å½•
        saveReconciliationRecord(channel, date, result);
        
        // 5. å¤„ç†å·®å¼‚
        if (result.hasDifference()) {
            handleDifference(result);
        }
        
        log.info("å¯¹è´¦å®Œæˆ: channel={}, date={}, result={}", 
            channel, date, result);
    }
    
    /**
     * æ‰§è¡Œå¯¹è´¦é€»è¾‘
     */
    private ReconciliationResult doReconcile(
            List<PaymentOrder> localOrders,
            List<ThirdPartyOrder> thirdPartyOrders) {
        
        ReconciliationResult result = new ReconciliationResult();
        
        // 1. å°†ç¬¬ä¸‰æ–¹è®¢å•è½¬ä¸ºMap
        Map<String, ThirdPartyOrder> thirdPartyMap = thirdPartyOrders.stream()
            .collect(Collectors.toMap(
                ThirdPartyOrder::getOrderNo,
                Function.identity()
            ));
        
        // 2. éå†æœ¬åœ°è®¢å•
        for (PaymentOrder localOrder : localOrders) {
            String thirdPartyOrderNo = localOrder.getThirdPartyOrderNo();
            ThirdPartyOrder thirdPartyOrder = thirdPartyMap.get(thirdPartyOrderNo);
            
            if (thirdPartyOrder == null) {
                // é•¿è´¦ï¼šæœ¬åœ°æœ‰ï¼Œç¬¬ä¸‰æ–¹æ²¡æœ‰
                result.addLongOrder(localOrder);
                log.warn("å‘ç°é•¿è´¦: paymentNo={}, thirdPartyOrderNo={}", 
                    localOrder.getPaymentNo(), thirdPartyOrderNo);
                continue;
            }
            
            // 3. æ¯”å¯¹é‡‘é¢
            if (!localOrder.getAmount().equals(thirdPartyOrder.getAmount())) {
                // é‡‘é¢ä¸ä¸€è‡´
                result.addAmountDiff(localOrder, thirdPartyOrder);
                log.warn("é‡‘é¢ä¸ä¸€è‡´: paymentNo={}, local={}, third={}", 
                    localOrder.getPaymentNo(), 
                    localOrder.getAmount(), 
                    thirdPartyOrder.getAmount());
                continue;
            }
            
            // 4. æ¯”å¯¹çŠ¶æ€
            if (!matchStatus(localOrder.getStatus(), thirdPartyOrder.getStatus())) {
                // çŠ¶æ€ä¸ä¸€è‡´
                result.addStatusDiff(localOrder, thirdPartyOrder);
                log.warn("çŠ¶æ€ä¸ä¸€è‡´: paymentNo={}, local={}, third={}", 
                    localOrder.getPaymentNo(), 
                    localOrder.getStatus(), 
                    thirdPartyOrder.getStatus());
                continue;
            }
            
            // 5. å¯¹è´¦æˆåŠŸ
            result.addMatchedOrder(localOrder);
            
            // ä»Mapä¸­ç§»é™¤
            thirdPartyMap.remove(thirdPartyOrderNo);
        }
        
        // 6. å‰©ä½™çš„ç¬¬ä¸‰æ–¹è®¢å•ä¸ºçŸ­è´¦
        for (ThirdPartyOrder thirdPartyOrder : thirdPartyMap.values()) {
            result.addShortOrder(thirdPartyOrder);
            log.warn("å‘ç°çŸ­è´¦: thirdPartyOrderNo={}", 
                thirdPartyOrder.getOrderNo());
        }
        
        return result;
    }
    
    /**
     * å¤„ç†å¯¹è´¦å·®å¼‚
     */
    private void handleDifference(ReconciliationResult result) {
        // 1. å¤„ç†é•¿è´¦
        for (PaymentOrder order : result.getLongOrders()) {
            handleLongOrder(order);
        }
        
        // 2. å¤„ç†çŸ­è´¦
        for (ThirdPartyOrder order : result.getShortOrders()) {
            handleShortOrder(order);
        }
        
        // 3. å¤„ç†é‡‘é¢å·®å¼‚
        for (OrderDifference diff : result.getAmountDiffs()) {
            handleAmountDiff(diff);
        }
        
        // 4. å¤„ç†çŠ¶æ€å·®å¼‚
        for (OrderDifference diff : result.getStatusDiffs()) {
            handleStatusDiff(diff);
        }
    }
    
    /**
     * å¤„ç†é•¿è´¦
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. æŸ¥è¯¢ç¬¬ä¸‰æ–¹è®¢å•çŠ¶æ€
     * 2. å¦‚æœç¬¬ä¸‰æ–¹å·²æ”¯ä»˜ï¼Œè¡¥å•
     * 3. å¦‚æœç¬¬ä¸‰æ–¹æœªæ”¯ä»˜ï¼Œå…³é—­è®¢å•
     */
    private void handleLongOrder(PaymentOrder order) {
        log.info("å¤„ç†é•¿è´¦: paymentNo={}", order.getPaymentNo());
        
        try {
            // 1. æŸ¥è¯¢ç¬¬ä¸‰æ–¹è®¢å•çŠ¶æ€
            ThirdPartyOrderStatus status = queryThirdPartyStatus(order);
            
            if (ThirdPartyOrderStatus.SUCCESS.equals(status)) {
                // 2. ç¬¬ä¸‰æ–¹å·²æ”¯ä»˜ï¼Œè¡¥å•
                order.setStatus(PaymentStatus.SUCCESS);
                order.setPayTime(new Date());
                paymentOrderMapper.updateById(order);
                
                // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
                notifyBusiness(order);
                
                log.info("é•¿è´¦è¡¥å•æˆåŠŸ: paymentNo={}", order.getPaymentNo());
                
            } else {
                // 3. ç¬¬ä¸‰æ–¹æœªæ”¯ä»˜ï¼Œå…³é—­è®¢å•
                order.setStatus(PaymentStatus.CLOSED);
                paymentOrderMapper.updateById(order);
                
                log.info("é•¿è´¦å…³é—­è®¢å•: paymentNo={}", order.getPaymentNo());
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†é•¿è´¦å¤±è´¥: paymentNo={}", order.getPaymentNo(), e);
            // å‘é€å‘Šè­¦
            sendAlert("é•¿è´¦å¤„ç†å¤±è´¥", order.getPaymentNo());
        }
    }
    
    /**
     * å¤„ç†çŸ­è´¦
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. æ ¹æ®ç¬¬ä¸‰æ–¹è®¢å•å·æŸ¥è¯¢æœ¬åœ°è®¢å•
     * 2. å¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¥å•
     * 3. å¦‚æœæœ¬åœ°å­˜åœ¨ä½†çŠ¶æ€ä¸å¯¹ï¼Œæ›´æ–°çŠ¶æ€
     */
    private void handleShortOrder(ThirdPartyOrder thirdPartyOrder) {
        log.info("å¤„ç†çŸ­è´¦: thirdPartyOrderNo={}", thirdPartyOrder.getOrderNo());
        
        try {
            // 1. æŸ¥è¯¢æœ¬åœ°è®¢å•
            PaymentOrder localOrder = paymentOrderMapper
                .selectByThirdPartyOrderNo(thirdPartyOrder.getOrderNo());
            
            if (localOrder == null) {
                // 2. æœ¬åœ°ä¸å­˜åœ¨ï¼Œåˆ›å»ºè¡¥å•
                createSupplementOrder(thirdPartyOrder);
                log.info("çŸ­è´¦åˆ›å»ºè¡¥å•: thirdPartyOrderNo={}", 
                    thirdPartyOrder.getOrderNo());
                
            } else {
                // 3. æœ¬åœ°å­˜åœ¨ï¼Œæ›´æ–°çŠ¶æ€
                if (!PaymentStatus.SUCCESS.equals(localOrder.getStatus())) {
                    localOrder.setStatus(PaymentStatus.SUCCESS);
                    localOrder.setPayTime(thirdPartyOrder.getPayTime());
                    paymentOrderMapper.updateById(localOrder);
                    
                    // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
                    notifyBusiness(localOrder);
                    
                    log.info("çŸ­è´¦æ›´æ–°çŠ¶æ€: paymentNo={}", localOrder.getPaymentNo());
                }
            }
            
        } catch (Exception e) {
            log.error("å¤„ç†çŸ­è´¦å¤±è´¥: thirdPartyOrderNo={}", 
                thirdPartyOrder.getOrderNo(), e);
            // å‘é€å‘Šè­¦
            sendAlert("çŸ­è´¦å¤„ç†å¤±è´¥", thirdPartyOrder.getOrderNo());
        }
    }
    
    /**
     * ä¸‹è½½å¯¹è´¦å•
     */
    private List<ThirdPartyOrder> downloadBill(PayChannel channel, LocalDate date) {
        switch (channel) {
            case WECHAT:
                return weChatPayService.downloadBill(date);
            case ALIPAY:
                return alipayService.downloadBill(date);
            default:
                throw new BusinessException("ä¸æ”¯æŒçš„æ”¯ä»˜æ¸ é“");
        }
    }
}
```

## ğŸ”¥ éš¾ç‚¹æ·±åº¦è§£æ

### éš¾ç‚¹1: å¦‚ä½•ä¿è¯æ”¯ä»˜çš„å¹‚ç­‰æ€§ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜æŒ‰é’®
    â†“
ç½‘ç»œè¶…æ—¶
    â†“
ç”¨æˆ·å†æ¬¡ç‚¹å‡»
    â†“
æ˜¯å¦ä¼šé‡å¤æ‰£æ¬¾ï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆï¼šå¤šå±‚é˜²æŠ¤

```java
/**
 * å¹‚ç­‰æ€§ä¿è¯
 * @author erik.zhou
 */
@Service
@Slf4j
public class IdempotentService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private RedissonClient redissonClient;
    
    /**
     * ç¬¬ä¸€å±‚ï¼šå‰ç«¯é˜²é‡å¤æäº¤
     * ç”Ÿæˆå”¯ä¸€tokenï¼Œæäº¤æ—¶éªŒè¯
     */
    public String generateToken(String userId) {
        String token = UUID.randomUUID().toString();
        String key = "payment:token:" + userId;
        redisTemplate.opsForValue().set(key, token, 5, TimeUnit.MINUTES);
        return token;
    }
    
    public boolean validateToken(String userId, String token) {
        String key = "payment:token:" + userId;
        String stored = (String) redisTemplate.opsForValue().get(key);
        
        if (token.equals(stored)) {
            // éªŒè¯é€šè¿‡ï¼Œåˆ é™¤token
            redisTemplate.delete(key);
            return true;
        }
        
        return false;
    }
    
    /**
     * ç¬¬äºŒå±‚ï¼šä¸šåŠ¡è®¢å•å·å”¯ä¸€æ€§
     * æ•°æ®åº“å”¯ä¸€ç´¢å¼•
     */
    @Transactional(rollbackFor = Exception.class)
    public PaymentOrder createOrderWithUniqueCheck(PaymentRequest request) {
        try {
            PaymentOrder order = buildOrder(request);
            paymentOrderMapper.insert(order);
            return order;
            
        } catch (DuplicateKeyException e) {
            // å”¯ä¸€ç´¢å¼•å†²çªï¼Œè®¢å•å·²å­˜åœ¨
            log.warn("è®¢å•å·²å­˜åœ¨: businessOrderNo={}", 
                request.getBusinessOrderNo());
            
            return paymentOrderMapper
                .selectByBusinessOrderNo(request.getBusinessOrderNo());
        }
    }
    
    /**
     * ç¬¬ä¸‰å±‚ï¼šåˆ†å¸ƒå¼é”
     * é˜²æ­¢å¹¶å‘åˆ›å»ºè®¢å•
     */
    public PaymentOrder createOrderWithLock(PaymentRequest request) {
        String lockKey = "payment:lock:" + request.getBusinessOrderNo();
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                // æ£€æŸ¥è®¢å•æ˜¯å¦å·²å­˜åœ¨
                PaymentOrder existOrder = paymentOrderMapper
                    .selectByBusinessOrderNo(request.getBusinessOrderNo());
                
                if (existOrder != null) {
                    return existOrder;
                }
                
                // åˆ›å»ºè®¢å•
                return createOrder(request);
            }
            
            throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new BusinessException("è·å–é”å¤±è´¥");
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
    
    /**
     * ç¬¬å››å±‚ï¼šæ”¯ä»˜å›è°ƒå¹‚ç­‰æ€§
     * çŠ¶æ€æœºä¿è¯
     */
    @Transactional(rollbackFor = Exception.class)
    public void handleCallbackIdempotent(PaymentCallback callback) {
        PaymentOrder order = paymentOrderMapper
            .selectByThirdPartyOrderNo(callback.getOrderNo());
        
        // çŠ¶æ€æ£€æŸ¥
        if (PaymentStatus.SUCCESS.equals(order.getStatus())) {
            log.info("è®¢å•å·²æ”¯ä»˜ï¼Œè·³è¿‡: paymentNo={}", order.getPaymentNo());
            return;
        }
        
        // ä½¿ç”¨ä¹è§‚é”æ›´æ–°
        order.setStatus(PaymentStatus.SUCCESS);
        order.setVersion(order.getVersion() + 1);
        
        int updated = paymentOrderMapper.updateByIdWithVersion(order);
        
        if (updated == 0) {
            // æ›´æ–°å¤±è´¥ï¼Œè¯´æ˜å·²è¢«å…¶ä»–çº¿ç¨‹å¤„ç†
            log.info("è®¢å•å·²è¢«å¤„ç†: paymentNo={}", order.getPaymentNo());
            return;
        }
        
        // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
        notifyBusiness(order);
    }
}
```

### éš¾ç‚¹2: å¦‚ä½•å¤„ç†æ”¯ä»˜è¶…æ—¶ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
ç”¨æˆ·å‘èµ·æ”¯ä»˜
    â†“
30åˆ†é’Ÿæœªæ”¯ä»˜
    â†“
è®¢å•å¦‚ä½•å¤„ç†ï¼Ÿ
åº“å­˜å¦‚ä½•é‡Šæ”¾ï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆï¼šå»¶è¿Ÿé˜Ÿåˆ—

```java
/**
 * æ”¯ä»˜è¶…æ—¶å¤„ç†
 * @author erik.zhou
 */
@Service
@Slf4j
public class PaymentTimeoutService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    @Autowired
    private PaymentOrderMapper paymentOrderMapper;
    
    /**
     * è®¾ç½®æ”¯ä»˜è¶…æ—¶
     */
    public void scheduleTimeout(String paymentNo) {
        TimeoutMessage message = TimeoutMessage.builder()
            .paymentNo(paymentNo)
            .createTime(System.currentTimeMillis())
            .build();
        
        // å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼ˆ30åˆ†é’Ÿåï¼‰
        rocketMQTemplate.syncSend(
            "payment-timeout-topic",
            MessageBuilder.withPayload(message).build(),
            3000,
            18 // å»¶è¿Ÿçº§åˆ«18 = 30åˆ†é’Ÿ
        );
        
        log.info("è®¾ç½®æ”¯ä»˜è¶…æ—¶: paymentNo={}", paymentNo);
    }
    
    /**
     * å¤„ç†è¶…æ—¶è®¢å•
     */
    @RocketMQMessageListener(
        topic = "payment-timeout-topic",
        consumerGroup = "payment-timeout-group"
    )
    public class TimeoutConsumer implements RocketMQListener<TimeoutMessage> {
        
        @Override
        public void onMessage(TimeoutMessage message) {
            String paymentNo = message.getPaymentNo();
            log.info("å¤„ç†è¶…æ—¶è®¢å•: paymentNo={}", paymentNo);
            
            try {
                // 1. æŸ¥è¯¢è®¢å•çŠ¶æ€
                PaymentOrder order = paymentOrderMapper
                    .selectByPaymentNo(paymentNo);
                
                if (order == null) {
                    log.warn("è®¢å•ä¸å­˜åœ¨: paymentNo={}", paymentNo);
                    return;
                }
                
                // 2. å¦‚æœå·²æ”¯ä»˜ï¼Œè·³è¿‡
                if (PaymentStatus.SUCCESS.equals(order.getStatus())) {
                    log.info("è®¢å•å·²æ”¯ä»˜ï¼Œè·³è¿‡: paymentNo={}", paymentNo);
                    return;
                }
                
                // 3. æŸ¥è¯¢ç¬¬ä¸‰æ–¹æ”¯ä»˜çŠ¶æ€
                ThirdPartyOrderStatus status = queryThirdPartyStatus(order);
                
                if (ThirdPartyOrderStatus.SUCCESS.equals(status)) {
                    // ç¬¬ä¸‰æ–¹å·²æ”¯ä»˜ï¼Œè¡¥å•
                    order.setStatus(PaymentStatus.SUCCESS);
                    order.setPayTime(new Date());
                    paymentOrderMapper.updateById(order);
                    
                    // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿ
                    notifyBusiness(order);
                    
                    log.info("è¶…æ—¶è®¢å•è¡¥å•: paymentNo={}", paymentNo);
                    
                } else {
                    // 4. å…³é—­è®¢å•
                    order.setStatus(PaymentStatus.CLOSED);
                    order.setCloseTime(new Date());
                    paymentOrderMapper.updateById(order);
                    
                    // é€šçŸ¥ä¸šåŠ¡ç³»ç»Ÿé‡Šæ”¾åº“å­˜
                    notifyBusinessClose(order);
                    
                    log.info("è¶…æ—¶è®¢å•å…³é—­: paymentNo={}", paymentNo);
                }
                
            } catch (Exception e) {
                log.error("å¤„ç†è¶…æ—¶è®¢å•å¤±è´¥: paymentNo={}", paymentNo, e);
            }
        }
    }
}
```

### éš¾ç‚¹3: å¦‚ä½•ä¿è¯èµ„é‡‘å®‰å…¨ï¼Ÿ

#### è§£å†³æ–¹æ¡ˆï¼šå¤šé‡ä¿éšœ

```java
/**
 * èµ„é‡‘å®‰å…¨ä¿éšœ
 * @author erik.zhou
 */
@Service
@Slf4j
public class FundSecurityService {
    
    /**
     * 1. é‡‘é¢æ ¡éªŒ
     */
    public void validateAmount(PaymentRequest request) {
        // é‡‘é¢å¿…é¡»å¤§äº0
        if (request.getAmount().compareTo(BigDecimal.ZERO) <= 0) {
            throw new BusinessException("é‡‘é¢å¿…é¡»å¤§äº0");
        }
        
        // é‡‘é¢ä¸èƒ½è¶…è¿‡é™é¢
        if (request.getAmount().compareTo(new BigDecimal("50000")) > 0) {
            throw new BusinessException("å•ç¬”é‡‘é¢ä¸èƒ½è¶…è¿‡5ä¸‡å…ƒ");
        }
        
        // é‡‘é¢ç²¾åº¦æ£€æŸ¥ï¼ˆæœ€å¤š2ä½å°æ•°ï¼‰
        if (request.getAmount().scale() > 2) {
            throw new BusinessException("é‡‘é¢ç²¾åº¦é”™è¯¯");
        }
    }
    
    /**
     * 2. ç­¾åéªŒè¯
     */
    public boolean verifySign(PaymentCallback callback) {
        // æ„å»ºå¾…ç­¾åå­—ç¬¦ä¸²
        String signStr = buildSignString(callback);
        
        // ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
        return RSAUtils.verify(signStr, callback.getSign(), publicKey);
    }
    
    /**
     * 3. é˜²ç¯¡æ”¹
     */
    public void checkTamper(PaymentOrder order, PaymentCallback callback) {
        // æ£€æŸ¥é‡‘é¢æ˜¯å¦ä¸€è‡´
        if (!order.getAmount().equals(callback.getAmount())) {
            log.error("é‡‘é¢è¢«ç¯¡æ”¹: paymentNo={}, order={}, callback={}", 
                order.getPaymentNo(), order.getAmount(), callback.getAmount());
            throw new SecurityException("é‡‘é¢è¢«ç¯¡æ”¹");
        }
    }
    
    /**
     * 4. é£æ§æ£€æŸ¥
     */
    public void riskCheck(PaymentRequest request) {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨é»‘åå•
        if (isInBlacklist(request.getUserId())) {
            throw new BusinessException("ç”¨æˆ·å·²è¢«é™åˆ¶æ”¯ä»˜");
        }
        
        // æ£€æŸ¥å•æ—¥æ”¯ä»˜æ¬¡æ•°
        int todayCount = getTodayPaymentCount(request.getUserId());
        if (todayCount > 100) {
            throw new BusinessException("ä»Šæ—¥æ”¯ä»˜æ¬¡æ•°è¶…é™");
        }
        
        // æ£€æŸ¥å•æ—¥æ”¯ä»˜é‡‘é¢
        BigDecimal todayAmount = getTodayPaymentAmount(request.getUserId());
        if (todayAmount.compareTo(new BigDecimal("100000")) > 0) {
            throw new BusinessException("ä»Šæ—¥æ”¯ä»˜é‡‘é¢è¶…é™");
        }
    }
}
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ”¯ä»˜TPS | 5000 |
| æ”¯ä»˜æˆåŠŸç‡ | 99.99% |
| å¹³å‡å“åº”æ—¶é—´ | 200ms |
| P99å“åº”æ—¶é—´ | 500ms |
| å¯¹è´¦å‡†ç¡®ç‡ | 100% |

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å¹‚ç­‰æ€§è®¾è®¡
- å‰ç«¯é˜²é‡å¤æäº¤
- ä¸šåŠ¡è®¢å•å·å”¯ä¸€
- åˆ†å¸ƒå¼é”
- çŠ¶æ€æœº

### 2. èµ„é‡‘å®‰å…¨
- é‡‘é¢æ ¡éªŒ
- ç­¾åéªŒè¯
- é˜²ç¯¡æ”¹
- é£æ§æ£€æŸ¥

### 3. å¯¹è´¦æœºåˆ¶
- æ¯æ—¥è‡ªåŠ¨å¯¹è´¦
- å·®å¼‚è‡ªåŠ¨å¤„ç†
- å‘Šè­¦é€šçŸ¥
- äººå·¥å¤æ ¸

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

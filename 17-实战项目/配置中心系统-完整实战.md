# é…ç½®ä¸­å¿ƒç³»ç»Ÿ-å®Œæ•´å®æˆ˜

> @author erik.zhou  
> éš¾åº¦: â­â­â­â­â­  
> æŠ€æœ¯æ ˆ: Spring Cloud Config + Nacos + Apollo + Git

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ä¸šåŠ¡åœºæ™¯
æ„å»ºä¸€ä¸ªä¼ä¸šçº§çš„é…ç½®ä¸­å¿ƒç³»ç»Ÿï¼Œå®ç°é…ç½®çš„ç»Ÿä¸€ç®¡ç†å’ŒåŠ¨æ€ä¸‹å‘ï¼š
- **é…ç½®ç®¡ç†**: å¤šç¯å¢ƒã€å¤šé›†ç¾¤é…ç½®ç»Ÿä¸€ç®¡ç†
- **åŠ¨æ€åˆ·æ–°**: é…ç½®çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯åº”ç”¨
- **ç°åº¦å‘å¸ƒ**: é…ç½®ç°åº¦å‘å¸ƒï¼Œé™ä½å˜æ›´é£é™©
- **ç‰ˆæœ¬ç®¡ç†**: é…ç½®ç‰ˆæœ¬æ§åˆ¶ï¼Œæ”¯æŒå›æ»š

### æ ¸å¿ƒéš¾ç‚¹
1. **é…ç½®çƒ­æ›´æ–°** - é…ç½®å˜æ›´å®æ—¶æ¨é€ï¼Œåº”ç”¨æ— æ„ŸçŸ¥åˆ·æ–°
2. **é…ç½®ç°åº¦å‘å¸ƒ** - åˆ†æ‰¹æ¬¡å‘å¸ƒé…ç½®ï¼Œå®æ—¶ç›‘æ§å½±å“
3. **é…ç½®ä¸€è‡´æ€§ä¿è¯** - åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é…ç½®çš„å¼ºä¸€è‡´æ€§

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹1: é…ç½®çƒ­æ›´æ–°

### é—®é¢˜åœºæ™¯
- é…ç½®å˜æ›´éœ€è¦å®æ—¶ç”Ÿæ•ˆï¼Œä¸èƒ½é‡å¯åº”ç”¨
- é…ç½®æ¨é€è¦å¿«é€Ÿï¼Œå»¶è¿Ÿè¦åœ¨ç§’çº§
- é…ç½®åˆ·æ–°è¦ä¿è¯åŸå­æ€§ï¼Œé¿å…ä¸­é—´çŠ¶æ€
- è¦æ”¯æŒä¸åŒç±»å‹çš„é…ç½®åˆ·æ–°ï¼ˆBeanã€ç¼“å­˜ã€è¿æ¥æ± ç­‰ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### 1. é…ç½®ç›‘å¬ä¸æ¨é€

```java
/**
 * é…ç½®å˜æ›´ç›‘å¬å™¨
 * @author erik.zhou
 */
@Component
public class ConfigChangeListener {
    
    @Autowired
    private ConfigService configService;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * åˆå§‹åŒ–é…ç½®ç›‘å¬
     */
    @PostConstruct
    public void init() {
        // ç›‘å¬Nacosé…ç½®å˜æ›´
        String dataId = "application.yml";
        String group = "DEFAULT_GROUP";
        
        configService.addListener(dataId, group, new Listener() {
            @Override
            public void receiveConfigInfo(String configInfo) {
                handleConfigChange(dataId, configInfo);
            }
            
            @Override
            public Executor getExecutor() {
                return Executors.newSingleThreadExecutor();
            }
        });
    }
    
    /**
     * å¤„ç†é…ç½®å˜æ›´
     */
    private void handleConfigChange(String dataId, String newConfig) {
        log.info("é…ç½®å˜æ›´: dataId={}", dataId);
        
        try {
            // 1. è§£ææ–°é…ç½®
            Map<String, Object> newProperties = parseConfig(newConfig);
            
            // 2. è·å–æ—§é…ç½®
            Map<String, Object> oldProperties = getCurrentProperties();
            
            // 3. è®¡ç®—å·®å¼‚
            ConfigDiff diff = calculateDiff(oldProperties, newProperties);
            
            // 4. éªŒè¯é…ç½®
            validateConfig(newProperties);
            
            // 5. å‘å¸ƒé…ç½®å˜æ›´äº‹ä»¶
            ConfigChangeEvent event = new ConfigChangeEvent(this, dataId, diff);
            eventPublisher.publishEvent(event);
            
            // 6. è®°å½•å˜æ›´å†å²
            recordConfigChange(dataId, oldProperties, newProperties);
            
            log.info("é…ç½®åˆ·æ–°æˆåŠŸ: dataId={}, å˜æ›´é¡¹æ•°={}", 
                dataId, diff.getChangedKeys().size());
            
        } catch (Exception e) {
            log.error("é…ç½®åˆ·æ–°å¤±è´¥: dataId={}", dataId, e);
            // å‘é€å‘Šè­¦
            sendAlert("é…ç½®åˆ·æ–°å¤±è´¥", dataId, e.getMessage());
        }
    }
    
    /**
     * è®¡ç®—é…ç½®å·®å¼‚
     */
    private ConfigDiff calculateDiff(Map<String, Object> oldProps, 
                                     Map<String, Object> newProps) {
        ConfigDiff diff = new ConfigDiff();
        
        // æ‰¾å‡ºæ–°å¢çš„é…ç½®
        newProps.forEach((key, value) -> {
            if (!oldProps.containsKey(key)) {
                diff.addAddedKey(key, value);
            } else if (!Objects.equals(oldProps.get(key), value)) {
                diff.addChangedKey(key, oldProps.get(key), value);
            }
        });
        
        // æ‰¾å‡ºåˆ é™¤çš„é…ç½®
        oldProps.forEach((key, value) -> {
            if (!newProps.containsKey(key)) {
                diff.addRemovedKey(key, value);
            }
        });
        
        return diff;
    }
    
    /**
     * éªŒè¯é…ç½®
     */
    private void validateConfig(Map<String, Object> properties) {
        // 1. éªŒè¯å¿…å¡«é¡¹
        validateRequiredProperties(properties);
        
        // 2. éªŒè¯æ•°æ®ç±»å‹
        validatePropertyTypes(properties);
        
        // 3. éªŒè¯å–å€¼èŒƒå›´
        validatePropertyValues(properties);
        
        // 4. éªŒè¯ä¾èµ–å…³ç³»
        validatePropertyDependencies(properties);
    }
    
    /**
     * è®°å½•é…ç½®å˜æ›´å†å²
     */
    private void recordConfigChange(String dataId, 
                                    Map<String, Object> oldProps,
                                    Map<String, Object> newProps) {
        ConfigChangeRecord record = new ConfigChangeRecord();
        record.setDataId(dataId);
        record.setOldConfig(JSON.toJSONString(oldProps));
        record.setNewConfig(JSON.toJSONString(newProps));
        record.setChangeTime(System.currentTimeMillis());
        record.setOperator(getCurrentUser());
        
        // ä¿å­˜åˆ°æ•°æ®åº“
        configChangeRecordMapper.insert(record);
        
        // åŒæ—¶ä¿å­˜åˆ°Redisï¼ˆç”¨äºå¿«é€ŸæŸ¥è¯¢æœ€è¿‘å˜æ›´ï¼‰
        String key = "config:change:history:" + dataId;
        redisTemplate.opsForList().leftPush(key, record);
        redisTemplate.opsForList().trim(key, 0, 99); // åªä¿ç•™æœ€è¿‘100æ¡
    }
}
```

#### 2. é…ç½®åˆ·æ–°å¤„ç†å™¨

```java
/**
 * é…ç½®åˆ·æ–°å¤„ç†å™¨
 * å¤„ç†ä¸åŒç±»å‹çš„é…ç½®åˆ·æ–°
 * @author erik.zhou
 */
@Component
public class ConfigRefreshHandler {
    
    @Autowired
    private ApplicationContext applicationContext;
    
    @Autowired
    private Environment environment;
    
    /**
     * ç›‘å¬é…ç½®å˜æ›´äº‹ä»¶
     */
    @EventListener
    public void handleConfigChange(ConfigChangeEvent event) {
        ConfigDiff diff = event.getDiff();
        
        // 1. åˆ·æ–°@Valueæ³¨è§£çš„å­—æ®µ
        refreshValueAnnotations(diff);
        
        // 2. åˆ·æ–°@ConfigurationPropertiesçš„Bean
        refreshConfigurationProperties(diff);
        
        // 3. åˆ·æ–°ç¼“å­˜é…ç½®
        refreshCacheConfig(diff);
        
        // 4. åˆ·æ–°æ•°æ®æºé…ç½®
        refreshDataSourceConfig(diff);
        
        // 5. åˆ·æ–°çº¿ç¨‹æ± é…ç½®
        refreshThreadPoolConfig(diff);
        
        // 6. åˆ·æ–°é™æµé…ç½®
        refreshRateLimitConfig(diff);
    }
    
    /**
     * åˆ·æ–°@Valueæ³¨è§£çš„å­—æ®µ
     */
    private void refreshValueAnnotations(ConfigDiff diff) {
        // è·å–æ‰€æœ‰Bean
        String[] beanNames = applicationContext.getBeanDefinitionNames();
        
        for (String beanName : beanNames) {
            try {
                Object bean = applicationContext.getBean(beanName);
                Class<?> clazz = bean.getClass();
                
                // éå†æ‰€æœ‰å­—æ®µ
                for (Field field : clazz.getDeclaredFields()) {
                    Value valueAnnotation = field.getAnnotation(Value.class);
                    
                    if (valueAnnotation != null) {
                        String placeholder = valueAnnotation.value();
                        String propertyKey = extractPropertyKey(placeholder);
                        
                        // æ£€æŸ¥è¯¥é…ç½®æ˜¯å¦å˜æ›´
                        if (diff.hasChanged(propertyKey)) {
                            // åˆ·æ–°å­—æ®µå€¼
                            refreshField(bean, field, propertyKey);
                        }
                    }
                }
            } catch (Exception e) {
                log.error("åˆ·æ–°Beanå¤±è´¥: {}", beanName, e);
            }
        }
    }
    
    /**
     * åˆ·æ–°å­—æ®µå€¼
     */
    private void refreshField(Object bean, Field field, String propertyKey) {
        try {
            field.setAccessible(true);
            
            // è·å–æ–°å€¼
            String newValue = environment.getProperty(propertyKey);
            
            // ç±»å‹è½¬æ¢
            Object convertedValue = convertValue(newValue, field.getType());
            
            // è®¾ç½®æ–°å€¼
            field.set(bean, convertedValue);
            
            log.info("åˆ·æ–°å­—æ®µæˆåŠŸ: bean={}, field={}, newValue={}", 
                bean.getClass().getSimpleName(), field.getName(), newValue);
            
        } catch (Exception e) {
            log.error("åˆ·æ–°å­—æ®µå¤±è´¥: bean={}, field={}", 
                bean.getClass().getSimpleName(), field.getName(), e);
        }
    }
    
    /**
     * åˆ·æ–°@ConfigurationPropertiesçš„Bean
     */
    private void refreshConfigurationProperties(ConfigDiff diff) {
        // è·å–æ‰€æœ‰@ConfigurationPropertiesçš„Bean
        Map<String, Object> beans = applicationContext
            .getBeansWithAnnotation(ConfigurationProperties.class);
        
        beans.forEach((beanName, bean) -> {
            try {
                // é‡æ–°ç»‘å®šé…ç½®
                Binder binder = Binder.get(environment);
                ConfigurationProperties annotation = bean.getClass()
                    .getAnnotation(ConfigurationProperties.class);
                
                String prefix = annotation.prefix();
                
                // æ£€æŸ¥è¯¥å‰ç¼€çš„é…ç½®æ˜¯å¦å˜æ›´
                if (diff.hasPrefixChanged(prefix)) {
                    // é‡æ–°ç»‘å®š
                    binder.bind(prefix, Bindable.ofInstance(bean));
                    
                    log.info("åˆ·æ–°ConfigurationPropertiesæˆåŠŸ: bean={}, prefix={}", 
                        beanName, prefix);
                }
            } catch (Exception e) {
                log.error("åˆ·æ–°ConfigurationPropertieså¤±è´¥: bean={}", beanName, e);
            }
        });
    }
    
    /**
     * åˆ·æ–°æ•°æ®æºé…ç½®
     */
    private void refreshDataSourceConfig(ConfigDiff diff) {
        // æ£€æŸ¥æ•°æ®æºç›¸å…³é…ç½®æ˜¯å¦å˜æ›´
        if (diff.hasPrefixChanged("spring.datasource")) {
            log.info("æ•°æ®æºé…ç½®å˜æ›´ï¼Œé‡æ–°åˆå§‹åŒ–è¿æ¥æ± ");
            
            try {
                // è·å–æ•°æ®æºBean
                DataSource dataSource = applicationContext.getBean(DataSource.class);
                
                if (dataSource instanceof HikariDataSource) {
                    HikariDataSource hikariDataSource = (HikariDataSource) dataSource;
                    
                    // æ›´æ–°è¿æ¥æ± é…ç½®
                    if (diff.hasChanged("spring.datasource.hikari.maximum-pool-size")) {
                        int maxPoolSize = environment.getProperty(
                            "spring.datasource.hikari.maximum-pool-size", 
                            Integer.class, 10);
                        hikariDataSource.setMaximumPoolSize(maxPoolSize);
                    }
                    
                    if (diff.hasChanged("spring.datasource.hikari.minimum-idle")) {
                        int minIdle = environment.getProperty(
                            "spring.datasource.hikari.minimum-idle", 
                            Integer.class, 5);
                        hikariDataSource.setMinimumIdle(minIdle);
                    }
                    
                    log.info("æ•°æ®æºé…ç½®åˆ·æ–°æˆåŠŸ");
                }
            } catch (Exception e) {
                log.error("æ•°æ®æºé…ç½®åˆ·æ–°å¤±è´¥", e);
            }
        }
    }
    
    /**
     * åˆ·æ–°çº¿ç¨‹æ± é…ç½®
     */
    private void refreshThreadPoolConfig(ConfigDiff diff) {
        if (diff.hasPrefixChanged("thread.pool")) {
            log.info("çº¿ç¨‹æ± é…ç½®å˜æ›´ï¼ŒåŠ¨æ€è°ƒæ•´");
            
            try {
                ThreadPoolTaskExecutor executor = applicationContext
                    .getBean("taskExecutor", ThreadPoolTaskExecutor.class);
                
                if (diff.hasChanged("thread.pool.core-size")) {
                    int coreSize = environment.getProperty(
                        "thread.pool.core-size", Integer.class, 10);
                    executor.setCorePoolSize(coreSize);
                }
                
                if (diff.hasChanged("thread.pool.max-size")) {
                    int maxSize = environment.getProperty(
                        "thread.pool.max-size", Integer.class, 20);
                    executor.setMaxPoolSize(maxSize);
                }
                
                if (diff.hasChanged("thread.pool.queue-capacity")) {
                    int queueCapacity = environment.getProperty(
                        "thread.pool.queue-capacity", Integer.class, 100);
                    executor.setQueueCapacity(queueCapacity);
                }
                
                log.info("çº¿ç¨‹æ± é…ç½®åˆ·æ–°æˆåŠŸ");
            } catch (Exception e) {
                log.error("çº¿ç¨‹æ± é…ç½®åˆ·æ–°å¤±è´¥", e);
            }
        }
    }
}
```

#### 3. é…ç½®æ¨é€æœºåˆ¶

```java
/**
 * é…ç½®æ¨é€æœåŠ¡
 * æ”¯æŒå¤šç§æ¨é€æ–¹å¼
 * @author erik.zhou
 */
@Service
public class ConfigPushService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private WebSocketSessionManager sessionManager;
    
    /**
     * æ¨é€é…ç½®å˜æ›´
     * æ”¯æŒé•¿è½®è¯¢ã€WebSocketã€Redis Pub/Sub
     */
    public void pushConfigChange(String dataId, String group, String content) {
        ConfigChangeMessage message = new ConfigChangeMessage();
        message.setDataId(dataId);
        message.setGroup(group);
        message.setContent(content);
        message.setMd5(calculateMd5(content));
        message.setTimestamp(System.currentTimeMillis());
        
        // 1. Redis Pub/Subæ¨é€ï¼ˆæœ€å¿«ï¼‰
        pushViaRedisPubSub(message);
        
        // 2. WebSocketæ¨é€ï¼ˆå®æ—¶æ€§å¥½ï¼‰
        pushViaWebSocket(message);
        
        // 3. æ›´æ–°é•¿è½®è¯¢ç¼“å­˜
        updateLongPollingCache(message);
    }
    
    /**
     * Redis Pub/Subæ¨é€
     */
    private void pushViaRedisPubSub(ConfigChangeMessage message) {
        String channel = "config:change:" + message.getDataId();
        redisTemplate.convertAndSend(channel, message);
        log.info("Redisæ¨é€é…ç½®å˜æ›´: dataId={}", message.getDataId());
    }
    
    /**
     * WebSocketæ¨é€
     */
    private void pushViaWebSocket(ConfigChangeMessage message) {
        // è·å–è®¢é˜…è¯¥é…ç½®çš„æ‰€æœ‰ä¼šè¯
        List<WebSocketSession> sessions = sessionManager
            .getSessionsByDataId(message.getDataId());
        
        sessions.forEach(session -> {
            try {
                session.sendMessage(new TextMessage(JSON.toJSONString(message)));
                log.info("WebSocketæ¨é€é…ç½®å˜æ›´: dataId={}, sessionId={}", 
                    message.getDataId(), session.getId());
            } catch (Exception e) {
                log.error("WebSocketæ¨é€å¤±è´¥", e);
            }
        });
    }
    
    /**
     * æ›´æ–°é•¿è½®è¯¢ç¼“å­˜
     */
    private void updateLongPollingCache(ConfigChangeMessage message) {
        String key = "config:longpolling:" + message.getDataId();
        redisTemplate.opsForValue().set(key, message, 30, TimeUnit.SECONDS);
    }
}
```

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹2: é…ç½®ç°åº¦å‘å¸ƒ

### é—®é¢˜åœºæ™¯
- é…ç½®å˜æ›´æœ‰é£é™©ï¼Œéœ€è¦åˆ†æ‰¹æ¬¡å‘å¸ƒ
- è¦èƒ½å®æ—¶ç›‘æ§é…ç½®å˜æ›´çš„å½±å“
- å‘ç°é—®é¢˜è¦èƒ½å¿«é€Ÿå›æ»š
- è¦æ”¯æŒå¤šç§ç°åº¦ç­–ç•¥ï¼ˆæŒ‰å®ä¾‹ã€æŒ‰ç™¾åˆ†æ¯”ã€æŒ‰ç”¨æˆ·ï¼‰

### è§£å†³æ–¹æ¡ˆ

#### 1. ç°åº¦å‘å¸ƒç­–ç•¥

```java
/**
 * é…ç½®ç°åº¦å‘å¸ƒæœåŠ¡
 * @author erik.zhou
 */
@Service
public class ConfigGrayReleaseService {
    
    @Autowired
    private ConfigService configService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private MetricsCollector metricsCollector;
    
    /**
     * åˆ›å»ºç°åº¦å‘å¸ƒ
     */
    public GrayRelease createGrayRelease(GrayReleaseRequest request) {
        // 1. éªŒè¯é…ç½®
        validateConfig(request.getNewConfig());
        
        // 2. åˆ›å»ºç°åº¦å‘å¸ƒè®°å½•
        GrayRelease release = new GrayRelease();
        release.setId(generateReleaseId());
        release.setDataId(request.getDataId());
        release.setGroup(request.getGroup());
        release.setOldConfig(getCurrentConfig(request.getDataId()));
        release.setNewConfig(request.getNewConfig());
        release.setStrategy(request.getStrategy());
        release.setStatus(GrayReleaseStatus.CREATED);
        release.setCreateTime(System.currentTimeMillis());
        
        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        grayReleaseMapper.insert(release);
        
        // 4. ä¿å­˜åˆ°Redis
        String key = "gray:release:" + release.getId();
        redisTemplate.opsForValue().set(key, release, 7, TimeUnit.DAYS);
        
        return release;
    }
    
    /**
     * æ‰§è¡Œç°åº¦å‘å¸ƒ
     */
    public void executeGrayRelease(String releaseId) {
        GrayRelease release = getGrayRelease(releaseId);
        
        if (release.getStatus() != GrayReleaseStatus.CREATED) {
            throw new IllegalStateException("ç°åº¦å‘å¸ƒçŠ¶æ€ä¸æ­£ç¡®");
        }
        
        try {
            // 1. æ›´æ–°çŠ¶æ€ä¸ºæ‰§è¡Œä¸­
            updateReleaseStatus(releaseId, GrayReleaseStatus.EXECUTING);
            
            // 2. æ ¹æ®ç­–ç•¥æ‰§è¡Œç°åº¦
            switch (release.getStrategy().getType()) {
                case INSTANCE:
                    executeInstanceGray(release);
                    break;
                    
                case PERCENTAGE:
                    executePercentageGray(release);
                    break;
                    
                case USER:
                    executeUserGray(release);
                    break;
            }
            
            // 3. å¯åŠ¨ç›‘æ§
            startMonitoring(release);
            
            // 4. æ›´æ–°çŠ¶æ€ä¸ºç°åº¦ä¸­
            updateReleaseStatus(releaseId, GrayReleaseStatus.GRAY);
            
            log.info("ç°åº¦å‘å¸ƒæ‰§è¡ŒæˆåŠŸ: releaseId={}", releaseId);
            
        } catch (Exception e) {
            log.error("ç°åº¦å‘å¸ƒæ‰§è¡Œå¤±è´¥: releaseId={}", releaseId, e);
            updateReleaseStatus(releaseId, GrayReleaseStatus.FAILED);
            throw e;
        }
    }
    
    /**
     * æŒ‰å®ä¾‹ç°åº¦
     */
    private void executeInstanceGray(GrayRelease release) {
        List<String> grayInstances = release.getStrategy().getGrayInstances();
        
        // å°†ç°åº¦å®ä¾‹åˆ—è¡¨ä¿å­˜åˆ°Redis
        String key = "gray:instances:" + release.getDataId();
        redisTemplate.delete(key);
        grayInstances.forEach(instance -> 
            redisTemplate.opsForSet().add(key, instance));
        
        // è®¾ç½®è¿‡æœŸæ—¶é—´
        redisTemplate.expire(key, 7, TimeUnit.DAYS);
        
        log.info("æŒ‰å®ä¾‹ç°åº¦: dataId={}, instances={}", 
            release.getDataId(), grayInstances);
    }
    
    /**
     * æŒ‰ç™¾åˆ†æ¯”ç°åº¦
     */
    private void executePercentageGray(GrayRelease release) {
        int percentage = release.getStrategy().getPercentage();
        
        // ä¿å­˜ç°åº¦ç™¾åˆ†æ¯”
        String key = "gray:percentage:" + release.getDataId();
        redisTemplate.opsForValue().set(key, percentage, 7, TimeUnit.DAYS);
        
        log.info("æŒ‰ç™¾åˆ†æ¯”ç°åº¦: dataId={}, percentage={}%", 
            release.getDataId(), percentage);
    }
    
    /**
     * æŒ‰ç”¨æˆ·ç°åº¦
     */
    private void executeUserGray(GrayRelease release) {
        List<String> grayUsers = release.getStrategy().getGrayUsers();
        
        // å°†ç°åº¦ç”¨æˆ·åˆ—è¡¨ä¿å­˜åˆ°Redis
        String key = "gray:users:" + release.getDataId();
        redisTemplate.delete(key);
        grayUsers.forEach(user -> 
            redisTemplate.opsForSet().add(key, user));
        
        redisTemplate.expire(key, 7, TimeUnit.DAYS);
        
        log.info("æŒ‰ç”¨æˆ·ç°åº¦: dataId={}, users={}", 
            release.getDataId(), grayUsers);
    }
    
    /**
     * å¯åŠ¨ç›‘æ§
     */
    private void startMonitoring(GrayRelease release) {
        // åˆ›å»ºç›‘æ§ä»»åŠ¡
        MonitoringTask task = new MonitoringTask();
        task.setReleaseId(release.getId());
        task.setDataId(release.getDataId());
        task.setStartTime(System.currentTimeMillis());
        
        // å®šæ—¶æ£€æŸ¥æŒ‡æ ‡
        ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
        scheduler.scheduleAtFixedRate(() -> {
            checkMetrics(release);
        }, 0, 1, TimeUnit.MINUTES);
        
        // ä¿å­˜è°ƒåº¦å™¨å¼•ç”¨
        monitoringSchedulers.put(release.getId(), scheduler);
    }
    
    /**
     * æ£€æŸ¥æŒ‡æ ‡
     */
    private void checkMetrics(GrayRelease release) {
        // 1. è·å–ç°åº¦å®ä¾‹çš„æŒ‡æ ‡
        List<String> grayInstances = getGrayInstances(release);
        Map<String, Metrics> grayMetrics = metricsCollector
            .collectMetrics(grayInstances);
        
        // 2. è·å–éç°åº¦å®ä¾‹çš„æŒ‡æ ‡
        List<String> normalInstances = getNormalInstances(release);
        Map<String, Metrics> normalMetrics = metricsCollector
            .collectMetrics(normalInstances);
        
        // 3. å¯¹æ¯”æŒ‡æ ‡
        MetricsComparison comparison = compareMetrics(grayMetrics, normalMetrics);
        
        // 4. åˆ¤æ–­æ˜¯å¦å¼‚å¸¸
        if (comparison.hasAbnormal()) {
            log.warn("ç°åº¦å‘å¸ƒæ£€æµ‹åˆ°å¼‚å¸¸: releaseId={}, abnormal={}", 
                release.getId(), comparison.getAbnormalMetrics());
            
            // å‘é€å‘Šè­¦
            sendAlert(release, comparison);
            
            // å¦‚æœé…ç½®äº†è‡ªåŠ¨å›æ»šï¼Œåˆ™æ‰§è¡Œå›æ»š
            if (release.getStrategy().isAutoRollback()) {
                rollback(release.getId());
            }
        } else {
            log.info("ç°åº¦å‘å¸ƒæŒ‡æ ‡æ­£å¸¸: releaseId={}", release.getId());
        }
    }
    
    /**
     * å®Œæˆç°åº¦å‘å¸ƒ
     * å°†é…ç½®æ¨é€åˆ°æ‰€æœ‰å®ä¾‹
     */
    public void completeGrayRelease(String releaseId) {
        GrayRelease release = getGrayRelease(releaseId);
        
        if (release.getStatus() != GrayReleaseStatus.GRAY) {
            throw new IllegalStateException("ç°åº¦å‘å¸ƒçŠ¶æ€ä¸æ­£ç¡®");
        }
        
        try {
            // 1. åœæ­¢ç›‘æ§
            stopMonitoring(releaseId);
            
            // 2. æ¸…é™¤ç°åº¦æ ‡è®°
            clearGrayMarks(release);
            
            // 3. å‘å¸ƒé…ç½®åˆ°æ‰€æœ‰å®ä¾‹
            publishConfigToAll(release);
            
            // 4. æ›´æ–°çŠ¶æ€ä¸ºå·²å®Œæˆ
            updateReleaseStatus(releaseId, GrayReleaseStatus.COMPLETED);
            
            log.info("ç°åº¦å‘å¸ƒå®Œæˆ: releaseId={}", releaseId);
            
        } catch (Exception e) {
            log.error("å®Œæˆç°åº¦å‘å¸ƒå¤±è´¥: releaseId={}", releaseId, e);
            throw e;
        }
    }
    
    /**
     * å›æ»šç°åº¦å‘å¸ƒ
     */
    public void rollback(String releaseId) {
        GrayRelease release = getGrayRelease(releaseId);
        
        try {
            log.info("å¼€å§‹å›æ»šç°åº¦å‘å¸ƒ: releaseId={}", releaseId);
            
            // 1. åœæ­¢ç›‘æ§
            stopMonitoring(releaseId);
            
            // 2. æ¸…é™¤ç°åº¦æ ‡è®°
            clearGrayMarks(release);
            
            // 3. æ¢å¤æ—§é…ç½®
            publishConfig(release.getDataId(), release.getGroup(), 
                release.getOldConfig());
            
            // 4. æ›´æ–°çŠ¶æ€ä¸ºå·²å›æ»š
            updateReleaseStatus(releaseId, GrayReleaseStatus.ROLLBACK);
            
            log.info("ç°åº¦å‘å¸ƒå›æ»šæˆåŠŸ: releaseId={}", releaseId);
            
        } catch (Exception e) {
            log.error("ç°åº¦å‘å¸ƒå›æ»šå¤±è´¥: releaseId={}", releaseId, e);
            throw e;
        }
    }
}
```


#### 2. ç°åº¦é…ç½®è·å–

```java
/**
 * é…ç½®è·å–æœåŠ¡
 * æ ¹æ®ç°åº¦ç­–ç•¥è¿”å›ä¸åŒçš„é…ç½®
 * @author erik.zhou
 */
@Service
public class ConfigFetchService {
    
    @Autowired
    private ConfigService configService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * è·å–é…ç½®
     * æ ¹æ®ç°åº¦ç­–ç•¥è¿”å›å¯¹åº”çš„é…ç½®
     */
    public String getConfig(String dataId, String group, String instanceId) {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç°åº¦å‘å¸ƒ
        GrayRelease grayRelease = getActiveGrayRelease(dataId, group);
        
        if (grayRelease == null) {
            // æ²¡æœ‰ç°åº¦å‘å¸ƒï¼Œè¿”å›æ­£å¼é…ç½®
            return configService.getConfig(dataId, group, 5000);
        }
        
        // 2. åˆ¤æ–­æ˜¯å¦å‘½ä¸­ç°åº¦
        boolean isGray = matchGrayStrategy(grayRelease, instanceId);
        
        if (isGray) {
            // å‘½ä¸­ç°åº¦ï¼Œè¿”å›ç°åº¦é…ç½®
            log.info("å‘½ä¸­ç°åº¦é…ç½®: dataId={}, instanceId={}", dataId, instanceId);
            return grayRelease.getNewConfig();
        } else {
            // æœªå‘½ä¸­ç°åº¦ï¼Œè¿”å›æ­£å¼é…ç½®
            return grayRelease.getOldConfig();
        }
    }
    
    /**
     * è·å–æ´»è·ƒçš„ç°åº¦å‘å¸ƒ
     */
    private GrayRelease getActiveGrayRelease(String dataId, String group) {
        String key = "gray:release:active:" + dataId + ":" + group;
        return (GrayRelease) redisTemplate.opsForValue().get(key);
    }
    
    /**
     * åŒ¹é…ç°åº¦ç­–ç•¥
     */
    private boolean matchGrayStrategy(GrayRelease release, String instanceId) {
        GrayStrategy strategy = release.getStrategy();
        
        switch (strategy.getType()) {
            case INSTANCE:
                return matchInstanceStrategy(strategy, instanceId);
                
            case PERCENTAGE:
                return matchPercentageStrategy(strategy, instanceId);
                
            case USER:
                return matchUserStrategy(strategy);
                
            default:
                return false;
        }
    }
    
    /**
     * åŒ¹é…å®ä¾‹ç­–ç•¥
     */
    private boolean matchInstanceStrategy(GrayStrategy strategy, String instanceId) {
        String key = "gray:instances:" + strategy.getDataId();
        return Boolean.TRUE.equals(
            redisTemplate.opsForSet().isMember(key, instanceId));
    }
    
    /**
     * åŒ¹é…ç™¾åˆ†æ¯”ç­–ç•¥
     */
    private boolean matchPercentageStrategy(GrayStrategy strategy, String instanceId) {
        String key = "gray:percentage:" + strategy.getDataId();
        Integer percentage = (Integer) redisTemplate.opsForValue().get(key);
        
        if (percentage == null) {
            return false;
        }
        
        // ä½¿ç”¨å®ä¾‹IDçš„hashå€¼è¿›è¡Œåˆ†æµ
        int hash = Math.abs(instanceId.hashCode());
        return (hash % 100) < percentage;
    }
    
    /**
     * åŒ¹é…ç”¨æˆ·ç­–ç•¥
     */
    private boolean matchUserStrategy(GrayStrategy strategy) {
        String userId = UserContext.getCurrentUserId();
        if (userId == null) {
            return false;
        }
        
        String key = "gray:users:" + strategy.getDataId();
        return Boolean.TRUE.equals(
            redisTemplate.opsForSet().isMember(key, userId));
    }
}
```

---

## ğŸ¯ æŠ€æœ¯éš¾ç‚¹3: é…ç½®ä¸€è‡´æ€§ä¿è¯

### é—®é¢˜åœºæ™¯
- é…ç½®ä¸­å¿ƒé›†ç¾¤éƒ¨ç½²ï¼Œè¦ä¿è¯æ•°æ®ä¸€è‡´æ€§
- é…ç½®å˜æ›´è¦ä¿è¯åŸå­æ€§ï¼Œä¸èƒ½å‡ºç°éƒ¨åˆ†æˆåŠŸ
- ç½‘ç»œåˆ†åŒºæ—¶è¦ä¿è¯é…ç½®çš„å¯ç”¨æ€§
- é…ç½®åŒæ­¥è¦é«˜æ•ˆï¼Œä¸èƒ½å½±å“æ€§èƒ½

### è§£å†³æ–¹æ¡ˆ

#### 1. é…ç½®å­˜å‚¨ä¸åŒæ­¥

```java
/**
 * é…ç½®å­˜å‚¨æœåŠ¡
 * ä½¿ç”¨Raftåè®®ä¿è¯ä¸€è‡´æ€§
 * @author erik.zhou
 */
@Service
public class ConfigStorageService {
    
    @Autowired
    private RaftNode raftNode;
    
    @Autowired
    private ConfigRepository configRepository;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ä¿å­˜é…ç½®
     * é€šè¿‡Raftåè®®ä¿è¯ä¸€è‡´æ€§
     */
    public void saveConfig(String dataId, String group, String content) {
        // 1. æ„å»ºé…ç½®å˜æ›´å‘½ä»¤
        ConfigChangeCommand command = new ConfigChangeCommand();
        command.setDataId(dataId);
        command.setGroup(group);
        command.setContent(content);
        command.setTimestamp(System.currentTimeMillis());
        command.setOperator(getCurrentUser());
        
        // 2. æäº¤åˆ°Rafté›†ç¾¤
        CompletableFuture<Boolean> future = raftNode.propose(command);
        
        try {
            // 3. ç­‰å¾…æäº¤ç»“æœ
            Boolean success = future.get(5, TimeUnit.SECONDS);
            
            if (!success) {
                throw new ConfigException("é…ç½®ä¿å­˜å¤±è´¥ï¼šRaftæäº¤å¤±è´¥");
            }
            
            log.info("é…ç½®ä¿å­˜æˆåŠŸ: dataId={}, group={}", dataId, group);
            
        } catch (TimeoutException e) {
            throw new ConfigException("é…ç½®ä¿å­˜è¶…æ—¶", e);
        } catch (Exception e) {
            throw new ConfigException("é…ç½®ä¿å­˜å¤±è´¥", e);
        }
    }
    
    /**
     * åº”ç”¨é…ç½®å˜æ›´
     * ç”±RaftçŠ¶æ€æœºè°ƒç”¨
     */
    public void applyConfigChange(ConfigChangeCommand command) {
        try {
            // 1. ä¿å­˜åˆ°æ•°æ®åº“
            ConfigInfo configInfo = new ConfigInfo();
            configInfo.setDataId(command.getDataId());
            configInfo.setGroup(command.getGroup());
            configInfo.setContent(command.getContent());
            configInfo.setMd5(calculateMd5(command.getContent()));
            configInfo.setUpdateTime(command.getTimestamp());
            configInfo.setOperator(command.getOperator());
            
            configRepository.save(configInfo);
            
            // 2. æ›´æ–°ç¼“å­˜
            updateCache(configInfo);
            
            // 3. æ¨é€é…ç½®å˜æ›´
            pushConfigChange(configInfo);
            
            log.info("åº”ç”¨é…ç½®å˜æ›´æˆåŠŸ: dataId={}", command.getDataId());
            
        } catch (Exception e) {
            log.error("åº”ç”¨é…ç½®å˜æ›´å¤±è´¥", e);
            throw e;
        }
    }
    
    /**
     * æ›´æ–°ç¼“å­˜
     */
    private void updateCache(ConfigInfo configInfo) {
        String key = buildCacheKey(configInfo.getDataId(), configInfo.getGroup());
        
        // 1. æ›´æ–°æœ¬åœ°ç¼“å­˜
        localCache.put(key, configInfo);
        
        // 2. æ›´æ–°Redisç¼“å­˜
        redisTemplate.opsForValue().set(key, configInfo, 1, TimeUnit.HOURS);
    }
    
    /**
     * è·å–é…ç½®
     * å¤šçº§ç¼“å­˜ç­–ç•¥
     */
    public String getConfig(String dataId, String group) {
        String key = buildCacheKey(dataId, group);
        
        // 1. ä»æœ¬åœ°ç¼“å­˜è·å–
        ConfigInfo configInfo = localCache.get(key);
        if (configInfo != null) {
            return configInfo.getContent();
        }
        
        // 2. ä»Redisç¼“å­˜è·å–
        configInfo = (ConfigInfo) redisTemplate.opsForValue().get(key);
        if (configInfo != null) {
            // æ›´æ–°æœ¬åœ°ç¼“å­˜
            localCache.put(key, configInfo);
            return configInfo.getContent();
        }
        
        // 3. ä»æ•°æ®åº“è·å–
        configInfo = configRepository.findByDataIdAndGroup(dataId, group);
        if (configInfo != null) {
            // æ›´æ–°ç¼“å­˜
            updateCache(configInfo);
            return configInfo.getContent();
        }
        
        return null;
    }
}
```

#### 2. é…ç½®ç‰ˆæœ¬ç®¡ç†

```java
/**
 * é…ç½®ç‰ˆæœ¬ç®¡ç†æœåŠ¡
 * @author erik.zhou
 */
@Service
public class ConfigVersionService {
    
    @Autowired
    private ConfigVersionRepository versionRepository;
    
    @Autowired
    private ConfigStorageService storageService;
    
    /**
     * ä¿å­˜é…ç½®ç‰ˆæœ¬
     */
    public void saveVersion(String dataId, String group, String content) {
        // 1. è·å–å½“å‰ç‰ˆæœ¬å·
        Long currentVersion = getCurrentVersion(dataId, group);
        
        // 2. åˆ›å»ºæ–°ç‰ˆæœ¬
        ConfigVersion version = new ConfigVersion();
        version.setDataId(dataId);
        version.setGroup(group);
        version.setVersion(currentVersion + 1);
        version.setContent(content);
        version.setMd5(calculateMd5(content));
        version.setCreateTime(System.currentTimeMillis());
        version.setOperator(getCurrentUser());
        
        // 3. ä¿å­˜ç‰ˆæœ¬
        versionRepository.save(version);
        
        log.info("ä¿å­˜é…ç½®ç‰ˆæœ¬: dataId={}, version={}", dataId, version.getVersion());
    }
    
    /**
     * è·å–é…ç½®å†å²ç‰ˆæœ¬
     */
    public List<ConfigVersion> getVersionHistory(String dataId, String group, 
                                                 int page, int size) {
        return versionRepository.findByDataIdAndGroup(dataId, group, page, size);
    }
    
    /**
     * å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
     */
    public void rollbackToVersion(String dataId, String group, Long version) {
        // 1. è·å–æŒ‡å®šç‰ˆæœ¬çš„é…ç½®
        ConfigVersion configVersion = versionRepository
            .findByDataIdAndGroupAndVersion(dataId, group, version);
        
        if (configVersion == null) {
            throw new ConfigException("é…ç½®ç‰ˆæœ¬ä¸å­˜åœ¨");
        }
        
        // 2. ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬
        storageService.saveConfig(dataId, group, configVersion.getContent());
        
        // 3. è®°å½•å›æ»šæ“ä½œ
        recordRollback(dataId, group, version);
        
        log.info("é…ç½®å›æ»šæˆåŠŸ: dataId={}, version={}", dataId, version);
    }
    
    /**
     * å¯¹æ¯”ä¸¤ä¸ªç‰ˆæœ¬
     */
    public ConfigDiff compareVersions(String dataId, String group, 
                                     Long version1, Long version2) {
        ConfigVersion v1 = versionRepository
            .findByDataIdAndGroupAndVersion(dataId, group, version1);
        ConfigVersion v2 = versionRepository
            .findByDataIdAndGroupAndVersion(dataId, group, version2);
        
        if (v1 == null || v2 == null) {
            throw new ConfigException("é…ç½®ç‰ˆæœ¬ä¸å­˜åœ¨");
        }
        
        // è§£æé…ç½®
        Map<String, Object> props1 = parseConfig(v1.getContent());
        Map<String, Object> props2 = parseConfig(v2.getContent());
        
        // è®¡ç®—å·®å¼‚
        return calculateDiff(props1, props2);
    }
}
```

#### 3. é…ç½®å®¡è®¡

```java
/**
 * é…ç½®å®¡è®¡æœåŠ¡
 * @author erik.zhou
 */
@Service
public class ConfigAuditService {
    
    @Autowired
    private ConfigAuditRepository auditRepository;
    
    /**
     * è®°å½•é…ç½®æ“ä½œ
     */
    public void recordOperation(ConfigOperation operation) {
        ConfigAudit audit = new ConfigAudit();
        audit.setDataId(operation.getDataId());
        audit.setGroup(operation.getGroup());
        audit.setOperationType(operation.getType());
        audit.setOldContent(operation.getOldContent());
        audit.setNewContent(operation.getNewContent());
        audit.setOperator(operation.getOperator());
        audit.setOperatorIp(operation.getOperatorIp());
        audit.setOperateTime(System.currentTimeMillis());
        audit.setRemark(operation.getRemark());
        
        auditRepository.save(audit);
    }
    
    /**
     * æŸ¥è¯¢å®¡è®¡æ—¥å¿—
     */
    public List<ConfigAudit> queryAuditLog(ConfigAuditQuery query) {
        return auditRepository.query(query);
    }
    
    /**
     * å¯¼å‡ºå®¡è®¡æ—¥å¿—
     */
    public void exportAuditLog(ConfigAuditQuery query, OutputStream output) {
        List<ConfigAudit> audits = auditRepository.query(query);
        
        // å¯¼å‡ºä¸ºExcel
        ExcelWriter writer = EasyExcel.write(output, ConfigAudit.class).build();
        WriteSheet sheet = EasyExcel.writerSheet("å®¡è®¡æ—¥å¿—").build();
        writer.write(audits, sheet);
        writer.finish();
    }
}
```

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•ç¯å¢ƒ
- æœåŠ¡å™¨: 4æ ¸8G * 3å°ï¼ˆé…ç½®ä¸­å¿ƒé›†ç¾¤ï¼‰
- å®¢æˆ·ç«¯: 1000ä¸ªå®ä¾‹
- é…ç½®æ•°é‡: 10000ä¸ª

### æµ‹è¯•ç»“æœ

#### 1. é…ç½®è¯»å–æ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹¶å‘æ•° | 1000 |
| QPS | 50000 |
| å¹³å‡å“åº”æ—¶é—´ | 2ms |
| P95å“åº”æ—¶é—´ | 5ms |
| P99å“åº”æ—¶é—´ | 10ms |
| ç¼“å­˜å‘½ä¸­ç‡ | 99% |

#### 2. é…ç½®æ¨é€æ€§èƒ½

| æ¨é€æ–¹å¼ | å»¶è¿Ÿ | æˆåŠŸç‡ |
|---------|------|--------|
| Redis Pub/Sub | <100ms | 99.9% |
| WebSocket | <200ms | 99.5% |
| é•¿è½®è¯¢ | <5s | 99% |

#### 3. ç°åº¦å‘å¸ƒæ€§èƒ½

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| ç°åº¦å®ä¾‹æ•° | 100 |
| é…ç½®æ¨é€æ—¶é—´ | <1s |
| ç›‘æ§æ£€æŸ¥é—´éš” | 1åˆ†é’Ÿ |
| å›æ»šæ—¶é—´ | <5s |

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. é…ç½®è®¾è®¡åŸåˆ™

```yaml
# é…ç½®å‘½åè§„èŒƒ
# æ ¼å¼: <åº”ç”¨å>-<ç¯å¢ƒ>-<æ¨¡å—>.yml

# âœ… å¥½çš„é…ç½®è®¾è®¡
# application-prod-database.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/db
    username: root
    password: ${DB_PASSWORD} # æ•æ„Ÿä¿¡æ¯ä½¿ç”¨ç¯å¢ƒå˜é‡
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5

# application-prod-redis.yml
spring:
  redis:
    host: localhost
    port: 6379
    password: ${REDIS_PASSWORD}
    lettuce:
      pool:
        max-active: 20
        max-idle: 10

# âŒ ä¸å¥½çš„é…ç½®è®¾è®¡
# æ‰€æœ‰é…ç½®æ··åœ¨ä¸€èµ·ï¼Œéš¾ä»¥ç®¡ç†
application:
  db.url: xxx
  db.user: xxx
  redis.host: xxx
  kafka.servers: xxx
  # ... å‡ ç™¾è¡Œé…ç½®
```

### 2. é…ç½®åŠ å¯†

```java
/**
 * é…ç½®åŠ å¯†æœåŠ¡
 * @author erik.zhou
 */
@Service
public class ConfigEncryptionService {
    
    private static final String ENCRYPTED_PREFIX = "ENC(";
    private static final String ENCRYPTED_SUFFIX = ")";
    
    @Autowired
    private StringEncryptor encryptor;
    
    /**
     * åŠ å¯†é…ç½®å€¼
     */
    public String encrypt(String plainText) {
        String encrypted = encryptor.encrypt(plainText);
        return ENCRYPTED_PREFIX + encrypted + ENCRYPTED_SUFFIX;
    }
    
    /**
     * è§£å¯†é…ç½®å€¼
     */
    public String decrypt(String encryptedText) {
        if (!isEncrypted(encryptedText)) {
            return encryptedText;
        }
        
        String encrypted = encryptedText
            .substring(ENCRYPTED_PREFIX.length(), 
                      encryptedText.length() - ENCRYPTED_SUFFIX.length());
        
        return encryptor.decrypt(encrypted);
    }
    
    /**
     * åˆ¤æ–­æ˜¯å¦ä¸ºåŠ å¯†é…ç½®
     */
    private boolean isEncrypted(String text) {
        return text != null && 
               text.startsWith(ENCRYPTED_PREFIX) && 
               text.endsWith(ENCRYPTED_SUFFIX);
    }
    
    /**
     * å¤„ç†é…ç½®
     * è‡ªåŠ¨è§£å¯†åŠ å¯†çš„é…ç½®é¡¹
     */
    public Map<String, Object> processConfig(Map<String, Object> config) {
        Map<String, Object> processed = new HashMap<>();
        
        config.forEach((key, value) -> {
            if (value instanceof String) {
                processed.put(key, decrypt((String) value));
            } else if (value instanceof Map) {
                processed.put(key, processConfig((Map<String, Object>) value));
            } else {
                processed.put(key, value);
            }
        });
        
        return processed;
    }
}
```

### 3. é…ç½®ç›‘æ§

```java
/**
 * é…ç½®ç›‘æ§æœåŠ¡
 * @author erik.zhou
 */
@Service
public class ConfigMonitoringService {
    
    @Autowired
    private MeterRegistry registry;
    
    /**
     * è®°å½•é…ç½®è¯»å–
     */
    public void recordConfigRead(String dataId, boolean fromCache) {
        Counter.builder("config.read.total")
            .tag("dataId", dataId)
            .tag("fromCache", String.valueOf(fromCache))
            .register(registry)
            .increment();
    }
    
    /**
     * è®°å½•é…ç½®å˜æ›´
     */
    public void recordConfigChange(String dataId) {
        Counter.builder("config.change.total")
            .tag("dataId", dataId)
            .register(registry)
            .increment();
    }
    
    /**
     * è®°å½•é…ç½®æ¨é€
     */
    public void recordConfigPush(String dataId, String pushType, boolean success) {
        Counter.builder("config.push.total")
            .tag("dataId", dataId)
            .tag("pushType", pushType)
            .tag("success", String.valueOf(success))
            .register(registry)
            .increment();
    }
    
    /**
     * è®°å½•ç°åº¦å‘å¸ƒ
     */
    public void recordGrayRelease(String releaseId, String status) {
        Counter.builder("config.gray.release.total")
            .tag("releaseId", releaseId)
            .tag("status", status)
            .register(registry)
            .increment();
    }
}
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **é…ç½®çƒ­æ›´æ–°**
   - å¤šç§æ¨é€æ–¹å¼ï¼ˆRedis Pub/Subã€WebSocketã€é•¿è½®è¯¢ï¼‰
   - æ™ºèƒ½åˆ·æ–°æœºåˆ¶ï¼ˆ@Valueã€@ConfigurationPropertiesï¼‰
   - é…ç½®éªŒè¯å’Œå›æ»š
   - å˜æ›´å†å²è®°å½•

2. **é…ç½®ç°åº¦å‘å¸ƒ**
   - å¤šç§ç°åº¦ç­–ç•¥ï¼ˆå®ä¾‹ã€ç™¾åˆ†æ¯”ã€ç”¨æˆ·ï¼‰
   - å®æ—¶ç›‘æ§å’Œå‘Šè­¦
   - è‡ªåŠ¨å›æ»šæœºåˆ¶
   - ç°åº¦å®Œæˆå’Œå›æ»š

3. **é…ç½®ä¸€è‡´æ€§ä¿è¯**
   - Raftåè®®ä¿è¯å¼ºä¸€è‡´æ€§
   - å¤šçº§ç¼“å­˜æå‡æ€§èƒ½
   - é…ç½®ç‰ˆæœ¬ç®¡ç†
   - å®Œå–„çš„å®¡è®¡æ—¥å¿—

### æŠ€æœ¯æ”¶è·

- æŒæ¡äº†é…ç½®ä¸­å¿ƒçš„æ ¸å¿ƒåŸç†
- ç†è§£äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®
- å­¦ä¼šäº†è®¾è®¡ç°åº¦å‘å¸ƒç³»ç»Ÿ
- ç§¯ç´¯äº†é…ç½®ç®¡ç†ç»éªŒ

### ç”Ÿäº§ç»éªŒ

- é…ç½®è¦åˆ†ç±»ç®¡ç†ï¼Œé¿å…æ··ä¹±
- æ•æ„Ÿé…ç½®è¦åŠ å¯†å­˜å‚¨
- é…ç½®å˜æ›´è¦æœ‰å®¡æ‰¹æµç¨‹
- è¦æœ‰å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

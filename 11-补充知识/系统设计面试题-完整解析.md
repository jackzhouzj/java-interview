# ç³»ç»Ÿè®¾è®¡é¢è¯•é¢˜-å®Œæ•´è§£æ

> @author erik.zhou  
> éš¾åº¦: â­â­â­â­â­  
> é€‚ç”¨åœºæ™¯: é¢è¯•å‡†å¤‡ã€æ¶æ„è®¾è®¡

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿè®¾è®¡æ–¹æ³•è®º](#ç³»ç»Ÿè®¾è®¡æ–¹æ³•è®º)
- [ç»å…¸è®¾è®¡é¢˜](#ç»å…¸è®¾è®¡é¢˜)
- [é«˜é¢‘é¢è¯•é¢˜](#é«˜é¢‘é¢è¯•é¢˜)
- [è®¾è®¡æ¨¡å¼åº”ç”¨](#è®¾è®¡æ¨¡å¼åº”ç”¨)

---

## ğŸ¯ ç³»ç»Ÿè®¾è®¡æ–¹æ³•è®º

### è®¾è®¡æ­¥éª¤

```
1. éœ€æ±‚æ¾„æ¸…ï¼ˆ5åˆ†é’Ÿï¼‰
   - åŠŸèƒ½éœ€æ±‚
   - éåŠŸèƒ½éœ€æ±‚
   - è§„æ¨¡ä¼°ç®—
   
2. é«˜å±‚è®¾è®¡ï¼ˆ10åˆ†é’Ÿï¼‰
   - ç³»ç»Ÿæ¶æ„å›¾
   - æ ¸å¿ƒç»„ä»¶
   - æ•°æ®æµå‘
   
3. è¯¦ç»†è®¾è®¡ï¼ˆ15åˆ†é’Ÿï¼‰
   - æ•°æ®åº“è®¾è®¡
   - APIè®¾è®¡
   - å…³é”®ç®—æ³•
   
4. ä¼˜åŒ–å’Œæƒè¡¡ï¼ˆ10åˆ†é’Ÿï¼‰
   - æ€§èƒ½ä¼˜åŒ–
   - å¯æ‰©å±•æ€§
   - å¯ç”¨æ€§
```

### éœ€æ±‚æ¾„æ¸…æ¨¡æ¿

```
åŠŸèƒ½éœ€æ±‚ï¼š
- ç”¨æˆ·å¯ä»¥åšä»€ä¹ˆï¼Ÿ
- ç³»ç»Ÿéœ€è¦æ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ
- æ˜¯å¦éœ€è¦å®æ—¶æ€§ï¼Ÿ

éåŠŸèƒ½éœ€æ±‚ï¼š
- DAUï¼ˆæ—¥æ´»ç”¨æˆ·ï¼‰æ˜¯å¤šå°‘ï¼Ÿ
- QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰æ˜¯å¤šå°‘ï¼Ÿ
- æ•°æ®é‡æœ‰å¤šå¤§ï¼Ÿ
- å¯ç”¨æ€§è¦æ±‚ï¼ˆ99.9%ï¼Ÿ99.99%ï¼Ÿï¼‰
- å»¶è¿Ÿè¦æ±‚ï¼ˆ<100msï¼Ÿ<1sï¼Ÿï¼‰

çº¦æŸæ¡ä»¶ï¼š
- é¢„ç®—é™åˆ¶
- æŠ€æœ¯æ ˆé™åˆ¶
- æ—¶é—´é™åˆ¶
```

---

## ğŸ’¡ ç»å…¸è®¾è®¡é¢˜

### 1. è®¾è®¡çŸ­é“¾ç³»ç»Ÿ

#### éœ€æ±‚åˆ†æ

```
åŠŸèƒ½éœ€æ±‚ï¼š
1. ç”ŸæˆçŸ­é“¾ï¼šè¾“å…¥é•¿URLï¼Œè¿”å›çŸ­URL
2. è·³è½¬ï¼šè®¿é—®çŸ­URLï¼Œè·³è½¬åˆ°é•¿URL
3. ç»Ÿè®¡ï¼šè®°å½•è®¿é—®æ¬¡æ•°ã€è®¿é—®æ¥æº

éåŠŸèƒ½éœ€æ±‚ï¼š
- DAU: 100ä¸‡
- å†™QPS: 1000
- è¯»QPS: 10000
- çŸ­é“¾é•¿åº¦: 6-7ä½
- æ•°æ®ä¿ç•™: æ°¸ä¹…
```

#### é«˜å±‚è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    çŸ­é“¾ç³»ç»Ÿæ¶æ„                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚  å®¢æˆ·ç«¯   â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚       â”‚                                                  â”‚
â”‚       â–¼                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ APIç½‘å…³  â”‚â”€â”€â”€â”€â”€â–¶â”‚ çŸ­é“¾æœåŠ¡  â”‚â”€â”€â”€â”€â”€â–¶â”‚  Redis   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                          â”‚                              â”‚
â”‚                          â–¼                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚  MySQL   â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â”‚                              â”‚
â”‚                          â–¼                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚  Kafka   â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                         â”‚                               â”‚
â”‚                         â–¼                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚                    â”‚ ç»Ÿè®¡æœåŠ¡  â”‚                         â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¯¦ç»†è®¾è®¡

```java
/**
 * çŸ­é“¾æœåŠ¡å®ç°
 * @author erik.zhou
 */
@Service
public class ShortUrlService {
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    @Autowired
    private ShortUrlRepository shortUrlRepository;
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    private static final String BASE62 = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    
    /**
     * ç”ŸæˆçŸ­é“¾
     */
    public String generateShortUrl(String longUrl) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        String existingShortUrl = getExistingShortUrl(longUrl);
        if (existingShortUrl != null) {
            return existingShortUrl;
        }
        
        // 2. ç”ŸæˆçŸ­ç 
        String shortCode = generateShortCode();
        
        // 3. ä¿å­˜åˆ°æ•°æ®åº“
        ShortUrl shortUrl = new ShortUrl();
        shortUrl.setShortCode(shortCode);
        shortUrl.setLongUrl(longUrl);
        shortUrl.setCreateTime(LocalDateTime.now());
        shortUrlRepository.save(shortUrl);
        
        // 4. ç¼“å­˜åˆ°Redis
        String cacheKey = "short_url:" + shortCode;
        redisTemplate.opsForValue().set(cacheKey, longUrl, 7, TimeUnit.DAYS);
        
        return "https://short.url/" + shortCode;
    }
    
    /**
     * è·å–é•¿URL
     */
    public String getLongUrl(String shortCode) {
        // 1. ä»Redisè·å–
        String cacheKey = "short_url:" + shortCode;
        String longUrl = redisTemplate.opsForValue().get(cacheKey);
        
        if (longUrl != null) {
            // å¼‚æ­¥è®°å½•è®¿é—®
            recordAccess(shortCode);
            return longUrl;
        }
        
        // 2. ä»æ•°æ®åº“è·å–
        ShortUrl shortUrl = shortUrlRepository.findByShortCode(shortCode);
        if (shortUrl == null) {
            throw new NotFoundException("çŸ­é“¾ä¸å­˜åœ¨");
        }
        
        // 3. å›å†™ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, shortUrl.getLongUrl(), 7, TimeUnit.DAYS);
        
        // 4. è®°å½•è®¿é—®
        recordAccess(shortCode);
        
        return shortUrl.getLongUrl();
    }
    
    /**
     * ç”ŸæˆçŸ­ç ï¼ˆBase62ç¼–ç ï¼‰
     */
    private String generateShortCode() {
        // ä½¿ç”¨é›ªèŠ±ç®—æ³•ç”Ÿæˆå”¯ä¸€ID
        long id = SnowflakeIdGenerator.nextId();
        
        // Base62ç¼–ç 
        StringBuilder sb = new StringBuilder();
        while (id > 0) {
            sb.append(BASE62.charAt((int) (id % 62)));
            id /= 62;
        }
        
        return sb.reverse().toString();
    }
    
    /**
     * è®°å½•è®¿é—®ï¼ˆå¼‚æ­¥ï¼‰
     */
    private void recordAccess(String shortCode) {
        AccessLog log = new AccessLog();
        log.setShortCode(shortCode);
        log.setAccessTime(System.currentTimeMillis());
        log.setIp(getClientIp());
        log.setUserAgent(getUserAgent());
        
        // å‘é€åˆ°Kafka
        kafkaTemplate.send("short-url-access", JSON.toJSONString(log));
    }
}

/**
 * æ•°æ®åº“è¡¨è®¾è®¡
 */
CREATE TABLE short_url (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL UNIQUE,
    long_url VARCHAR(2048) NOT NULL,
    create_time DATETIME NOT NULL,
    expire_time DATETIME,
    INDEX idx_short_code (short_code),
    INDEX idx_long_url (long_url(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE access_log (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    short_code VARCHAR(10) NOT NULL,
    access_time BIGINT NOT NULL,
    ip VARCHAR(50),
    user_agent VARCHAR(500),
    INDEX idx_short_code_time (short_code, access_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```
1. æ€§èƒ½ä¼˜åŒ–
   - Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
   - ä½¿ç”¨CDNåŠ é€Ÿè·³è½¬
   - æ•°æ®åº“è¯»å†™åˆ†ç¦»
   
2. é«˜å¯ç”¨
   - å¤šæœºæˆ¿éƒ¨ç½²
   - æ•°æ®åº“ä¸»ä»å¤åˆ¶
   - Redisé›†ç¾¤
   
3. æ‰©å±•æ€§
   - æ°´å¹³æ‰©å±•åº”ç”¨æœåŠ¡å™¨
   - æ•°æ®åº“åˆ†åº“åˆ†è¡¨
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
   
4. å®‰å…¨æ€§
   - é˜²æ­¢æ¶æ„ç”ŸæˆçŸ­é“¾
   - é™æµé˜²åˆ·
   - é»‘åå•æœºåˆ¶
```

---

### 2. è®¾è®¡åˆ†å¸ƒå¼IDç”Ÿæˆå™¨

#### éœ€æ±‚åˆ†æ

```
åŠŸèƒ½éœ€æ±‚ï¼š
1. ç”Ÿæˆå…¨å±€å”¯ä¸€ID
2. IDè¶‹åŠ¿é€’å¢
3. é«˜æ€§èƒ½ï¼ˆ10ä¸‡QPSï¼‰

éåŠŸèƒ½éœ€æ±‚ï¼š
- é«˜å¯ç”¨ï¼ˆ99.99%ï¼‰
- ä½å»¶è¿Ÿï¼ˆ<1msï¼‰
- å¯æ‰©å±•
```

#### æ–¹æ¡ˆå¯¹æ¯”

```java
/**
 * æ–¹æ¡ˆ1ï¼šæ•°æ®åº“è‡ªå¢ID
 * @author erik.zhou
 */
// ä¼˜ç‚¹ï¼šç®€å•ã€IDé€’å¢
// ç¼ºç‚¹ï¼šæ€§èƒ½å·®ã€å•ç‚¹æ•…éšœã€æ‰©å±•å›°éš¾

CREATE TABLE id_generator (
    id BIGINT PRIMARY KEY AUTO_INCREMENT
) ENGINE=InnoDB;

/**
 * æ–¹æ¡ˆ2ï¼šUUID
 * @author erik.zhou
 */
String id = UUID.randomUUID().toString();
// ä¼˜ç‚¹ï¼šç®€å•ã€æ€§èƒ½å¥½ã€æ— å•ç‚¹
// ç¼ºç‚¹ï¼šæ— åºã€å ç”¨ç©ºé—´å¤§ã€ä¸é€‚åˆåšä¸»é”®

/**
 * æ–¹æ¡ˆ3ï¼šRedisè‡ªå¢
 * @author erik.zhou
 */
Long id = redisTemplate.opsForValue().increment("id_generator");
// ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ã€IDé€’å¢
// ç¼ºç‚¹ï¼šä¾èµ–Redisã€éœ€è¦æŒä¹…åŒ–

/**
 * æ–¹æ¡ˆ4ï¼šé›ªèŠ±ç®—æ³•ï¼ˆæ¨èï¼‰
 * @author erik.zhou
 */
public class SnowflakeIdGenerator {
    
    // 64ä½IDç»“æ„ï¼š
    // 1ä½ç¬¦å·ä½ + 41ä½æ—¶é—´æˆ³ + 10ä½æœºå™¨ID + 12ä½åºåˆ—å·
    
    private final long workerId;
    private final long datacenterId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    // æ—¶é—´æˆ³å 41ä½ï¼Œå¯ç”¨69å¹´
    private final long twepoch = 1609459200000L;  // 2021-01-01
    
    // æœºå™¨IDå 10ä½ï¼Œæœ€å¤š1024å°æœºå™¨
    private final long workerIdBits = 5L;
    private final long datacenterIdBits = 5L;
    private final long maxWorkerId = -1L ^ (-1L << workerIdBits);
    private final long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);
    
    // åºåˆ—å·å 12ä½ï¼Œæ¯æ¯«ç§’æœ€å¤š4096ä¸ªID
    private final long sequenceBits = 12L;
    private final long sequenceMask = -1L ^ (-1L << sequenceBits);
    
    private final long workerIdShift = sequenceBits;
    private final long datacenterIdShift = sequenceBits + workerIdBits;
    private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;
    
    public SnowflakeIdGenerator(long workerId, long datacenterId) {
        if (workerId > maxWorkerId || workerId < 0) {
            throw new IllegalArgumentException("worker Id can't be greater than " + maxWorkerId + " or less than 0");
        }
        if (datacenterId > maxDatacenterId || datacenterId < 0) {
            throw new IllegalArgumentException("datacenter Id can't be greater than " + maxDatacenterId + " or less than 0");
        }
        this.workerId = workerId;
        this.datacenterId = datacenterId;
    }
    
    /**
     * ç”ŸæˆID
     */
    public synchronized long nextId() {
        long timestamp = timeGen();
        
        // æ—¶é’Ÿå›æ‹¨
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("Clock moved backwards");
        }
        
        // åŒä¸€æ¯«ç§’å†…
        if (lastTimestamp == timestamp) {
            sequence = (sequence + 1) & sequenceMask;
            // åºåˆ—å·æº¢å‡º
            if (sequence == 0) {
                timestamp = tilNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        // ç»„è£…ID
        return ((timestamp - twepoch) << timestampLeftShift)
            | (datacenterId << datacenterIdShift)
            | (workerId << workerIdShift)
            | sequence;
    }
    
    private long tilNextMillis(long lastTimestamp) {
        long timestamp = timeGen();
        while (timestamp <= lastTimestamp) {
            timestamp = timeGen();
        }
        return timestamp;
    }
    
    private long timeGen() {
        return System.currentTimeMillis();
    }
}

// ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ã€IDé€’å¢ã€æ— å•ç‚¹
// ç¼ºç‚¹ï¼šä¾èµ–æ—¶é’Ÿã€éœ€è¦åˆ†é…æœºå™¨ID
```

---

### 3. è®¾è®¡é™æµç³»ç»Ÿ

#### é™æµç®—æ³•

```java
/**
 * é™æµç®—æ³•å®ç°
 * @author erik.zhou
 */

/**
 * 1. å›ºå®šçª—å£ç®—æ³•
 */
public class FixedWindowRateLimiter {
    
    private final int limit;
    private final AtomicInteger counter = new AtomicInteger(0);
    private long windowStart = System.currentTimeMillis();
    
    public FixedWindowRateLimiter(int limit) {
        this.limit = limit;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        
        // æ–°çª—å£
        if (now - windowStart >= 1000) {
            counter.set(0);
            windowStart = now;
        }
        
        // æ£€æŸ¥é™æµ
        if (counter.get() < limit) {
            counter.incrementAndGet();
            return true;
        }
        
        return false;
    }
}

/**
 * 2. æ»‘åŠ¨çª—å£ç®—æ³•
 */
public class SlidingWindowRateLimiter {
    
    private final int limit;
    private final Queue<Long> timestamps = new LinkedList<>();
    
    public SlidingWindowRateLimiter(int limit) {
        this.limit = limit;
    }
    
    public synchronized boolean tryAcquire() {
        long now = System.currentTimeMillis();
        long windowStart = now - 1000;
        
        // ç§»é™¤è¿‡æœŸæ—¶é—´æˆ³
        while (!timestamps.isEmpty() && timestamps.peek() <= windowStart) {
            timestamps.poll();
        }
        
        // æ£€æŸ¥é™æµ
        if (timestamps.size() < limit) {
            timestamps.offer(now);
            return true;
        }
        
        return false;
    }
}

/**
 * 3. ä»¤ç‰Œæ¡¶ç®—æ³•
 */
public class TokenBucketRateLimiter {
    
    private final int capacity;  // æ¡¶å®¹é‡
    private final int rate;      // ä»¤ç‰Œç”Ÿæˆé€Ÿç‡
    private int tokens;          // å½“å‰ä»¤ç‰Œæ•°
    private long lastRefillTime; // ä¸Šæ¬¡è¡¥å……æ—¶é—´
    
    public TokenBucketRateLimiter(int capacity, int rate) {
        this.capacity = capacity;
        this.rate = rate;
        this.tokens = capacity;
        this.lastRefillTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        refill();
        
        if (tokens > 0) {
            tokens--;
            return true;
        }
        
        return false;
    }
    
    private void refill() {
        long now = System.currentTimeMillis();
        long elapsedTime = now - lastRefillTime;
        
        // è®¡ç®—æ–°å¢ä»¤ç‰Œæ•°
        int newTokens = (int) (elapsedTime * rate / 1000);
        
        if (newTokens > 0) {
            tokens = Math.min(capacity, tokens + newTokens);
            lastRefillTime = now;
        }
    }
}

/**
 * 4. æ¼æ¡¶ç®—æ³•
 */
public class LeakyBucketRateLimiter {
    
    private final int capacity;  // æ¡¶å®¹é‡
    private final int rate;      // æ¼å‡ºé€Ÿç‡
    private int water;           // å½“å‰æ°´é‡
    private long lastLeakTime;   // ä¸Šæ¬¡æ¼æ°´æ—¶é—´
    
    public LeakyBucketRateLimiter(int capacity, int rate) {
        this.capacity = capacity;
        this.rate = rate;
        this.water = 0;
        this.lastLeakTime = System.currentTimeMillis();
    }
    
    public synchronized boolean tryAcquire() {
        leak();
        
        if (water < capacity) {
            water++;
            return true;
        }
        
        return false;
    }
    
    private void leak() {
        long now = System.currentTimeMillis();
        long elapsedTime = now - lastLeakTime;
        
        // è®¡ç®—æ¼å‡ºçš„æ°´é‡
        int leaked = (int) (elapsedTime * rate / 1000);
        
        if (leaked > 0) {
            water = Math.max(0, water - leaked);
            lastLeakTime = now;
        }
    }
}
```

#### åˆ†å¸ƒå¼é™æµ

```java
/**
 * Redisåˆ†å¸ƒå¼é™æµ
 * @author erik.zhou
 */
@Component
public class RedisRateLimiter {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ»‘åŠ¨çª—å£é™æµï¼ˆLuaè„šæœ¬ï¼‰
     */
    public boolean tryAcquire(String key, int limit, int windowSize) {
        String script =
            "local key = KEYS[1]\n" +
            "local limit = tonumber(ARGV[1])\n" +
            "local window = tonumber(ARGV[2])\n" +
            "local now = tonumber(ARGV[3])\n" +
            "local windowStart = now - window\n" +
            "\n" +
            "-- åˆ é™¤è¿‡æœŸæ•°æ®\n" +
            "redis.call('zremrangebyscore', key, 0, windowStart)\n" +
            "\n" +
            "-- è·å–å½“å‰æ•°é‡\n" +
            "local count = redis.call('zcard', key)\n" +
            "\n" +
            "if count < limit then\n" +
            "  redis.call('zadd', key, now, now)\n" +
            "  redis.call('expire', key, window)\n" +
            "  return 1\n" +
            "else\n" +
            "  return 0\n" +
            "end";
        
        Long result = redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            limit,
            windowSize,
            System.currentTimeMillis()
        );
        
        return result != null && result == 1;
    }
}
```

---

## ğŸ“ é«˜é¢‘é¢è¯•é¢˜

### 1. å¦‚ä½•è®¾è®¡ä¸€ä¸ªç§’æ€ç³»ç»Ÿï¼Ÿ

```
å…³é”®ç‚¹ï¼š
1. é«˜å¹¶å‘å¤„ç†
   - å‰ç«¯é™æµï¼ˆæŒ‰é’®ç½®ç°ã€éªŒè¯ç ï¼‰
   - ç½‘å…³é™æµ
   - æœåŠ¡é™æµ
   
2. åº“å­˜æ‰£å‡
   - Redisé¢„æ‰£åº“å­˜
   - æ•°æ®åº“æœ€ç»ˆæ‰£å‡
   - é˜²æ­¢è¶…å–
   
3. è®¢å•å¤„ç†
   - å¼‚æ­¥ä¸‹å•
   - æ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°
   
4. ç¼“å­˜ä¼˜åŒ–
   - å•†å“ä¿¡æ¯ç¼“å­˜
   - åº“å­˜ç¼“å­˜
   - å¤šçº§ç¼“å­˜
```

### 2. å¦‚ä½•è®¾è®¡ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Ÿ

```
å…³é”®ç‚¹ï¼š
1. æ¶ˆæ¯å­˜å‚¨
   - ç£ç›˜é¡ºåºå†™
   - å†…å­˜æ˜ å°„æ–‡ä»¶
   - åˆ†æ®µå­˜å‚¨
   
2. æ¶ˆæ¯å¯é æ€§
   - ç”Ÿäº§è€…ç¡®è®¤
   - æ¶ˆè´¹è€…ç¡®è®¤
   - æ¶ˆæ¯æŒä¹…åŒ–
   
3. é«˜å¯ç”¨
   - ä¸»ä»å¤åˆ¶
   - é›†ç¾¤éƒ¨ç½²
   - æ•…éšœè½¬ç§»
   
4. æ€§èƒ½ä¼˜åŒ–
   - æ‰¹é‡å‘é€
   - é›¶æ‹·è´
   - å¼‚æ­¥åˆ·ç›˜
```

### 3. å¦‚ä½•è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ç¼“å­˜ï¼Ÿ

```
å…³é”®ç‚¹ï¼š
1. æ•°æ®åˆ†ç‰‡
   - ä¸€è‡´æ€§å“ˆå¸Œ
   - è™šæ‹ŸèŠ‚ç‚¹
   
2. æ•°æ®ä¸€è‡´æ€§
   - ç¼“å­˜æ›´æ–°ç­–ç•¥
   - ç¼“å­˜å¤±æ•ˆç­–ç•¥
   
3. é«˜å¯ç”¨
   - ä¸»ä»å¤åˆ¶
   - å“¨å…µæ¨¡å¼
   - é›†ç¾¤æ¨¡å¼
   
4. ç¼“å­˜é—®é¢˜
   - ç¼“å­˜ç©¿é€
   - ç¼“å­˜å‡»ç©¿
   - ç¼“å­˜é›ªå´©
```

---

## ğŸ“ æ€»ç»“

### è®¾è®¡åŸåˆ™

1. **å¯æ‰©å±•æ€§** - ç³»ç»Ÿèƒ½å¤Ÿæ°´å¹³æ‰©å±•
2. **é«˜å¯ç”¨æ€§** - ç³»ç»Ÿæ•…éšœæ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤
3. **é«˜æ€§èƒ½** - æ»¡è¶³æ€§èƒ½è¦æ±‚
4. **ä¸€è‡´æ€§** - æ•°æ®ä¸€è‡´æ€§ä¿è¯
5. **å®‰å…¨æ€§** - ç³»ç»Ÿå®‰å…¨é˜²æŠ¤

### é¢è¯•æŠ€å·§

1. **éœ€æ±‚æ¾„æ¸…** - å…ˆé—®æ¸…æ¥šéœ€æ±‚
2. **ä»ç®€åˆ°ç¹** - å…ˆè®¾è®¡ç®€å•æ–¹æ¡ˆï¼Œå†ä¼˜åŒ–
3. **æƒè¡¡å–èˆ** - è¯´æ˜ä¸åŒæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹
4. **æ•°æ®ä¼°ç®—** - ä¼°ç®—QPSã€å­˜å‚¨ã€å¸¦å®½
5. **ç”»å›¾è¯´æ˜** - ç”¨å›¾è¡¨è¾¾æ¸…æ¥šæ¶æ„

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

# Jenkins å®Œæ•´æ•™ç¨‹

## ğŸ“‹ ç›®å½•
- [æŠ€æœ¯æ¦‚è¿°](#æŠ€æœ¯æ¦‚è¿°)
- [å­¦ä¹ ç›®æ ‡](#å­¦ä¹ ç›®æ ‡)
- [åŸºç¡€æ¦‚å¿µ](#åŸºç¡€æ¦‚å¿µ)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [å®æˆ˜åº”ç”¨](#å®æˆ˜åº”ç”¨)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [ç›¸å…³èµ„æº](#ç›¸å…³èµ„æº)

## ğŸ“š æŠ€æœ¯æ¦‚è¿°

- **ç‰ˆæœ¬**: Jenkins 2.440+ (LTS)
- **å®˜æ–¹æ–‡æ¡£**: https://www.jenkins.io/doc/
- **GitHub**: https://github.com/jenkinsci/jenkins
- **å­¦ä¹ éš¾åº¦**: â­â­â­ (1-5æ˜Ÿ)
- **é‡è¦ç¨‹åº¦**: â­â­â­â­â­ (1-5æ˜Ÿ)
- **å‰ç½®çŸ¥è¯†**: 
  - JavaåŸºç¡€
  - LinuxåŸºç¡€å‘½ä»¤
  - Gitç‰ˆæœ¬æ§åˆ¶
  - Maven/Gradleæ„å»ºå·¥å…·
  - Shellè„šæœ¬åŸºç¡€

### ä»€ä¹ˆæ˜¯Jenkins

Jenkinsæ˜¯é¢†å…ˆçš„å¼€æºè‡ªåŠ¨åŒ–æœåŠ¡å™¨ï¼Œä½¿ç”¨Javaæ„å»ºã€‚å®ƒæä¾›è¶…è¿‡2000ä¸ªæ’ä»¶æ¥æ”¯æŒå‡ ä¹ä»»ä½•è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œè®©äººç±»å¯ä»¥ä¸“æ³¨äºæœºå™¨æ— æ³•å®Œæˆçš„å·¥ä½œã€‚Jenkinsæ˜¯å®ç°æŒç»­é›†æˆ(CI)å’ŒæŒç»­äº¤ä»˜(CD)çš„æ ¸å¿ƒå·¥å…·ã€‚

### æ ¸å¿ƒä»·å€¼

1. **è‡ªåŠ¨åŒ–æ„å»º**: è‡ªåŠ¨ç¼–è¯‘ã€æµ‹è¯•ã€æ‰“åŒ…åº”ç”¨ç¨‹åº
2. **æŒç»­é›†æˆ**: é¢‘ç¹é›†æˆä»£ç å˜æ›´ï¼Œå¿«é€Ÿå‘ç°é—®é¢˜
3. **æŒç»­äº¤ä»˜**: è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹ï¼Œå¿«é€Ÿäº¤ä»˜ä»·å€¼
4. **å¯æ‰©å±•æ€§**: ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ
5. **åˆ†å¸ƒå¼æ„å»º**: æ”¯æŒä¸»ä»æ¶æ„ï¼Œæ¨ªå‘æ‰©å±•

### åº”ç”¨åœºæ™¯

- è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•Java/Python/Node.jsç­‰é¡¹ç›®
- å®ç°CI/CDæµæ°´çº¿ï¼Œè‡ªåŠ¨éƒ¨ç½²åˆ°å„ç§ç¯å¢ƒ
- å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼ˆæ•°æ®å¤‡ä»½ã€æŠ¥è¡¨ç”Ÿæˆç­‰ï¼‰
- ä»£ç è´¨é‡æ£€æŸ¥å’Œå®‰å…¨æ‰«æ
- å¤šç¯å¢ƒéƒ¨ç½²ç®¡ç†ï¼ˆå¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ï¼‰

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] ç†è§£Jenkinsçš„æ¶æ„å’Œå·¥ä½œåŸç†
- [ ] æŒæ¡Jenkinsçš„å®‰è£…å’ŒåŸºç¡€é…ç½®
- [ ] ç†Ÿç»ƒä½¿ç”¨Freestyle Jobå’ŒPipeline
- [ ] æŒæ¡Jenkinsfileçš„ç¼–å†™
- [ ] ç†è§£åˆ†å¸ƒå¼æ„å»ºå’ŒAgentç®¡ç†
- [ ] æŒæ¡å¸¸ç”¨æ’ä»¶çš„ä½¿ç”¨
- [ ] äº†è§£Jenkinsçš„å®‰å…¨é…ç½®
- [ ] æŒæ¡CI/CDæœ€ä½³å®è·µ


## ğŸ“– åŸºç¡€æ¦‚å¿µ

### 1.1 Jenkinsæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Jenkins Master                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Web UI      â”‚  â”‚  Jobç®¡ç†     â”‚  â”‚  æ’ä»¶ç³»ç»Ÿ    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  è°ƒåº¦å™¨      â”‚  â”‚  æ„å»ºé˜Ÿåˆ—    â”‚  â”‚  å®‰å…¨ç®¡ç†    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Agent 1     â”‚  â”‚  Agent 2     â”‚  â”‚  Agent 3     â”‚
â”‚  (Linux)     â”‚  â”‚  (Windows)   â”‚  â”‚  (Docker)    â”‚
â”‚  ExecutorÃ—2  â”‚  â”‚  ExecutorÃ—4  â”‚  â”‚  ExecutorÃ—2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç»„ä»¶**:
- **Master**: è°ƒåº¦æ„å»ºã€åˆ†å‘ä»»åŠ¡ã€ç›‘æ§Agentã€æä¾›Webç•Œé¢
- **Agent/Slave**: æ‰§è¡ŒMasteråˆ†é…çš„æ„å»ºä»»åŠ¡
- **Executor**: Agentä¸Šçš„æ‰§è¡Œæ§½ä½ï¼Œå†³å®šå¹¶å‘æ„å»ºæ•°
- **Job/Project**: æ„å»ºä»»åŠ¡çš„é…ç½®å•å…ƒ
- **Build**: Jobçš„ä¸€æ¬¡æ‰§è¡Œå®ä¾‹
- **Workspace**: æ„å»ºæ—¶çš„å·¥ä½œç›®å½•

### 1.2 æ ¸å¿ƒæ¦‚å¿µ

**Jobç±»å‹**:
- **Freestyle Project**: ä¼ ç»Ÿçš„è‡ªç”±é£æ ¼é¡¹ç›®ï¼Œé€šè¿‡UIé…ç½®
- **Pipeline**: ä½¿ç”¨ä»£ç å®šä¹‰çš„æµæ°´çº¿é¡¹ç›®
- **Multi-configuration Project**: å¤šé…ç½®é¡¹ç›®ï¼Œç”¨äºçŸ©é˜µæ„å»º
- **Folder**: ç»„ç»‡å’Œç®¡ç†Jobçš„æ–‡ä»¶å¤¹
- **Multibranch Pipeline**: è‡ªåŠ¨ä¸ºæ¯ä¸ªåˆ†æ”¯åˆ›å»ºPipeline

**æ„å»ºè§¦å‘å™¨**:
- **SCMè½®è¯¢**: å®šæœŸæ£€æŸ¥ä»£ç ä»“åº“å˜æ›´
- **Webhook**: Gitä»“åº“æ¨é€æ—¶è§¦å‘
- **å®šæ—¶æ„å»º**: æŒ‰Cronè¡¨è¾¾å¼å®šæ—¶æ‰§è¡Œ
- **ä¸Šæ¸¸é¡¹ç›®è§¦å‘**: ä¾èµ–é¡¹ç›®æ„å»ºå®Œæˆåè§¦å‘
- **æ‰‹åŠ¨è§¦å‘**: ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ„å»º

**æ„å»ºå‚æ•°**:
- **String Parameter**: å­—ç¬¦ä¸²å‚æ•°
- **Boolean Parameter**: å¸ƒå°”å‚æ•°
- **Choice Parameter**: é€‰æ‹©å‚æ•°
- **File Parameter**: æ–‡ä»¶å‚æ•°
- **Password Parameter**: å¯†ç å‚æ•°

### 1.3 Pipelineæ¦‚å¿µ

**Pipelineç±»å‹**:
1. **Declarative Pipeline**: å£°æ˜å¼ï¼Œç»“æ„åŒ–ï¼Œæ¨èä½¿ç”¨
2. **Scripted Pipeline**: è„šæœ¬å¼ï¼Œæ›´çµæ´»ï¼ŒåŸºäºGroovy

**Pipelineç»“æ„**:
```groovy
pipeline {
    agent any              // åœ¨å“ªé‡Œæ‰§è¡Œ
    stages {              // é˜¶æ®µå®šä¹‰
        stage('Build') {  // å•ä¸ªé˜¶æ®µ
            steps {       // æ­¥éª¤
                // æ‰§è¡Œå‘½ä»¤
            }
        }
    }
}
```


## ğŸ”¥ æ ¸å¿ƒç‰¹æ€§

### 2.1 Pipelineå³ä»£ç  ğŸ”¥

Pipelineå³ä»£ç æ˜¯Jenkinsæœ€æ ¸å¿ƒçš„ç‰¹æ€§ï¼Œé€šè¿‡Jenkinsfileå°†æ„å»ºæµç¨‹ä»£ç åŒ–ã€‚

**Declarative Pipelineç¤ºä¾‹**:
```groovy
pipeline {
    agent any
    
    environment {
        MAVEN_HOME = '/usr/local/maven'
        JAVA_HOME = '/usr/local/jdk11'
    }
    
    parameters {
        string(name: 'BRANCH', defaultValue: 'main', description: 'Gitåˆ†æ”¯')
        choice(name: 'ENVIRONMENT', choices: ['dev', 'test', 'prod'], description: 'éƒ¨ç½²ç¯å¢ƒ')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'è·³è¿‡æµ‹è¯•')
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: "${params.BRANCH}", 
                    url: 'https://github.com/myorg/myrepo.git',
                    credentialsId: 'github-credentials'
            }
        }
        
        stage('Build') {
            steps {
                sh """
                    mvn clean package \
                    -DskipTests=${params.SKIP_TESTS} \
                    -Dmaven.test.failure.ignore=true
                """
            }
        }
        
        stage('Test') {
            when {
                expression { params.SKIP_TESTS == false }
            }
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    if (params.ENVIRONMENT == 'prod') {
                        input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ?', ok: 'éƒ¨ç½²'
                    }
                }
                sh """
                    scp target/*.jar user@${params.ENVIRONMENT}-server:/opt/app/
                    ssh user@${params.ENVIRONMENT}-server 'systemctl restart myapp'
                """
            }
        }
    }
    
    post {
        success {
            echo 'æ„å»ºæˆåŠŸï¼'
            emailext subject: "æ„å»ºæˆåŠŸ: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                     body: "æ„å»ºæˆåŠŸï¼ŒæŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}",
                     to: 'team@example.com'
        }
        failure {
            echo 'æ„å»ºå¤±è´¥ï¼'
            emailext subject: "æ„å»ºå¤±è´¥: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                     body: "æ„å»ºå¤±è´¥ï¼ŒæŸ¥çœ‹è¯¦æƒ…: ${env.BUILD_URL}",
                     to: 'team@example.com'
        }
    }
}
```

**Scripted Pipelineç¤ºä¾‹**:
```groovy
node {
    try {
        stage('Checkout') {
            checkout scm
        }
        
        stage('Build') {
            sh 'mvn clean package'
        }
        
        stage('Test') {
            sh 'mvn test'
        }
        
        stage('Deploy') {
            if (env.BRANCH_NAME == 'main') {
                sh 'kubectl apply -f k8s/'
            }
        }
        
        currentBuild.result = 'SUCCESS'
    } catch (Exception e) {
        currentBuild.result = 'FAILURE'
        throw e
    } finally {
        // æ¸…ç†å·¥ä½œ
        cleanWs()
    }
}
```


### 2.2 åˆ†å¸ƒå¼æ„å»º ğŸ”¥ (âš ï¸ éš¾ç‚¹)

åˆ†å¸ƒå¼æ„å»ºæ˜¯Jenkinsæ‰©å±•èƒ½åŠ›çš„å…³é”®ï¼Œé€šè¿‡Master-Agentæ¶æ„å®ç°è´Ÿè½½åˆ†æ‹…ã€‚

**Agenté…ç½®æ–¹å¼**:

1. **SSH Agent** (æ¨è):
```java
import hudson.model.*;
import hudson.slaves.*;
import jenkins.model.Jenkins;

public class AgentManager {
    public void createSSHAgent() throws IOException {
        Jenkins jenkins = Jenkins.get();
        
        // åˆ›å»ºSSHè¿æ¥çš„Agent
        DumbSlave sshAgent = new DumbSlave(
            "linux-agent-01",           // Agentåç§°
            "/opt/jenkins",             // è¿œç¨‹å·¥ä½œç›®å½•
            new SSHLauncher(
                "192.168.1.100",        // ä¸»æœºåœ°å€
                22,                     // SSHç«¯å£
                "jenkins-ssh-key",      // å‡­æ®ID
                null,                   // JVMé€‰é¡¹
                null,                   // Javaè·¯å¾„
                null,                   // å¯åŠ¨å‰ç¼€å‘½ä»¤
                null                    // å¯åŠ¨åç¼€å‘½ä»¤
            )
        );
        
        sshAgent.setNumExecutors(4);                    // æ‰§è¡Œå™¨æ•°é‡
        sshAgent.setLabelString("linux maven java11");  // æ ‡ç­¾
        sshAgent.setMode(Node.Mode.NORMAL);             // ä½¿ç”¨æ¨¡å¼
        
        jenkins.addNode(sshAgent);
        jenkins.save();
    }
}
```

2. **JNLP Agent** (é€‚ç”¨äºDocker):
```java
public void createJNLPAgent() throws IOException {
    Jenkins jenkins = Jenkins.get();
    
    DumbSlave agent = new DumbSlave(
        "docker-agent-01",
        "/home/jenkins/agent",
        new JNLPLauncher(true)  // Java Web Startå¯åŠ¨å™¨
    );
    
    agent.setNumExecutors(2);
    agent.setLabelString("docker linux x64");
    agent.setMode(Node.Mode.NORMAL);
    agent.setRetentionStrategy(new RetentionStrategy.Always());
    
    // æ·»åŠ ç¯å¢ƒå˜é‡
    EnvironmentVariablesNodeProperty envProp = 
        new EnvironmentVariablesNodeProperty(
            new EnvironmentVariablesNodeProperty.Entry(
                "DOCKER_HOST", "unix:///var/run/docker.sock"
            )
        );
    agent.getNodeProperties().add(envProp);
    
    jenkins.addNode(agent);
    jenkins.save();
}
```

**åœ¨Pipelineä¸­ä½¿ç”¨Agent**:
```groovy
pipeline {
    agent none  // ä¸ä½¿ç”¨é»˜è®¤agent
    
    stages {
        stage('Build on Linux') {
            agent {
                label 'linux && maven'  // ä½¿ç”¨æ ‡ç­¾é€‰æ‹©agent
            }
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('Build on Docker') {
            agent {
                docker {
                    image 'maven:3.8-jdk-11'
                    label 'docker'
                    args '-v /root/.m2:/root/.m2'
                }
            }
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('Build on Kubernetes') {
            agent {
                kubernetes {
                    yaml '''
                        apiVersion: v1
                        kind: Pod
                        spec:
                          containers:
                          - name: maven
                            image: maven:3.8-jdk-11
                            command: ['cat']
                            tty: true
                    '''
                }
            }
            steps {
                container('maven') {
                    sh 'mvn clean package'
                }
            }
        }
    }
}
```

**Agentç®¡ç†**:
```java
public void manageAgents() {
    Jenkins jenkins = Jenkins.get();
    
    // åˆ—å‡ºæ‰€æœ‰èŠ‚ç‚¹
    List<Node> nodes = jenkins.getNodes();
    for (Node node : nodes) {
        Computer computer = node.toComputer();
        
        if (computer != null) {
            String name = node.getNodeName();
            boolean online = computer.isOnline();
            boolean idle = computer.isIdle();
            int executors = computer.getExecutors().size();
            
            System.out.println(String.format(
                "Node: %s, Online: %s, Idle: %s, Executors: %d",
                name, online, idle, executors
            ));
            
            // ä¸´æ—¶ä¸‹çº¿èŠ‚ç‚¹ï¼ˆç»´æŠ¤ï¼‰
            if (online) {
                computer.setTemporarilyOffline(true, 
                    new OfflineCause.UserCause(User.current(), "ç»´æŠ¤ä¸­"));
            }
            
            // æ¢å¤åœ¨çº¿
            computer.setTemporarilyOffline(false, null);
        }
    }
    
    // åˆ é™¤èŠ‚ç‚¹
    Node nodeToRemove = jenkins.getNode("old-agent");
    if (nodeToRemove != null) {
        jenkins.removeNode(nodeToRemove);
    }
}
```


### 2.3 æ’ä»¶ç³»ç»Ÿ ğŸ”¥

Jenkinsæ‹¥æœ‰è¶…è¿‡2000ä¸ªæ’ä»¶ï¼Œæå¤§æ‰©å±•äº†å…¶åŠŸèƒ½ã€‚

**å¸¸ç”¨æ’ä»¶åˆ†ç±»**:

1. **æºç ç®¡ç†æ’ä»¶**:
   - Git Plugin: Gité›†æˆ
   - GitHub Plugin: GitHubé›†æˆ
   - GitLab Plugin: GitLabé›†æˆ
   - Subversion Plugin: SVNé›†æˆ

2. **æ„å»ºå·¥å…·æ’ä»¶**:
   - Maven Integration: Mavené¡¹ç›®æ„å»º
   - Gradle Plugin: Gradleé¡¹ç›®æ„å»º
   - NodeJS Plugin: Node.jsé¡¹ç›®æ„å»º
   - Docker Plugin: Dockeré•œåƒæ„å»º

3. **éƒ¨ç½²æ’ä»¶**:
   - Deploy to container: éƒ¨ç½²åˆ°Tomcatç­‰å®¹å™¨
   - Kubernetes Plugin: éƒ¨ç½²åˆ°K8s
   - SSH Plugin: SSHè¿œç¨‹éƒ¨ç½²
   - Ansible Plugin: Ansibleè‡ªåŠ¨åŒ–éƒ¨ç½²

4. **é€šçŸ¥æ’ä»¶**:
   - Email Extension: é‚®ä»¶é€šçŸ¥
   - Slack Notification: Slacké€šçŸ¥
   - DingTalk Plugin: é’‰é’‰é€šçŸ¥
   - WeChat Plugin: ä¼ä¸šå¾®ä¿¡é€šçŸ¥

5. **ä»£ç è´¨é‡æ’ä»¶**:
   - SonarQube Scanner: ä»£ç è´¨é‡åˆ†æ
   - Checkstyle Plugin: ä»£ç é£æ ¼æ£€æŸ¥
   - FindBugs Plugin: Bugæ£€æµ‹
   - JaCoCo Plugin: ä»£ç è¦†ç›–ç‡

6. **å®‰å…¨æ’ä»¶**:
   - Role-based Authorization: åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶
   - LDAP Plugin: LDAPè®¤è¯
   - Active Directory Plugin: ADåŸŸè®¤è¯
   - OWASP Dependency-Check: ä¾èµ–å®‰å…¨æ£€æŸ¥

**æ’ä»¶ä½¿ç”¨ç¤ºä¾‹**:
```groovy
pipeline {
    agent any
    
    stages {
        stage('Code Quality') {
            steps {
                // SonarQubeä»£ç æ‰«æ
                withSonarQubeEnv('SonarQube') {
                    sh 'mvn sonar:sonar'
                }
                
                // ç­‰å¾…è´¨é‡é—¨æ£€æŸ¥
                timeout(time: 10, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                // OWASPä¾èµ–æ£€æŸ¥
                dependencyCheck additionalArguments: '--format HTML --format XML',
                                odcInstallation: 'OWASP-DC'
                
                // å‘å¸ƒæŠ¥å‘Š
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }
        
        stage('Deploy to K8s') {
            steps {
                // Kuberneteséƒ¨ç½²
                kubernetesDeploy(
                    configs: 'k8s/*.yaml',
                    kubeconfigId: 'k8s-config',
                    enableConfigSubstitution: true
                )
            }
        }
        
        stage('Notify') {
            steps {
                // é’‰é’‰é€šçŸ¥
                dingtalk(
                    robot: 'jenkins-robot',
                    type: 'MARKDOWN',
                    title: "æ„å»ºé€šçŸ¥: ${env.JOB_NAME}",
                    text: [
                        "### æ„å»ºä¿¡æ¯",
                        "- é¡¹ç›®: ${env.JOB_NAME}",
                        "- æ„å»ºå·: ${env.BUILD_NUMBER}",
                        "- çŠ¶æ€: ${currentBuild.result}",
                        "- è¯¦æƒ…: [æŸ¥çœ‹](${env.BUILD_URL})"
                    ]
                )
            }
        }
    }
}
```

### 2.4 å‡­æ®ç®¡ç†

Jenkinsæä¾›å®‰å…¨çš„å‡­æ®ç®¡ç†æœºåˆ¶ï¼Œé¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç æ•æ„Ÿä¿¡æ¯ã€‚

**å‡­æ®ç±»å‹**:
- **Username with password**: ç”¨æˆ·åå¯†ç 
- **SSH Username with private key**: SSHç§é’¥
- **Secret text**: å¯†é’¥æ–‡æœ¬
- **Secret file**: å¯†é’¥æ–‡ä»¶
- **Certificate**: è¯ä¹¦

**åœ¨Pipelineä¸­ä½¿ç”¨å‡­æ®**:
```groovy
pipeline {
    agent any
    
    stages {
        stage('Use Credentials') {
            steps {
                // ä½¿ç”¨ç”¨æˆ·åå¯†ç 
                withCredentials([
                    usernamePassword(
                        credentialsId: 'docker-hub',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )
                ]) {
                    sh '''
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
                        docker push myimage:latest
                    '''
                }
                
                // ä½¿ç”¨SSHå¯†é’¥
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'deploy-key',
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )
                ]) {
                    sh '''
                        ssh -i $SSH_KEY $SSH_USER@server 'bash deploy.sh'
                    '''
                }
                
                // ä½¿ç”¨å¯†é’¥æ–‡æœ¬
                withCredentials([
                    string(credentialsId: 'api-token', variable: 'API_TOKEN')
                ]) {
                    sh '''
                        curl -H "Authorization: Bearer $API_TOKEN" https://api.example.com
                    '''
                }
            }
        }
    }
}
```


### 2.5 Multibranch Pipeline (âš ï¸ éš¾ç‚¹)

Multibranch Pipelineè‡ªåŠ¨ä¸ºGitä»“åº“çš„æ¯ä¸ªåˆ†æ”¯åˆ›å»ºç‹¬ç«‹çš„Pipelineã€‚

**é…ç½®Multibranch Pipeline**:
```groovy
// Jenkinsfileåœ¨ä»£ç ä»“åº“æ ¹ç›®å½•
pipeline {
    agent any
    
    stages {
        stage('Branch Info') {
            steps {
                script {
                    echo "å½“å‰åˆ†æ”¯: ${env.BRANCH_NAME}"
                    echo "å˜æ›´ä½œè€…: ${env.CHANGE_AUTHOR}"
                    echo "å˜æ›´æ ‡é¢˜: ${env.CHANGE_TITLE}"
                }
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
        
        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                script {
                    def env = (env.BRANCH_NAME == 'main') ? 'prod' : 'dev'
                    sh "kubectl apply -f k8s/${env}/"
                }
            }
        }
    }
}
```

**åˆ†æ”¯ç­–ç•¥é…ç½®**:
```groovy
// åœ¨Jenkins UIä¸­é…ç½®æˆ–ä½¿ç”¨Job DSL
multibranchPipelineJob('my-multibranch-pipeline') {
    branchSources {
        git {
            id('my-repo')
            remote('https://github.com/myorg/myrepo.git')
            credentialsId('github-credentials')
            
            // åˆ†æ”¯å‘ç°ç­–ç•¥
            traits {
                // å‘ç°æ‰€æœ‰åˆ†æ”¯
                gitBranchDiscovery()
                
                // å‘ç°PR
                gitHubPullRequestDiscovery {
                    strategyId(1) // åˆå¹¶åçš„ä»£ç 
                }
                
                // å¿½ç•¥ç‰¹å®šåˆ†æ”¯
                headWildcardFilter {
                    includes('main develop feature/* release/*')
                    excludes('hotfix/*')
                }
            }
        }
    }
    
    // è§¦å‘å™¨
    triggers {
        periodic(1) // æ¯åˆ†é’Ÿæ‰«æä¸€æ¬¡
    }
    
    // å­¤å„¿é¡¹ç›®ç­–ç•¥
    orphanedItemStrategy {
        discardOldItems {
            numToKeep(10)
        }
    }
}
```

### 2.6 å…±äº«åº“ (âš ï¸ éš¾ç‚¹)

å…±äº«åº“å…è®¸åœ¨å¤šä¸ªPipelineä¹‹é—´å¤ç”¨ä»£ç ã€‚

**å…±äº«åº“ç»“æ„**:
```
jenkins-shared-library/
â”œâ”€â”€ vars/                    # å…¨å±€å˜é‡ï¼ˆå¯ç›´æ¥åœ¨Pipelineä¸­è°ƒç”¨ï¼‰
â”‚   â”œâ”€â”€ buildJava.groovy
â”‚   â”œâ”€â”€ deployK8s.groovy
â”‚   â””â”€â”€ notifyDingTalk.groovy
â”œâ”€â”€ src/                     # ç±»åº“ï¼ˆéœ€è¦importï¼‰
â”‚   â””â”€â”€ org/
â”‚       â””â”€â”€ mycompany/
â”‚           â””â”€â”€ jenkins/
â”‚               â”œâ”€â”€ Builder.groovy
â”‚               â””â”€â”€ Deployer.groovy
â””â”€â”€ resources/               # èµ„æºæ–‡ä»¶
    â””â”€â”€ templates/
        â””â”€â”€ Dockerfile
```

**vars/buildJava.groovy**:
```groovy
// å…¨å±€å˜é‡ï¼Œå¯ç›´æ¥è°ƒç”¨
def call(Map config) {
    pipeline {
        agent any
        
        stages {
            stage('Checkout') {
                steps {
                    git url: config.gitUrl, branch: config.branch
                }
            }
            
            stage('Build') {
                steps {
                    sh """
                        mvn clean package \
                        -DskipTests=${config.skipTests ?: false}
                    """
                }
            }
            
            stage('Test') {
                when {
                    expression { !config.skipTests }
                }
                steps {
                    sh 'mvn test'
                    junit '**/target/surefire-reports/*.xml'
                }
            }
        }
    }
}
```

**ä½¿ç”¨å…±äº«åº“**:
```groovy
@Library('jenkins-shared-library@main') _

// ç›´æ¥è°ƒç”¨varsä¸­çš„æ–¹æ³•
buildJava(
    gitUrl: 'https://github.com/myorg/myrepo.git',
    branch: 'main',
    skipTests: false
)

// æˆ–è€…åœ¨Pipelineä¸­ä½¿ç”¨
pipeline {
    agent any
    
    stages {
        stage('Build') {
            steps {
                script {
                    // ä½¿ç”¨å…±äº«åº“ä¸­çš„ç±»
                    def builder = new org.mycompany.jenkins.Builder()
                    builder.build('maven')
                }
            }
        }
        
        stage('Deploy') {
            steps {
                // ä½¿ç”¨varsä¸­çš„æ–¹æ³•
                deployK8s(
                    namespace: 'production',
                    deployment: 'myapp'
                )
            }
        }
        
        stage('Notify') {
            steps {
                notifyDingTalk(
                    robot: 'jenkins-robot',
                    message: "éƒ¨ç½²å®Œæˆ: ${env.JOB_NAME}"
                )
            }
        }
    }
}
```


## ğŸ’» å®æˆ˜åº”ç”¨

### 3.1 ç¯å¢ƒæ­å»º

**Dockeræ–¹å¼å®‰è£…ï¼ˆæ¨èï¼‰**:
```bash
# æ‹‰å–Jenkinsé•œåƒ
docker pull jenkins/jenkins:lts

# åˆ›å»ºæ•°æ®å·
docker volume create jenkins_home

# å¯åŠ¨Jenkinså®¹å™¨
docker run -d \
  --name jenkins \
  -p 8080:8080 \
  -p 50000:50000 \
  -v jenkins_home:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  jenkins/jenkins:lts

# æŸ¥çœ‹åˆå§‹ç®¡ç†å‘˜å¯†ç 
docker exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
```

**Linuxç³»ç»Ÿå®‰è£…**:
```bash
# CentOS/RHEL
sudo wget -O /etc/yum.repos.d/jenkins.repo \
    https://pkg.jenkins.io/redhat-stable/jenkins.repo
sudo rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io.key
sudo yum install jenkins java-11-openjdk-devel
sudo systemctl start jenkins
sudo systemctl enable jenkins

# Ubuntu/Debian
wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -
sudo sh -c 'echo deb https://pkg.jenkins.io/debian-stable binary/ > \
    /etc/apt/sources.list.d/jenkins.list'
sudo apt-get update
sudo apt-get install jenkins
sudo systemctl start jenkins
sudo systemctl enable jenkins
```

**åˆå§‹åŒ–é…ç½®**:
1. è®¿é—® http://localhost:8080
2. è¾“å…¥åˆå§‹ç®¡ç†å‘˜å¯†ç 
3. å®‰è£…æ¨èæ’ä»¶æˆ–è‡ªé€‰æ’ä»¶
4. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
5. é…ç½®Jenkins URL

### 3.2 å¿«é€Ÿå¼€å§‹ - Freestyle Job

**åˆ›å»ºç®€å•çš„Mavenæ„å»ºä»»åŠ¡**:

1. æ–°å»ºä»»åŠ¡ â†’ Freestyle project
2. æºç ç®¡ç† â†’ Git
   - Repository URL: https://github.com/myorg/myrepo.git
   - Credentials: æ·»åŠ GitHubå‡­æ®
   - Branch: */main

3. æ„å»ºè§¦å‘å™¨
   - â˜‘ GitHub hook trigger for GITScm polling

4. æ„å»ºç¯å¢ƒ
   - â˜‘ Delete workspace before build starts

5. æ„å»ºæ­¥éª¤ â†’ Invoke top-level Maven targets
   - Goals: clean package
   - Properties: -DskipTests=false

6. æ„å»ºåæ“ä½œ
   - Archive the artifacts: target/*.jar
   - Publish JUnit test result report: **/target/surefire-reports/*.xml
   - E-mail Notification: team@example.com

### 3.3 è¿›é˜¶æ¡ˆä¾‹ - å®Œæ•´CI/CD Pipeline

**Spring Bootåº”ç”¨çš„å®Œæ•´CI/CDæµç¨‹**:

```groovy
@Library('jenkins-shared-library') _

pipeline {
    agent any
    
    environment {
        // ç¯å¢ƒå˜é‡
        DOCKER_REGISTRY = 'registry.example.com'
        APP_NAME = 'spring-boot-app'
        K8S_NAMESPACE = 'production'
        SONAR_HOST = 'http://sonarqube:9000'
    }
    
    parameters {
        choice(name: 'DEPLOY_ENV', choices: ['dev', 'test', 'prod'], description: 'éƒ¨ç½²ç¯å¢ƒ')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'è·³è¿‡æµ‹è¯•')
        booleanParam(name: 'DEPLOY_ENABLED', defaultValue: true, description: 'æ˜¯å¦éƒ¨ç½²')
    }
    
    options {
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // ç¦æ­¢å¹¶å‘æ„å»º
        disableConcurrentBuilds()
        // è¶…æ—¶æ—¶é—´
        timeout(time: 30, unit: 'MINUTES')
        // æ·»åŠ æ—¶é—´æˆ³
        timestamps()
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "æ£€å‡ºä»£ç : ${env.GIT_BRANCH}"
                }
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                script {
                    echo "å¼€å§‹æ„å»º..."
                }
                sh '''
                    mvn clean package \
                    -DskipTests=${SKIP_TESTS} \
                    -Dmaven.test.failure.ignore=true
                '''
            }
        }
        
        stage('Unit Test') {
            when {
                expression { params.SKIP_TESTS == false }
            }
            steps {
                sh 'mvn test'
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    jacoco(
                        execPattern: '**/target/jacoco.exec',
                        classPattern: '**/target/classes',
                        sourcePattern: '**/src/main/java'
                    )
                }
            }
        }
        
        stage('Code Quality') {
            steps {
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        mvn sonar:sonar \
                        -Dsonar.projectKey=${APP_NAME} \
                        -Dsonar.host.url=${SONAR_HOST}
                    '''
                }
                
                timeout(time: 10, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('Security Scan') {
            parallel {
                stage('Dependency Check') {
                    steps {
                        dependencyCheck additionalArguments: '--format HTML --format XML',
                                        odcInstallation: 'OWASP-DC'
                        dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
                    }
                }
                
                stage('Docker Image Scan') {
                    steps {
                        sh '''
                            trivy image --severity HIGH,CRITICAL \
                            ${DOCKER_REGISTRY}/${APP_NAME}:${BUILD_NUMBER}
                        '''
                    }
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.withRegistry("https://${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        def customImage = docker.build("${APP_NAME}:${BUILD_NUMBER}")
                        customImage.push()
                        customImage.push('latest')
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { params.DEPLOY_ENABLED == true }
            }
            steps {
                script {
                    if (params.DEPLOY_ENV == 'prod') {
                        input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ?', ok: 'éƒ¨ç½²', submitter: 'admin'
                    }
                    
                    // ä½¿ç”¨Kubernetesæ’ä»¶éƒ¨ç½²
                    kubernetesDeploy(
                        configs: "k8s/${params.DEPLOY_ENV}/*.yaml",
                        kubeconfigId: 'k8s-config',
                        enableConfigSubstitution: true
                    )
                    
                    // ç­‰å¾…éƒ¨ç½²å®Œæˆ
                    sh """
                        kubectl rollout status deployment/${APP_NAME} \
                        -n ${K8S_NAMESPACE} \
                        --timeout=5m
                    """
                }
            }
        }
        
        stage('Smoke Test') {
            when {
                expression { params.DEPLOY_ENABLED == true }
            }
            steps {
                script {
                    def serviceUrl = sh(
                        script: "kubectl get svc ${APP_NAME} -n ${K8S_NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].ip}'",
                        returnStdout: true
                    ).trim()
                    
                    sh """
                        curl -f http://${serviceUrl}/actuator/health || exit 1
                    """
                }
            }
        }
    }
    
    post {
        success {
            script {
                notifyDingTalk(
                    robot: 'jenkins-robot',
                    type: 'MARKDOWN',
                    title: "âœ… æ„å»ºæˆåŠŸ",
                    text: [
                        "### æ„å»ºä¿¡æ¯",
                        "- é¡¹ç›®: ${env.JOB_NAME}",
                        "- æ„å»ºå·: ${env.BUILD_NUMBER}",
                        "- åˆ†æ”¯: ${env.GIT_BRANCH}",
                        "- ç¯å¢ƒ: ${params.DEPLOY_ENV}",
                        "- çŠ¶æ€: æˆåŠŸ âœ…",
                        "- è¯¦æƒ…: [æŸ¥çœ‹](${env.BUILD_URL})"
                    ]
                )
            }
        }
        
        failure {
            script {
                notifyDingTalk(
                    robot: 'jenkins-robot',
                    type: 'MARKDOWN',
                    title: "âŒ æ„å»ºå¤±è´¥",
                    text: [
                        "### æ„å»ºä¿¡æ¯",
                        "- é¡¹ç›®: ${env.JOB_NAME}",
                        "- æ„å»ºå·: ${env.BUILD_NUMBER}",
                        "- åˆ†æ”¯: ${env.GIT_BRANCH}",
                        "- çŠ¶æ€: å¤±è´¥ âŒ",
                        "- è¯¦æƒ…: [æŸ¥çœ‹](${env.BUILD_URL}console)"
                    ]
                )
            }
        }
        
        always {
            // æ¸…ç†å·¥ä½œç©ºé—´
            cleanWs()
        }
    }
}
```


### 3.4 REST APIä½¿ç”¨

Jenkinsæä¾›å®Œæ•´çš„REST APIç”¨äºè‡ªåŠ¨åŒ–ç®¡ç†ã€‚

**è§¦å‘æ„å»º**:
```bash
# è§¦å‘æ— å‚æ•°æ„å»º
curl -X POST -u username:token \
  http://jenkins.example.com/job/my-project/build

# è§¦å‘å¸¦å‚æ•°æ„å»º
curl -X POST -u username:token \
  --data "BRANCH=main&ENVIRONMENT=prod" \
  http://jenkins.example.com/job/my-project/buildWithParameters

# ä½¿ç”¨JSONå‚æ•°
curl -X POST -u username:token \
  --data-urlencode 'json={"parameter": [{"name":"BRANCH", "value":"main"}]}' \
  http://jenkins.example.com/job/my-project/buildWithParameters
```

**æŸ¥è¯¢æ„å»ºçŠ¶æ€**:
```bash
# è·å–æœ€åä¸€æ¬¡æ„å»ºçŠ¶æ€
curl -s -u username:token \
  "http://jenkins.example.com/job/my-project/lastBuild/api/json?tree=building,result"

# è·å–ç‰¹å®šæ„å»ºçš„è¯¦ç»†ä¿¡æ¯
curl -s -u username:token \
  "http://jenkins.example.com/job/my-project/123/api/json"

# è·å–æ„å»ºæ—¥å¿—
curl -s -u username:token \
  "http://jenkins.example.com/job/my-project/123/consoleText"
```

**åœæ­¢æ„å»º**:
```bash
curl -X POST -u username:token \
  http://jenkins.example.com/job/my-project/123/stop
```

**CLIå·¥å…·ä½¿ç”¨**:
```bash
# ä¸‹è½½CLIå®¢æˆ·ç«¯
wget http://jenkins.example.com/jnlpJars/jenkins-cli.jar

# æ„å»ºä»»åŠ¡
java -jar jenkins-cli.jar -s http://jenkins.example.com/ \
  -auth username:token build my-project -s -v

# å¸¦å‚æ•°æ„å»º
java -jar jenkins-cli.jar -s http://jenkins.example.com/ \
  -auth username:token build my-project -p BRANCH=main -p ENV=prod

# åˆ›å»ºä»»åŠ¡
cat job-config.xml | java -jar jenkins-cli.jar -s http://jenkins.example.com/ \
  -auth username:token create-job new-project

# åˆ—å‡ºæ‰€æœ‰ä»»åŠ¡
java -jar jenkins-cli.jar -s http://jenkins.example.com/ \
  -auth username:token list-jobs
```


## âœ¨ æœ€ä½³å®è·µ

### 4.1 Pipelineæœ€ä½³å®è·µ

**1. ä½¿ç”¨Declarative Pipeline**:
```groovy
// âœ… æ¨èï¼šå£°æ˜å¼Pipelineï¼Œç»“æ„æ¸…æ™°
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
    }
}

// âŒ ä¸æ¨èï¼šè„šæœ¬å¼Pipelineï¼Œé™¤ééœ€è¦å¤æ‚é€»è¾‘
node {
    stage('Build') {
        sh 'mvn clean package'
    }
}
```

**2. ä½¿ç”¨å…±äº«åº“å¤ç”¨ä»£ç **:
```groovy
// âœ… æ¨èï¼šä½¿ç”¨å…±äº«åº“
@Library('jenkins-shared-library') _
buildJava(gitUrl: 'https://github.com/myorg/myrepo.git')

// âŒ ä¸æ¨èï¼šåœ¨æ¯ä¸ªPipelineä¸­é‡å¤ä»£ç 
pipeline {
    // å¤§é‡é‡å¤çš„æ„å»ºé€»è¾‘...
}
```

**3. åˆç†ä½¿ç”¨å¹¶è¡Œæ„å»º**:
```groovy
// âœ… æ¨èï¼šç‹¬ç«‹ä»»åŠ¡å¹¶è¡Œæ‰§è¡Œ
stage('Tests') {
    parallel {
        stage('Unit Tests') {
            steps { sh 'mvn test' }
        }
        stage('Integration Tests') {
            steps { sh 'mvn verify' }
        }
        stage('Security Scan') {
            steps { sh 'trivy scan' }
        }
    }
}
```

**4. ä½¿ç”¨whenæ¡ä»¶æ§åˆ¶æ‰§è¡Œ**:
```groovy
// âœ… æ¨èï¼šä½¿ç”¨whenæ¡ä»¶
stage('Deploy to Prod') {
    when {
        allOf {
            branch 'main'
            expression { currentBuild.result == 'SUCCESS' }
        }
    }
    steps {
        sh 'kubectl apply -f k8s/prod/'
    }
}
```

**5. åˆç†è®¾ç½®è¶…æ—¶**:
```groovy
// âœ… æ¨èï¼šè®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
options {
    timeout(time: 30, unit: 'MINUTES')
}

stage('Long Running Task') {
    options {
        timeout(time: 10, unit: 'MINUTES')
    }
    steps {
        sh 'long-running-command'
    }
}
```

### 4.2 æ€§èƒ½ä¼˜åŒ–

**1. ä½¿ç”¨å¢é‡æ„å»º**:
```groovy
// Mavenå¢é‡æ„å»º
sh 'mvn clean package -T 4 -Dmaven.test.skip=true'

// Gradleå¢é‡æ„å»º
sh './gradlew build --build-cache --parallel'
```

**2. ç¼“å­˜ä¾èµ–**:
```groovy
// Dockeræ„å»ºç¼“å­˜
docker.build("myapp:${BUILD_NUMBER}", "--cache-from myapp:latest .")

// Mavenæœ¬åœ°ä»“åº“ç¼“å­˜
agent {
    docker {
        image 'maven:3.8-jdk-11'
        args '-v /root/.m2:/root/.m2'
    }
}
```

**3. åˆç†åˆ†é…Agentèµ„æº**:
```groovy
// âœ… æ¨èï¼šæ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©Agent
stage('Build') {
    agent {
        label 'linux && maven && high-memory'
    }
    steps {
        sh 'mvn clean package'
    }
}

// âŒ ä¸æ¨èï¼šæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨Masterä¸Šæ‰§è¡Œ
agent { label 'master' }
```

**4. æ¸…ç†å·¥ä½œç©ºé—´**:
```groovy
// âœ… æ¨èï¼šæ„å»ºåæ¸…ç†
post {
    always {
        cleanWs()
    }
}

// æˆ–è€…æ„å»ºå‰æ¸…ç†
options {
    skipDefaultCheckout()
}
stages {
    stage('Checkout') {
        steps {
            cleanWs()
            checkout scm
        }
    }
}
```

### 4.3 å®‰å…¨æœ€ä½³å®è·µ

**1. ä½¿ç”¨å‡­æ®ç®¡ç†**:
```groovy
// âœ… æ¨èï¼šä½¿ç”¨å‡­æ®ç®¡ç†
withCredentials([
    usernamePassword(credentialsId: 'docker-hub', 
                     usernameVariable: 'USER', 
                     passwordVariable: 'PASS')
]) {
    sh 'echo $PASS | docker login -u $USER --password-stdin'
}

// âŒ ä¸æ¨èï¼šç¡¬ç¼–ç å¯†ç 
sh 'docker login -u myuser -p mypassword'
```

**2. é™åˆ¶Pipelineæƒé™**:
```groovy
// ä½¿ç”¨@NonCPSæ³¨è§£é™åˆ¶Groovyä»£ç æ‰§è¡Œ
@NonCPS
def parseJson(String json) {
    return new groovy.json.JsonSlurper().parseText(json)
}

// ä½¿ç”¨Script Securityæ’ä»¶å®¡æ‰¹è„šæœ¬
```

**3. å®¡è®¡å’Œæ—¥å¿—**:
```groovy
// è®°å½•å…³é”®æ“ä½œ
stage('Deploy') {
    steps {
        script {
            echo "éƒ¨ç½²æ“ä½œç”± ${env.BUILD_USER} è§¦å‘"
            echo "éƒ¨ç½²ç¯å¢ƒ: ${params.ENVIRONMENT}"
            echo "éƒ¨ç½²æ—¶é—´: ${new Date()}"
        }
        sh 'kubectl apply -f k8s/'
    }
}
```

**4. ä½¿ç”¨RBACæƒé™æ§åˆ¶**:
- å®‰è£…Role-based Authorization Strategyæ’ä»¶
- ä¸ºä¸åŒå›¢é˜Ÿåˆ›å»ºä¸åŒè§’è‰²
- æœ€å°æƒé™åŸåˆ™ï¼šåªæˆäºˆå¿…è¦çš„æƒé™
- å®šæœŸå®¡æŸ¥æƒé™é…ç½®

### 4.4 å¸¸è§é™·é˜±

**âš ï¸ é™·é˜±1ï¼šåœ¨Pipelineä¸­ä½¿ç”¨ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡**
```groovy
// âŒ é”™è¯¯ï¼šä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡
def myObject = new SomeNonSerializableClass()
stage('Use Object') {
    steps {
        script {
            myObject.doSomething()  // å¯èƒ½å¯¼è‡´åºåˆ—åŒ–é”™è¯¯
        }
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨@NonCPSæˆ–é¿å…è·¨stageä½¿ç”¨
@NonCPS
def processData(data) {
    def obj = new SomeNonSerializableClass()
    return obj.process(data)
}
```

**âš ï¸ é™·é˜±2ï¼šå¿˜è®°æ¸…ç†å·¥ä½œç©ºé—´**
```groovy
// âŒ é”™è¯¯ï¼šä¸æ¸…ç†å·¥ä½œç©ºé—´ï¼Œç£ç›˜ç©ºé—´è€—å°½
pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                sh 'mvn clean package'
            }
        }
    }
}

// âœ… æ­£ç¡®ï¼šå®šæœŸæ¸…ç†
post {
    always {
        cleanWs()
    }
}
```

**âš ï¸ é™·é˜±3ï¼šAgentæ ‡ç­¾é…ç½®é”™è¯¯**
```groovy
// âŒ é”™è¯¯ï¼šæ ‡ç­¾ä¸å­˜åœ¨æˆ–æ‹¼å†™é”™è¯¯
agent {
    label 'linuxx'  // æ‹¼å†™é”™è¯¯
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ­£ç¡®çš„æ ‡ç­¾
agent {
    label 'linux && docker'
}
```

**âš ï¸ é™·é˜±4ï¼šå¿½ç•¥æ„å»ºå¤±è´¥**
```groovy
// âŒ é”™è¯¯ï¼šå¿½ç•¥é”™è¯¯ç»§ç»­æ‰§è¡Œ
sh 'mvn test || true'

// âœ… æ­£ç¡®ï¼šæ­£ç¡®å¤„ç†é”™è¯¯
script {
    try {
        sh 'mvn test'
    } catch (Exception e) {
        currentBuild.result = 'UNSTABLE'
        echo "æµ‹è¯•å¤±è´¥: ${e.message}"
    }
}
```


## â“ å¸¸è§é—®é¢˜

### Q1: Jenkinsæ„å»ºé€Ÿåº¦æ…¢æ€ä¹ˆä¼˜åŒ–ï¼Ÿ

**A**: å¤šæ–¹é¢ä¼˜åŒ–ç­–ç•¥ï¼š

1. **ä½¿ç”¨åˆ†å¸ƒå¼æ„å»º**:
   - æ·»åŠ å¤šä¸ªAgentèŠ‚ç‚¹
   - åˆç†åˆ†é…æ„å»ºä»»åŠ¡åˆ°ä¸åŒAgent
   - ä½¿ç”¨æ ‡ç­¾ç®¡ç†Agent

2. **å¯ç”¨æ„å»ºç¼“å­˜**:
   ```groovy
   // Mavenæœ¬åœ°ä»“åº“ç¼“å­˜
   agent {
       docker {
           image 'maven:3.8-jdk-11'
           args '-v $HOME/.m2:/root/.m2'
       }
   }
   
   // Dockeré•œåƒç¼“å­˜
   sh 'docker build --cache-from myapp:latest -t myapp:${BUILD_NUMBER} .'
   ```

3. **å¹¶è¡Œæ„å»º**:
   ```groovy
   stage('Tests') {
       parallel {
           stage('Unit') { steps { sh 'mvn test' } }
           stage('Integration') { steps { sh 'mvn verify' } }
       }
   }
   ```

4. **å¢é‡æ„å»º**:
   ```bash
   # Mavenå¤šçº¿ç¨‹æ„å»º
   mvn clean package -T 4
   
   # Gradleå¢é‡æ„å»º
   ./gradlew build --build-cache
   ```

### Q2: å¦‚ä½•å®ç°Jenkinsçš„é«˜å¯ç”¨ï¼Ÿ

**A**: é«˜å¯ç”¨æ–¹æ¡ˆï¼š

1. **ä¸»å¤‡æ¨¡å¼**:
   - ä½¿ç”¨å…±äº«å­˜å‚¨ï¼ˆNFS/EFSï¼‰å­˜å‚¨JENKINS_HOME
   - é…ç½®ä¸»å¤‡Jenkinså®ä¾‹
   - ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨åˆ‡æ¢

2. **ä½¿ç”¨Jenkins Configuration as Code (JCasC)**:
   ```yaml
   # jenkins.yaml
   jenkins:
     systemMessage: "Jenkins configured automatically by JCasC"
     numExecutors: 2
     securityRealm:
       local:
         allowsSignup: false
         users:
           - id: "admin"
             password: "${ADMIN_PASSWORD}"
     authorizationStrategy:
       globalMatrix:
         permissions:
           - "Overall/Administer:admin"
   ```

3. **å®šæœŸå¤‡ä»½**:
   ```bash
   # å¤‡ä»½è„šæœ¬
   #!/bin/bash
   JENKINS_HOME=/var/lib/jenkins
   BACKUP_DIR=/backup/jenkins
   DATE=$(date +%Y%m%d_%H%M%S)
   
   # åœæ­¢Jenkins
   systemctl stop jenkins
   
   # å¤‡ä»½
   tar -czf ${BACKUP_DIR}/jenkins_${DATE}.tar.gz ${JENKINS_HOME}
   
   # å¯åŠ¨Jenkins
   systemctl start jenkins
   
   # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
   find ${BACKUP_DIR} -name "jenkins_*.tar.gz" -mtime +7 -delete
   ```

### Q3: Pipelineä¸­å¦‚ä½•å¤„ç†æ•æ„Ÿä¿¡æ¯ï¼Ÿ

**A**: ä½¿ç”¨å‡­æ®ç®¡ç†ï¼š

```groovy
pipeline {
    agent any
    
    stages {
        stage('Deploy') {
            steps {
                // æ–¹å¼1ï¼šä½¿ç”¨withCredentials
                withCredentials([
                    string(credentialsId: 'api-key', variable: 'API_KEY'),
                    usernamePassword(
                        credentialsId: 'db-credentials',
                        usernameVariable: 'DB_USER',
                        passwordVariable: 'DB_PASS'
                    )
                ]) {
                    sh '''
                        curl -H "Authorization: Bearer $API_KEY" https://api.example.com
                        mysql -u $DB_USER -p$DB_PASS < schema.sql
                    '''
                }
                
                // æ–¹å¼2ï¼šä½¿ç”¨environment
                environment {
                    API_TOKEN = credentials('api-token')
                }
            }
        }
    }
}
```

### Q4: å¦‚ä½•è°ƒè¯•Pipelineè„šæœ¬ï¼Ÿ

**A**: è°ƒè¯•æŠ€å·§ï¼š

1. **ä½¿ç”¨echoè¾“å‡ºè°ƒè¯•ä¿¡æ¯**:
   ```groovy
   script {
       echo "å½“å‰åˆ†æ”¯: ${env.BRANCH_NAME}"
       echo "æ„å»ºå·: ${env.BUILD_NUMBER}"
       echo "å‚æ•°å€¼: ${params.ENVIRONMENT}"
   }
   ```

2. **ä½¿ç”¨ReplayåŠŸèƒ½**:
   - åœ¨æ„å»ºå†å²ä¸­ç‚¹å‡»"Replay"
   - ä¿®æ”¹Pipelineè„šæœ¬
   - é‡æ–°è¿è¡Œæµ‹è¯•

3. **ä½¿ç”¨Blue OceanæŸ¥çœ‹å¯è§†åŒ–æµç¨‹**:
   - å®‰è£…Blue Oceanæ’ä»¶
   - æ›´ç›´è§‚åœ°æŸ¥çœ‹Pipelineæ‰§è¡Œæµç¨‹

4. **ä½¿ç”¨try-catchæ•è·é”™è¯¯**:
   ```groovy
   script {
       try {
           sh 'some-command'
       } catch (Exception e) {
           echo "é”™è¯¯: ${e.toString()}"
           echo "é”™è¯¯æ¶ˆæ¯: ${e.getMessage()}"
           currentBuild.result = 'FAILURE'
       }
   }
   ```

### Q5: Jenkinsç£ç›˜ç©ºé—´ä¸è¶³æ€ä¹ˆåŠï¼Ÿ

**A**: æ¸…ç†ç­–ç•¥ï¼š

1. **é…ç½®æ„å»ºä¿ç•™ç­–ç•¥**:
   ```groovy
   options {
       buildDiscarder(logRotator(
           numToKeepStr: '10',        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»º
           artifactNumToKeepStr: '5'  // ä¿ç•™æœ€è¿‘5æ¬¡æ„å»ºçš„åˆ¶å“
       ))
   }
   ```

2. **å®šæœŸæ¸…ç†å·¥ä½œç©ºé—´**:
   ```groovy
   post {
       always {
           cleanWs()
       }
   }
   ```

3. **æ¸…ç†Dockeré•œåƒ**:
   ```bash
   # æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
   docker system prune -a -f
   
   # å®šæœŸæ¸…ç†ï¼ˆæ·»åŠ åˆ°crontabï¼‰
   0 2 * * * docker system prune -a -f
   ```

4. **æ¸…ç†æ—§çš„æ„å»ºè®°å½•**:
   ```bash
   # æ¸…ç†30å¤©å‰çš„æ„å»º
   find /var/lib/jenkins/jobs/*/builds/ -type d -mtime +30 -exec rm -rf {} \;
   ```

### Q6: å¦‚ä½•å®ç°å¤šç¯å¢ƒéƒ¨ç½²ï¼Ÿ

**A**: å¤šç¯å¢ƒéƒ¨ç½²æ–¹æ¡ˆï¼š

```groovy
pipeline {
    agent any
    
    parameters {
        choice(name: 'ENVIRONMENT', 
               choices: ['dev', 'test', 'staging', 'prod'], 
               description: 'éƒ¨ç½²ç¯å¢ƒ')
    }
    
    stages {
        stage('Deploy') {
            steps {
                script {
                    // æ ¹æ®ç¯å¢ƒåŠ è½½ä¸åŒé…ç½®
                    def config = [
                        'dev': [
                            'namespace': 'dev',
                            'replicas': 1,
                            'resources': 'small'
                        ],
                        'test': [
                            'namespace': 'test',
                            'replicas': 2,
                            'resources': 'medium'
                        ],
                        'prod': [
                            'namespace': 'production',
                            'replicas': 5,
                            'resources': 'large'
                        ]
                    ]
                    
                    def envConfig = config[params.ENVIRONMENT]
                    
                    // ç”Ÿäº§ç¯å¢ƒéœ€è¦å®¡æ‰¹
                    if (params.ENVIRONMENT == 'prod') {
                        input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ?', 
                              ok: 'éƒ¨ç½²',
                              submitter: 'admin,ops'
                    }
                    
                    // éƒ¨ç½²
                    sh """
                        kubectl apply -f k8s/${params.ENVIRONMENT}/ \
                        --namespace=${envConfig.namespace}
                        
                        kubectl scale deployment myapp \
                        --replicas=${envConfig.replicas} \
                        --namespace=${envConfig.namespace}
                    """
                }
            }
        }
    }
}
```

### Q7: Pipelineæ‰§è¡Œè¶…æ—¶æ€ä¹ˆåŠï¼Ÿ

**A**: è¶…æ—¶å¤„ç†ï¼š

```groovy
pipeline {
    agent any
    
    options {
        // å…¨å±€è¶…æ—¶
        timeout(time: 1, unit: 'HOURS')
    }
    
    stages {
        stage('Long Running Task') {
            options {
                // å•ä¸ªstageè¶…æ—¶
                timeout(time: 30, unit: 'MINUTES')
            }
            steps {
                script {
                    // å•ä¸ªæ­¥éª¤è¶…æ—¶
                    timeout(time: 10, unit: 'MINUTES') {
                        sh 'long-running-command'
                    }
                }
            }
        }
    }
}
```

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹èµ„æº
- **å®˜æ–¹æ–‡æ¡£**: https://www.jenkins.io/doc/
- **Pipelineè¯­æ³•**: https://www.jenkins.io/doc/book/pipeline/syntax/
- **æ’ä»¶ä¸­å¿ƒ**: https://plugins.jenkins.io/
- **GitHubä»“åº“**: https://github.com/jenkinsci/jenkins
- **ç¤¾åŒºè®ºå›**: https://community.jenkins.io/

### æ¨èæ’ä»¶
- **Blue Ocean**: ç°ä»£åŒ–çš„Pipelineå¯è§†åŒ–ç•Œé¢
- **Pipeline**: Pipelineæ ¸å¿ƒæ’ä»¶
- **Git Plugin**: Gité›†æˆ
- **Docker Plugin**: Dockeré›†æˆ
- **Kubernetes Plugin**: Kubernetesé›†æˆ
- **SonarQube Scanner**: ä»£ç è´¨é‡åˆ†æ
- **Email Extension**: é‚®ä»¶é€šçŸ¥
- **Role-based Authorization**: åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

### å­¦ä¹ èµ„æº
- **Jenkinså®˜æ–¹æ•™ç¨‹**: https://www.jenkins.io/doc/tutorials/
- **Pipelineç¤ºä¾‹**: https://www.jenkins.io/doc/pipeline/examples/
- **æœ€ä½³å®è·µ**: https://www.jenkins.io/doc/book/pipeline/pipeline-best-practices/

### ç›¸å…³æŠ€æœ¯
- [GitLab CI/CDå®Œæ•´æ•™ç¨‹](GitLab-CI-CD-å®Œæ•´æ•™ç¨‹.md)
- [Dockerå®Œæ•´æ•™ç¨‹](../02-å®¹å™¨åŒ–/Docker-å®Œæ•´æ•™ç¨‹.md)
- [Kuberneteså®Œæ•´æ•™ç¨‹](../02-å®¹å™¨åŒ–/Kubernetes-å®Œæ•´æ•™ç¨‹.md)
- [Mavenå®Œæ•´æ•™ç¨‹](../../08-å¼€å‘å·¥å…·é“¾/01-æ„å»ºå·¥å…·/Maven-å®Œæ•´æ•™ç¨‹.md)
- [Gitå®Œæ•´æ•™ç¨‹](../../08-å¼€å‘å·¥å…·é“¾/02-ç‰ˆæœ¬æ§åˆ¶/Git-å®Œæ•´æ•™ç¨‹.md)

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] ç†è§£Jenkinsçš„Master-Agentæ¶æ„
- [ ] æŒæ¡Freestyle Jobçš„åˆ›å»ºå’Œé…ç½®
- [ ] ç†Ÿç»ƒç¼–å†™Declarative Pipeline
- [ ] ç†è§£Pipelineçš„å„ä¸ªç»„æˆéƒ¨åˆ†ï¼ˆagentã€stagesã€stepsã€postï¼‰
- [ ] æŒæ¡å¸¸ç”¨æ’ä»¶çš„ä½¿ç”¨
- [ ] ç†è§£åˆ†å¸ƒå¼æ„å»ºçš„é…ç½®å’Œä½¿ç”¨
- [ ] æŒæ¡å‡­æ®ç®¡ç†
- [ ] äº†è§£å…±äº«åº“çš„ä½¿ç”¨
- [ ] æŒæ¡Multibranch Pipeline
- [ ] ç†è§£Jenkinsçš„å®‰å…¨é…ç½®
- [ ] æŒæ¡CI/CDæœ€ä½³å®è·µ
- [ ] èƒ½å¤Ÿæ’æŸ¥å¸¸è§é—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-01  
**æ–‡æ¡£æ¥æº**: Jenkinså®˜æ–¹æ–‡æ¡£ + Context7  
**@author** erik.zhou

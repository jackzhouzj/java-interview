# åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ - å®Œæ•´æ•™ç¨‹

> æŒæ¡åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒç†è®ºå’Œå®è·µ
> 
> @author erik.zhou

## ğŸ“š æŠ€æœ¯æ¦‚è¿°

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **å­¦ä¹ éš¾åº¦** | â­â­â­â­â­ |
| **é‡è¦ç¨‹åº¦** | â­â­â­â­â­ |
| **é¢„è®¡æ—¶é•¿** | 50-70 å°æ—¶ |
| **å‰ç½®çŸ¥è¯†** | ç½‘ç»œç¼–ç¨‹ã€å¹¶å‘ç¼–ç¨‹ã€æ•°æ®åº“ |

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] ç†è§£ CAP å’Œ BASE ç†è®º
- [ ] æŒæ¡åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼ˆPaxosã€Raftï¼‰
- [ ] æŒæ¡åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
- [ ] ç†è§£åˆ†å¸ƒå¼é”çš„å®ç°
- [ ] æŒæ¡åˆ†å¸ƒå¼ ID ç”Ÿæˆæ–¹æ¡ˆ
- [ ] ç†è§£åˆ†å¸ƒå¼ Session ç®¡ç†
- [ ] èƒ½å¤Ÿè®¾è®¡é«˜å¯ç”¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿ

## ğŸ“– ç›®å½•

1. [åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º](#1-åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º)
2. [åˆ†å¸ƒå¼ä¸€è‡´æ€§](#2-åˆ†å¸ƒå¼ä¸€è‡´æ€§)
3. [åˆ†å¸ƒå¼äº‹åŠ¡](#3-åˆ†å¸ƒå¼äº‹åŠ¡)
4. [åˆ†å¸ƒå¼é”](#4-åˆ†å¸ƒå¼é”)
5. [åˆ†å¸ƒå¼ ID](#5-åˆ†å¸ƒå¼-id)
6. [åˆ†å¸ƒå¼ Session](#6-åˆ†å¸ƒå¼-session)
7. [åˆ†å¸ƒå¼ç¼“å­˜](#7-åˆ†å¸ƒå¼ç¼“å­˜)

---

## 1. åˆ†å¸ƒå¼ç³»ç»Ÿç†è®º

### 1.1 CAP ç†è®º ğŸ”¥

**CAP å®šç†**ï¼šä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸å¯èƒ½åŒæ—¶æ»¡è¶³ä»¥ä¸‹ä¸‰ä¸ªç‰¹æ€§ï¼š

```
C (Consistency)      - ä¸€è‡´æ€§
A (Availability)     - å¯ç”¨æ€§
P (Partition tolerance) - åˆ†åŒºå®¹é”™æ€§
```

**è¯¦ç»†è§£é‡Š**ï¼š

**ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰**
- æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çœ‹åˆ°ç›¸åŒçš„æ•°æ®
- å†™æ“ä½œå®Œæˆåï¼Œæ‰€æœ‰è¯»æ“ä½œéƒ½èƒ½è¯»åˆ°æœ€æ–°æ•°æ®
- ä¾‹å¦‚ï¼šé“¶è¡Œè½¬è´¦ï¼Œä½™é¢å¿…é¡»ä¸€è‡´

**å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰**
- ç³»ç»Ÿåœ¨åˆç†æ—¶é—´å†…è¿”å›ç»“æœ
- æ¯ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”ï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰
- ä¾‹å¦‚ï¼šç½‘ç«™è®¿é—®ï¼Œå¿…é¡»èƒ½å¤Ÿå“åº”

**åˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰**
- ç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºæ—¶ä»èƒ½ç»§ç»­å·¥ä½œ
- èŠ‚ç‚¹é—´é€šä¿¡å¤±è´¥ï¼Œç³»ç»Ÿä»èƒ½æä¾›æœåŠ¡
- ä¾‹å¦‚ï¼šæœºæˆ¿æ–­ç½‘ï¼Œç³»ç»Ÿä»èƒ½è¿è¡Œ

**CAP ç»„åˆé€‰æ‹©**ï¼š

| ç»„åˆ | è¯´æ˜ | å…¸å‹åº”ç”¨ |
|------|------|---------|
| **CP** | ä¿è¯ä¸€è‡´æ€§å’Œåˆ†åŒºå®¹é”™ï¼Œç‰ºç‰²å¯ç”¨æ€§ | ZooKeeperã€HBaseã€Redis Cluster |
| **AP** | ä¿è¯å¯ç”¨æ€§å’Œåˆ†åŒºå®¹é”™ï¼Œç‰ºç‰²ä¸€è‡´æ€§ | Cassandraã€DynamoDBã€Eureka |
| **CA** | ä¿è¯ä¸€è‡´æ€§å’Œå¯ç”¨æ€§ï¼Œä¸è€ƒè™‘åˆ†åŒº | å•æœºæ•°æ®åº“ï¼ˆMySQLã€PostgreSQLï¼‰ |

**æ³¨æ„**ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç½‘ç»œåˆ†åŒºæ˜¯å¿…ç„¶å­˜åœ¨çš„ï¼Œæ‰€ä»¥å®é™…ä¸Šæ˜¯åœ¨ CP å’Œ AP ä¹‹é—´é€‰æ‹©ã€‚

### 1.2 BASE ç†è®º ğŸ”¥

BASE æ˜¯å¯¹ CAP ä¸­ä¸€è‡´æ€§å’Œå¯ç”¨æ€§æƒè¡¡çš„ç»“æœï¼Œæ˜¯ AP æ–¹æ¡ˆçš„å»¶ä¼¸ã€‚

```
BA (Basically Available)    - åŸºæœ¬å¯ç”¨
S  (Soft state)             - è½¯çŠ¶æ€
E  (Eventually consistent)  - æœ€ç»ˆä¸€è‡´æ€§
```

**åŸºæœ¬å¯ç”¨ï¼ˆBasically Availableï¼‰**
- ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§
- å“åº”æ—¶é—´å¯ä»¥é€‚å½“å»¶é•¿
- åŠŸèƒ½å¯ä»¥é™çº§

**è½¯çŠ¶æ€ï¼ˆSoft stateï¼‰**
- å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨ä¸­é—´çŠ¶æ€
- ä¸­é—´çŠ¶æ€ä¸å½±å“ç³»ç»Ÿå¯ç”¨æ€§
- ä¾‹å¦‚ï¼šè®¢å•çŠ¶æ€ä»"å¾…æ”¯ä»˜"åˆ°"å·²æ”¯ä»˜"çš„è¿‡ç¨‹

**æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventually consistentï¼‰**
- ç³»ç»Ÿä¸­æ‰€æœ‰æ•°æ®å‰¯æœ¬ï¼Œç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæœ€ç»ˆèƒ½å¤Ÿè¾¾åˆ°ä¸€è‡´çŠ¶æ€
- ä¸éœ€è¦å®æ—¶ä¿è¯ä¸€è‡´æ€§
- ä¾‹å¦‚ï¼šå¾®åšç‚¹èµæ•°ï¼Œå¯ä»¥å»¶è¿Ÿæ›´æ–°

**BASE åº”ç”¨åœºæ™¯**ï¼š
- ç”µå•†è®¢å•ç³»ç»Ÿ
- ç¤¾äº¤ç½‘ç»œï¼ˆç‚¹èµã€è¯„è®ºï¼‰
- æ—¥å¿—æ”¶é›†ç³»ç»Ÿ
- æ•°æ®åˆ†æç³»ç»Ÿ

---

## 2. åˆ†å¸ƒå¼ä¸€è‡´æ€§

### 2.1 ä¸€è‡´æ€§çº§åˆ«

```
å¼ºä¸€è‡´æ€§ (Strong Consistency)
  â†“
é¡ºåºä¸€è‡´æ€§ (Sequential Consistency)
  â†“
å› æœä¸€è‡´æ€§ (Causal Consistency)
  â†“
æœ€ç»ˆä¸€è‡´æ€§ (Eventual Consistency)
  â†“
å¼±ä¸€è‡´æ€§ (Weak Consistency)
```

**å¼ºä¸€è‡´æ€§**
- ä»»ä½•æ—¶åˆ»ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®å®Œå…¨ä¸€è‡´
- å†™æ“ä½œå®Œæˆåï¼Œç«‹å³èƒ½è¯»åˆ°æœ€æ–°æ•°æ®
- å®ç°ï¼šåˆ†å¸ƒå¼é”ã€ä¸¤é˜¶æ®µæäº¤
- ä»£ä»·ï¼šæ€§èƒ½å·®ã€å¯ç”¨æ€§ä½

**æœ€ç»ˆä¸€è‡´æ€§**
- ç»è¿‡ä¸€æ®µæ—¶é—´åï¼Œæ‰€æœ‰èŠ‚ç‚¹æ•°æ®ä¸€è‡´
- å…è®¸çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´
- å®ç°ï¼šæ¶ˆæ¯é˜Ÿåˆ—ã€å¼‚æ­¥å¤åˆ¶
- ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½ã€å¯ç”¨æ€§é«˜

### 2.2 Paxos ç®—æ³•

**Paxos æ˜¯ä»€ä¹ˆï¼Ÿ**
- åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•
- è§£å†³åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å°±æŸä¸ªå€¼è¾¾æˆä¸€è‡´
- ç†è®ºåŸºç¡€ï¼Œä½†å®ç°å¤æ‚

**Paxos è§’è‰²**ï¼š
```
Proposer  - æè®®è€…ï¼ˆæå‡ºææ¡ˆï¼‰
Acceptor  - æ¥å—è€…ï¼ˆæ¥å—æˆ–æ‹’ç»ææ¡ˆï¼‰
Learner   - å­¦ä¹ è€…ï¼ˆå­¦ä¹ è¢«é€‰å®šçš„ææ¡ˆï¼‰
```

**Paxos æµç¨‹**ï¼š

```
é˜¶æ®µä¸€ï¼šPrepare
1. Proposer é€‰æ‹©ææ¡ˆç¼–å· nï¼Œå‘å¤šæ•° Acceptor å‘é€ Prepare(n)
2. Acceptor æ”¶åˆ° Prepare(n)ï¼š
   - å¦‚æœ n å¤§äºå·²æ¥å—çš„ææ¡ˆç¼–å·ï¼Œæ‰¿è¯ºä¸å†æ¥å—å°äº n çš„ææ¡ˆ
   - è¿”å›å·²æ¥å—çš„æœ€å¤§ç¼–å·ææ¡ˆ

é˜¶æ®µäºŒï¼šAccept
1. Proposer æ”¶åˆ°å¤šæ•° Acceptor çš„å“åº”åï¼Œå‘é€ Accept(n, value)
2. Acceptor æ”¶åˆ° Accept(n, value)ï¼š
   - å¦‚æœ n å¤§äºç­‰äºæ‰¿è¯ºçš„ç¼–å·ï¼Œæ¥å—è¯¥ææ¡ˆ
   - å¦åˆ™æ‹’ç»

é˜¶æ®µä¸‰ï¼šLearn
1. Acceptor æ¥å—ææ¡ˆåï¼Œé€šçŸ¥æ‰€æœ‰ Learner
2. Learner æ”¶åˆ°å¤šæ•° Acceptor çš„é€šçŸ¥åï¼Œå­¦ä¹ è¯¥å€¼
```

**Paxos åº”ç”¨**ï¼š
- ZooKeeperï¼ˆZAB åè®®ï¼ŒPaxos å˜ç§ï¼‰
- Chubbyï¼ˆGoogle åˆ†å¸ƒå¼é”æœåŠ¡ï¼‰

### 2.3 Raft ç®—æ³• ğŸ”¥

**Raft æ˜¯ä»€ä¹ˆï¼Ÿ**
- æ›´æ˜“ç†è§£çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•
- ä¸ Paxos ç­‰ä»·ï¼Œä½†æ›´å®¹æ˜“å®ç°
- å¹¿æ³›åº”ç”¨äºå·¥ä¸šç•Œ

**Raft è§’è‰²**ï¼š
```
Leader    - é¢†å¯¼è€…ï¼ˆå¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯è¯·æ±‚ï¼‰
Follower  - è·Ÿéšè€…ï¼ˆè¢«åŠ¨æ¥æ”¶è¯·æ±‚ï¼‰
Candidate - å€™é€‰è€…ï¼ˆé€‰ä¸¾æ—¶çš„ä¸´æ—¶è§’è‰²ï¼‰
```

**Raft æ ¸å¿ƒæœºåˆ¶**ï¼š

**1. Leader é€‰ä¸¾**
```java
// é€‰ä¸¾æµç¨‹
1. åˆå§‹çŠ¶æ€ï¼šæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ Follower
2. Follower è¶…æ—¶æœªæ”¶åˆ° Leader å¿ƒè·³ï¼Œè½¬ä¸º Candidate
3. Candidate å‘èµ·é€‰ä¸¾ï¼Œè¯·æ±‚å…¶ä»–èŠ‚ç‚¹æŠ•ç¥¨
4. è·å¾—å¤šæ•°ç¥¨çš„ Candidate æˆä¸º Leader
5. Leader å®šæœŸå‘é€å¿ƒè·³ï¼Œç»´æŒé¢†å¯¼åœ°ä½

// é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆéšæœºï¼‰
election_timeout = random(150ms, 300ms)

// å¿ƒè·³é—´éš”
heartbeat_interval = 50ms
```

**2. æ—¥å¿—å¤åˆ¶**
```java
// æ—¥å¿—å¤åˆ¶æµç¨‹
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ° Leader
2. Leader å°†è¯·æ±‚è¿½åŠ åˆ°æœ¬åœ°æ—¥å¿—
3. Leader å¹¶è¡Œå‘é€ AppendEntries RPC åˆ° Follower
4. Follower æ¥æ”¶æ—¥å¿—å¹¶è¿½åŠ åˆ°æœ¬åœ°
5. Leader æ”¶åˆ°å¤šæ•° Follower çš„ç¡®è®¤åï¼Œæäº¤æ—¥å¿—
6. Leader é€šçŸ¥ Follower æäº¤æ—¥å¿—
7. è¿”å›ç»“æœç»™å®¢æˆ·ç«¯

// æ—¥å¿—æ¡ç›®ç»“æ„
class LogEntry {
    int term;           // ä»»æœŸå·
    int index;          // æ—¥å¿—ç´¢å¼•
    Command command;    // å‘½ä»¤
}
```

**3. å®‰å…¨æ€§ä¿è¯**
- **é€‰ä¸¾å®‰å…¨æ€§**ï¼šä¸€ä¸ªä»»æœŸå†…æœ€å¤šä¸€ä¸ª Leader
- **æ—¥å¿—åŒ¹é…æ€§**ï¼šå¦‚æœä¸¤ä¸ªæ—¥å¿—æ¡ç›®æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸï¼Œåˆ™å®ƒä»¬å­˜å‚¨ç›¸åŒçš„å‘½ä»¤
- **Leader å®Œæ•´æ€§**ï¼šå¦‚æœæŸä¸ªæ—¥å¿—æ¡ç›®åœ¨æŸä¸ªä»»æœŸè¢«æäº¤ï¼Œåˆ™è¯¥æ¡ç›®å¿…ç„¶å‡ºç°åœ¨æ›´é«˜ä»»æœŸçš„ Leader æ—¥å¿—ä¸­
- **çŠ¶æ€æœºå®‰å…¨æ€§**ï¼šå¦‚æœæŸä¸ªèŠ‚ç‚¹å·²åº”ç”¨æŸä¸ªæ—¥å¿—æ¡ç›®åˆ°çŠ¶æ€æœºï¼Œåˆ™å…¶ä»–èŠ‚ç‚¹ä¸ä¼šåº”ç”¨ä¸åŒçš„æ—¥å¿—æ¡ç›®

**Raft åº”ç”¨**ï¼š
- etcdï¼ˆKubernetes ä½¿ç”¨ï¼‰
- Consulï¼ˆæœåŠ¡å‘ç°ï¼‰
- TiKVï¼ˆåˆ†å¸ƒå¼ KV å­˜å‚¨ï¼‰

**Raft vs Paxos**ï¼š

| å¯¹æ¯”é¡¹ | Raft | Paxos |
|-------|------|-------|
| æ˜“ç†è§£æ€§ | â­â­â­â­â­ | â­â­ |
| æ˜“å®ç°æ€§ | â­â­â­â­â­ | â­â­ |
| æ€§èƒ½ | é«˜ | é«˜ |
| åº”ç”¨ | etcdã€Consul | ZooKeeper |

---

## 3. åˆ†å¸ƒå¼äº‹åŠ¡ ğŸ”¥

### 3.1 åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜

**ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼äº‹åŠ¡ï¼Ÿ**
- è·¨å¤šä¸ªæ•°æ®åº“æˆ–æœåŠ¡çš„äº‹åŠ¡
- éœ€è¦ä¿è¯å¤šä¸ªæ“ä½œçš„åŸå­æ€§

**å…¸å‹åœºæ™¯**ï¼š
```java
// ç”µå•†ä¸‹å•åœºæ™¯
1. è®¢å•æœåŠ¡ï¼šåˆ›å»ºè®¢å•
2. åº“å­˜æœåŠ¡ï¼šæ‰£å‡åº“å­˜
3. ç§¯åˆ†æœåŠ¡ï¼šå¢åŠ ç§¯åˆ†
4. æ”¯ä»˜æœåŠ¡ï¼šæ‰£å‡ä½™é¢

// è¦æ±‚ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
```

### 3.2 ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰

**æµç¨‹**ï¼š

```
é˜¶æ®µä¸€ï¼šå‡†å¤‡é˜¶æ®µï¼ˆPrepareï¼‰
1. åè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ Prepare è¯·æ±‚
2. å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œä½†ä¸æäº¤
3. å‚ä¸è€…è¿”å› Yes æˆ– No

é˜¶æ®µäºŒï¼šæäº¤é˜¶æ®µï¼ˆCommitï¼‰
1. å¦‚æœæ‰€æœ‰å‚ä¸è€…è¿”å› Yesï¼š
   - åè°ƒè€…å‘é€ Commit è¯·æ±‚
   - å‚ä¸è€…æäº¤äº‹åŠ¡
2. å¦‚æœæœ‰å‚ä¸è€…è¿”å› Noï¼š
   - åè°ƒè€…å‘é€ Rollback è¯·æ±‚
   - å‚ä¸è€…å›æ»šäº‹åŠ¡
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
// åè°ƒè€…
public class TransactionCoordinator {
    private List<Participant> participants;
    
    public boolean executeTransaction() {
        // é˜¶æ®µä¸€ï¼šå‡†å¤‡
        boolean allPrepared = true;
        for (Participant p : participants) {
            if (!p.prepare()) {
                allPrepared = false;
                break;
            }
        }
        
        // é˜¶æ®µäºŒï¼šæäº¤æˆ–å›æ»š
        if (allPrepared) {
            for (Participant p : participants) {
                p.commit();
            }
            return true;
        } else {
            for (Participant p : participants) {
                p.rollback();
            }
            return false;
        }
    }
}

// å‚ä¸è€…
public interface Participant {
    boolean prepare();  // å‡†å¤‡é˜¶æ®µ
    void commit();      // æäº¤
    void rollback();    // å›æ»š
}
```

**ä¼˜ç‚¹**ï¼š
- å¼ºä¸€è‡´æ€§
- å®ç°ç›¸å¯¹ç®€å•

**ç¼ºç‚¹**ï¼š
- åŒæ­¥é˜»å¡ï¼šæ‰€æœ‰å‚ä¸è€…ç­‰å¾…åè°ƒè€…æŒ‡ä»¤
- å•ç‚¹æ•…éšœï¼šåè°ƒè€…æ•…éšœå¯¼è‡´ç³»ç»Ÿä¸å¯ç”¨
- æ•°æ®ä¸ä¸€è‡´ï¼šç½‘ç»œåˆ†åŒºå¯èƒ½å¯¼è‡´éƒ¨åˆ†æäº¤
- æ€§èƒ½å·®ï¼šä¸¤æ¬¡ç½‘ç»œå¾€è¿”

### 3.3 ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰

**æ”¹è¿›**ï¼š
- å¢åŠ è¶…æ—¶æœºåˆ¶
- å¢åŠ  CanCommit é˜¶æ®µ

**æµç¨‹**ï¼š
```
é˜¶æ®µä¸€ï¼šCanCommitï¼ˆè¯¢é—®ï¼‰
1. åè°ƒè€…è¯¢é—®å‚ä¸è€…æ˜¯å¦å¯ä»¥æ‰§è¡Œäº‹åŠ¡
2. å‚ä¸è€…è¿”å› Yes æˆ– No

é˜¶æ®µäºŒï¼šPreCommitï¼ˆé¢„æäº¤ï¼‰
1. å¦‚æœæ‰€æœ‰å‚ä¸è€…è¿”å› Yesï¼Œå‘é€ PreCommit
2. å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡ï¼Œä½†ä¸æäº¤

é˜¶æ®µä¸‰ï¼šDoCommitï¼ˆæäº¤ï¼‰
1. åè°ƒè€…å‘é€ DoCommit
2. å‚ä¸è€…æäº¤äº‹åŠ¡
```

**ä¼˜ç‚¹**ï¼š
- é™ä½é˜»å¡èŒƒå›´
- å¢åŠ è¶…æ—¶æœºåˆ¶

**ç¼ºç‚¹**ï¼š
- ä»ç„¶å­˜åœ¨æ•°æ®ä¸ä¸€è‡´é£é™©
- å®ç°æ›´å¤æ‚

### 3.4 TCCï¼ˆTry-Confirm-Cancelï¼‰ğŸ”¥

**TCC æ¨¡å¼**ï¼š

```
Try      - å°è¯•æ‰§è¡Œï¼Œé¢„ç•™èµ„æº
Confirm  - ç¡®è®¤æ‰§è¡Œï¼Œä½¿ç”¨èµ„æº
Cancel   - å–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾èµ„æº
```

**ä»£ç ç¤ºä¾‹**ï¼š

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    // Tryï¼šåˆ›å»ºè®¢å•ï¼ˆçŠ¶æ€ä¸ºå¾…ç¡®è®¤ï¼‰
    @Transactional
    public void tryCreateOrder(OrderDTO order) {
        order.setStatus(OrderStatus.PENDING);
        orderRepository.save(order);
    }
    
    // Confirmï¼šç¡®è®¤è®¢å•
    @Transactional
    public void confirmOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        order.setStatus(OrderStatus.CONFIRMED);
        orderRepository.save(order);
    }
    
    // Cancelï¼šå–æ¶ˆè®¢å•
    @Transactional
    public void cancelOrder(Long orderId) {
        Order order = orderRepository.findById(orderId);
        order.setStatus(OrderStatus.CANCELLED);
        orderRepository.save(order);
    }
}

// åº“å­˜æœåŠ¡
@Service
public class InventoryService {
    
    // Tryï¼šå†»ç»“åº“å­˜
    @Transactional
    public void tryReduceInventory(Long productId, int quantity) {
        Inventory inventory = inventoryRepository.findById(productId);
        inventory.setFrozen(inventory.getFrozen() + quantity);
        inventoryRepository.save(inventory);
    }
    
    // Confirmï¼šæ‰£å‡åº“å­˜
    @Transactional
    public void confirmReduceInventory(Long productId, int quantity) {
        Inventory inventory = inventoryRepository.findById(productId);
        inventory.setAvailable(inventory.getAvailable() - quantity);
        inventory.setFrozen(inventory.getFrozen() - quantity);
        inventoryRepository.save(inventory);
    }
    
    // Cancelï¼šé‡Šæ”¾åº“å­˜
    @Transactional
    public void cancelReduceInventory(Long productId, int quantity) {
        Inventory inventory = inventoryRepository.findById(productId);
        inventory.setFrozen(inventory.getFrozen() - quantity);
        inventoryRepository.save(inventory);
    }
}

// TCC äº‹åŠ¡ç®¡ç†å™¨
@Service
public class TCCTransactionManager {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private InventoryService inventoryService;
    
    public void executeTransaction(OrderDTO order) {
        try {
            // Try é˜¶æ®µ
            orderService.tryCreateOrder(order);
            inventoryService.tryReduceInventory(order.getProductId(), order.getQuantity());
            
            // Confirm é˜¶æ®µ
            orderService.confirmOrder(order.getId());
            inventoryService.confirmReduceInventory(order.getProductId(), order.getQuantity());
        } catch (Exception e) {
            // Cancel é˜¶æ®µ
            orderService.cancelOrder(order.getId());
            inventoryService.cancelReduceInventory(order.getProductId(), order.getQuantity());
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- æ€§èƒ½å¥½ï¼ˆæ— é”ï¼‰
- æœ€ç»ˆä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- å®ç°å¤æ‚
- éœ€è¦å®ç° Tryã€Confirmã€Cancel ä¸‰ä¸ªæ–¹æ³•
- éœ€è¦è€ƒè™‘å¹‚ç­‰æ€§

**TCC æ¡†æ¶**ï¼š
- Seataï¼ˆé˜¿é‡Œå¼€æºï¼‰
- ByteTCC
- TCC-Transaction

### 3.5 Saga æ¨¡å¼

**Saga æ˜¯ä»€ä¹ˆï¼Ÿ**
- é•¿äº‹åŠ¡è§£å†³æ–¹æ¡ˆ
- å°†é•¿äº‹åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªæœ¬åœ°çŸ­äº‹åŠ¡
- æ¯ä¸ªçŸ­äº‹åŠ¡éƒ½æœ‰å¯¹åº”çš„è¡¥å¿äº‹åŠ¡

**ä¸¤ç§å®ç°æ–¹å¼**ï¼š

**1. äº‹ä»¶ç¼–æ’ï¼ˆChoreographyï¼‰**
```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Transactional
    public void createOrder(OrderDTO order) {
        // 1. åˆ›å»ºè®¢å•
        orderRepository.save(order);
        
        // 2. å‘å¸ƒè®¢å•åˆ›å»ºäº‹ä»¶
        eventPublisher.publish(new OrderCreatedEvent(order));
    }
    
    // ç›‘å¬åº“å­˜æ‰£å‡å¤±è´¥äº‹ä»¶
    @EventListener
    public void onInventoryReduceFailed(InventoryReduceFailedEvent event) {
        // è¡¥å¿ï¼šå–æ¶ˆè®¢å•
        cancelOrder(event.getOrderId());
    }
}

// åº“å­˜æœåŠ¡
@Service
public class InventoryService {
    
    // ç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶
    @EventListener
    public void onOrderCreated(OrderCreatedEvent event) {
        try {
            // æ‰£å‡åº“å­˜
            reduceInventory(event.getProductId(), event.getQuantity());
            
            // å‘å¸ƒåº“å­˜æ‰£å‡æˆåŠŸäº‹ä»¶
            eventPublisher.publish(new InventoryReducedEvent(event.getOrderId()));
        } catch (Exception e) {
            // å‘å¸ƒåº“å­˜æ‰£å‡å¤±è´¥äº‹ä»¶
            eventPublisher.publish(new InventoryReduceFailedEvent(event.getOrderId()));
        }
    }
}
```

**2. å‘½ä»¤åè°ƒï¼ˆOrchestrationï¼‰**
```java
// Saga åè°ƒå™¨
@Service
public class OrderSagaOrchestrator {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    public void executeOrderSaga(OrderDTO order) {
        try {
            // æ­¥éª¤ 1ï¼šåˆ›å»ºè®¢å•
            orderService.createOrder(order);
            
            // æ­¥éª¤ 2ï¼šæ‰£å‡åº“å­˜
            inventoryService.reduceInventory(order.getProductId(), order.getQuantity());
            
            // æ­¥éª¤ 3ï¼šæ‰£å‡ä½™é¢
            paymentService.deductBalance(order.getUserId(), order.getAmount());
            
        } catch (Exception e) {
            // è¡¥å¿æµç¨‹ï¼ˆé€†åºæ‰§è¡Œï¼‰
            compensate(order);
        }
    }
    
    private void compensate(OrderDTO order) {
        // è¡¥å¿ 3ï¼šé€€æ¬¾
        paymentService.refund(order.getUserId(), order.getAmount());
        
        // è¡¥å¿ 2ï¼šæ¢å¤åº“å­˜
        inventoryService.addInventory(order.getProductId(), order.getQuantity());
        
        // è¡¥å¿ 1ï¼šå–æ¶ˆè®¢å•
        orderService.cancelOrder(order.getId());
    }
}
```

**ä¼˜ç‚¹**ï¼š
- é€‚åˆé•¿äº‹åŠ¡
- æ€§èƒ½å¥½

**ç¼ºç‚¹**ï¼š
- æœ€ç»ˆä¸€è‡´æ€§
- éœ€è¦å®ç°è¡¥å¿é€»è¾‘
- å¤æ‚åº¦é«˜



### 3.6 æœ¬åœ°æ¶ˆæ¯è¡¨

**å®ç°åŸç†**ï¼š

```java
// è®¢å•æœåŠ¡
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private MessageRepository messageRepository;
    
    @Transactional
    public void createOrder(OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(orderDTO.getUserId());
        order.setAmount(orderDTO.getAmount());
        orderRepository.save(order);
        
        // 2. ä¿å­˜æœ¬åœ°æ¶ˆæ¯ï¼ˆåŒä¸€ä¸ªäº‹åŠ¡ï¼‰
        Message message = new Message();
        message.setTopic("order-created");
        message.setContent(JSON.toJSONString(order));
        message.setStatus(MessageStatus.PENDING);
        messageRepository.save(message);
    }
}

// å®šæ—¶ä»»åŠ¡ï¼šæ‰«ææœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œå‘é€æ¶ˆæ¯
@Component
public class MessageSender {
    
    @Autowired
    private MessageRepository messageRepository;
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    @Scheduled(fixedDelay = 1000)
    public void sendPendingMessages() {
        List<Message> messages = messageRepository.findByStatus(MessageStatus.PENDING);
        
        for (Message message : messages) {
            try {
                // å‘é€æ¶ˆæ¯åˆ° Kafka
                kafkaTemplate.send(message.getTopic(), message.getContent());
                
                // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
                message.setStatus(MessageStatus.SENT);
                messageRepository.save(message);
            } catch (Exception e) {
                // å‘é€å¤±è´¥ï¼Œä¸‹æ¬¡é‡è¯•
                log.error("å‘é€æ¶ˆæ¯å¤±è´¥", e);
            }
        }
    }
}

// åº“å­˜æœåŠ¡ï¼šæ¶ˆè´¹æ¶ˆæ¯
@Service
public class InventoryConsumer {
    
    @KafkaListener(topics = "order-created")
    public void onOrderCreated(String message) {
        Order order = JSON.parseObject(message, Order.class);
        
        // æ‰£å‡åº“å­˜ï¼ˆå¹‚ç­‰æ€§å¤„ç†ï¼‰
        inventoryService.reduceInventory(order.getProductId(), order.getQuantity());
    }
}
```

**ä¼˜ç‚¹**ï¼š
- å®ç°ç®€å•
- ä¿è¯æœ€ç»ˆä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- éœ€è¦å®šæ—¶æ‰«æ
- æ¶ˆæ¯è¡¨å¯èƒ½å¾ˆå¤§

---

## 4. åˆ†å¸ƒå¼é” ğŸ”¥

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”ï¼Ÿ

**å•æœºé”çš„é—®é¢˜**ï¼š
```java
// å•æœºç¯å¢ƒï¼šsynchronized å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨
public synchronized void deductInventory(Long productId) {
    Inventory inventory = inventoryRepository.findById(productId);
    if (inventory.getQuantity() > 0) {
        inventory.setQuantity(inventory.getQuantity() - 1);
        inventoryRepository.save(inventory);
    }
}

// åˆ†å¸ƒå¼ç¯å¢ƒï¼šå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œsynchronized æ— æ³•ä¿è¯çº¿ç¨‹å®‰å…¨
// å®ä¾‹ 1 å’Œå®ä¾‹ 2 å¯èƒ½åŒæ—¶æ‰£å‡åº“å­˜ï¼Œå¯¼è‡´è¶…å–
```

### 4.2 åŸºäº Redis çš„åˆ†å¸ƒå¼é”

**å®ç°æ–¹å¼ 1ï¼šSETNX + EXPIRE**

```java
@Service
public class RedisLock {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * è·å–é”
     * @param key é”çš„ key
     * @param value é”çš„ valueï¼ˆé€šå¸¸æ˜¯å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ UUIDï¼‰
     * @param expireTime è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
     * @return æ˜¯å¦è·å–æˆåŠŸ
     */
    public boolean tryLock(String key, String value, long expireTime) {
        // ä½¿ç”¨ SET key value NX EX expireTime å‘½ä»¤
        // NXï¼šåªåœ¨ key ä¸å­˜åœ¨æ—¶è®¾ç½®
        // EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´
        Boolean result = redisTemplate.opsForValue()
            .setIfAbsent(key, value, expireTime, TimeUnit.SECONDS);
        return Boolean.TRUE.equals(result);
    }
    
    /**
     * é‡Šæ”¾é”
     * @param key é”çš„ key
     * @param value é”çš„ value
     */
    public void unlock(String key, String value) {
        // ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
        String script = 
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";
        
        redisTemplate.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            value
        );
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class InventoryService {
    
    @Autowired
    private RedisLock redisLock;
    
    public void deductInventory(Long productId) {
        String lockKey = "inventory:lock:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // è·å–é”
            if (redisLock.tryLock(lockKey, lockValue, 30)) {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                Inventory inventory = inventoryRepository.findById(productId);
                if (inventory.getQuantity() > 0) {
                    inventory.setQuantity(inventory.getQuantity() - 1);
                    inventoryRepository.save(inventory);
                }
            } else {
                throw new RuntimeException("è·å–é”å¤±è´¥");
            }
        } finally {
            // é‡Šæ”¾é”
            redisLock.unlock(lockKey, lockValue);
        }
    }
}
```

**å®ç°æ–¹å¼ 2ï¼šRedissonï¼ˆæ¨èï¼‰**

```java
@Configuration
public class RedissonConfig {
    
    @Bean
    public RedissonClient redissonClient() {
        Config config = new Config();
        config.useSingleServer()
            .setAddress("redis://127.0.0.1:6379")
            .setPassword("password");
        return Redisson.create(config);
    }
}

@Service
public class InventoryService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void deductInventory(Long productId) {
        String lockKey = "inventory:lock:" + productId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾… 10 ç§’ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ 30 ç§’
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                Inventory inventory = inventoryRepository.findById(productId);
                if (inventory.getQuantity() > 0) {
                    inventory.setQuantity(inventory.getQuantity() - 1);
                    inventoryRepository.save(inventory);
                }
            } else {
                throw new RuntimeException("è·å–é”å¤±è´¥");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("è·å–é”è¢«ä¸­æ–­", e);
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

**Redisson ç‰¹æ€§**ï¼š
- è‡ªåŠ¨ç»­æœŸï¼ˆçœ‹é—¨ç‹—æœºåˆ¶ï¼‰
- å¯é‡å…¥é”
- å…¬å¹³é”
- è¯»å†™é”
- çº¢é”ï¼ˆRedLockï¼‰

### 4.3 åŸºäº ZooKeeper çš„åˆ†å¸ƒå¼é”

```java
@Service
public class ZookeeperLock {
    
    private CuratorFramework client;
    
    @PostConstruct
    public void init() {
        client = CuratorFrameworkFactory.builder()
            .connectString("127.0.0.1:2181")
            .sessionTimeoutMs(5000)
            .retryPolicy(new ExponentialBackoffRetry(1000, 3))
            .build();
        client.start();
    }
    
    public void executeWithLock(String lockPath, Runnable task) {
        InterProcessMutex lock = new InterProcessMutex(client, lockPath);
        
        try {
            // è·å–é”
            if (lock.acquire(10, TimeUnit.SECONDS)) {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘
                task.run();
            } else {
                throw new RuntimeException("è·å–é”å¤±è´¥");
            }
        } catch (Exception e) {
            throw new RuntimeException("æ‰§è¡Œå¤±è´¥", e);
        } finally {
            // é‡Šæ”¾é”
            try {
                lock.release();
            } catch (Exception e) {
                log.error("é‡Šæ”¾é”å¤±è´¥", e);
            }
        }
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class InventoryService {
    
    @Autowired
    private ZookeeperLock zookeeperLock;
    
    public void deductInventory(Long productId) {
        String lockPath = "/locks/inventory/" + productId;
        
        zookeeperLock.executeWithLock(lockPath, () -> {
            Inventory inventory = inventoryRepository.findById(productId);
            if (inventory.getQuantity() > 0) {
                inventory.setQuantity(inventory.getQuantity() - 1);
                inventoryRepository.save(inventory);
            }
        });
    }
}
```

**ZooKeeper é”ç‰¹ç‚¹**ï¼š
- å¼ºä¸€è‡´æ€§ï¼ˆCPï¼‰
- è‡ªåŠ¨é‡Šæ”¾ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰
- æ”¯æŒå…¬å¹³é”ï¼ˆé¡ºåºèŠ‚ç‚¹ï¼‰

### 4.4 åˆ†å¸ƒå¼é”å¯¹æ¯”

| ç‰¹æ€§ | Redis | ZooKeeper | æ•°æ®åº“ |
|------|-------|-----------|--------|
| æ€§èƒ½ | â­â­â­â­â­ | â­â­â­ | â­â­ |
| å¯é æ€§ | â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ |
| å®ç°å¤æ‚åº¦ | â­â­â­ | â­â­â­â­ | â­â­ |
| ä¸€è‡´æ€§ | AP | CP | CP |
| æ¨èåœºæ™¯ | é«˜æ€§èƒ½åœºæ™¯ | å¼ºä¸€è‡´æ€§åœºæ™¯ | ç®€å•åœºæ™¯ |

---

## 5. åˆ†å¸ƒå¼ ID ğŸ”¥

### 5.1 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼ IDï¼Ÿ

**å•æœº ID çš„é—®é¢˜**ï¼š
- æ•°æ®åº“è‡ªå¢ IDï¼šåˆ†åº“åˆ†è¡¨åæ— æ³•ä¿è¯å…¨å±€å”¯ä¸€
- UUIDï¼šæ— åºã€å ç”¨ç©ºé—´å¤§ã€ä¸é€‚åˆä½œä¸ºä¸»é”®

**åˆ†å¸ƒå¼ ID è¦æ±‚**ï¼š
- å…¨å±€å”¯ä¸€
- è¶‹åŠ¿é€’å¢ï¼ˆæœ‰åˆ©äºæ•°æ®åº“ç´¢å¼•ï¼‰
- é«˜æ€§èƒ½
- é«˜å¯ç”¨

### 5.2 é›ªèŠ±ç®—æ³•ï¼ˆSnowflakeï¼‰ğŸ”¥

**ç»“æ„**ï¼š
```
0 - 0000000000 0000000000 0000000000 0000000000 0 - 00000 - 00000 - 000000000000
|   |                                               |   |       |       |
|   |                                               |   |       |       â””â”€ åºåˆ—å·ï¼ˆ12ä½ï¼‰
|   |                                               |   |       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœºå™¨IDï¼ˆ5ä½ï¼‰
|   |                                               |   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ•°æ®ä¸­å¿ƒIDï¼ˆ5ä½ï¼‰
|   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¬¦å·ä½ï¼ˆ1ä½ï¼Œå›ºå®šä¸º0ï¼‰

æ€»å…± 64 ä½ï¼ˆLong ç±»å‹ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- æ—¶é—´æˆ³ï¼ˆ41ä½ï¼‰ï¼šå¯ç”¨ 69 å¹´
- æ•°æ®ä¸­å¿ƒ IDï¼ˆ5ä½ï¼‰ï¼šæœ€å¤š 32 ä¸ªæ•°æ®ä¸­å¿ƒ
- æœºå™¨ IDï¼ˆ5ä½ï¼‰ï¼šæ¯ä¸ªæ•°æ®ä¸­å¿ƒæœ€å¤š 32 å°æœºå™¨
- åºåˆ—å·ï¼ˆ12ä½ï¼‰ï¼šæ¯æ¯«ç§’æœ€å¤šç”Ÿæˆ 4096 ä¸ª ID

**å®ç°**ï¼š

```java
public class SnowflakeIdGenerator {
    
    // èµ·å§‹æ—¶é—´æˆ³ï¼ˆ2020-01-01ï¼‰
    private final long twepoch = 1577808000000L;
    
    // æœºå™¨ ID æ‰€å ä½æ•°
    private final long workerIdBits = 5L;
    
    // æ•°æ®ä¸­å¿ƒ ID æ‰€å ä½æ•°
    private final long datacenterIdBits = 5L;
    
    // åºåˆ—å·æ‰€å ä½æ•°
    private final long sequenceBits = 12L;
    
    // æœºå™¨ ID æœ€å¤§å€¼
    private final long maxWorkerId = ~(-1L << workerIdBits);
    
    // æ•°æ®ä¸­å¿ƒ ID æœ€å¤§å€¼
    private final long maxDatacenterId = ~(-1L << datacenterIdBits);
    
    // åºåˆ—å·æœ€å¤§å€¼
    private final long sequenceMask = ~(-1L << sequenceBits);
    
    // æœºå™¨ ID å·¦ç§»ä½æ•°
    private final long workerIdShift = sequenceBits;
    
    // æ•°æ®ä¸­å¿ƒ ID å·¦ç§»ä½æ•°
    private final long datacenterIdShift = sequenceBits + workerIdBits;
    
    // æ—¶é—´æˆ³å·¦ç§»ä½æ•°
    private final long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;
    
    private long workerId;
    private long datacenterId;
    private long sequence = 0L;
    private long lastTimestamp = -1L;
    
    public SnowflakeIdGenerator(long workerId, long datacenterId) {
        if (workerId > maxWorkerId || workerId < 0) {
            throw new IllegalArgumentException("worker Id can't be greater than " + maxWorkerId + " or less than 0");
        }
        if (datacenterId > maxDatacenterId || datacenterId < 0) {
            throw new IllegalArgumentException("datacenter Id can't be greater than " + maxDatacenterId + " or less than 0");
        }
        this.workerId = workerId;
        this.datacenterId = datacenterId;
    }
    
    public synchronized long nextId() {
        long timestamp = timeGen();
        
        // æ—¶é’Ÿå›æ‹¨
        if (timestamp < lastTimestamp) {
            throw new RuntimeException("Clock moved backwards. Refusing to generate id");
        }
        
        // åŒä¸€æ¯«ç§’å†…
        if (lastTimestamp == timestamp) {
            sequence = (sequence + 1) & sequenceMask;
            // åºåˆ—å·æº¢å‡º
            if (sequence == 0) {
                timestamp = tilNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0L;
        }
        
        lastTimestamp = timestamp;
        
        // ç”Ÿæˆ ID
        return ((timestamp - twepoch) << timestampLeftShift)
            | (datacenterId << datacenterIdShift)
            | (workerId << workerIdShift)
            | sequence;
    }
    
    private long tilNextMillis(long lastTimestamp) {
        long timestamp = timeGen();
        while (timestamp <= lastTimestamp) {
            timestamp = timeGen();
        }
        return timestamp;
    }
    
    private long timeGen() {
        return System.currentTimeMillis();
    }
}

// ä½¿ç”¨ç¤ºä¾‹
@Configuration
public class IdGeneratorConfig {
    
    @Bean
    public SnowflakeIdGenerator snowflakeIdGenerator() {
        // ä»é…ç½®ä¸­å¿ƒè·å– workerId å’Œ datacenterId
        long workerId = 1L;
        long datacenterId = 1L;
        return new SnowflakeIdGenerator(workerId, datacenterId);
    }
}

@Service
public class OrderService {
    
    @Autowired
    private SnowflakeIdGenerator idGenerator;
    
    public void createOrder(OrderDTO orderDTO) {
        Order order = new Order();
        order.setId(idGenerator.nextId());  // ç”Ÿæˆåˆ†å¸ƒå¼ ID
        order.setUserId(orderDTO.getUserId());
        order.setAmount(orderDTO.getAmount());
        orderRepository.save(order);
    }
}
```

**ä¼˜ç‚¹**ï¼š
- æ€§èƒ½é«˜ï¼ˆæœ¬åœ°ç”Ÿæˆï¼‰
- è¶‹åŠ¿é€’å¢
- ä¸ä¾èµ–ç¬¬ä¸‰æ–¹ç³»ç»Ÿ

**ç¼ºç‚¹**ï¼š
- ä¾èµ–ç³»ç»Ÿæ—¶é’Ÿ
- éœ€è¦é…ç½® workerId å’Œ datacenterId

### 5.3 ç¾å›¢ Leaf

**Leaf-Segmentï¼ˆå·æ®µæ¨¡å¼ï¼‰**ï¼š

```java
// ä»æ•°æ®åº“æ‰¹é‡è·å– ID
CREATE TABLE leaf_alloc (
    biz_tag VARCHAR(128) NOT NULL COMMENT 'ä¸šåŠ¡æ ‡è¯†',
    max_id BIGINT NOT NULL COMMENT 'å½“å‰æœ€å¤§ID',
    step INT NOT NULL COMMENT 'æ­¥é•¿',
    description VARCHAR(256) COMMENT 'æè¿°',
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (biz_tag)
);

// ä½¿ç”¨ç¤ºä¾‹
@Service
public class LeafSegmentService {
    
    @Autowired
    private LeafAllocRepository leafAllocRepository;
    
    private Map<String, SegmentBuffer> cache = new ConcurrentHashMap<>();
    
    public long nextId(String bizTag) {
        SegmentBuffer buffer = cache.get(bizTag);
        if (buffer == null) {
            buffer = new SegmentBuffer();
            cache.put(bizTag, buffer);
        }
        
        if (buffer.needUpdate()) {
            updateSegment(bizTag, buffer);
        }
        
        return buffer.nextId();
    }
    
    private void updateSegment(String bizTag, SegmentBuffer buffer) {
        LeafAlloc leafAlloc = leafAllocRepository.findByBizTag(bizTag);
        
        // æ›´æ–°æ•°æ®åº“
        long newMaxId = leafAlloc.getMaxId() + leafAlloc.getStep();
        leafAlloc.setMaxId(newMaxId);
        leafAllocRepository.save(leafAlloc);
        
        // æ›´æ–°ç¼“å­˜
        buffer.setMinId(leafAlloc.getMaxId() - leafAlloc.getStep());
        buffer.setMaxId(leafAlloc.getMaxId());
    }
}
```

**Leaf-Snowflakeï¼ˆé›ªèŠ±æ¨¡å¼ï¼‰**ï¼š
- åŸºäº ZooKeeper è‡ªåŠ¨åˆ†é… workerId
- è§£å†³æ—¶é’Ÿå›æ‹¨é—®é¢˜

### 5.4 åˆ†å¸ƒå¼ ID æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | æ€§èƒ½ | å¯ç”¨æ€§ | å¤æ‚åº¦ | æ¨èåœºæ™¯ |
|------|------|--------|--------|---------|
| æ•°æ®åº“è‡ªå¢ | â­â­ | â­â­â­ | â­ | å°è§„æ¨¡ç³»ç»Ÿ |
| UUID | â­â­â­â­â­ | â­â­â­â­â­ | â­ | ä¸éœ€è¦æœ‰åº |
| Snowflake | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ | é«˜æ€§èƒ½åœºæ™¯ |
| Leaf-Segment | â­â­â­â­ | â­â­â­â­ | â­â­ | ä¸­ç­‰è§„æ¨¡ |
| Leaf-Snowflake | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­ | å¤§è§„æ¨¡ç³»ç»Ÿ |

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

### ç†è®ºåŸºç¡€
- [ ] ç†è§£ CAP å’Œ BASE ç†è®º
- [ ] æŒæ¡ä¸€è‡´æ€§çº§åˆ«
- [ ] ç†è§£ Paxos å’Œ Raft ç®—æ³•

### åˆ†å¸ƒå¼äº‹åŠ¡
- [ ] æŒæ¡ 2PC å’Œ 3PC
- [ ] ç†è§£ TCC æ¨¡å¼
- [ ] æŒæ¡ Saga æ¨¡å¼
- [ ] èƒ½å¤Ÿé€‰æ‹©åˆé€‚çš„åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ

### åˆ†å¸ƒå¼é”
- [ ] æŒæ¡ Redis åˆ†å¸ƒå¼é”å®ç°
- [ ] ç†è§£ ZooKeeper åˆ†å¸ƒå¼é”
- [ ] èƒ½å¤Ÿé€‰æ‹©åˆé€‚çš„åˆ†å¸ƒå¼é”æ–¹æ¡ˆ

### åˆ†å¸ƒå¼ ID
- [ ] ç†è§£é›ªèŠ±ç®—æ³•åŸç†
- [ ] æŒæ¡ Leaf æ–¹æ¡ˆ
- [ ] èƒ½å¤Ÿé€‰æ‹©åˆé€‚çš„åˆ†å¸ƒå¼ ID æ–¹æ¡ˆ

---

**@author erik.zhou**


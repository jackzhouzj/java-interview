# ç³»ç»Ÿè®¾è®¡é¢è¯•é¢˜ - å®Œæ•´è§£æ

> æŒæ¡ç³»ç»Ÿè®¾è®¡çš„æ€è·¯å’Œæ–¹æ³•ï¼Œæå‡æ¶æ„èƒ½åŠ›
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

ç³»ç»Ÿè®¾è®¡é¢è¯•æ˜¯é«˜çº§/èµ„æ·±å·¥ç¨‹å¸ˆé¢è¯•çš„é‡ç‚¹ï¼Œè€ƒå¯Ÿï¼š
- æ¶æ„è®¾è®¡èƒ½åŠ›
- æŠ€æœ¯é€‰å‹èƒ½åŠ›
- é—®é¢˜åˆ†æèƒ½åŠ›
- æ²Ÿé€šè¡¨è¾¾èƒ½åŠ›

## ğŸ¯ ç³»ç»Ÿè®¾è®¡æ–¹æ³•è®º

### è®¾è®¡æµç¨‹ï¼ˆSNAKE åŸåˆ™ï¼‰

```
S - Scenarioï¼ˆåœºæ™¯ï¼‰
  â†“
N - Necessaryï¼ˆéœ€æ±‚ï¼‰
  â†“
A - Applicationï¼ˆåº”ç”¨ï¼‰
  â†“
K - Kilobitï¼ˆæ•°æ®ï¼‰
  â†“
E - Evolveï¼ˆæ¼”è¿›ï¼‰
```

### 1. Scenario - æ˜ç¡®åœºæ™¯

**éœ€è¦é—®çš„é—®é¢˜**ï¼š
- ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ
- ç”¨æˆ·è§„æ¨¡æœ‰å¤šå¤§ï¼Ÿ
- å¹¶å‘é‡æœ‰å¤šå¤§ï¼Ÿ
- æ•°æ®é‡æœ‰å¤šå¤§ï¼Ÿ
- æ€§èƒ½è¦æ±‚æ˜¯ä»€ä¹ˆï¼Ÿ

### 2. Necessary - åˆ†æéœ€æ±‚

**åŠŸèƒ½éœ€æ±‚**ï¼š
- æ ¸å¿ƒåŠŸèƒ½
- æ¬¡è¦åŠŸèƒ½
- å¯é€‰åŠŸèƒ½

**éåŠŸèƒ½éœ€æ±‚**ï¼š
- æ€§èƒ½ï¼šQPSã€å»¶è¿Ÿ
- å¯ç”¨æ€§ï¼šSLA
- ä¸€è‡´æ€§ï¼šå¼ºä¸€è‡´ vs æœ€ç»ˆä¸€è‡´
- æ‰©å±•æ€§ï¼šæ°´å¹³æ‰©å±•

### 3. Application - åº”ç”¨è®¾è®¡

**æ¶æ„è®¾è®¡**ï¼š
- åˆ†å±‚æ¶æ„
- æ¨¡å—åˆ’åˆ†
- æ¥å£è®¾è®¡

**æŠ€æœ¯é€‰å‹**ï¼š
- æ•°æ®åº“é€‰æ‹©
- ç¼“å­˜æ–¹æ¡ˆ
- æ¶ˆæ¯é˜Ÿåˆ—
- å­˜å‚¨æ–¹æ¡ˆ

### 4. Kilobit - æ•°æ®ä¼°ç®—

**å­˜å‚¨ä¼°ç®—**ï¼š
- å•æ¡æ•°æ®å¤§å°
- æ€»æ•°æ®é‡
- å¢é•¿é€Ÿåº¦

**æµé‡ä¼°ç®—**ï¼š
- DAUï¼ˆæ—¥æ´»ç”¨æˆ·ï¼‰
- QPSï¼ˆæ¯ç§’è¯·æ±‚æ•°ï¼‰
- å¸¦å®½éœ€æ±‚

### 5. Evolve - ç³»ç»Ÿæ¼”è¿›

**ä¼˜åŒ–æ–¹å‘**ï¼š
- æ€§èƒ½ä¼˜åŒ–
- å¯ç”¨æ€§ä¼˜åŒ–
- æ‰©å±•æ€§ä¼˜åŒ–
- æˆæœ¬ä¼˜åŒ–

---

## ğŸ“ ç»å…¸ç³»ç»Ÿè®¾è®¡é¢˜

## 1. è®¾è®¡çŸ­é“¾ç³»ç»Ÿ ğŸ”¥

### 1.1 éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚**ï¼š
- é•¿é“¾æ¥è½¬çŸ­é“¾æ¥
- çŸ­é“¾æ¥è·³è½¬åˆ°é•¿é“¾æ¥
- ç»Ÿè®¡è®¿é—®æ¬¡æ•°

**éåŠŸèƒ½éœ€æ±‚**ï¼š
- é«˜æ€§èƒ½ï¼šQPS 10000+
- é«˜å¯ç”¨ï¼š99.99%
- çŸ­é“¾æ¥å”¯ä¸€
- çŸ­é“¾æ¥å°½å¯èƒ½çŸ­

### 1.2 æ•°æ®ä¼°ç®—

**å‡è®¾**ï¼š
- DAUï¼š1000 ä¸‡
- æ¯ä¸ªç”¨æˆ·å¹³å‡ç”Ÿæˆ 0.1 ä¸ªçŸ­é“¾æ¥
- æ¯å¤©ç”Ÿæˆï¼š1000 ä¸‡ * 0.1 = 100 ä¸‡ä¸ªçŸ­é“¾æ¥
- æ¯å¹´ç”Ÿæˆï¼š100 ä¸‡ * 365 = 3.65 äº¿ä¸ªçŸ­é“¾æ¥
- 5 å¹´æ•°æ®ï¼š3.65 äº¿ * 5 = 18.25 äº¿ä¸ªçŸ­é“¾æ¥

**å­˜å‚¨ä¼°ç®—**ï¼š
- å•æ¡æ•°æ®ï¼šé•¿é“¾æ¥ï¼ˆ200 å­—èŠ‚ï¼‰+ çŸ­é“¾æ¥ï¼ˆ10 å­—èŠ‚ï¼‰+ å…¶ä»–ï¼ˆ50 å­—èŠ‚ï¼‰= 260 å­—èŠ‚
- æ€»å­˜å‚¨ï¼š18.25 äº¿ * 260 å­—èŠ‚ â‰ˆ 475 GB

**QPS ä¼°ç®—**ï¼š
- è¯»å†™æ¯”ï¼š100:1ï¼ˆå‡è®¾ï¼‰
- å†™ QPSï¼š100 ä¸‡ / 86400 â‰ˆ 12 QPS
- è¯» QPSï¼š12 * 100 = 1200 QPS
- å³°å€¼ QPSï¼š1200 * 3 = 3600 QPS

### 1.3 æ¶æ„è®¾è®¡

**æ ¸å¿ƒç®—æ³•ï¼šBase62 ç¼–ç **

```java
@Service
public class ShortUrlService {
    
    private static final String BASE62 = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    
    @Autowired
    private SnowflakeIdGenerator idGenerator;
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private ShortUrlRepository shortUrlRepository;
    
    /**
     * ç”ŸæˆçŸ­é“¾æ¥
     */
    public String generateShortUrl(String longUrl) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        String existShortUrl = getShortUrlFromCache(longUrl);
        if (existShortUrl != null) {
            return existShortUrl;
        }
        
        // 2. ç”Ÿæˆå”¯ä¸€ ID
        long id = idGenerator.nextId();
        
        // 3. Base62 ç¼–ç 
        String shortCode = base62Encode(id);
        
        // 4. ä¿å­˜åˆ°æ•°æ®åº“
        ShortUrl shortUrl = new ShortUrl();
        shortUrl.setId(id);
        shortUrl.setShortCode(shortCode);
        shortUrl.setLongUrl(longUrl);
        shortUrl.setCreateTime(new Date());
        shortUrlRepository.save(shortUrl);
        
        // 5. ä¿å­˜åˆ°ç¼“å­˜
        String shortUrlKey = "short:url:" + shortCode;
        redisTemplate.opsForValue().set(shortUrlKey, longUrl, 7, TimeUnit.DAYS);
        
        return "https://short.url/" + shortCode;
    }
    
    /**
     * è·å–é•¿é“¾æ¥
     */
    public String getLongUrl(String shortCode) {
        // 1. ä»ç¼“å­˜è·å–
        String cacheKey = "short:url:" + shortCode;
        String longUrl = redisTemplate.opsForValue().get(cacheKey);
        if (longUrl != null) {
            // å¼‚æ­¥æ›´æ–°è®¿é—®æ¬¡æ•°
            updateAccessCount(shortCode);
            return longUrl;
        }
        
        // 2. ä»æ•°æ®åº“è·å–
        ShortUrl shortUrl = shortUrlRepository.findByShortCode(shortCode);
        if (shortUrl == null) {
            throw new NotFoundException("çŸ­é“¾æ¥ä¸å­˜åœ¨");
        }
        
        // 3. æ›´æ–°ç¼“å­˜
        redisTemplate.opsForValue().set(cacheKey, shortUrl.getLongUrl(), 7, TimeUnit.DAYS);
        
        // 4. æ›´æ–°è®¿é—®æ¬¡æ•°
        updateAccessCount(shortCode);
        
        return shortUrl.getLongUrl();
    }
    
    /**
     * Base62 ç¼–ç 
     */
    private String base62Encode(long num) {
        StringBuilder sb = new StringBuilder();
        while (num > 0) {
            int remainder = (int) (num % 62);
            sb.append(BASE62.charAt(remainder));
            num /= 62;
        }
        return sb.reverse().toString();
    }
    
    /**
     * æ›´æ–°è®¿é—®æ¬¡æ•°ï¼ˆå¼‚æ­¥ï¼‰
     */
    @Async
    private void updateAccessCount(String shortCode) {
        String countKey = "short:count:" + shortCode;
        redisTemplate.opsForValue().increment(countKey);
    }
    
    private String getShortUrlFromCache(String longUrl) {
        // ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        // å¦‚æœå­˜åœ¨ï¼Œå†æŸ¥è¯¢ç¼“å­˜æˆ–æ•°æ®åº“
        return null;
    }
}
```

**æ•°æ®åº“è®¾è®¡**ï¼š

```sql
CREATE TABLE short_url (
    id BIGINT PRIMARY KEY COMMENT 'å”¯ä¸€ID',
    short_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'çŸ­é“¾æ¥ç ',
    long_url VARCHAR(2048) NOT NULL COMMENT 'é•¿é“¾æ¥',
    access_count BIGINT DEFAULT 0 COMMENT 'è®¿é—®æ¬¡æ•°',
    create_time DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    expire_time DATETIME COMMENT 'è¿‡æœŸæ—¶é—´',
    INDEX idx_short_code (short_code),
    INDEX idx_long_url (long_url(255))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**æ¶æ„å›¾**ï¼š

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç”¨æˆ·è¯·æ±‚   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nginx     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  API Gateway â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Service â”‚       â”‚ Service â”‚       â”‚ Service â”‚
   â”‚  å®ä¾‹1   â”‚       â”‚  å®ä¾‹2   â”‚       â”‚  å®ä¾‹3   â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                  â”‚                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                  â”‚                  â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚  Redis  â”‚       â”‚  MySQL  â”‚       â”‚  MQ     â”‚
   â”‚  ç¼“å­˜    â”‚       â”‚  ä¸»ä»    â”‚       â”‚  æ¶ˆæ¯    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ä¼˜åŒ–æ–¹æ¡ˆ

**æ€§èƒ½ä¼˜åŒ–**ï¼š
1. **å¤šçº§ç¼“å­˜**ï¼š
   - æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰ï¼šçƒ­ç‚¹æ•°æ®
   - Redis ç¼“å­˜ï¼šå…¨é‡æ•°æ®
   - ç¼“å­˜é¢„çƒ­ï¼šæå‰åŠ è½½çƒ­ç‚¹æ•°æ®

2. **å¸ƒéš†è¿‡æ»¤å™¨**ï¼š
   - åˆ¤æ–­çŸ­é“¾æ¥æ˜¯å¦å­˜åœ¨
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢

3. **è¯»å†™åˆ†ç¦»**ï¼š
   - ä¸»åº“ï¼šå†™æ“ä½œ
   - ä»åº“ï¼šè¯»æ“ä½œ

**é«˜å¯ç”¨**ï¼š
1. **æœåŠ¡å¤šå®ä¾‹éƒ¨ç½²**
2. **Redis ä¸»ä» + å“¨å…µ**
3. **MySQL ä¸»ä» + MHA**
4. **é™æµé™çº§**ï¼š
   - é™æµï¼šä»¤ç‰Œæ¡¶ç®—æ³•
   - é™çº§ï¼šè¿”å›é»˜è®¤é¡µé¢

**æ‰©å±•æ€§**ï¼š
1. **æ•°æ®åº“åˆ†ç‰‡**ï¼š
   - æŒ‰çŸ­é“¾æ¥ hash åˆ†ç‰‡
   - æ”¯æŒæ°´å¹³æ‰©å±•

2. **CDN åŠ é€Ÿ**ï¼š
   - é™æ€èµ„æº CDN
   - çŸ­é“¾æ¥è·³è½¬ CDN

---

## 2. è®¾è®¡ç§’æ€ç³»ç»Ÿ ğŸ”¥

### 2.1 éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚**ï¼š
- å•†å“ç§’æ€
- åº“å­˜æ‰£å‡
- è®¢å•åˆ›å»º
- é˜²æ­¢è¶…å–

**éåŠŸèƒ½éœ€æ±‚**ï¼š
- é«˜å¹¶å‘ï¼šQPS 10 ä¸‡+
- é«˜å¯ç”¨ï¼š99.99%
- é˜²åˆ·ï¼šé˜²æ­¢æ¶æ„è¯·æ±‚
- å…¬å¹³æ€§ï¼šå…ˆåˆ°å…ˆå¾—

### 2.2 æ•°æ®ä¼°ç®—

**å‡è®¾**ï¼š
- ç§’æ€å•†å“ï¼š1000 ä»¶
- å‚ä¸ç”¨æˆ·ï¼š100 ä¸‡
- ç§’æ€æ—¶é•¿ï¼š10 ç§’
- QPSï¼š100 ä¸‡ / 10 = 10 ä¸‡ QPS

### 2.3 æ¶æ„è®¾è®¡

**æ ¸å¿ƒæµç¨‹**ï¼š

```
ç”¨æˆ·è¯·æ±‚
  â†“
å‰ç«¯é™æµï¼ˆé˜²é‡å¤ç‚¹å‡»ï¼‰
  â†“
CDNï¼ˆé™æ€èµ„æºï¼‰
  â†“
ç½‘å…³é™æµï¼ˆä»¤ç‰Œæ¡¶ï¼‰
  â†“
ç”¨æˆ·é‰´æƒï¼ˆé˜²åˆ·ï¼‰
  â†“
Redis é¢„æ‰£åº“å­˜
  â†“
å‘é€ MQ æ¶ˆæ¯
  â†“
å¼‚æ­¥åˆ›å»ºè®¢å•
  â†“
è¿”å›ç»“æœ
```

**ä»£ç å®ç°**ï¼š

```java
@Service
public class SeckillService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * ç§’æ€æ¥å£
     */
    public SeckillResult seckill(Long userId, Long productId) {
        // 1. ç”¨æˆ·é™æµï¼ˆæ¯ä¸ªç”¨æˆ·åªèƒ½ç§’æ€ä¸€æ¬¡ï¼‰
        String userKey = "seckill:user:" + productId + ":" + userId;
        Boolean isFirstTime = redisTemplate.opsForValue().setIfAbsent(userKey, "1", 1, TimeUnit.HOURS);
        if (!Boolean.TRUE.equals(isFirstTime)) {
            return SeckillResult.fail("æ‚¨å·²ç»å‚ä¸è¿‡ç§’æ€");
        }
        
        // 2. é¢„æ‰£åº“å­˜ï¼ˆRedisï¼‰
        String stockKey = "seckill:stock:" + productId;
        Long stock = redisTemplate.opsForValue().decrement(stockKey);
        if (stock == null || stock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š
            redisTemplate.opsForValue().increment(stockKey);
            return SeckillResult.fail("åº“å­˜ä¸è¶³");
        }
        
        // 3. å‘é€ MQ æ¶ˆæ¯ï¼ˆå¼‚æ­¥åˆ›å»ºè®¢å•ï¼‰
        SeckillMessage message = new SeckillMessage();
        message.setUserId(userId);
        message.setProductId(productId);
        rabbitTemplate.convertAndSend("seckill.exchange", "seckill.order", message);
        
        return SeckillResult.success("ç§’æ€æˆåŠŸï¼Œæ­£åœ¨åˆ›å»ºè®¢å•");
    }
    
    /**
     * æ¶ˆè´¹ MQ æ¶ˆæ¯ï¼Œåˆ›å»ºè®¢å•
     */
    @RabbitListener(queues = "seckill.order.queue")
    public void createOrder(SeckillMessage message) {
        try {
            // 1. å†æ¬¡æ£€æŸ¥åº“å­˜ï¼ˆæ•°æ®åº“ï¼‰
            Product product = productRepository.findById(message.getProductId());
            if (product.getStock() <= 0) {
                // åº“å­˜ä¸è¶³ï¼Œå›æ»š Redis
                String stockKey = "seckill:stock:" + message.getProductId();
                redisTemplate.opsForValue().increment(stockKey);
                return;
            }
            
            // 2. æ‰£å‡æ•°æ®åº“åº“å­˜ï¼ˆä¹è§‚é”ï¼‰
            int updated = productRepository.decrementStock(message.getProductId());
            if (updated == 0) {
                // æ‰£å‡å¤±è´¥ï¼Œå›æ»š Redis
                String stockKey = "seckill:stock:" + message.getProductId();
                redisTemplate.opsForValue().increment(stockKey);
                return;
            }
            
            // 3. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setUserId(message.getUserId());
            order.setProductId(message.getProductId());
            order.setStatus(OrderStatus.PENDING);
            orderRepository.save(order);
            
            // 4. å‘é€é€šçŸ¥
            notifyUser(message.getUserId(), "ç§’æ€æˆåŠŸï¼Œè®¢å•å·²åˆ›å»º");
            
        } catch (Exception e) {
            log.error("åˆ›å»ºè®¢å•å¤±è´¥", e);
            // å›æ»š Redis åº“å­˜
            String stockKey = "seckill:stock:" + message.getProductId();
            redisTemplate.opsForValue().increment(stockKey);
        }
    }
}

// ä¹è§‚é”æ‰£å‡åº“å­˜
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    @Modifying
    @Query("UPDATE Product p SET p.stock = p.stock - 1 WHERE p.id = :productId AND p.stock > 0")
    int decrementStock(@Param("productId") Long productId);
}
```

**æ•°æ®åº“è®¾è®¡**ï¼š

```sql
-- å•†å“è¡¨
CREATE TABLE product (
    id BIGINT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    stock INT NOT NULL DEFAULT 0,
    price DECIMAL(10, 2) NOT NULL,
    version INT NOT NULL DEFAULT 0 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
    INDEX idx_stock (stock)
) ENGINE=InnoDB;

-- è®¢å•è¡¨
CREATE TABLE `order` (
    id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    status VARCHAR(20) NOT NULL,
    create_time DATETIME NOT NULL,
    INDEX idx_user_id (user_id),
    INDEX idx_product_id (product_id)
) ENGINE=InnoDB;
```

### 2.4 ä¼˜åŒ–æ–¹æ¡ˆ

**å‰ç«¯ä¼˜åŒ–**ï¼š
1. **æŒ‰é’®ç½®ç°**ï¼šé˜²æ­¢é‡å¤ç‚¹å‡»
2. **éªŒè¯ç **ï¼šé˜²æ­¢æœºå™¨äºº
3. **ç­”é¢˜**ï¼šå¢åŠ å‚ä¸é—¨æ§›

**åç«¯ä¼˜åŒ–**ï¼š
1. **å¤šçº§é™æµ**ï¼š
   - ç½‘å…³é™æµï¼šæ€» QPS é™åˆ¶
   - ç”¨æˆ·é™æµï¼šæ¯ä¸ªç”¨æˆ·é™åˆ¶
   - IP é™æµï¼šæ¯ä¸ª IP é™åˆ¶

2. **ç¼“å­˜ä¼˜åŒ–**ï¼š
   - é¡µé¢é™æ€åŒ–
   - CDN åŠ é€Ÿ
   - Redis ç¼“å­˜

3. **å¼‚æ­¥å¤„ç†**ï¼š
   - MQ å‰Šå³°å¡«è°·
   - å¼‚æ­¥åˆ›å»ºè®¢å•

4. **æ•°æ®åº“ä¼˜åŒ–**ï¼š
   - è¯»å†™åˆ†ç¦»
   - åˆ†åº“åˆ†è¡¨
   - ä¹è§‚é”é˜²æ­¢è¶…å–

**ç›‘æ§å‘Šè­¦**ï¼š
1. **å®æ—¶ç›‘æ§**ï¼š
   - QPS ç›‘æ§
   - åº“å­˜ç›‘æ§
   - é”™è¯¯ç‡ç›‘æ§

2. **å‘Šè­¦æœºåˆ¶**ï¼š
   - QPS è¶…è¿‡é˜ˆå€¼å‘Šè­¦
   - åº“å­˜ä¸è¶³å‘Šè­¦
   - ç³»ç»Ÿå¼‚å¸¸å‘Šè­¦

---

## 3. è®¾è®¡ IM å³æ—¶é€šè®¯ç³»ç»Ÿ ğŸ”¥

### 3.1 éœ€æ±‚åˆ†æ

**åŠŸèƒ½éœ€æ±‚**ï¼š
- å•èŠ
- ç¾¤èŠ
- æ¶ˆæ¯æ¨é€
- æ¶ˆæ¯å­˜å‚¨
- åœ¨çº¿çŠ¶æ€

**éåŠŸèƒ½éœ€æ±‚**ï¼š
- å®æ—¶æ€§ï¼šå»¶è¿Ÿ < 100ms
- é«˜å¯ç”¨ï¼š99.99%
- æ¶ˆæ¯å¯é ï¼šä¸ä¸¢å¤±ã€ä¸é‡å¤
- æ”¯æŒæµ·é‡ç”¨æˆ·

### 3.2 æ•°æ®ä¼°ç®—

**å‡è®¾**ï¼š
- DAUï¼š1 äº¿
- åœ¨çº¿ç”¨æˆ·ï¼š1000 ä¸‡ï¼ˆ10%ï¼‰
- æ¯ä¸ªç”¨æˆ·å¹³å‡å‘é€ 50 æ¡æ¶ˆæ¯/å¤©
- æ¯å¤©æ¶ˆæ¯é‡ï¼š1 äº¿ * 50 = 50 äº¿æ¡

**å­˜å‚¨ä¼°ç®—**ï¼š
- å•æ¡æ¶ˆæ¯ï¼š200 å­—èŠ‚
- æ¯å¤©å­˜å‚¨ï¼š50 äº¿ * 200 å­—èŠ‚ = 1 TB
- ä¿ç•™ 3 ä¸ªæœˆï¼š1 TB * 90 = 90 TB

**è¿æ¥æ•°ä¼°ç®—**ï¼š
- åœ¨çº¿ç”¨æˆ·ï¼š1000 ä¸‡
- å•å°æœåŠ¡å™¨ï¼š10 ä¸‡è¿æ¥
- éœ€è¦æœåŠ¡å™¨ï¼š1000 ä¸‡ / 10 ä¸‡ = 100 å°

### 3.3 æ¶æ„è®¾è®¡

**æ•´ä½“æ¶æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     WebSocket      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¢æˆ·ç«¯  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  æ¥å…¥å±‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚  (Netty)    â”‚
                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                               â”‚  ä¸šåŠ¡å±‚      â”‚
                               â”‚  (Service)  â”‚
                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                 â”‚                 â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
             â”‚   Redis     â”‚   â”‚   MySQL   â”‚   â”‚   Kafka     â”‚
             â”‚  (åœ¨çº¿çŠ¶æ€)  â”‚   â”‚  (æ¶ˆæ¯)    â”‚   â”‚  (æ¶ˆæ¯é˜Ÿåˆ—)  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä»£ç **ï¼š

```java
// Netty æœåŠ¡å™¨
@Component
public class WebSocketServer {
    
    private EventLoopGroup bossGroup;
    private EventLoopGroup workerGroup;
    
    @PostConstruct
    public void start() throws Exception {
        bossGroup = new NioEventLoopGroup(1);
        workerGroup = new NioEventLoopGroup();
        
        ServerBootstrap bootstrap = new ServerBootstrap();
        bootstrap.group(bossGroup, workerGroup)
            .channel(NioServerSocketChannel.class)
            .childHandler(new ChannelInitializer<SocketChannel>() {
                @Override
                protected void initChannel(SocketChannel ch) {
                    ChannelPipeline pipeline = ch.pipeline();
                    pipeline.addLast(new HttpServerCodec());
                    pipeline.addLast(new HttpObjectAggregator(65536));
                    pipeline.addLast(new WebSocketServerProtocolHandler("/ws"));
                    pipeline.addLast(new WebSocketHandler());
                }
            });
        
        ChannelFuture future = bootstrap.bind(8080).sync();
        log.info("WebSocket æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼Œç«¯å£ï¼š8080");
    }
    
    @PreDestroy
    public void stop() {
        bossGroup.shutdownGracefully();
        workerGroup.shutdownGracefully();
    }
}

// WebSocket å¤„ç†å™¨
@Component
@ChannelHandler.Sharable
public class WebSocketHandler extends SimpleChannelInboundHandler<TextWebSocketFrame> {
    
    @Autowired
    private MessageService messageService;
    
    @Autowired
    private SessionManager sessionManager;
    
    @Override
    public void channelActive(ChannelHandlerContext ctx) {
        log.info("å®¢æˆ·ç«¯è¿æ¥ï¼š{}", ctx.channel().id());
    }
    
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame frame) {
        String text = frame.text();
        Message message = JSON.parseObject(text, Message.class);
        
        // å¤„ç†æ¶ˆæ¯
        messageService.handleMessage(ctx.channel(), message);
    }
    
    @Override
    public void channelInactive(ChannelHandlerContext ctx) {
        log.info("å®¢æˆ·ç«¯æ–­å¼€ï¼š{}", ctx.channel().id());
        sessionManager.removeSession(ctx.channel());
    }
}

// æ¶ˆæ¯æœåŠ¡
@Service
public class MessageService {
    
    @Autowired
    private SessionManager sessionManager;
    
    @Autowired
    private MessageRepository messageRepository;
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    /**
     * å¤„ç†æ¶ˆæ¯
     */
    public void handleMessage(Channel channel, Message message) {
        switch (message.getType()) {
            case LOGIN:
                handleLogin(channel, message);
                break;
            case SINGLE_CHAT:
                handleSingleChat(message);
                break;
            case GROUP_CHAT:
                handleGroupChat(message);
                break;
            default:
                log.warn("æœªçŸ¥æ¶ˆæ¯ç±»å‹ï¼š{}", message.getType());
        }
    }
    
    /**
     * å¤„ç†ç™»å½•
     */
    private void handleLogin(Channel channel, Message message) {
        Long userId = message.getUserId();
        
        // 1. ä¿å­˜ä¼šè¯
        sessionManager.addSession(userId, channel);
        
        // 2. æ›´æ–°åœ¨çº¿çŠ¶æ€
        updateOnlineStatus(userId, true);
        
        // 3. æ¨é€ç¦»çº¿æ¶ˆæ¯
        pushOfflineMessages(userId);
    }
    
    /**
     * å¤„ç†å•èŠ
     */
    private void handleSingleChat(Message message) {
        // 1. ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
        messageRepository.save(message);
        
        // 2. å‘é€æ¶ˆæ¯åˆ° Kafkaï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
        kafkaTemplate.send("im.message", JSON.toJSONString(message));
        
        // 3. æ¨é€æ¶ˆæ¯ç»™æ¥æ”¶è€…
        Channel receiverChannel = sessionManager.getChannel(message.getReceiverId());
        if (receiverChannel != null && receiverChannel.isActive()) {
            // åœ¨çº¿ï¼Œç›´æ¥æ¨é€
            receiverChannel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message)));
        } else {
            // ç¦»çº¿ï¼Œä¿å­˜åˆ°ç¦»çº¿æ¶ˆæ¯è¡¨
            saveOfflineMessage(message);
        }
    }
    
    /**
     * å¤„ç†ç¾¤èŠ
     */
    private void handleGroupChat(Message message) {
        // 1. ä¿å­˜æ¶ˆæ¯
        messageRepository.save(message);
        
        // 2. è·å–ç¾¤æˆå‘˜
        List<Long> memberIds = groupService.getGroupMembers(message.getGroupId());
        
        // 3. æ¨é€æ¶ˆæ¯ç»™æ‰€æœ‰åœ¨çº¿æˆå‘˜
        for (Long memberId : memberIds) {
            if (memberId.equals(message.getSenderId())) {
                continue;  // è·³è¿‡å‘é€è€…
            }
            
            Channel channel = sessionManager.getChannel(memberId);
            if (channel != null && channel.isActive()) {
                channel.writeAndFlush(new TextWebSocketFrame(JSON.toJSONString(message)));
            } else {
                saveOfflineMessage(message);
            }
        }
    }
}
```

### 3.4 ä¼˜åŒ–æ–¹æ¡ˆ

**æ€§èƒ½ä¼˜åŒ–**ï¼š
1. **è¿æ¥ç®¡ç†**ï¼š
   - ä½¿ç”¨ Netty ç®¡ç†é•¿è¿æ¥
   - å¿ƒè·³æ£€æµ‹ï¼ˆ30 ç§’ï¼‰
   - è‡ªåŠ¨é‡è¿

2. **æ¶ˆæ¯æ¨é€**ï¼š
   - å¼‚æ­¥æ¨é€
   - æ‰¹é‡æ¨é€
   - æ¶ˆæ¯åˆå¹¶

3. **å­˜å‚¨ä¼˜åŒ–**ï¼š
   - çƒ­æ•°æ® Redis
   - å†·æ•°æ® MySQL
   - å†å²æ•°æ®å½’æ¡£

**é«˜å¯ç”¨**ï¼š
1. **æœåŠ¡å¤šå®ä¾‹**ï¼š
   - æ¥å…¥å±‚å¤šå®ä¾‹
   - ä¸šåŠ¡å±‚å¤šå®ä¾‹
   - è´Ÿè½½å‡è¡¡

2. **æ¶ˆæ¯å¯é æ€§**ï¼š
   - æ¶ˆæ¯ ACK æœºåˆ¶
   - æ¶ˆæ¯é‡è¯•
   - æ¶ˆæ¯å»é‡

3. **æ•…éšœè½¬ç§»**ï¼š
   - è¿æ¥è¿ç§»
   - ä¼šè¯æ¢å¤

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] æŒæ¡ç³»ç»Ÿè®¾è®¡æ–¹æ³•è®ºï¼ˆSNAKEï¼‰
- [ ] èƒ½å¤Ÿè¿›è¡Œæ•°æ®ä¼°ç®—
- [ ] èƒ½å¤Ÿè®¾è®¡çŸ­é“¾ç³»ç»Ÿ
- [ ] èƒ½å¤Ÿè®¾è®¡ç§’æ€ç³»ç»Ÿ
- [ ] èƒ½å¤Ÿè®¾è®¡ IM ç³»ç»Ÿ
- [ ] èƒ½å¤Ÿè¿›è¡ŒæŠ€æœ¯é€‰å‹
- [ ] èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿä¼˜åŒ–

---

**@author erik.zhou**


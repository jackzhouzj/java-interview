# å¾®æœåŠ¡æ¶æ„è®¾è®¡-å®Œæ•´æ•™ç¨‹

> @author erik.zhou  
> éš¾åº¦: â­â­â­â­â­  
> æŠ€æœ¯æ ˆ: Spring Cloud + Dubbo + Kubernetes

## ğŸ“‹ ç›®å½•

- [å¾®æœåŠ¡æ ¸å¿ƒæ¦‚å¿µ](#å¾®æœåŠ¡æ ¸å¿ƒæ¦‚å¿µ)
- [å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™](#å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™)
- [æœåŠ¡æ²»ç†](#æœåŠ¡æ²»ç†)
- [å¾®æœåŠ¡é€šä¿¡](#å¾®æœåŠ¡é€šä¿¡)
- [æ•°æ®ç®¡ç†](#æ•°æ®ç®¡ç†)
- [å¾®æœåŠ¡å®‰å…¨](#å¾®æœåŠ¡å®‰å…¨)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## ğŸ¯ å¾®æœåŠ¡æ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å¾®æœåŠ¡

å¾®æœåŠ¡æ˜¯ä¸€ç§æ¶æ„é£æ ¼ï¼Œå°†å•ä¸€åº”ç”¨ç¨‹åºå¼€å‘ä¸ºä¸€ç»„å°å‹æœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡è¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­ï¼ŒæœåŠ¡é—´é‡‡ç”¨è½»é‡çº§é€šä¿¡æœºåˆ¶ï¼ˆé€šå¸¸æ˜¯HTTP RESTful APIï¼‰ã€‚

### å¾®æœåŠ¡ vs å•ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å•ä½“æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  UIå±‚ + ä¸šåŠ¡é€»è¾‘å±‚ + æ•°æ®è®¿é—®å±‚                     â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â”‚  æ‰€æœ‰åŠŸèƒ½æ‰“åŒ…åœ¨ä¸€ä¸ªåº”ç”¨ä¸­                           â”‚  â”‚
â”‚  â”‚                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                               â”‚
â”‚                         â–¼                               â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚   æ•°æ®åº“     â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å¾®æœåŠ¡æ¶æ„                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ç”¨æˆ·æœåŠ¡  â”‚  â”‚ è®¢å•æœåŠ¡  â”‚  â”‚ å•†å“æœåŠ¡  â”‚  â”‚ æ”¯ä»˜æœåŠ¡  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚       â”‚             â”‚             â”‚             â”‚        â”‚
â”‚       â–¼             â–¼             â–¼             â–¼        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ç”¨æˆ·DB â”‚   â”‚ è®¢å•DB â”‚   â”‚ å•†å“DB â”‚   â”‚ æ”¯ä»˜DB â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¾®æœåŠ¡ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š
- ç‹¬ç«‹éƒ¨ç½²å’Œæ‰©å±•
- æŠ€æœ¯æ ˆçµæ´»
- æ•…éšœéš”ç¦»
- å›¢é˜Ÿè‡ªæ²»

**ç¼ºç‚¹**ï¼š
- åˆ†å¸ƒå¼ç³»ç»Ÿå¤æ‚æ€§
- æ•°æ®ä¸€è‡´æ€§æŒ‘æˆ˜
- è¿ç»´æˆæœ¬å¢åŠ 
- æœåŠ¡é—´é€šä¿¡å¼€é”€

---

## âœ‚ï¸ å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™

### 1. æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†

```
ç”µå•†ç³»ç»Ÿæ‹†åˆ†ç¤ºä¾‹ï¼š

ç”¨æˆ·åŸŸï¼š
  - ç”¨æˆ·æœåŠ¡ï¼ˆæ³¨å†Œã€ç™»å½•ã€ä¸ªäººä¿¡æ¯ï¼‰
  - è®¤è¯æœåŠ¡ï¼ˆOAuth2ã€JWTï¼‰

å•†å“åŸŸï¼š
  - å•†å“æœåŠ¡ï¼ˆå•†å“ç®¡ç†ã€ç±»ç›®ç®¡ç†ï¼‰
  - åº“å­˜æœåŠ¡ï¼ˆåº“å­˜ç®¡ç†ã€åº“å­˜æ‰£å‡ï¼‰

äº¤æ˜“åŸŸï¼š
  - è®¢å•æœåŠ¡ï¼ˆè®¢å•åˆ›å»ºã€è®¢å•ç®¡ç†ï¼‰
  - æ”¯ä»˜æœåŠ¡ï¼ˆæ”¯ä»˜ã€é€€æ¬¾ï¼‰
  - è´­ç‰©è½¦æœåŠ¡ï¼ˆè´­ç‰©è½¦ç®¡ç†ï¼‰

è¥é”€åŸŸï¼š
  - ä¼˜æƒ åˆ¸æœåŠ¡ï¼ˆä¼˜æƒ åˆ¸å‘æ”¾ã€ä½¿ç”¨ï¼‰
  - æ´»åŠ¨æœåŠ¡ï¼ˆä¿ƒé”€æ´»åŠ¨ç®¡ç†ï¼‰

ç‰©æµåŸŸï¼š
  - ç‰©æµæœåŠ¡ï¼ˆç‰©æµè·Ÿè¸ªã€é…é€ï¼‰
```

### 2. æŒ‰DDDé™ç•Œä¸Šä¸‹æ–‡æ‹†åˆ†

```java
/**
 * æŒ‰DDDé™ç•Œä¸Šä¸‹æ–‡æ‹†åˆ†
 * @author erik.zhou
 */

// è®¢å•ä¸Šä¸‹æ–‡
@Service
public class OrderService {
    // è®¢å•èšåˆæ ¹
    // è®¢å•é¡¹å®ä½“
    // è®¢å•çŠ¶æ€å€¼å¯¹è±¡
}

// å•†å“ä¸Šä¸‹æ–‡
@Service
public class ProductService {
    // å•†å“èšåˆæ ¹
    // SKUå®ä½“
    // ä»·æ ¼å€¼å¯¹è±¡
}

// åº“å­˜ä¸Šä¸‹æ–‡
@Service
public class InventoryService {
    // åº“å­˜èšåˆæ ¹
    // ä»“åº“å®ä½“
}
```

### 3. æ‹†åˆ†åŸåˆ™

```
1. å•ä¸€èŒè´£åŸåˆ™
   - æ¯ä¸ªæœåŠ¡åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡èƒ½åŠ›
   
2. é«˜å†…èšä½è€¦åˆ
   - æœåŠ¡å†…éƒ¨é«˜å†…èš
   - æœåŠ¡ä¹‹é—´ä½è€¦åˆ
   
3. æœåŠ¡è‡ªæ²»
   - ç‹¬ç«‹å¼€å‘ã€éƒ¨ç½²ã€æ‰©å±•
   - æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“
   
4. åˆé€‚çš„ç²’åº¦
   - ä¸è¦è¿‡åº¦æ‹†åˆ†
   - é¿å…åˆ†å¸ƒå¼å•ä½“
   
5. æ¼”è¿›å¼æ‹†åˆ†
   - ä»å•ä½“é€æ­¥æ‹†åˆ†
   - å…ˆæ‹†åˆ†æ ¸å¿ƒä¸šåŠ¡
```

---

## ğŸ”§ æœåŠ¡æ²»ç†

### 1. æœåŠ¡æ³¨å†Œä¸å‘ç°

```java
/**
 * NacosæœåŠ¡æ³¨å†Œ
 * @author erik.zhou
 */
@SpringBootApplication
@EnableDiscoveryClient
public class OrderServiceApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderServiceApplication.class, args);
    }
}

// application.yml
spring:
  application:
    name: order-service
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        namespace: dev
        group: DEFAULT_GROUP
        metadata:
          version: 1.0.0
          region: cn-beijing
```

```java
/**
 * æœåŠ¡å‘ç°
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    private DiscoveryClient discoveryClient;
    
    @Autowired
    private RestTemplate restTemplate;
    
    /**
     * è°ƒç”¨å•†å“æœåŠ¡
     */
    public Product getProduct(Long productId) {
        // 1. ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡å®ä¾‹
        List<ServiceInstance> instances = discoveryClient
            .getInstances("product-service");
        
        if (instances.isEmpty()) {
            throw new ServiceException("å•†å“æœåŠ¡ä¸å¯ç”¨");
        }
        
        // 2. è´Ÿè½½å‡è¡¡é€‰æ‹©å®ä¾‹
        ServiceInstance instance = loadBalance(instances);
        
        // 3. è°ƒç”¨æœåŠ¡
        String url = instance.getUri() + "/api/products/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
    
    /**
     * ç®€å•çš„è´Ÿè½½å‡è¡¡
     */
    private ServiceInstance loadBalance(List<ServiceInstance> instances) {
        int index = ThreadLocalRandom.current().nextInt(instances.size());
        return instances.get(index);
    }
}
```

### 2. è´Ÿè½½å‡è¡¡

```java
/**
 * Ribbonè´Ÿè½½å‡è¡¡
 * @author erik.zhou
 */
@Configuration
public class LoadBalancerConfig {
    
    /**
     * é…ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥
     */
    @Bean
    public IRule ribbonRule() {
        // è½®è¯¢ç­–ç•¥
        return new RoundRobinRule();
        
        // éšæœºç­–ç•¥
        // return new RandomRule();
        
        // é‡è¯•ç­–ç•¥
        // return new RetryRule();
        
        // æœ€å°å¹¶å‘ç­–ç•¥
        // return new BestAvailableRule();
        
        // åŠ æƒå“åº”æ—¶é—´ç­–ç•¥
        // return new WeightedResponseTimeRule();
    }
}

/**
 * ä½¿ç”¨Ribbonè°ƒç”¨æœåŠ¡
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    @LoadBalanced  // å¯ç”¨è´Ÿè½½å‡è¡¡
    private RestTemplate restTemplate;
    
    /**
     * è°ƒç”¨å•†å“æœåŠ¡
     */
    public Product getProduct(Long productId) {
        // ç›´æ¥ä½¿ç”¨æœåŠ¡åè°ƒç”¨
        String url = "http://product-service/api/products/" + productId;
        return restTemplate.getForObject(url, Product.class);
    }
}
```

### 3. æœåŠ¡ç†”æ–­é™çº§

```java
/**
 * Sentinelç†”æ–­é™çº§
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    private ProductServiceClient productServiceClient;
    
    /**
     * åˆ›å»ºè®¢å•
     */
    @SentinelResource(
        value = "createOrder",
        blockHandler = "createOrderBlockHandler",
        fallback = "createOrderFallback"
    )
    public Order createOrder(OrderCreateRequest request) {
        // 1. æŸ¥è¯¢å•†å“ä¿¡æ¯
        Product product = productServiceClient.getProduct(request.getProductId());
        
        // 2. æ£€æŸ¥åº“å­˜
        boolean hasStock = checkStock(request.getProductId(), request.getQuantity());
        if (!hasStock) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        // 3. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        order.setPrice(product.getPrice());
        
        orderRepository.save(order);
        
        return order;
    }
    
    /**
     * é™æµå¤„ç†
     */
    public Order createOrderBlockHandler(OrderCreateRequest request, BlockException ex) {
        log.warn("åˆ›å»ºè®¢å•è¢«é™æµ: {}", request);
        throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
    }
    
    /**
     * é™çº§å¤„ç†
     */
    public Order createOrderFallback(OrderCreateRequest request, Throwable ex) {
        log.error("åˆ›å»ºè®¢å•å¤±è´¥: {}", request, ex);
        throw new BusinessException("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
    }
}

/**
 * Sentinelè§„åˆ™é…ç½®
 * @author erik.zhou
 */
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void initRules() {
        // æµæ§è§„åˆ™
        List<FlowRule> flowRules = new ArrayList<>();
        FlowRule flowRule = new FlowRule();
        flowRule.setResource("createOrder");
        flowRule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        flowRule.setCount(100);  // QPSé˜ˆå€¼
        flowRules.add(flowRule);
        FlowRuleManager.loadRules(flowRules);
        
        // ç†”æ–­è§„åˆ™
        List<DegradeRule> degradeRules = new ArrayList<>();
        DegradeRule degradeRule = new DegradeRule();
        degradeRule.setResource("createOrder");
        degradeRule.setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType());
        degradeRule.setCount(0.5);  // é”™è¯¯ç‡50%
        degradeRule.setTimeWindow(10);  // ç†”æ–­æ—¶é•¿10ç§’
        degradeRules.add(degradeRule);
        DegradeRuleManager.loadRules(degradeRules);
    }
}
```

### 4. æœåŠ¡ç½‘å…³

```java
/**
 * Spring Cloud Gatewayé…ç½®
 * @author erik.zhou
 */
@Configuration
public class GatewayConfig {
    
    @Bean
    public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
        return builder.routes()
            // ç”¨æˆ·æœåŠ¡è·¯ç”±
            .route("user-service", r -> r
                .path("/api/users/**")
                .filters(f -> f
                    .stripPrefix(1)
                    .addRequestHeader("X-Gateway", "true")
                    .circuitBreaker(c -> c
                        .setName("userServiceCircuitBreaker")
                        .setFallbackUri("forward:/fallback/user"))
                )
                .uri("lb://user-service"))
            
            // è®¢å•æœåŠ¡è·¯ç”±
            .route("order-service", r -> r
                .path("/api/orders/**")
                .filters(f -> f
                    .stripPrefix(1)
                    .requestRateLimiter(c -> c
                        .setRateLimiter(redisRateLimiter())
                        .setKeyResolver(ipKeyResolver()))
                )
                .uri("lb://order-service"))
            
            .build();
    }
    
    /**
     * Redisé™æµå™¨
     */
    @Bean
    public RedisRateLimiter redisRateLimiter() {
        return new RedisRateLimiter(100, 200);  // ä»¤ç‰Œæ¡¶ï¼šæ¯ç§’100ä¸ªï¼Œçªå‘200ä¸ª
    }
    
    /**
     * IPé™æµKeyè§£æå™¨
     */
    @Bean
    public KeyResolver ipKeyResolver() {
        return exchange -> Mono.just(
            exchange.getRequest().getRemoteAddress().getAddress().getHostAddress()
        );
    }
}
```

---

## ğŸ“¡ å¾®æœåŠ¡é€šä¿¡

### 1. åŒæ­¥é€šä¿¡ - REST

```java
/**
 * OpenFeignå£°æ˜å¼è°ƒç”¨
 * @author erik.zhou
 */
@FeignClient(
    name = "product-service",
    fallback = ProductServiceFallback.class
)
public interface ProductServiceClient {
    
    @GetMapping("/api/products/{id}")
    Product getProduct(@PathVariable("id") Long id);
    
    @PostMapping("/api/products")
    Product createProduct(@RequestBody ProductCreateRequest request);
    
    @GetMapping("/api/products")
    PageResult<Product> getProducts(
        @RequestParam("page") int page,
        @RequestParam("size") int size
    );
}

/**
 * Fallbackå®ç°
 * @author erik.zhou
 */
@Component
public class ProductServiceFallback implements ProductServiceClient {
    
    @Override
    public Product getProduct(Long id) {
        log.warn("å•†å“æœåŠ¡è°ƒç”¨å¤±è´¥ï¼Œè¿”å›é»˜è®¤å€¼");
        return Product.getDefault();
    }
    
    @Override
    public Product createProduct(ProductCreateRequest request) {
        throw new ServiceException("å•†å“æœåŠ¡ä¸å¯ç”¨");
    }
    
    @Override
    public PageResult<Product> getProducts(int page, int size) {
        return PageResult.empty();
    }
}
```

### 2. åŒæ­¥é€šä¿¡ - RPC

```java
/**
 * Dubbo RPCè°ƒç”¨
 * @author erik.zhou
 */

// æœåŠ¡æä¾›è€…
@DubboService(version = "1.0.0", timeout = 3000)
public class ProductServiceImpl implements ProductService {
    
    @Override
    public Product getProduct(Long id) {
        return productRepository.findById(id)
            .orElseThrow(() -> new NotFoundException("å•†å“ä¸å­˜åœ¨"));
    }
}

// æœåŠ¡æ¶ˆè´¹è€…
@Service
public class OrderService {
    
    @DubboReference(version = "1.0.0", timeout = 3000, retries = 2)
    private ProductService productService;
    
    public Order createOrder(OrderCreateRequest request) {
        // è°ƒç”¨å•†å“æœåŠ¡
        Product product = productService.getProduct(request.getProductId());
        
        // åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setProductId(product.getId());
        order.setPrice(product.getPrice());
        
        return orderRepository.save(order);
    }
}
```

### 3. å¼‚æ­¥é€šä¿¡ - æ¶ˆæ¯é˜Ÿåˆ—

```java
/**
 * RabbitMQå¼‚æ­¥é€šä¿¡
 * @author erik.zhou
 */

// æ¶ˆæ¯å‘é€è€…
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * åˆ›å»ºè®¢å•åå‘é€æ¶ˆæ¯
     */
    public Order createOrder(OrderCreateRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        // ... è®¾ç½®è®¢å•ä¿¡æ¯
        orderRepository.save(order);
        
        // 2. å‘é€è®¢å•åˆ›å»ºäº‹ä»¶
        OrderCreatedEvent event = new OrderCreatedEvent();
        event.setOrderId(order.getId());
        event.setUserId(order.getUserId());
        event.setTotalAmount(order.getTotalAmount());
        
        rabbitTemplate.convertAndSend(
            "order.exchange",
            "order.created",
            event
        );
        
        return order;
    }
}

// æ¶ˆæ¯æ¥æ”¶è€…
@Component
public class InventoryEventListener {
    
    @Autowired
    private InventoryService inventoryService;
    
    /**
     * ç›‘å¬è®¢å•åˆ›å»ºäº‹ä»¶ï¼Œæ‰£å‡åº“å­˜
     */
    @RabbitListener(queues = "inventory.order.created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        log.info("æ”¶åˆ°è®¢å•åˆ›å»ºäº‹ä»¶: {}", event);
        
        try {
            // æ‰£å‡åº“å­˜
            inventoryService.deductInventory(
                event.getOrderId(),
                event.getProductId(),
                event.getQuantity()
            );
            
        } catch (Exception e) {
            log.error("æ‰£å‡åº“å­˜å¤±è´¥", e);
            // å‘é€è¡¥å¿æ¶ˆæ¯
            sendCompensationMessage(event);
        }
    }
}
```

---

## ğŸ’¾ æ•°æ®ç®¡ç†

### 1. æ•°æ®åº“æ‹†åˆ†

```
æ¯ä¸ªå¾®æœåŠ¡æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®åº“ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡     â”‚     â”‚  è®¢å•æœåŠ¡     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·é€»è¾‘     â”‚     â”‚  è®¢å•é€»è¾‘     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚
       â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·DB      â”‚     â”‚   è®¢å•DB      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
- æœåŠ¡ç‹¬ç«‹æ€§
- æŠ€æœ¯æ ˆçµæ´»
- æ•…éšœéš”ç¦»

æŒ‘æˆ˜ï¼š
- åˆ†å¸ƒå¼äº‹åŠ¡
- æ•°æ®ä¸€è‡´æ€§
- è·¨åº“æŸ¥è¯¢
```

### 2. åˆ†å¸ƒå¼äº‹åŠ¡

```java
/**
 * Seataåˆ†å¸ƒå¼äº‹åŠ¡
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private ProductServiceClient productServiceClient;
    
    @Autowired
    private InventoryServiceClient inventoryServiceClient;
    
    /**
     * åˆ›å»ºè®¢å•ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰
     */
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public Order createOrder(OrderCreateRequest request) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setProductId(request.getProductId());
        order.setQuantity(request.getQuantity());
        orderRepository.save(order);
        
        // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        inventoryServiceClient.deductInventory(
            request.getProductId(),
            request.getQuantity()
        );
        
        // 3. æ‰£å‡ç§¯åˆ†ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
        if (request.getUsePoints() > 0) {
            userServiceClient.deductPoints(
                request.getUserId(),
                request.getUsePoints()
            );
        }
        
        return order;
    }
}
```

### 3. æœ€ç»ˆä¸€è‡´æ€§

```java
/**
 * åŸºäºæ¶ˆæ¯çš„æœ€ç»ˆä¸€è‡´æ€§
 * @author erik.zhou
 */
@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    /**
     * åˆ›å»ºè®¢å•
     */
    @Transactional
    public Order createOrder(OrderCreateRequest request) {
        // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        Order order = new Order();
        // ... è®¾ç½®è®¢å•ä¿¡æ¯
        orderRepository.save(order);
        
        // 2. å‘é€äº‹ä»¶æ¶ˆæ¯
        OrderCreatedEvent event = new OrderCreatedEvent(order);
        rabbitTemplate.convertAndSend("order.exchange", "order.created", event);
        
        return order;
    }
}

/**
 * åº“å­˜æœåŠ¡ç›‘å¬è®¢å•äº‹ä»¶
 * @author erik.zhou
 */
@Component
public class InventoryEventListener {
    
    @RabbitListener(queues = "inventory.order.created")
    @Transactional
    public void handleOrderCreated(OrderCreatedEvent event) {
        // æ‰£å‡åº“å­˜ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
        inventoryService.deductInventory(
            event.getProductId(),
            event.getQuantity()
        );
    }
}
```

---

## ğŸ”’ å¾®æœåŠ¡å®‰å…¨

### 1. æœåŠ¡é—´è®¤è¯

```java
/**
 * æœåŠ¡é—´JWTè®¤è¯
 * @author erik.zhou
 */
@Component
public class ServiceAuthInterceptor implements ClientHttpRequestInterceptor {
    
    @Value("${service.auth.secret}")
    private String secret;
    
    @Override
    public ClientHttpResponse intercept(
            HttpRequest request,
            byte[] body,
            ClientHttpRequestExecution execution) throws IOException {
        
        // ç”ŸæˆæœåŠ¡é—´è®¤è¯Token
        String token = generateServiceToken();
        
        // æ·»åŠ åˆ°è¯·æ±‚å¤´
        request.getHeaders().add("X-Service-Token", token);
        
        return execution.execute(request, body);
    }
    
    private String generateServiceToken() {
        return Jwts.builder()
            .setSubject("order-service")
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + 60000))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
}
```

### 2. APIç½‘å…³é‰´æƒ

```java
/**
 * ç½‘å…³é‰´æƒè¿‡æ»¤å™¨
 * @author erik.zhou
 */
@Component
public class AuthGatewayFilter implements GlobalFilter, Ordered {
    
    @Autowired
    private JwtTokenUtil jwtTokenUtil;
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        ServerHttpRequest request = exchange.getRequest();
        
        // ç™½åå•è·¯å¾„
        if (isWhiteListed(request.getPath().value())) {
            return chain.filter(exchange);
        }
        
        // è·å–Token
        String token = extractToken(request);
        if (token == null) {
            return unauthorized(exchange);
        }
        
        // éªŒè¯Token
        if (!jwtTokenUtil.validateToken(token)) {
            return unauthorized(exchange);
        }
        
        // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
        String userId = jwtTokenUtil.getUserIdFromToken(token);
        ServerHttpRequest newRequest = request.mutate()
            .header("X-User-Id", userId)
            .build();
        
        return chain.filter(exchange.mutate().request(newRequest).build());
    }
    
    @Override
    public int getOrder() {
        return -100;
    }
}
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. æœåŠ¡æ‹†åˆ†å»ºè®®

```
1. ä»å•ä½“å¼€å§‹
   - ä¸è¦ä¸€å¼€å§‹å°±å¾®æœåŠ¡
   - ä¸šåŠ¡ç¨³å®šåå†æ‹†åˆ†
   
2. æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†
   - ä¸è¦æŒ‰æŠ€æœ¯å±‚æ‹†åˆ†
   - éµå¾ªDDDåŸåˆ™
   
3. åˆé€‚çš„ç²’åº¦
   - ä¸è¦è¿‡åº¦æ‹†åˆ†
   - ä¸€ä¸ªå›¢é˜Ÿç»´æŠ¤3-5ä¸ªæœåŠ¡
   
4. æ¼”è¿›å¼æ‹†åˆ†
   - å…ˆæ‹†åˆ†æ ¸å¿ƒä¸šåŠ¡
   - é€æ­¥æ‹†åˆ†å…¶ä»–æ¨¡å—
```

### 2. æœåŠ¡é€šä¿¡å»ºè®®

```
1. åŒæ­¥ vs å¼‚æ­¥
   - æŸ¥è¯¢æ“ä½œï¼šåŒæ­¥è°ƒç”¨
   - äº‹ä»¶é€šçŸ¥ï¼šå¼‚æ­¥æ¶ˆæ¯
   
2. REST vs RPC
   - å¤–éƒ¨æ¥å£ï¼šREST
   - å†…éƒ¨è°ƒç”¨ï¼šRPC
   
3. è¶…æ—¶å’Œé‡è¯•
   - è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
   - å®ç°å¹‚ç­‰æ€§
   - ä½¿ç”¨æŒ‡æ•°é€€é¿é‡è¯•
```

### 3. æ•°æ®ç®¡ç†å»ºè®®

```
1. æ•°æ®åº“æ‹†åˆ†
   - æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ•°æ®åº“
   - é¿å…è·¨åº“join
   
2. åˆ†å¸ƒå¼äº‹åŠ¡
   - ä¼˜å…ˆä½¿ç”¨æœ€ç»ˆä¸€è‡´æ€§
   - å¿…è¦æ—¶ä½¿ç”¨Seata
   
3. æ•°æ®åŒæ­¥
   - ä½¿ç”¨CDCï¼ˆCanalï¼‰
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—
```

---

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **æœåŠ¡æ‹†åˆ†** - æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†ï¼Œåˆé€‚çš„ç²’åº¦
2. **æœåŠ¡æ²»ç†** - æ³¨å†Œå‘ç°ã€è´Ÿè½½å‡è¡¡ã€ç†”æ–­é™çº§
3. **æœåŠ¡é€šä¿¡** - RESTã€RPCã€æ¶ˆæ¯é˜Ÿåˆ—
4. **æ•°æ®ç®¡ç†** - ç‹¬ç«‹æ•°æ®åº“ã€åˆ†å¸ƒå¼äº‹åŠ¡ã€æœ€ç»ˆä¸€è‡´æ€§
5. **æœåŠ¡å®‰å…¨** - è®¤è¯é‰´æƒã€APIç½‘å…³

### å®æ–½å»ºè®®

1. **å¾ªåºæ¸è¿›** - ä»å•ä½“é€æ­¥æ¼”è¿›åˆ°å¾®æœåŠ¡
2. **æŠ€æœ¯é€‰å‹** - æ ¹æ®å›¢é˜Ÿèƒ½åŠ›é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ ˆ
3. **ç›‘æ§å®Œå–„** - å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»
4. **æ–‡æ¡£é½å…¨** - ç»´æŠ¤æœåŠ¡æ–‡æ¡£å’Œæ¥å£æ–‡æ¡£

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04

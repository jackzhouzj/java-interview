# å‘é‡æ•°æ®åº“å®Œæ•´æ•™ç¨‹

> **ä½œè€…**: erik.zhou  
> **åˆ›å»ºæ—¶é—´**: 2025-01-31  
> **æŠ€æœ¯æ ˆ**: Pinecone, Milvus, Qdrant, Chroma, Weaviate

## ğŸ“‹ ç›®å½•

- [1. å‘é‡æ•°æ®åº“ç®€ä»‹](#1-å‘é‡æ•°æ®åº“ç®€ä»‹)
- [2. æ ¸å¿ƒæ¦‚å¿µ](#2-æ ¸å¿ƒæ¦‚å¿µ)
- [3. ä¸»æµå‘é‡æ•°æ®åº“å¯¹æ¯”](#3-ä¸»æµå‘é‡æ•°æ®åº“å¯¹æ¯”)
- [4. Pineconeå®æˆ˜](#4-pineconeå®æˆ˜)
- [5. Milvuså®æˆ˜](#5-milvuså®æˆ˜)
- [6. æ€§èƒ½ä¼˜åŒ–](#6-æ€§èƒ½ä¼˜åŒ–)
- [7. æœ€ä½³å®è·µ](#7-æœ€ä½³å®è·µ)

---

## 1. å‘é‡æ•°æ®åº“ç®€ä»‹

### 1.1 ä»€ä¹ˆæ˜¯å‘é‡æ•°æ®åº“

å‘é‡æ•°æ®åº“æ˜¯ä¸“é—¨ç”¨äºå­˜å‚¨å’Œæ£€ç´¢é«˜ç»´å‘é‡æ•°æ®çš„æ•°æ®åº“ç³»ç»Ÿï¼Œæ˜¯AIåº”ç”¨(ç‰¹åˆ«æ˜¯RAGç³»ç»Ÿ)çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ã€‚

**æ ¸å¿ƒç‰¹æ€§**:
- ğŸ” é«˜æ•ˆçš„ç›¸ä¼¼åº¦æœç´¢
- ğŸ“Š æ”¯æŒé«˜ç»´å‘é‡å­˜å‚¨
- âš¡ æ¯«ç§’çº§æŸ¥è¯¢å“åº”
- ğŸ“ˆ æ°´å¹³æ‰©å±•èƒ½åŠ›
- ğŸ”„ å®æ—¶ç´¢å¼•æ›´æ–°

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å‘é‡æ•°æ®åº“

ä¼ ç»Ÿæ•°æ®åº“æ— æ³•é«˜æ•ˆå¤„ç†å‘é‡ç›¸ä¼¼åº¦æœç´¢:

| ç‰¹æ€§ | ä¼ ç»Ÿæ•°æ®åº“ | å‘é‡æ•°æ®åº“ |
|------|-----------|-----------|
| æ•°æ®ç±»å‹ | ç»“æ„åŒ–æ•°æ® | é«˜ç»´å‘é‡ |
| æŸ¥è¯¢æ–¹å¼ | ç²¾ç¡®åŒ¹é… | ç›¸ä¼¼åº¦æœç´¢ |
| ç´¢å¼•ç®—æ³• | B-Tree/Hash | HNSW/IVF |
| æŸ¥è¯¢æ€§èƒ½ | O(log n) | O(log n) è¿‘ä¼¼ |
| é€‚ç”¨åœºæ™¯ | CRUDæ“ä½œ | è¯­ä¹‰æœç´¢/æ¨è |

### 1.3 åº”ç”¨åœºæ™¯

- **è¯­ä¹‰æœç´¢**: åŸºäºå†…å®¹ç†è§£çš„æœç´¢
- **æ¨èç³»ç»Ÿ**: ç›¸ä¼¼å•†å“/å†…å®¹æ¨è
- **RAGç³»ç»Ÿ**: æ£€ç´¢å¢å¼ºç”Ÿæˆ
- **å›¾åƒæœç´¢**: ä»¥å›¾æœå›¾
- **å¼‚å¸¸æ£€æµ‹**: è¯†åˆ«å¼‚å¸¸æ¨¡å¼

---

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 å‘é‡åµŒå…¥ (Embedding)

å°†æ–‡æœ¬ã€å›¾åƒç­‰æ•°æ®è½¬æ¢ä¸ºå›ºå®šç»´åº¦çš„æ•°å€¼å‘é‡:

```
æ–‡æœ¬: "LangChain4jæ˜¯ä¸€ä¸ªJavaæ¡†æ¶"
â†“ (Embedding Model)
å‘é‡: [0.23, -0.45, 0.67, ..., 0.12]  // 1536ç»´
```

### 2.2 ç›¸ä¼¼åº¦åº¦é‡

#### 2.2.1 ä½™å¼¦ç›¸ä¼¼åº¦ (Cosine Similarity)
```java
/**
 * ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—
 * 
 * @author erik.zhou
 */
public class SimilarityCalculator {
    
    public static double cosineSimilarity(float[] vectorA, float[] vectorB) {
        double dotProduct = 0.0;
        double normA = 0.0;
        double normB = 0.0;
        
        for (int i = 0; i < vectorA.length; i++) {
            dotProduct += vectorA[i] * vectorB[i];
            normA += Math.pow(vectorA[i], 2);
            normB += Math.pow(vectorB[i], 2);
        }
        
        return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
    }
}
```

#### 2.2.2 æ¬§æ°è·ç¦» (Euclidean Distance)
```java
public static double euclideanDistance(float[] vectorA, float[] vectorB) {
    double sum = 0.0;
    for (int i = 0; i < vectorA.length; i++) {
        sum += Math.pow(vectorA[i] - vectorB[i], 2);
    }
    return Math.sqrt(sum);
}
```

### 2.3 ç´¢å¼•ç®—æ³•

#### HNSW (Hierarchical Navigable Small World)
- é«˜æ€§èƒ½è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢
- å¤šå±‚å›¾ç»“æ„
- æŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œå¬å›ç‡é«˜

#### IVF (Inverted File Index)
- å€’æ’ç´¢å¼•ç»“æ„
- é€‚åˆå¤§è§„æ¨¡æ•°æ®
- éœ€è¦è®­ç»ƒèšç±»ä¸­å¿ƒ

---

## 3. ä¸»æµå‘é‡æ•°æ®åº“å¯¹æ¯”

### 3.1 åŠŸèƒ½å¯¹æ¯”

| æ•°æ®åº“ | éƒ¨ç½²æ–¹å¼ | æ€§èƒ½ | æ˜“ç”¨æ€§ | æˆæœ¬ | æ¨èåœºæ™¯ |
|--------|---------|------|--------|------|---------|
| Pinecone | äº‘æœåŠ¡ | â­â­â­â­â­ | â­â­â­â­â­ | ğŸ’°ğŸ’°ğŸ’° | ç”Ÿäº§ç¯å¢ƒ |
| Milvus | è‡ªæ‰˜ç®¡/äº‘ | â­â­â­â­â­ | â­â­â­ | ğŸ’° | å¤§è§„æ¨¡éƒ¨ç½² |
| Qdrant | è‡ªæ‰˜ç®¡/äº‘ | â­â­â­â­ | â­â­â­â­ | ğŸ’°ğŸ’° | ä¸­å°è§„æ¨¡ |
| Chroma | æœ¬åœ°/äº‘ | â­â­â­ | â­â­â­â­â­ | å…è´¹ | å¼€å‘æµ‹è¯• |
| Weaviate | è‡ªæ‰˜ç®¡/äº‘ | â­â­â­â­ | â­â­â­â­ | ğŸ’°ğŸ’° | GraphQLéœ€æ±‚ |

### 3.2 æŠ€æœ¯ç‰¹ç‚¹

#### Pinecone
- âœ… å®Œå…¨æ‰˜ç®¡ï¼Œé›¶è¿ç»´
- âœ… è‡ªåŠ¨æ‰©å±•
- âœ… ä½å»¶è¿Ÿ
- âŒ æˆæœ¬è¾ƒé«˜
- âŒ ä¾›åº”å•†é”å®š

#### Milvus
- âœ… å¼€æºå…è´¹
- âœ… é«˜æ€§èƒ½
- âœ… æ”¯æŒå¤šç§ç´¢å¼•
- âŒ éƒ¨ç½²å¤æ‚
- âŒ å­¦ä¹ æ›²çº¿é™¡å³­

#### Qdrant
- âœ… Rustå®ç°ï¼Œæ€§èƒ½ä¼˜ç§€
- âœ… ä¸°å¯Œçš„è¿‡æ»¤åŠŸèƒ½
- âœ… æ˜“äºéƒ¨ç½²
- âš ï¸ ç¤¾åŒºç›¸å¯¹è¾ƒå°

---

## 4. Pineconeå®æˆ˜

### 4.1 å¿«é€Ÿå¼€å§‹

#### 4.1.1 Mavenä¾èµ–
```xml
<dependencies>
    <!-- Pineconeå®¢æˆ·ç«¯ -->
    <dependency>
        <groupId>io.pinecone</groupId>
        <artifactId>pinecone-client</artifactId>
        <version>0.7.0</version>
    </dependency>
    
    <!-- LangChain4j Pineconeé›†æˆ -->
    <dependency>
        <groupId>dev.langchain4j</groupId>
        <artifactId>langchain4j-pinecone</artifactId>
        <version>0.36.0</version>
    </dependency>
</dependencies>
```

#### 4.1.2 é…ç½®
```yaml
# application.yml
pinecone:
  api-key: ${PINECONE_API_KEY}
  environment: us-east-1-aws
  index-name: langchain4j-demo
  dimension: 1536
  metric: cosine
```

### 4.2 æ ¸å¿ƒæ“ä½œ

#### 4.2.1 åˆå§‹åŒ–å®¢æˆ·ç«¯
```java
package com.example.vector.pinecone;

import io.pinecone.clients.Pinecone;
import io.pinecone.clients.Index;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

/**
 * Pineconeé…ç½®
 * 
 * @author erik.zhou
 */
@Configuration
public class PineconeConfig {
    
    @Value("${pinecone.api-key}")
    private String apiKey;
    
    @Value("${pinecone.index-name}")
    private String indexName;
    
    @Bean
    public Pinecone pineconeClient() {
        return new Pinecone.Builder(apiKey).build();
    }
    
    @Bean
    public Index pineconeIndex(Pinecone pinecone) {
        return pinecone.getIndexConnection(indexName);
    }
}
```

#### 4.2.2 å‘é‡å­˜å‚¨æœåŠ¡
```java
package com.example.vector.pinecone;

import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.EmbeddingStore;
import dev.langchain4j.store.embedding.pinecone.PineconeEmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Pineconeå‘é‡å­˜å‚¨æœåŠ¡
 * 
 * @author erik.zhou
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class PineconeVectorService {
    
    private final EmbeddingStore<TextSegment> embeddingStore;
    
    /**
     * æ·»åŠ å‘é‡
     */
    public String addVector(String id, Embedding embedding, TextSegment textSegment) {
        log.info("æ·»åŠ å‘é‡: id={}", id);
        return embeddingStore.add(id, embedding, textSegment);
    }
    
    /**
     * æ‰¹é‡æ·»åŠ å‘é‡
     */
    public List<String> addVectors(List<Embedding> embeddings, List<TextSegment> segments) {
        log.info("æ‰¹é‡æ·»åŠ å‘é‡: count={}", embeddings.size());
        return embeddingStore.addAll(embeddings, segments);
    }
    
    /**
     * ç›¸ä¼¼åº¦æœç´¢
     */
    public List<EmbeddingMatch<TextSegment>> search(
        Embedding queryEmbedding,
        int maxResults,
        double minScore
    ) {
        log.info("æ‰§è¡Œç›¸ä¼¼åº¦æœç´¢: maxResults={}, minScore={}", maxResults, minScore);
        return embeddingStore.findRelevant(queryEmbedding, maxResults, minScore);
    }
    
    /**
     * åˆ é™¤å‘é‡
     */
    public void deleteVector(String id) {
        log.info("åˆ é™¤å‘é‡: id={}", id);
        embeddingStore.remove(id);
    }
}
```


#### 4.2.3 å®Œæ•´RAGç¤ºä¾‹
```java
package com.example.vector.pinecone;

import dev.langchain4j.data.document.Document;
import dev.langchain4j.data.document.splitter.DocumentSplitters;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.model.embedding.EmbeddingModel;
import dev.langchain4j.model.chat.ChatLanguageModel;
import dev.langchain4j.rag.content.retriever.ContentRetriever;
import dev.langchain4j.rag.content.retriever.EmbeddingStoreContentRetriever;
import dev.langchain4j.service.AiServices;
import dev.langchain4j.store.embedding.EmbeddingStore;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * åŸºäºPineconeçš„RAGæœåŠ¡
 * 
 * @author erik.zhou
 */
@Slf4j
@Service
@RequiredArgsConstructor
public class PineconeRAGService {
    
    private final EmbeddingModel embeddingModel;
    private final ChatLanguageModel chatModel;
    private final EmbeddingStore<TextSegment> embeddingStore;
    
    /**
     * ç´¢å¼•æ–‡æ¡£
     */
    public void indexDocuments(List<Document> documents) {
        log.info("å¼€å§‹ç´¢å¼•æ–‡æ¡£: count={}", documents.size());
        
        // 1. åˆ†å‰²æ–‡æ¡£
        List<TextSegment> segments = documents.stream()
            .flatMap(doc -> DocumentSplitters.recursive(500, 100)
                .split(doc)
                .stream())
            .toList();
        
        log.info("æ–‡æ¡£å·²åˆ†å‰²ä¸º {} ä¸ªç‰‡æ®µ", segments.size());
        
        // 2. æ‰¹é‡ç”ŸæˆåµŒå…¥
        List<Embedding> embeddings = segments.stream()
            .map(segment -> embeddingModel.embed(segment).content())
            .toList();
        
        // 3. å­˜å‚¨åˆ°Pinecone
        embeddingStore.addAll(embeddings, segments);
        
        log.info("æ–‡æ¡£ç´¢å¼•å®Œæˆ");
    }
    
    /**
     * RAGæŸ¥è¯¢
     */
    public String query(String question) {
        log.info("æ”¶åˆ°æŸ¥è¯¢: {}", question);
        
        // åˆ›å»ºæ£€ç´¢å™¨
        ContentRetriever retriever = EmbeddingStoreContentRetriever.builder()
            .embeddingStore(embeddingStore)
            .embeddingModel(embeddingModel)
            .maxResults(5)
            .minScore(0.7)
            .build();
        
        // åˆ›å»ºAIåŠ©æ‰‹
        interface Assistant {
            String answer(String question);
        }
        
        Assistant assistant = AiServices.builder(Assistant.class)
            .chatLanguageModel(chatModel)
            .contentRetriever(retriever)
            .build();
        
        return assistant.answer(question);
    }
}
```

### 4.3 é«˜çº§åŠŸèƒ½

#### 4.3.1 å…ƒæ•°æ®è¿‡æ»¤
```java
package com.example.vector.pinecone;

import dev.langchain4j.data.embedding.Embedding;
import dev.langchain4j.data.segment.TextSegment;
import dev.langchain4j.store.embedding.EmbeddingMatch;
import dev.langchain4j.store.embedding.filter.Filter;
import dev.langchain4j.store.embedding.filter.comparison.IsEqualTo;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * å¸¦å…ƒæ•°æ®è¿‡æ»¤çš„æœç´¢
 * 
 * @author erik.zhou
 */
@Service
@RequiredArgsConstructor
public class PineconeFilterService {
    
    private final PineconeEmbeddingStore embeddingStore;
    
    /**
     * æŒ‰ç±»åˆ«è¿‡æ»¤æœç´¢
     */
    public List<EmbeddingMatch<TextSegment>> searchByCategory(
        Embedding queryEmbedding,
        String category
    ) {
        // åˆ›å»ºè¿‡æ»¤æ¡ä»¶
        Filter filter = new IsEqualTo("category", category);
        
        // æ‰§è¡Œè¿‡æ»¤æœç´¢
        return embeddingStore.findRelevant(
            queryEmbedding,
            10,
            0.7,
            filter
        );
    }
    
    /**
     * å¤šæ¡ä»¶è¿‡æ»¤
     */
    public List<EmbeddingMatch<TextSegment>> searchWithMultipleFilters(
        Embedding queryEmbedding,
        String category,
        String author
    ) {
        Filter filter = Filter.and(
            new IsEqualTo("category", category),
            new IsEqualTo("author", author)
        );
        
        return embeddingStore.findRelevant(queryEmbedding, 10, 0.7, filter);
    }
}
```

#### 4.3.2 å‘½åç©ºé—´ç®¡ç†
```java
package com.example.vector.pinecone;

import io.pinecone.clients.Index;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

/**
 * Pineconeå‘½åç©ºé—´ç®¡ç†
 * 
 * å‘½åç©ºé—´ç”¨äºåœ¨åŒä¸€ä¸ªç´¢å¼•ä¸­éš”ç¦»ä¸åŒçš„æ•°æ®é›†
 * 
 * @author erik.zhou
 */
@Service
@RequiredArgsConstructor
public class PineconeNamespaceService {
    
    private final Index index;
    
    /**
     * åœ¨æŒ‡å®šå‘½åç©ºé—´ä¸­æ·»åŠ å‘é‡
     */
    public void upsertToNamespace(
        String namespace,
        String id,
        List<Float> values,
        Map<String, String> metadata
    ) {
        index.upsert(
            List.of(new UpsertRequest(id, values, metadata)),
            namespace
        );
    }
    
    /**
     * ä»æŒ‡å®šå‘½åç©ºé—´æŸ¥è¯¢
     */
    public QueryResponse queryFromNamespace(
        String namespace,
        List<Float> queryVector,
        int topK
    ) {
        return index.query(
            new QueryRequest()
                .withNamespace(namespace)
                .withVector(queryVector)
                .withTopK(topK)
                .withIncludeMetadata(true)
        );
    }
    
    /**
     * åˆ é™¤å‘½åç©ºé—´
     */
    public void deleteNamespace(String namespace) {
        index.deleteAll(namespace);
    }
}
```

---

## 5. Milvuså®æˆ˜

### 5.1 Dockeréƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.5
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_QUOTA_BACKEND_BYTES=4294967296
    volumes:
      - etcd-data:/etcd

  minio:
    image: minio/minio:RELEASE.2023-03-20T20-16-18Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    volumes:
      - minio-data:/minio_data
    command: minio server /minio_data

  milvus:
    image: milvusdb/milvus:v2.3.0
    command: ["milvus", "run", "standalone"]
    environment:
      ETCD_ENDPOINTS: etcd:2379
      MINIO_ADDRESS: minio:9000
    volumes:
      - milvus-data:/var/lib/milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    depends_on:
      - etcd
      - minio

volumes:
  etcd-data:
  minio-data:
  milvus-data:
```

### 5.2 Javaé›†æˆ

#### 5.2.1 Mavenä¾èµ–
```xml
<dependency>
    <groupId>io.milvus</groupId>
    <artifactId>milvus-sdk-java</artifactId>
    <version>2.3.0</version>
</dependency>
```

#### 5.2.2 MilvusæœåŠ¡
```java
package com.example.vector.milvus;

import io.milvus.client.MilvusServiceClient;
import io.milvus.param.ConnectParam;
import io.milvus.param.collection.*;
import io.milvus.param.dml.*;
import io.milvus.param.index.*;
import io.milvus.grpc.DataType;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.List;

/**
 * Milvuså‘é‡æ•°æ®åº“æœåŠ¡
 * 
 * @author erik.zhou
 */
@Slf4j
@Service
public class MilvusVectorService {
    
    private final MilvusServiceClient milvusClient;
    private static final String COLLECTION_NAME = "document_embeddings";
    
    public MilvusVectorService() {
        // è¿æ¥Milvus
        this.milvusClient = new MilvusServiceClient(
            ConnectParam.newBuilder()
                .withHost("localhost")
                .withPort(19530)
                .build()
        );
        
        // åˆå§‹åŒ–é›†åˆ
        initCollection();
    }
    
    /**
     * åˆå§‹åŒ–é›†åˆ
     */
    private void initCollection() {
        // æ£€æŸ¥é›†åˆæ˜¯å¦å­˜åœ¨
        boolean hasCollection = milvusClient.hasCollection(
            HasCollectionParam.newBuilder()
                .withCollectionName(COLLECTION_NAME)
                .build()
        ).getData();
        
        if (!hasCollection) {
            createCollection();
            createIndex();
        }
    }
    
    /**
     * åˆ›å»ºé›†åˆ
     */
    private void createCollection() {
        log.info("åˆ›å»ºé›†åˆ: {}", COLLECTION_NAME);
        
        // å®šä¹‰å­—æ®µ
        FieldType idField = FieldType.newBuilder()
            .withName("id")
            .withDataType(DataType.Int64)
            .withPrimaryKey(true)
            .withAutoID(true)
            .build();
        
        FieldType textField = FieldType.newBuilder()
            .withName("text")
            .withDataType(DataType.VarChar)
            .withMaxLength(65535)
            .build();
        
        FieldType vectorField = FieldType.newBuilder()
            .withName("embedding")
            .withDataType(DataType.FloatVector)
            .withDimension(1536)
            .build();
        
        // åˆ›å»ºé›†åˆ
        CreateCollectionParam createParam = CreateCollectionParam.newBuilder()
            .withCollectionName(COLLECTION_NAME)
            .withDescription("Document embeddings collection")
            .withFieldTypes(List.of(idField, textField, vectorField))
            .build();
        
        milvusClient.createCollection(createParam);
    }
    
    /**
     * åˆ›å»ºç´¢å¼•
     */
    private void createIndex() {
        log.info("åˆ›å»ºç´¢å¼•");
        
        CreateIndexParam indexParam = CreateIndexParam.newBuilder()
            .withCollectionName(COLLECTION_NAME)
            .withFieldName("embedding")
            .withIndexType(IndexType.HNSW)
            .withMetricType(MetricType.COSINE)
            .withExtraParam("{\"M\":16,\"efConstruction\":256}")
            .build();
        
        milvusClient.createIndex(indexParam);
        
        // åŠ è½½é›†åˆåˆ°å†…å­˜
        milvusClient.loadCollection(
            LoadCollectionParam.newBuilder()
                .withCollectionName(COLLECTION_NAME)
                .build()
        );
    }
    
    /**
     * æ’å…¥å‘é‡
     */
    public void insertVectors(List<String> texts, List<List<Float>> embeddings) {
        log.info("æ’å…¥å‘é‡: count={}", texts.size());
        
        InsertParam insertParam = InsertParam.newBuilder()
            .withCollectionName(COLLECTION_NAME)
            .withFields(List.of(
                new InsertParam.Field("text", texts),
                new InsertParam.Field("embedding", embeddings)
            ))
            .build();
        
        milvusClient.insert(insertParam);
    }
    
    /**
     * æœç´¢ç›¸ä¼¼å‘é‡
     */
    public List<SearchResult> search(List<Float> queryVector, int topK) {
        log.info("æœç´¢ç›¸ä¼¼å‘é‡: topK={}", topK);
        
        SearchParam searchParam = SearchParam.newBuilder()
            .withCollectionName(COLLECTION_NAME)
            .withMetricType(MetricType.COSINE)
            .withTopK(topK)
            .withVectors(List.of(queryVector))
            .withVectorFieldName("embedding")
            .withOutFields(List.of("text"))
            .withParams("{\"ef\":64}")
            .build();
        
        SearchResults results = milvusClient.search(searchParam).getData();
        return parseSearchResults(results);
    }
    
    /**
     * åˆ é™¤å‘é‡
     */
    public void deleteVectors(List<Long> ids) {
        log.info("åˆ é™¤å‘é‡: count={}", ids.size());
        
        String expr = "id in " + ids.toString();
        
        DeleteParam deleteParam = DeleteParam.newBuilder()
            .withCollectionName(COLLECTION_NAME)
            .withExpr(expr)
            .build();
        
        milvusClient.delete(deleteParam);
    }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–é…ç½®

```java
package com.example.vector.milvus;

import io.milvus.param.IndexType;
import io.milvus.param.MetricType;

/**
 * Milvusç´¢å¼•é…ç½®
 * 
 * @author erik.zhou
 */
public class MilvusIndexConfig {
    
    /**
     * HNSWç´¢å¼• - é«˜æ€§èƒ½ï¼Œé«˜å¬å›ç‡
     * é€‚åˆ: å¤§å¤šæ•°åœºæ™¯
     */
    public static String getHNSWConfig() {
        return """
            {
                "M": 16,              // æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°
                "efConstruction": 256 // æ„å»ºæ—¶çš„æœç´¢æ·±åº¦
            }
            """;
    }
    
    /**
     * IVF_FLATç´¢å¼• - å¹³è¡¡æ€§èƒ½å’Œç²¾åº¦
     * é€‚åˆ: ä¸­ç­‰è§„æ¨¡æ•°æ®
     */
    public static String getIVFFlatConfig() {
        return """
            {
                "nlist": 1024  // èšç±»ä¸­å¿ƒæ•°é‡
            }
            """;
    }
    
    /**
     * IVF_PQç´¢å¼• - é«˜å‹ç¼©æ¯”
     * é€‚åˆ: å¤§è§„æ¨¡æ•°æ®ï¼Œå†…å­˜å—é™
     */
    public static String getIVFPQConfig() {
        return """
            {
                "nlist": 1024,  // èšç±»ä¸­å¿ƒæ•°é‡
                "m": 8,         // å­å‘é‡æ•°é‡
                "nbits": 8      // æ¯ä¸ªå­å‘é‡çš„ä½æ•°
            }
            """;
    }
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–

### 6.1 æ‰¹é‡æ“ä½œ

```java
package com.example.vector.optimization;

import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.stream.Collectors;

/**
 * æ‰¹é‡æ“ä½œä¼˜åŒ–
 * 
 * @author erik.zhou
 */
@Slf4j
@Service
public class BatchOperationService {
    
    private static final int BATCH_SIZE = 100;
    
    /**
     * æ‰¹é‡æ’å…¥å‘é‡
     */
    public void batchInsert(List<VectorData> data) {
        log.info("å¼€å§‹æ‰¹é‡æ’å…¥: total={}", data.size());
        
        // åˆ†æ‰¹å¤„ç†
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        for (int i = 0; i < data.size(); i += BATCH_SIZE) {
            int end = Math.min(i + BATCH_SIZE, data.size());
            List<VectorData> batch = data.subList(i, end);
            
            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
                insertBatch(batch);
            });
            
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰æ‰¹æ¬¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();
        
        log.info("æ‰¹é‡æ’å…¥å®Œæˆ");
    }
    
    private void insertBatch(List<VectorData> batch) {
        // å®é™…çš„æ’å…¥é€»è¾‘
        log.debug("æ’å…¥æ‰¹æ¬¡: size={}", batch.size());
    }
    
    record VectorData(String id, List<Float> vector, Map<String, String> metadata) {}
}
```

### 6.2 ç¼“å­˜ç­–ç•¥

```java
package com.example.vector.optimization;

import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.util.List;

/**
 * å‘é‡æœç´¢ç¼“å­˜
 * 
 * @author erik.zhou
 */
@Slf4j
@Service
public class VectorSearchCache {
    
    private final Cache<String, List<SearchResult>> cache;
    
    public VectorSearchCache() {
        this.cache = Caffeine.newBuilder()
            .maximumSize(10000)
            .expireAfterWrite(Duration.ofHours(1))
            .recordStats()
            .build();
    }
    
    /**
     * å¸¦ç¼“å­˜çš„æœç´¢
     */
    public List<SearchResult> searchWithCache(
        String queryText,
        List<Float> queryVector,
        VectorSearchFunction searchFunction
    ) {
        // ç”Ÿæˆç¼“å­˜é”®
        String cacheKey = generateCacheKey(queryText);
        
        // å°è¯•ä»ç¼“å­˜è·å–
        List<SearchResult> cached = cache.getIfPresent(cacheKey);
        if (cached != null) {
            log.debug("ç¼“å­˜å‘½ä¸­: key={}", cacheKey);
            return cached;
        }
        
        // æ‰§è¡Œæœç´¢
        List<SearchResult> results = searchFunction.search(queryVector);
        
        // å­˜å…¥ç¼“å­˜
        cache.put(cacheKey, results);
        
        return results;
    }
    
    private String generateCacheKey(String queryText) {
        return String.valueOf(queryText.hashCode());
    }
    
    @FunctionalInterface
    interface VectorSearchFunction {
        List<SearchResult> search(List<Float> vector);
    }
}
```

### 6.3 è¿æ¥æ± ç®¡ç†

```java
package com.example.vector.optimization;

import io.milvus.client.MilvusServiceClient;
import io.milvus.param.ConnectParam;
import org.apache.commons.pool2.BasePooledObjectFactory;
import org.apache.commons.pool2.PooledObject;
import org.apache.commons.pool2.impl.DefaultPooledObject;
import org.apache.commons.pool2.impl.GenericObjectPool;
import org.apache.commons.pool2.impl.GenericObjectPoolConfig;

/**
 * Milvusè¿æ¥æ± 
 * 
 * @author erik.zhou
 */
public class MilvusConnectionPool {
    
    private final GenericObjectPool<MilvusServiceClient> pool;
    
    public MilvusConnectionPool(String host, int port) {
        GenericObjectPoolConfig<MilvusServiceClient> config = new GenericObjectPoolConfig<>();
        config.setMaxTotal(20);
        config.setMaxIdle(10);
        config.setMinIdle(5);
        
        this.pool = new GenericObjectPool<>(
            new MilvusClientFactory(host, port),
            config
        );
    }
    
    public MilvusServiceClient borrowClient() throws Exception {
        return pool.borrowObject();
    }
    
    public void returnClient(MilvusServiceClient client) {
        pool.returnObject(client);
    }
    
    static class MilvusClientFactory extends BasePooledObjectFactory<MilvusServiceClient> {
        private final String host;
        private final int port;
        
        public MilvusClientFactory(String host, int port) {
            this.host = host;
            this.port = port;
        }
        
        @Override
        public MilvusServiceClient create() {
            return new MilvusServiceClient(
                ConnectParam.newBuilder()
                    .withHost(host)
                    .withPort(port)
                    .build()
            );
        }
        
        @Override
        public PooledObject<MilvusServiceClient> wrap(MilvusServiceClient client) {
            return new DefaultPooledObject<>(client);
        }
    }
}
```

---

## 7. æœ€ä½³å®è·µ

### 7.1 å‘é‡ç»´åº¦é€‰æ‹©

```java
/**
 * å‘é‡ç»´åº¦é€‰æ‹©æŒ‡å—
 * 
 * @author erik.zhou
 */
public class VectorDimensionGuide {
    
    /*
     * å¸¸è§åµŒå…¥æ¨¡å‹ç»´åº¦:
     * 
     * - OpenAI text-embedding-ada-002: 1536ç»´
     * - OpenAI text-embedding-3-small: 1536ç»´
     * - OpenAI text-embedding-3-large: 3072ç»´
     * - Cohere embed-english-v3.0: 1024ç»´
     * - Sentence-BERT: 384/768ç»´
     * 
     * é€‰æ‹©å»ºè®®:
     * - é«˜ç»´åº¦(1536+): æ›´é«˜ç²¾åº¦ï¼Œæ›´å¤§å­˜å‚¨å’Œè®¡ç®—æˆæœ¬
     * - ä¸­ç»´åº¦(512-1024): å¹³è¡¡æ€§èƒ½å’Œæˆæœ¬
     * - ä½ç»´åº¦(<512): å¿«é€Ÿæ£€ç´¢ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®
     */
}
```

### 7.2 ç´¢å¼•é€‰æ‹©ç­–ç•¥

```java
/**
 * ç´¢å¼•é€‰æ‹©ç­–ç•¥
 * 
 * @author erik.zhou
 */
public class IndexSelectionStrategy {
    
    /**
     * æ ¹æ®æ•°æ®è§„æ¨¡é€‰æ‹©ç´¢å¼•
     */
    public static String selectIndex(long dataSize) {
        if (dataSize < 100_000) {
            // å°è§„æ¨¡: FLATç´¢å¼•(ç²¾ç¡®æœç´¢)
            return "FLAT";
        } else if (dataSize < 1_000_000) {
            // ä¸­è§„æ¨¡: HNSWç´¢å¼•(é«˜æ€§èƒ½)
            return "HNSW";
        } else {
            // å¤§è§„æ¨¡: IVF_PQç´¢å¼•(é«˜å‹ç¼©)
            return "IVF_PQ";
        }
    }
}
```

### 7.3 ç›‘æ§å’Œå‘Šè­¦

```java
package com.example.vector.monitoring;

import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;

/**
 * å‘é‡æ•°æ®åº“ç›‘æ§
 * 
 * @author erik.zhou
 */
@Component
@RequiredArgsConstructor
public class VectorDBMonitoring {
    
    private final MeterRegistry meterRegistry;
    
    /**
     * è®°å½•æœç´¢å»¶è¿Ÿ
     */
    public void recordSearchLatency(long latencyMs) {
        Timer.builder("vector.search.latency")
            .description("Vector search latency")
            .tag("unit", "ms")
            .register(meterRegistry)
            .record(Duration.ofMillis(latencyMs));
    }
    
    /**
     * è®°å½•æœç´¢ç»“æœæ•°
     */
    public void recordSearchResults(int count) {
        meterRegistry.counter("vector.search.results", "count", String.valueOf(count))
            .increment();
    }
}
```

---

## 8. æ€»ç»“

å‘é‡æ•°æ®åº“æ˜¯AIåº”ç”¨çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½:

### æ ¸å¿ƒè¦ç‚¹
- âœ… é€‰æ‹©åˆé€‚çš„å‘é‡æ•°æ®åº“(Pinecone/Milvus/Qdrant)
- âœ… ä¼˜åŒ–å‘é‡ç»´åº¦å’Œç´¢å¼•ç®—æ³•
- âœ… å®æ–½æ‰¹é‡æ“ä½œå’Œç¼“å­˜ç­–ç•¥
- âœ… ç›‘æ§æ€§èƒ½æŒ‡æ ‡
- âœ… åˆç†ä½¿ç”¨å…ƒæ•°æ®è¿‡æ»¤

### é€‰å‹å»ºè®®
- **å¿«é€Ÿä¸Šçº¿**: Pinecone (æ‰˜ç®¡æœåŠ¡)
- **å¤§è§„æ¨¡éƒ¨ç½²**: Milvus (å¼€æºé«˜æ€§èƒ½)
- **ä¸­å°è§„æ¨¡**: Qdrant (æ˜“ç”¨é«˜æ•ˆ)
- **å¼€å‘æµ‹è¯•**: Chroma (è½»é‡çº§)

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2025-01-31  
**ç‰ˆæœ¬**: 1.0.0

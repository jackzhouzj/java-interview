# æ¡†æ¶æ‰©å±•æœ€ä½³å®è·µ

> æŒæ¡ Springã€MyBatisã€Dubboã€Netty çš„æ‰©å±•æ–¹æ³•å’Œæœ€ä½³å®è·µ
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

æœ¬æ–‡æ¡£æ€»ç»“äº†ä¸»æµæ¡†æ¶çš„æ‰©å±•æœºåˆ¶å’Œæœ€ä½³å®è·µï¼Œå¸®åŠ©ä½ ï¼š
- ç†è§£æ¡†æ¶çš„æ‰©å±•ç‚¹è®¾è®¡
- æŒæ¡æ­£ç¡®çš„æ‰©å±•æ–¹å¼
- é¿å…å¸¸è§çš„æ‰©å±•é™·é˜±
- æå‡æ¡†æ¶ä½¿ç”¨èƒ½åŠ›

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] æŒæ¡ Spring çš„ 10+ ç§æ‰©å±•æ–¹å¼
- [ ] ç†è§£ MyBatis çš„æ’ä»¶æœºåˆ¶
- [ ] å­¦ä¹  Dubbo çš„ SPI æ‰©å±•
- [ ] æŒæ¡ Netty çš„ Handler æ‰©å±•
- [ ] èƒ½å¤Ÿè®¾è®¡è‡ªå·±çš„æ‰©å±•æœºåˆ¶

## ğŸ“– ç›®å½•

1. [Spring æ‰©å±•æ–¹å¼](#1-spring-æ‰©å±•æ–¹å¼)
2. [MyBatis æ‰©å±•æ–¹å¼](#2-mybatis-æ‰©å±•æ–¹å¼)
3. [Dubbo æ‰©å±•æ–¹å¼](#3-dubbo-æ‰©å±•æ–¹å¼)
4. [Netty æ‰©å±•æ–¹å¼](#4-netty-æ‰©å±•æ–¹å¼)
5. [æ‰©å±•è®¾è®¡åŸåˆ™](#5-æ‰©å±•è®¾è®¡åŸåˆ™)

---

## 1. Spring æ‰©å±•æ–¹å¼

### 1.1 BeanPostProcessor - Bean åç½®å¤„ç†å™¨ ğŸ”¥

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨ Bean åˆå§‹åŒ–å‰åè¿›è¡Œè‡ªå®šä¹‰å¤„ç†

```java
@Component
public class CustomBeanPostProcessor implements BeanPostProcessor {
    
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) 
            throws BeansException {
        // Bean åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œ
        System.out.println("Before: " + beanName);
        return bean;
    }
    
    @Override
    public Object postProcessAfterInitialization(Object bean, String beanName) 
            throws BeansException {
        // Bean åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ
        System.out.println("After: " + beanName);
        
        // å¯ä»¥è¿”å›ä»£ç†å¯¹è±¡
        if (bean instanceof UserService) {
            return Proxy.newProxyInstance(
                bean.getClass().getClassLoader(),
                bean.getClass().getInterfaces(),
                (proxy, method, args) -> {
                    System.out.println("ä»£ç†æ‰§è¡Œï¼š" + method.getName());
                    return method.invoke(bean, args);
                }
            );
        }
        return bean;
    }
}
```

**å®æˆ˜æ¡ˆä¾‹**ï¼š

```java
// 1. è‡ªåŠ¨æ³¨å…¥é…ç½®å±æ€§
@Component
public class ConfigPropertyProcessor implements BeanPostProcessor {
    
    @Autowired
    private Environment environment;
    
    @Override
    public Object postProcessBeforeInitialization(Object bean, String beanName) {
        Class<?> clazz = bean.getClass();
        for (Field field : clazz.getDeclaredFields()) {
            ConfigProperty annotation = field.getAnnotation(ConfigProperty.class);
            if (annotation != null) {
                String value = environment.getProperty(annotation.value());
                field.setAccessible(true);
                try {
                    field.set(bean, value);
                } catch (IllegalAccessException e) {
                    throw new RuntimeException(e);
                }
            }
        }
        return bean;
    }
}

// ä½¿ç”¨
@Service
public class UserService {
    
    @ConfigProperty("app.name")
    private String appName;
    
    public void printAppName() {
        System.out.println("App Name: " + appName);
    }
}
```

---

### 1.2 BeanFactoryPostProcessor - BeanFactory åç½®å¤„ç†å™¨ ğŸ”¥

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨ BeanDefinition åŠ è½½å®Œæˆåï¼ŒBean å®ä¾‹åŒ–ä¹‹å‰ä¿®æ”¹ BeanDefinition

```java
@Component
public class CustomBeanFactoryPostProcessor implements BeanFactoryPostProcessor {
    
    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) 
            throws BeansException {
        // è·å–æ‰€æœ‰ BeanDefinition
        String[] beanNames = beanFactory.getBeanDefinitionNames();
        
        for (String beanName : beanNames) {
            BeanDefinition beanDefinition = beanFactory.getBeanDefinition(beanName);
            
            // ä¿®æ”¹ BeanDefinition
            if (beanName.equals("userService")) {
                beanDefinition.setScope("prototype");
                beanDefinition.setLazyInit(true);
            }
        }
    }
}
```

**å®æˆ˜æ¡ˆä¾‹**ï¼š

```java
// åŠ¨æ€æ³¨å†Œ Bean
@Component
public class DynamicBeanRegistrar implements BeanDefinitionRegistryPostProcessor {
    
    @Override
    public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) 
            throws BeansException {
        // åŠ¨æ€æ³¨å†Œ Bean
        BeanDefinition beanDefinition = BeanDefinitionBuilder
            .genericBeanDefinition(User.class)
            .addPropertyValue("id", 1L)
            .addPropertyValue("name", "åŠ¨æ€æ³¨å†Œ")
            .getBeanDefinition();
        
        registry.registerBeanDefinition("dynamicUser", beanDefinition);
    }
    
    @Override
    public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) {
        // å¯é€‰å®ç°
    }
}
```

---

### 1.3 ApplicationContextAware - è·å– ApplicationContext

**ä½¿ç”¨åœºæ™¯**ï¼šåœ¨ Bean ä¸­è·å– ApplicationContext

```java
@Component
public class SpringContextHolder implements ApplicationContextAware {
    
    private static ApplicationContext applicationContext;
    
    @Override
    public void setApplicationContext(ApplicationContext applicationContext) 
            throws BeansException {
        SpringContextHolder.applicationContext = applicationContext;
    }
    
    public static ApplicationContext getApplicationContext() {
        return applicationContext;
    }
    
    public static <T> T getBean(Class<T> clazz) {
        return applicationContext.getBean(clazz);
    }
    
    public static <T> T getBean(String name, Class<T> clazz) {
        return applicationContext.getBean(name, clazz);
    }
}
```

---

### 1.4 ImportBeanDefinitionRegistrar - åŠ¨æ€æ³¨å†Œ Bean

**ä½¿ç”¨åœºæ™¯**ï¼šé…åˆ @Import æ³¨è§£åŠ¨æ€æ³¨å†Œ Bean

```java
public class CustomImportBeanDefinitionRegistrar 
        implements ImportBeanDefinitionRegistrar {
    
    @Override
    public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, 
                                       BeanDefinitionRegistry registry) {
        // è·å–æ³¨è§£å±æ€§
        Map<String, Object> attributes = importingClassMetadata
            .getAnnotationAttributes(EnableCustom.class.getName());
        
        String[] basePackages = (String[]) attributes.get("basePackages");
        
        // æ‰«æåŒ…ï¼Œæ³¨å†Œ Bean
        for (String basePackage : basePackages) {
            // æ‰«æé€»è¾‘
            // ...
            
            // æ³¨å†Œ Bean
            BeanDefinition beanDefinition = BeanDefinitionBuilder
                .genericBeanDefinition(CustomBean.class)
                .getBeanDefinition();
            registry.registerBeanDefinition("customBean", beanDefinition);
        }
    }
}

// è‡ªå®šä¹‰æ³¨è§£
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@Import(CustomImportBeanDefinitionRegistrar.class)
public @interface EnableCustom {
    String[] basePackages() default {};
}

// ä½¿ç”¨
@Configuration
@EnableCustom(basePackages = "com.example")
public class AppConfig {
}
```

---

### 1.5 FactoryBean - å·¥å‚ Bean

**ä½¿ç”¨åœºæ™¯**ï¼šåˆ›å»ºå¤æ‚å¯¹è±¡

```java
@Component
public class UserFactoryBean implements FactoryBean<User> {
    
    @Override
    public User getObject() throws Exception {
        // å¤æ‚çš„å¯¹è±¡åˆ›å»ºé€»è¾‘
        User user = new User();
        user.setId(1L);
        user.setName("å·¥å‚åˆ›å»º");
        // å¯ä»¥è¿›è¡Œå¤æ‚çš„åˆå§‹åŒ–
        return user;
    }
    
    @Override
    public Class<?> getObjectType() {
        return User.class;
    }
    
    @Override
    public boolean isSingleton() {
        return true;
    }
}
```

---

### 1.6 ApplicationListener - äº‹ä»¶ç›‘å¬å™¨

**ä½¿ç”¨åœºæ™¯**ï¼šç›‘å¬ Spring äº‹ä»¶

```java
@Component
public class ApplicationStartedListener 
        implements ApplicationListener<ContextRefreshedEvent> {
    
    @Override
    public void onApplicationEvent(ContextRefreshedEvent event) {
        System.out.println("Spring å®¹å™¨å¯åŠ¨å®Œæˆ");
        // æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘
    }
}

// æˆ–ä½¿ç”¨ @EventListener
@Component
public class EventHandler {
    
    @EventListener
    public void handleContextRefreshed(ContextRefreshedEvent event) {
        System.out.println("Spring å®¹å™¨å¯åŠ¨å®Œæˆ");
    }
    
    @EventListener
    public void handleContextClosed(ContextClosedEvent event) {
        System.out.println("Spring å®¹å™¨å…³é—­");
    }
}
```

---

### 1.7 è‡ªå®šä¹‰æ³¨è§£ + AOP

**ä½¿ç”¨åœºæ™¯**ï¼šå®ç°è‡ªå®šä¹‰åŠŸèƒ½

```java
// 1. å®šä¹‰æ³¨è§£
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int value() default 10;  // æ¯ç§’è¯·æ±‚æ•°
}

// 2. å®ç°åˆ‡é¢
@Aspect
@Component
public class RateLimitAspect {
    
    private final Map<String, RateLimiter> limiters = new ConcurrentHashMap<>();
    
    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint pjp, RateLimit rateLimit) throws Throwable {
        String key = pjp.getSignature().toLongString();
        RateLimiter limiter = limiters.computeIfAbsent(key, 
            k -> RateLimiter.create(rateLimit.value()));
        
        if (limiter.tryAcquire()) {
            return pjp.proceed();
        } else {
            throw new RuntimeException("è¯·æ±‚è¿‡äºé¢‘ç¹");
        }
    }
}

// 3. ä½¿ç”¨
@Service
public class UserService {
    
    @RateLimit(10)
    public User getUser(Long id) {
        return new User(id, "å¼ ä¸‰");
    }
}
```

---

## 2. MyBatis æ‰©å±•æ–¹å¼

### 2.1 Interceptor - æ‹¦æˆªå™¨æ’ä»¶ ğŸ”¥

**ä½¿ç”¨åœºæ™¯**ï¼šæ‹¦æˆª SQL æ‰§è¡Œï¼Œå®ç°è‡ªå®šä¹‰åŠŸèƒ½

```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, RowBounds.class, 
                      ResultHandler.class})
})
@Component
public class SqlLogInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        MappedStatement mappedStatement = (MappedStatement) invocation.getArgs()[0];
        Object parameter = invocation.getArgs()[1];
        
        BoundSql boundSql = mappedStatement.getBoundSql(parameter);
        String sql = boundSql.getSql();
        
        System.out.println("SQL: " + sql);
        System.out.println("å‚æ•°: " + parameter);
        
        long start = System.currentTimeMillis();
        Object result = invocation.proceed();
        long end = System.currentTimeMillis();
        
        System.out.println("è€—æ—¶: " + (end - start) + "ms");
        return result;
    }
}
```

**å®æˆ˜æ¡ˆä¾‹ - åˆ†é¡µæ’ä»¶**ï¼š

```java
@Intercepts({
    @Signature(type = Executor.class, method = "query", 
               args = {MappedStatement.class, Object.class, RowBounds.class, 
                      ResultHandler.class})
})
public class PageInterceptor implements Interceptor {
    
    @Override
    public Object intercept(Invocation invocation) throws Throwable {
        Object[] args = invocation.getArgs();
        MappedStatement ms = (MappedStatement) args[0];
        Object parameter = args[1];
        RowBounds rowBounds = (RowBounds) args[2];
        
        if (rowBounds == RowBounds.DEFAULT) {
            return invocation.proceed();
        }
        
        BoundSql boundSql = ms.getBoundSql(parameter);
        String sql = boundSql.getSql();
        
        // æ„å»ºåˆ†é¡µ SQL
        String pageSql = sql + " LIMIT " + rowBounds.getOffset() + 
                       ", " + rowBounds.getLimit();
        
        // åˆ›å»ºæ–°çš„ MappedStatement
        MappedStatement newMs = copyMappedStatement(ms, new BoundSqlSqlSource(boundSql));
        args[0] = newMs;
        
        return invocation.proceed();
    }
}
```

---

### 2.2 TypeHandler - ç±»å‹å¤„ç†å™¨

**ä½¿ç”¨åœºæ™¯**ï¼šè‡ªå®šä¹‰ Java ç±»å‹ä¸ JDBC ç±»å‹çš„è½¬æ¢

```java
@MappedTypes(LocalDateTime.class)
@MappedJdbcTypes(JdbcType.TIMESTAMP)
public class LocalDateTimeTypeHandler extends BaseTypeHandler<LocalDateTime> {
    
    @Override
    public void setNonNullParameter(PreparedStatement ps, int i, 
                                   LocalDateTime parameter, JdbcType jdbcType) 
            throws SQLException {
        ps.setTimestamp(i, Timestamp.valueOf(parameter));
    }
    
    @Override
    public LocalDateTime getNullableResult(ResultSet rs, String columnName) 
            throws SQLException {
        Timestamp timestamp = rs.getTimestamp(columnName);
        return timestamp != null ? timestamp.toLocalDateTime() : null;
    }
    
    @Override
    public LocalDateTime getNullableResult(ResultSet rs, int columnIndex) 
            throws SQLException {
        Timestamp timestamp = rs.getTimestamp(columnIndex);
        return timestamp != null ? timestamp.toLocalDateTime() : null;
    }
    
    @Override
    public LocalDateTime getNullableResult(CallableStatement cs, int columnIndex) 
            throws SQLException {
        Timestamp timestamp = cs.getTimestamp(columnIndex);
        return timestamp != null ? timestamp.toLocalDateTime() : null;
    }
}
```

---

## 3. Dubbo æ‰©å±•æ–¹å¼

### 3.1 SPI æ‰©å±•æœºåˆ¶ ğŸ”¥

**ä½¿ç”¨åœºæ™¯**ï¼šæ‰©å±• Dubbo åŠŸèƒ½

```java
// 1. å®šä¹‰æ‰©å±•æ¥å£
@SPI("dubbo")
public interface Protocol {
    @Adaptive
    <T> Exporter<T> export(Invoker<T> invoker) throws RpcException;
    
    @Adaptive
    <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException;
}

// 2. å®ç°æ‰©å±•
public class CustomProtocol implements Protocol {
    
    @Override
    public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException {
        // è‡ªå®šä¹‰åè®®æš´éœ²é€»è¾‘
        return new CustomExporter<>(invoker);
    }
    
    @Override
    public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException {
        // è‡ªå®šä¹‰åè®®å¼•ç”¨é€»è¾‘
        return new CustomInvoker<>(type, url);
    }
}

// 3. é…ç½®æ‰©å±•
// META-INF/dubbo/org.apache.dubbo.rpc.Protocol
// custom=com.example.CustomProtocol

// 4. ä½¿ç”¨æ‰©å±•
@DubboService(protocol = "custom")
public class UserServiceImpl implements UserService {
}
```

---

### 3.2 Filter - è¿‡æ»¤å™¨

**ä½¿ç”¨åœºæ™¯**ï¼šæ‹¦æˆª RPC è°ƒç”¨

```java
@Activate(group = {CommonConstants.PROVIDER, CommonConstants.CONSUMER})
public class CustomFilter implements Filter {
    
    @Override
    public Result invoke(Invoker<?> invoker, Invocation invocation) 
            throws RpcException {
        System.out.println("è°ƒç”¨æ–¹æ³•ï¼š" + invocation.getMethodName());
        
        long start = System.currentTimeMillis();
        Result result = invoker.invoke(invocation);
        long end = System.currentTimeMillis();
        
        System.out.println("è°ƒç”¨è€—æ—¶ï¼š" + (end - start) + "ms");
        return result;
    }
}

// é…ç½®
// META-INF/dubbo/org.apache.dubbo.rpc.Filter
// custom=com.example.CustomFilter
```

---

## 4. Netty æ‰©å±•æ–¹å¼

### 4.1 ChannelHandler - å¤„ç†å™¨ ğŸ”¥

**ä½¿ç”¨åœºæ™¯**ï¼šå¤„ç†ç½‘ç»œäº‹ä»¶

```java
public class CustomHandler extends ChannelInboundHandlerAdapter {
    
    @Override
    public void channelActive(ChannelHandlerContext ctx) {
        System.out.println("è¿æ¥å»ºç«‹ï¼š" + ctx.channel().remoteAddress());
    }
    
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯ï¼š" + msg);
        ctx.writeAndFlush("æœåŠ¡å™¨æ”¶åˆ°ï¼š" + msg);
    }
    
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }
}
```

---

## 5. æ‰©å±•è®¾è®¡åŸåˆ™

### 5.1 å¼€é—­åŸåˆ™

- å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
- é€šè¿‡æ¥å£å’ŒæŠ½è±¡ç±»å®šä¹‰æ‰©å±•ç‚¹
- ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–æ³¨è§£å£°æ˜æ‰©å±•

### 5.2 å•ä¸€èŒè´£åŸåˆ™

- æ¯ä¸ªæ‰©å±•åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- é¿å…æ‰©å±•è¿‡äºå¤æ‚

### 5.3 ä¾èµ–å€’ç½®åŸåˆ™

- ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
- ä½¿ç”¨æ¥å£å®šä¹‰æ‰©å±•ç‚¹

---

## ğŸ“ æ€»ç»“

æŒæ¡æ¡†æ¶æ‰©å±•æœºåˆ¶æ˜¯ä»é«˜çº§å·¥ç¨‹å¸ˆè¿ˆå‘èµ„æ·±å·¥ç¨‹å¸ˆçš„å…³é”®èƒ½åŠ›ã€‚é€šè¿‡å­¦ä¹ è¿™äº›æ‰©å±•æ–¹å¼ï¼Œä½ å°†èƒ½å¤Ÿï¼š
- æ·±å…¥ç†è§£æ¡†æ¶åŸç†
- çµæ´»æ‰©å±•æ¡†æ¶åŠŸèƒ½
- è®¾è®¡è‡ªå·±çš„æ‰©å±•æœºåˆ¶
- æå‡æ¶æ„è®¾è®¡èƒ½åŠ›

**è®°ä½ï¼šå¥½çš„æ‰©å±•æœºåˆ¶åº”è¯¥ç®€å•ã€çµæ´»ã€æ˜“ç”¨ï¼** ğŸ¯

---

@author erik.zhou

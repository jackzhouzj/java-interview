# æ€§èƒ½ç–‘éš¾æ‚ç—‡ - å®Œæ•´è§£æ

> ç”Ÿäº§ç¯å¢ƒæ€§èƒ½é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

æ€§èƒ½é—®é¢˜å¾€å¾€æ˜¯ç³»ç»Ÿä¸Šçº¿åæœ€å¸¸é‡åˆ°çš„é—®é¢˜ã€‚æœ¬æ–‡æ¡£åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼Œè¯¦ç»†ä»‹ç»ï¼š
- æ¥å£å“åº”æ…¢çš„æ’æŸ¥å’Œä¼˜åŒ–
- ç³»ç»Ÿååé‡ä½çš„åˆ†æ
- å†…å­˜å ç”¨è¿‡é«˜çš„å¤„ç†
- æ•°æ®åº“è¿æ¥æ± é—®é¢˜
- ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨è¶…æ—¶

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] èƒ½å¤Ÿå®šä½æ€§èƒ½ç“¶é¢ˆ
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ¥å£å“åº”æ—¶é—´
- [ ] èƒ½å¤Ÿæå‡ç³»ç»Ÿååé‡
- [ ] èƒ½å¤Ÿä¼˜åŒ–å†…å­˜ä½¿ç”¨
- [ ] èƒ½å¤Ÿå¤„ç†ç¬¬ä¸‰æ–¹æœåŠ¡é—®é¢˜

---

## 1. æ¥å£å“åº”æ…¢ ğŸ”¥

### 1.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šè®¢å•åˆ—è¡¨æ¥å£å“åº”æ—¶é—´ä» 200ms å¢åŠ åˆ° 5s

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·åé¦ˆè®¢å•åˆ—è¡¨åŠ è½½å¾ˆæ…¢
- ç›‘æ§æ˜¾ç¤ºæ¥å£ P99 å“åº”æ—¶é—´ä» 200ms å¢åŠ åˆ° 5000ms
- æ•°æ®åº“ CPU ä½¿ç”¨ç‡æ­£å¸¸
- åº”ç”¨æœåŠ¡å™¨ CPU ä½¿ç”¨ç‡æ­£å¸¸

**ç›‘æ§æ•°æ®**ï¼š
```
æ—¶é—´: 2024-01-20 14:00:00
æ¥å£: GET /api/orders
P50: 500ms â†’ 2000ms
P99: 200ms â†’ 5000ms
QPS: 1000 â†’ 800
é”™è¯¯ç‡: 0.1% â†’ 2%
```

### 1.2 é—®é¢˜åˆ†æ

**æ’æŸ¥æ­¥éª¤**ï¼š

```bash
# 1. ä½¿ç”¨ Arthas åˆ†ææ–¹æ³•è€—æ—¶
java -jar arthas-boot.jar

# 2. è¿½è¸ªæ–¹æ³•è°ƒç”¨
trace com.example.OrderService getOrderList

# è¾“å‡ºï¼š
# +---[5023ms] com.example.OrderService:getOrderList()
#     +---[10ms] com.example.OrderRepository:findByUserId()
#     +---[5000ms] com.example.UserService:getUserInfo()  # é—®é¢˜åœ¨è¿™é‡Œ
#     +---[10ms] com.example.ProductService:getProductInfo()
```

**é—®é¢˜ä»£ç **ï¼š

```java
@Service
public class OrderService {
    
    public List<OrderVO> getOrderList(Long userId) {
        // 1. æŸ¥è¯¢è®¢å•åˆ—è¡¨
        List<Order> orders = orderRepository.findByUserId(userId);
        
        List<OrderVO> result = new ArrayList<>();
        for (Order order : orders) {
            OrderVO vo = new OrderVO();
            vo.setOrderId(order.getId());
            vo.setAmount(order.getAmount());
            
            // 2. å¾ªç¯è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼ˆN+1 é—®é¢˜ï¼‰âŒ
            UserInfo user = userService.getUserInfo(order.getUserId());
            vo.setUserName(user.getName());
            
            // 3. å¾ªç¯è°ƒç”¨å•†å“æœåŠ¡ï¼ˆN+1 é—®é¢˜ï¼‰âŒ
            ProductInfo product = productService.getProductInfo(order.getProductId());
            vo.setProductName(product.getName());
            
            result.add(vo);
        }
        
        return result;
    }
}
```

**é—®é¢˜åŸå› **ï¼š
- N+1 æŸ¥è¯¢é—®é¢˜ï¼šæ¯ä¸ªè®¢å•éƒ½è°ƒç”¨ä¸€æ¬¡ç”¨æˆ·æœåŠ¡å’Œå•†å“æœåŠ¡
- å¦‚æœæœ‰ 100 ä¸ªè®¢å•ï¼Œå°±ä¼šè°ƒç”¨ 200 æ¬¡è¿œç¨‹æœåŠ¡
- è¿œç¨‹è°ƒç”¨å»¶è¿Ÿç´¯åŠ ï¼Œå¯¼è‡´æ¥å£å“åº”æ…¢

### 1.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ‰¹é‡æŸ¥è¯¢**

```java
@Service
public class OrderService {
    
    public List<OrderVO> getOrderList(Long userId) {
        // 1. æŸ¥è¯¢è®¢å•åˆ—è¡¨
        List<Order> orders = orderRepository.findByUserId(userId);
        
        if (orders.isEmpty()) {
            return Collections.emptyList();
        }
        
        // 2. æ”¶é›†æ‰€æœ‰ç”¨æˆ· ID å’Œå•†å“ ID
        Set<Long> userIds = orders.stream()
            .map(Order::getUserId)
            .collect(Collectors.toSet());
        Set<Long> productIds = orders.stream()
            .map(Order::getProductId)
            .collect(Collectors.toSet());
        
        // 3. æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        Map<Long, UserInfo> userMap = userService.batchGetUserInfo(userIds);
        
        // 4. æ‰¹é‡æŸ¥è¯¢å•†å“ä¿¡æ¯
        Map<Long, ProductInfo> productMap = productService.batchGetProductInfo(productIds);
        
        // 5. ç»„è£…ç»“æœ
        List<OrderVO> result = new ArrayList<>();
        for (Order order : orders) {
            OrderVO vo = new OrderVO();
            vo.setOrderId(order.getId());
            vo.setAmount(order.getAmount());
            
            UserInfo user = userMap.get(order.getUserId());
            if (user != null) {
                vo.setUserName(user.getName());
            }
            
            ProductInfo product = productMap.get(order.getProductId());
            if (product != null) {
                vo.setProductName(product.getName());
            }
            
            result.add(vo);
        }
        
        return result;
    }
}

// ç”¨æˆ·æœåŠ¡æ‰¹é‡æŸ¥è¯¢
@Service
public class UserService {
    
    public Map<Long, UserInfo> batchGetUserInfo(Set<Long> userIds) {
        if (userIds.isEmpty()) {
            return Collections.emptyMap();
        }
        
        // æ‰¹é‡æŸ¥è¯¢
        List<UserInfo> users = userRepository.findByIdIn(userIds);
        
        return users.stream()
            .collect(Collectors.toMap(UserInfo::getId, Function.identity()));
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå¹¶è¡Œè°ƒç”¨**

```java
@Service
public class OrderService {
    
    @Autowired
    private ThreadPoolTaskExecutor executor;
    
    public List<OrderVO> getOrderList(Long userId) {
        List<Order> orders = orderRepository.findByUserId(userId);
        
        if (orders.isEmpty()) {
            return Collections.emptyList();
        }
        
        // å¹¶è¡ŒæŸ¥è¯¢ç”¨æˆ·å’Œå•†å“ä¿¡æ¯
        Set<Long> userIds = orders.stream().map(Order::getUserId).collect(Collectors.toSet());
        Set<Long> productIds = orders.stream().map(Order::getProductId).collect(Collectors.toSet());
        
        CompletableFuture<Map<Long, UserInfo>> userFuture = CompletableFuture.supplyAsync(
            () -> userService.batchGetUserInfo(userIds), executor);
        
        CompletableFuture<Map<Long, ProductInfo>> productFuture = CompletableFuture.supplyAsync(
            () -> productService.batchGetProductInfo(productIds), executor);
        
        // ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
        CompletableFuture.allOf(userFuture, productFuture).join();
        
        Map<Long, UserInfo> userMap = userFuture.join();
        Map<Long, ProductInfo> productMap = productFuture.join();
        
        // ç»„è£…ç»“æœ
        return orders.stream().map(order -> {
            OrderVO vo = new OrderVO();
            vo.setOrderId(order.getId());
            vo.setAmount(order.getAmount());
            vo.setUserName(userMap.getOrDefault(order.getUserId(), new UserInfo()).getName());
            vo.setProductName(productMap.getOrDefault(order.getProductId(), new ProductInfo()).getName());
            return vo;
        }).collect(Collectors.toList());
    }
}
```

**æ–¹æ¡ˆ 3ï¼šæ•°æ®å†—ä½™ï¼ˆæ¨èï¼‰**

```java
// è®¢å•è¡¨ä¸­å†—ä½™ç”¨æˆ·åå’Œå•†å“å
@Entity
public class Order {
    @Id
    private Long id;
    
    private Long userId;
    private String userName;  // å†—ä½™å­—æ®µ
    
    private Long productId;
    private String productName;  // å†—ä½™å­—æ®µ
    
    private BigDecimal amount;
}

@Service
public class OrderService {
    
    public List<OrderVO> getOrderList(Long userId) {
        // ç›´æ¥æŸ¥è¯¢ï¼Œä¸éœ€è¦å…³è”å…¶ä»–æœåŠ¡
        List<Order> orders = orderRepository.findByUserId(userId);
        
        return orders.stream().map(order -> {
            OrderVO vo = new OrderVO();
            vo.setOrderId(order.getId());
            vo.setAmount(order.getAmount());
            vo.setUserName(order.getUserName());
            vo.setProductName(order.getProductName());
            return vo;
        }).collect(Collectors.toList());
    }
    
    // åˆ›å»ºè®¢å•æ—¶å†—ä½™æ•°æ®
    @Transactional
    public Order createOrder(OrderDTO dto) {
        Order order = new Order();
        order.setUserId(dto.getUserId());
        order.setProductId(dto.getProductId());
        order.setAmount(dto.getAmount());
        
        // å†—ä½™ç”¨æˆ·å
        UserInfo user = userService.getUserInfo(dto.getUserId());
        order.setUserName(user.getName());
        
        // å†—ä½™å•†å“å
        ProductInfo product = productService.getProductInfo(dto.getProductId());
        order.setProductName(product.getName());
        
        return orderRepository.save(order);
    }
}
```

---

## 2. å¤§æ•°æ®é‡å¯¼å‡º OOM ğŸ”¥

### 2.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šå¯¼å‡º 100 ä¸‡æ¡è®¢å•æ•°æ®ï¼Œåº”ç”¨ OOM å´©æºƒ

**é—®é¢˜æè¿°**ï¼š
- è¿è¥äººå‘˜å¯¼å‡ºå…¨é‡è®¢å•æ•°æ®
- åº”ç”¨æœåŠ¡å™¨å†…å­˜é£™å‡
- æœ€ç»ˆ OOM å´©æºƒ

**é”™è¯¯æ—¥å¿—**ï¼š
```
java.lang.OutOfMemoryError: Java heap space
    at java.util.Arrays.copyOf(Arrays.java:3210)
    at java.util.ArrayList.grow(ArrayList.java:265)
    at com.example.OrderService.exportOrders(OrderService.java:50)
```

### 2.2 é—®é¢˜åˆ†æ

**é—®é¢˜ä»£ç **ï¼š

```java
@Service
public class OrderExportService {
    
    public void exportOrders(HttpServletResponse response) {
        // ä¸€æ¬¡æ€§æŸ¥è¯¢æ‰€æœ‰æ•°æ®åˆ°å†…å­˜ âŒ
        List<Order> orders = orderRepository.findAll();  // 100 ä¸‡æ¡æ•°æ®
        
        // åˆ›å»º Excel
        Workbook workbook = new XSSFWorkbook();
        Sheet sheet = workbook.createSheet("è®¢å•");
        
        int rowNum = 0;
        for (Order order : orders) {
            Row row = sheet.createRow(rowNum++);
            row.createCell(0).setCellValue(order.getId());
            row.createCell(1).setCellValue(order.getAmount().toString());
            // ...
        }
        
        workbook.write(response.getOutputStream());
    }
}
```

### 2.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæµå¼æŸ¥è¯¢ + åˆ†æ‰¹å†™å…¥**

```java
@Service
public class OrderExportService {
    
    @Autowired
    private EntityManager entityManager;
    
    public void exportOrders(HttpServletResponse response) throws IOException {
        response.setContentType("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
        response.setHeader("Content-Disposition", "attachment; filename=orders.xlsx");
        
        // ä½¿ç”¨ EasyExcel æµå¼å†™å…¥
        ExcelWriter excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class)
            .build();
        WriteSheet writeSheet = EasyExcel.writerSheet("è®¢å•").build();
        
        int pageSize = 5000;
        int pageNum = 0;
        
        while (true) {
            // åˆ†é¡µæŸ¥è¯¢
            Pageable pageable = PageRequest.of(pageNum, pageSize);
            Page<Order> page = orderRepository.findAll(pageable);
            
            if (page.isEmpty()) {
                break;
            }
            
            // è½¬æ¢ä¸º DTO
            List<OrderExportDTO> dtoList = page.getContent().stream()
                .map(this::convertToDTO)
                .collect(Collectors.toList());
            
            // å†™å…¥ Excel
            excelWriter.write(dtoList, writeSheet);
            
            // æ¸…ç†å†…å­˜
            entityManager.clear();
            
            pageNum++;
            
            if (!page.hasNext()) {
                break;
            }
        }
        
        excelWriter.finish();
    }
    
    private OrderExportDTO convertToDTO(Order order) {
        OrderExportDTO dto = new OrderExportDTO();
        dto.setOrderId(order.getId());
        dto.setAmount(order.getAmount());
        dto.setCreateTime(order.getCreateTime());
        return dto;
    }
}

@Data
public class OrderExportDTO {
    @ExcelProperty("è®¢å•ID")
    private Long orderId;
    
    @ExcelProperty("é‡‘é¢")
    private BigDecimal amount;
    
    @ExcelProperty("åˆ›å»ºæ—¶é—´")
    private LocalDateTime createTime;
}
```

**æ–¹æ¡ˆ 2ï¼šæ¸¸æ ‡æŸ¥è¯¢ï¼ˆMySQLï¼‰**

```java
@Repository
public interface OrderRepository extends JpaRepository<Order, Long> {
    
    @QueryHints(value = {
        @QueryHint(name = "org.hibernate.fetchSize", value = "1000"),
        @QueryHint(name = "org.hibernate.readOnly", value = "true")
    })
    @Query("SELECT o FROM Order o")
    Stream<Order> streamAll();
}

@Service
public class OrderExportService {
    
    @Transactional(readOnly = true)
    public void exportOrders(HttpServletResponse response) throws IOException {
        ExcelWriter excelWriter = EasyExcel.write(response.getOutputStream(), OrderExportDTO.class)
            .build();
        WriteSheet writeSheet = EasyExcel.writerSheet("è®¢å•").build();
        
        List<OrderExportDTO> buffer = new ArrayList<>(5000);
        
        // ä½¿ç”¨æµå¼æŸ¥è¯¢
        try (Stream<Order> orderStream = orderRepository.streamAll()) {
            orderStream.forEach(order -> {
                buffer.add(convertToDTO(order));
                
                // æ¯ 5000 æ¡å†™å…¥ä¸€æ¬¡
                if (buffer.size() >= 5000) {
                    excelWriter.write(buffer, writeSheet);
                    buffer.clear();
                }
            });
        }
        
        // å†™å…¥å‰©ä½™æ•°æ®
        if (!buffer.isEmpty()) {
            excelWriter.write(buffer, writeSheet);
        }
        
        excelWriter.finish();
    }
}
```

**æ–¹æ¡ˆ 3ï¼šå¼‚æ­¥å¯¼å‡º + æ–‡ä»¶ä¸‹è½½**

```java
@Service
public class OrderExportService {
    
    @Autowired
    private ThreadPoolTaskExecutor executor;
    
    @Autowired
    private MinioClient minioClient;
    
    /**
     * æäº¤å¯¼å‡ºä»»åŠ¡
     */
    public String submitExportTask(ExportRequest request) {
        String taskId = UUID.randomUUID().toString();
        
        // åˆ›å»ºå¯¼å‡ºä»»åŠ¡è®°å½•
        ExportTask task = new ExportTask();
        task.setTaskId(taskId);
        task.setStatus(ExportStatus.PENDING);
        task.setCreateTime(LocalDateTime.now());
        exportTaskRepository.save(task);
        
        // å¼‚æ­¥æ‰§è¡Œå¯¼å‡º
        executor.submit(() -> {
            try {
                doExport(taskId, request);
            } catch (Exception e) {
                log.error("å¯¼å‡ºå¤±è´¥", e);
                updateTaskStatus(taskId, ExportStatus.FAILED, e.getMessage());
            }
        });
        
        return taskId;
    }
    
    /**
     * æ‰§è¡Œå¯¼å‡º
     */
    private void doExport(String taskId, ExportRequest request) throws Exception {
        updateTaskStatus(taskId, ExportStatus.PROCESSING, null);
        
        // ç”Ÿæˆæ–‡ä»¶
        String fileName = "orders_" + taskId + ".xlsx";
        File tempFile = File.createTempFile("export_", ".xlsx");
        
        try (ExcelWriter excelWriter = EasyExcel.write(tempFile, OrderExportDTO.class).build()) {
            WriteSheet writeSheet = EasyExcel.writerSheet("è®¢å•").build();
            
            int pageSize = 5000;
            int pageNum = 0;
            
            while (true) {
                Pageable pageable = PageRequest.of(pageNum, pageSize);
                Page<Order> page = orderRepository.findAll(pageable);
                
                if (page.isEmpty()) {
                    break;
                }
                
                List<OrderExportDTO> dtoList = page.getContent().stream()
                    .map(this::convertToDTO)
                    .collect(Collectors.toList());
                
                excelWriter.write(dtoList, writeSheet);
                
                pageNum++;
                
                if (!page.hasNext()) {
                    break;
                }
            }
        }
        
        // ä¸Šä¼ åˆ° MinIO
        minioClient.uploadObject(
            UploadObjectArgs.builder()
                .bucket("exports")
                .object(fileName)
                .filename(tempFile.getAbsolutePath())
                .build()
        );
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        String downloadUrl = minioClient.getPresignedObjectUrl(
            GetPresignedObjectUrlArgs.builder()
                .bucket("exports")
                .object(fileName)
                .expiry(24, TimeUnit.HOURS)
                .method(Method.GET)
                .build()
        );
        
        updateTaskStatus(taskId, ExportStatus.COMPLETED, downloadUrl);
        
        // åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        tempFile.delete();
    }
    
    /**
     * æŸ¥è¯¢å¯¼å‡ºä»»åŠ¡çŠ¶æ€
     */
    public ExportTask getExportTask(String taskId) {
        return exportTaskRepository.findByTaskId(taskId);
    }
}
```

---

## 3. ç¬¬ä¸‰æ–¹æœåŠ¡è°ƒç”¨è¶…æ—¶ ğŸ”¥

### 3.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šè°ƒç”¨çŸ­ä¿¡æœåŠ¡è¶…æ—¶ï¼Œå¯¼è‡´æ³¨å†Œæ¥å£å¤±è´¥

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·æ³¨å†Œæ—¶éœ€è¦å‘é€éªŒè¯ç çŸ­ä¿¡
- çŸ­ä¿¡æœåŠ¡å“åº”æ…¢ï¼ˆ10s+ï¼‰
- æ³¨å†Œæ¥å£è¶…æ—¶å¤±è´¥
- ç”¨æˆ·æ— æ³•æ³¨å†Œ

**ç›‘æ§æ•°æ®**ï¼š
```
æ—¶é—´: 2024-01-25 10:00:00
æ¥å£: POST /api/register
çŸ­ä¿¡æœåŠ¡å“åº”æ—¶é—´: 100ms â†’ 10000ms
æ³¨å†Œæ¥å£æˆåŠŸç‡: 99% â†’ 60%
```

### 3.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šè¶…æ—¶æ§åˆ¶ + é‡è¯•**

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        // é…ç½®è¿æ¥æ± 
        PoolingHttpClientConnectionManager connectionManager = 
            new PoolingHttpClientConnectionManager();
        connectionManager.setMaxTotal(200);
        connectionManager.setDefaultMaxPerRoute(50);
        
        // é…ç½®è¶…æ—¶
        RequestConfig requestConfig = RequestConfig.custom()
            .setConnectTimeout(3000)      // è¿æ¥è¶…æ—¶ 3 ç§’
            .setSocketTimeout(5000)       // è¯»å–è¶…æ—¶ 5 ç§’
            .setConnectionRequestTimeout(1000)  // è·å–è¿æ¥è¶…æ—¶ 1 ç§’
            .build();
        
        CloseableHttpClient httpClient = HttpClients.custom()
            .setConnectionManager(connectionManager)
            .setDefaultRequestConfig(requestConfig)
            .build();
        
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory(httpClient);
        
        return new RestTemplate(factory);
    }
}

@Service
public class SmsService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    private static final int MAX_RETRIES = 3;
    
    public boolean sendSms(String phone, String code) {
        int retries = 0;
        
        while (retries < MAX_RETRIES) {
            try {
                SmsRequest request = new SmsRequest();
                request.setPhone(phone);
                request.setCode(code);
                
                ResponseEntity<SmsResponse> response = restTemplate.postForEntity(
                    "https://sms.example.com/send",
                    request,
                    SmsResponse.class
                );
                
                if (response.getBody() != null && response.getBody().isSuccess()) {
                    return true;
                }
                
            } catch (ResourceAccessException e) {
                // è¶…æ—¶ï¼Œé‡è¯•
                log.warn("çŸ­ä¿¡å‘é€è¶…æ—¶ï¼Œé‡è¯•ç¬¬ {} æ¬¡", retries + 1);
                retries++;
                
                if (retries >= MAX_RETRIES) {
                    log.error("çŸ­ä¿¡å‘é€å¤±è´¥ï¼Œå·²é‡è¯• {} æ¬¡", MAX_RETRIES);
                    return false;
                }
                
                // ç­‰å¾…åé‡è¯•
                try {
                    Thread.sleep(100 * retries);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                }
            }
        }
        
        return false;
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå¼‚æ­¥å‘é€ï¼ˆæ¨èï¼‰**

```java
@Service
public class RegisterService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private SmsService smsService;
    
    @Transactional
    public RegisterResult register(RegisterRequest request) {
        // 1. åˆ›å»ºç”¨æˆ·
        User user = new User();
        user.setPhone(request.getPhone());
        user.setPassword(passwordEncoder.encode(request.getPassword()));
        user.setStatus(UserStatus.PENDING);  // å¾…éªŒè¯
        userRepository.save(user);
        
        // 2. ç”ŸæˆéªŒè¯ç 
        String code = generateCode();
        
        // 3. ä¿å­˜éªŒè¯ç åˆ° Redis
        String key = "sms:code:" + request.getPhone();
        redisTemplate.opsForValue().set(key, code, 5, TimeUnit.MINUTES);
        
        // 4. å¼‚æ­¥å‘é€çŸ­ä¿¡
        CompletableFuture.runAsync(() -> {
            boolean success = smsService.sendSms(request.getPhone(), code);
            if (!success) {
                log.error("çŸ­ä¿¡å‘é€å¤±è´¥: {}", request.getPhone());
                // å¯ä»¥å‘é€å‘Šè­¦æˆ–è®°å½•åˆ°æ•°æ®åº“
            }
        });
        
        // 5. ç«‹å³è¿”å›
        return RegisterResult.success("æ³¨å†ŒæˆåŠŸï¼ŒéªŒè¯ç å·²å‘é€");
    }
}
```

**æ–¹æ¡ˆ 3ï¼šç†”æ–­é™çº§**

```java
@Service
public class SmsService {
    
    @Autowired
    private RestTemplate restTemplate;
    
    // ç†”æ–­å™¨
    private final CircuitBreaker circuitBreaker = CircuitBreaker.of("smsService",
        CircuitBreakerConfig.custom()
            .failureRateThreshold(50)  // å¤±è´¥ç‡é˜ˆå€¼ 50%
            .waitDurationInOpenState(Duration.ofSeconds(30))  // ç†”æ–­æ—¶é—´ 30 ç§’
            .slidingWindowSize(10)  // æ»‘åŠ¨çª—å£å¤§å°
            .build()
    );
    
    public boolean sendSms(String phone, String code) {
        try {
            return circuitBreaker.executeSupplier(() -> {
                return doSendSms(phone, code);
            });
        } catch (CallNotPermittedException e) {
            // ç†”æ–­å™¨æ‰“å¼€ï¼Œé™çº§å¤„ç†
            log.warn("çŸ­ä¿¡æœåŠ¡ç†”æ–­ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ");
            return sendSmsByBackup(phone, code);
        }
    }
    
    private boolean doSendSms(String phone, String code) {
        SmsRequest request = new SmsRequest();
        request.setPhone(phone);
        request.setCode(code);
        
        ResponseEntity<SmsResponse> response = restTemplate.postForEntity(
            "https://sms.example.com/send",
            request,
            SmsResponse.class
        );
        
        return response.getBody() != null && response.getBody().isSuccess();
    }
    
    // å¤‡ç”¨çŸ­ä¿¡æœåŠ¡
    private boolean sendSmsByBackup(String phone, String code) {
        try {
            SmsRequest request = new SmsRequest();
            request.setPhone(phone);
            request.setCode(code);
            
            ResponseEntity<SmsResponse> response = restTemplate.postForEntity(
                "https://sms-backup.example.com/send",
                request,
                SmsResponse.class
            );
            
            return response.getBody() != null && response.getBody().isSuccess();
        } catch (Exception e) {
            log.error("å¤‡ç”¨çŸ­ä¿¡æœåŠ¡ä¹Ÿå¤±è´¥", e);
            return false;
        }
    }
}
```

---

## 4. æ•°æ®åº“è¿æ¥æ± è€—å°½ ğŸ”¥

### 4.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šé«˜å³°æœŸæ•°æ®åº“è¿æ¥æ± è€—å°½ï¼Œå¤§é‡è¯·æ±‚å¤±è´¥

**é—®é¢˜æè¿°**ï¼š
- é«˜å³°æœŸ QPS ä» 1000 å¢åŠ åˆ° 5000
- æ•°æ®åº“è¿æ¥æ± è€—å°½
- å¤§é‡è¯·æ±‚ç­‰å¾…è¿æ¥è¶…æ—¶
- æ¥å£é”™è¯¯ç‡é£™å‡

**é”™è¯¯æ—¥å¿—**ï¼š
```
HikariPool-1 - Connection is not available, request timed out after 30000ms.
```

### 4.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šä¼˜åŒ–è¿æ¥æ± é…ç½®**

```yaml
spring:
  datasource:
    hikari:
      # æœ€å¤§è¿æ¥æ•°
      maximum-pool-size: 50
      # æœ€å°ç©ºé—²è¿æ¥æ•°
      minimum-idle: 10
      # è¿æ¥è¶…æ—¶æ—¶é—´
      connection-timeout: 3000
      # ç©ºé—²è¿æ¥è¶…æ—¶æ—¶é—´
      idle-timeout: 600000
      # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
      max-lifetime: 1800000
      # è¿æ¥æµ‹è¯•æŸ¥è¯¢
      connection-test-query: SELECT 1
```

**æ–¹æ¡ˆ 2ï¼šç›‘æ§è¿æ¥æ± **

```java
@Component
public class HikariCPMonitor {
    
    @Autowired
    private DataSource dataSource;
    
    @Scheduled(fixedDelay = 10000)
    public void monitor() {
        if (dataSource instanceof HikariDataSource) {
            HikariDataSource hikariDataSource = (HikariDataSource) dataSource;
            HikariPoolMXBean poolMXBean = hikariDataSource.getHikariPoolMXBean();
            
            int totalConnections = poolMXBean.getTotalConnections();
            int activeConnections = poolMXBean.getActiveConnections();
            int idleConnections = poolMXBean.getIdleConnections();
            int threadsAwaitingConnection = poolMXBean.getThreadsAwaitingConnection();
            
            log.info("è¿æ¥æ± ç›‘æ§: æ€»è¿æ¥æ•°={}, æ´»è·ƒè¿æ¥æ•°={}, ç©ºé—²è¿æ¥æ•°={}, ç­‰å¾…çº¿ç¨‹æ•°={}",
                totalConnections, activeConnections, idleConnections, threadsAwaitingConnection);
            
            // å‘Šè­¦
            if (threadsAwaitingConnection > 10) {
                log.warn("è¿æ¥æ± ç­‰å¾…çº¿ç¨‹è¿‡å¤š: {}", threadsAwaitingConnection);
            }
            
            double usage = (double) activeConnections / totalConnections;
            if (usage > 0.8) {
                log.warn("è¿æ¥æ± ä½¿ç”¨ç‡è¿‡é«˜: {}%", usage * 100);
            }
        }
    }
}
```

**æ–¹æ¡ˆ 3ï¼šä¼˜åŒ–æ…¢æŸ¥è¯¢**

```java
// æ…¢æŸ¥è¯¢ä¼šé•¿æ—¶é—´å ç”¨è¿æ¥ï¼Œå¯¼è‡´è¿æ¥æ± è€—å°½
// å‚è€ƒæ•°æ®åº“ç–‘éš¾æ‚ç—‡ä¸­çš„æ…¢æŸ¥è¯¢ä¼˜åŒ–
```

---

## 5. æ¥å£å“åº”æ—¶é—´ä¸ç¨³å®š ğŸ”¥

### 5.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šæ¥å£å“åº”æ—¶é—´æ³¢åŠ¨å¤§

**é—®é¢˜æè¿°**ï¼š
- åŒä¸€æ¥å£å“åº”æ—¶é—´ä» 50ms åˆ° 2000ms ä¸ç­‰
- ç”¨æˆ·ä½“éªŒå·®
- éš¾ä»¥å®šä½åŸå› 

**ç›‘æ§æ•°æ®**ï¼š
```
P50: 80ms
P90: 500ms
P99: 2000ms
```

### 5.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šGC ä¼˜åŒ–**

```bash
# æŸ¥çœ‹ GC æ—¥å¿—
-XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:/var/log/gc.log

# G1 GC ä¼˜åŒ–å‚æ•°
-XX:+UseG1GC
-XX:MaxGCPauseMillis=100
-XX:G1HeapRegionSize=16m
-XX:InitiatingHeapOccupancyPercent=45
```

**æ–¹æ¡ˆ 2ï¼šé¢„çƒ­ç¼“å­˜**

```java
@Component
public class CacheWarmer implements ApplicationRunner {
    
    @Autowired
    private ProductService productService;
    
    @Override
    public void run(ApplicationArguments args) {
        log.info("å¼€å§‹é¢„çƒ­ç¼“å­˜...");
        
        // é¢„çƒ­çƒ­é—¨å•†å“
        List<Long> hotProductIds = productService.getHotProductIds();
        for (Long productId : hotProductIds) {
            productService.getProduct(productId);
        }
        
        log.info("ç¼“å­˜é¢„çƒ­å®Œæˆï¼Œå…±é¢„çƒ­ {} ä¸ªå•†å“", hotProductIds.size());
    }
}
```

**æ–¹æ¡ˆ 3ï¼šè¿æ¥æ± é¢„çƒ­**

```java
@Component
public class ConnectionPoolWarmer implements ApplicationRunner {
    
    @Autowired
    private DataSource dataSource;
    
    @Override
    public void run(ApplicationArguments args) throws Exception {
        log.info("å¼€å§‹é¢„çƒ­æ•°æ®åº“è¿æ¥æ± ...");
        
        // é¢„çƒ­è¿æ¥
        List<Connection> connections = new ArrayList<>();
        for (int i = 0; i < 10; i++) {
            connections.add(dataSource.getConnection());
        }
        
        // é‡Šæ”¾è¿æ¥
        for (Connection conn : connections) {
            conn.close();
        }
        
        log.info("æ•°æ®åº“è¿æ¥æ± é¢„çƒ­å®Œæˆ");
    }
}
```

---

## 6. å†…å­˜å ç”¨è¿‡é«˜ ğŸ”¥

### 6.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šåº”ç”¨å†…å­˜æŒç»­å¢é•¿

**é—®é¢˜æè¿°**ï¼š
- åº”ç”¨å¯åŠ¨åå†…å­˜ 2G
- è¿è¡Œä¸€æ®µæ—¶é—´åå†…å­˜ 6G
- é¢‘ç¹ Full GC
- æœ€ç»ˆ OOM

### 6.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ’æŸ¥å¤§å¯¹è±¡**

```java
// ä½¿ç”¨ Arthas åˆ†æ
// 1. æŸ¥çœ‹å †å†…å­˜
memory

// 2. æŸ¥çœ‹å¯¹è±¡æ•°é‡
heapdump /tmp/heap.hprof

// 3. ä½¿ç”¨ MAT åˆ†æ heap dump
```

**æ–¹æ¡ˆ 2ï¼šä¼˜åŒ–é›†åˆä½¿ç”¨**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šæ— é™å¢é•¿çš„ç¼“å­˜
private static Map<String, Object> cache = new HashMap<>();

public void addToCache(String key, Object value) {
    cache.put(key, value);  // æ°¸è¿œä¸ä¼šæ¸…ç†
}

// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ LRU ç¼“å­˜
private static Map<String, Object> cache = new LinkedHashMap<String, Object>(
    16, 0.75f, true) {
    @Override
    protected boolean removeEldestEntry(Map.Entry<String, Object> eldest) {
        return size() > 10000;  // æœ€å¤šä¿ç•™ 10000 ä¸ª
    }
};

// æ›´å¥½çš„æ–¹æ¡ˆï¼šä½¿ç”¨ Caffeine
private final Cache<String, Object> cache = Caffeine.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(10, TimeUnit.MINUTES)
    .build();
```

**æ–¹æ¡ˆ 3ï¼šåŠæ—¶é‡Šæ”¾èµ„æº**

```java
// é”™è¯¯ç¤ºä¾‹ï¼šèµ„æºæœªé‡Šæ”¾
public void processFile(String path) {
    InputStream is = new FileInputStream(path);
    // å¤„ç†æ–‡ä»¶
    // å¿˜è®°å…³é—­æµï¼
}

// æ­£ç¡®ç¤ºä¾‹ï¼šä½¿ç”¨ try-with-resources
public void processFile(String path) {
    try (InputStream is = new FileInputStream(path)) {
        // å¤„ç†æ–‡ä»¶
    } catch (IOException e) {
        log.error("æ–‡ä»¶å¤„ç†å¤±è´¥", e);
    }
}
```

---

## 7. æ‰¹é‡æ“ä½œæ€§èƒ½å·® ğŸ”¥

### 7.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šæ‰¹é‡æ’å…¥ 10 ä¸‡æ¡æ•°æ®è€—æ—¶ 30 åˆ†é’Ÿ

**é—®é¢˜æè¿°**ï¼š
- éœ€è¦å¯¼å…¥ 10 ä¸‡æ¡ç”¨æˆ·æ•°æ®
- é€æ¡æ’å…¥ï¼Œè€—æ—¶è¿‡é•¿
- æ•°æ®åº“å‹åŠ›å¤§

### 7.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ‰¹é‡æ’å…¥**

```java
@Service
public class UserImportService {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public void batchImport(List<User> users) {
        String sql = "INSERT INTO users (name, email, phone) VALUES (?, ?, ?)";
        
        jdbcTemplate.batchUpdate(sql, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                User user = users.get(i);
                ps.setString(1, user.getName());
                ps.setString(2, user.getEmail());
                ps.setString(3, user.getPhone());
            }
            
            @Override
            public int getBatchSize() {
                return users.size();
            }
        });
    }
    
    // åˆ†æ‰¹å¤„ç†
    public void batchImportInChunks(List<User> users) {
        int batchSize = 1000;
        
        for (int i = 0; i < users.size(); i += batchSize) {
            int end = Math.min(i + batchSize, users.size());
            List<User> batch = users.subList(i, end);
            batchImport(batch);
            
            log.info("å·²å¯¼å…¥ {} æ¡æ•°æ®", end);
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šMyBatis æ‰¹é‡æ’å…¥**

```xml
<!-- UserMapper.xml -->
<insert id="batchInsert" parameterType="list">
    INSERT INTO users (name, email, phone) VALUES
    <foreach collection="list" item="user" separator=",">
        (#{user.name}, #{user.email}, #{user.phone})
    </foreach>
</insert>
```

```java
@Service
public class UserImportService {
    
    @Autowired
    private UserMapper userMapper;
    
    @Transactional
    public void batchImport(List<User> users) {
        int batchSize = 1000;
        
        for (int i = 0; i < users.size(); i += batchSize) {
            int end = Math.min(i + batchSize, users.size());
            List<User> batch = users.subList(i, end);
            userMapper.batchInsert(batch);
        }
    }
}
```

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿå®šä½æ¥å£å“åº”æ…¢çš„åŸå› 
- [ ] èƒ½å¤Ÿè§£å†³ N+1 æŸ¥è¯¢é—®é¢˜
- [ ] èƒ½å¤Ÿå¤„ç†å¤§æ•°æ®é‡å¯¼å‡º
- [ ] èƒ½å¤Ÿå¤„ç†ç¬¬ä¸‰æ–¹æœåŠ¡è¶…æ—¶
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 
- [ ] èƒ½å¤Ÿè¿›è¡Œæ€§èƒ½ç›‘æ§
- [ ] èƒ½å¤Ÿä¼˜åŒ– GC å‚æ•°
- [ ] èƒ½å¤Ÿæ’æŸ¥å†…å­˜æ³„æ¼
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ‰¹é‡æ“ä½œ

---

**@author erik.zhou**


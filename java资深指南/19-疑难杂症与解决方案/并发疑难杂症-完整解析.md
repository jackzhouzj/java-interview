# å¹¶å‘ç–‘éš¾æ‚ç—‡ - å®Œæ•´è§£æ

> ç”Ÿäº§ç¯å¢ƒå¹¶å‘é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

å¹¶å‘é—®é¢˜å¾€å¾€éš¾ä»¥å¤ç°å’Œå®šä½ã€‚æœ¬æ–‡æ¡£åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼Œè¯¦ç»†ä»‹ç»ï¼š
- è¶…å–é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
- çº¿ç¨‹æ± æ»¡çš„æ’æŸ¥å’Œä¼˜åŒ–
- å¹¶å‘æ›´æ–°å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´
- åˆ†å¸ƒå¼é”çš„æ­£ç¡®ä½¿ç”¨
- æ¥å£é‡å¤æäº¤çš„é˜²æŠ¤

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] èƒ½å¤Ÿè§£å†³è¶…å–é—®é¢˜
- [ ] èƒ½å¤Ÿä¼˜åŒ–çº¿ç¨‹æ± é…ç½®
- [ ] èƒ½å¤Ÿå¤„ç†å¹¶å‘æ›´æ–°
- [ ] èƒ½å¤Ÿæ­£ç¡®ä½¿ç”¨åˆ†å¸ƒå¼é”
- [ ] èƒ½å¤Ÿé˜²æ­¢æ¥å£é‡å¤æäº¤

---

## 1. è¶…å–é—®é¢˜ ğŸ”¥

### 1.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šç§’æ€æ´»åŠ¨ï¼Œ100 ä»¶å•†å“å–å‡º 120 ä»¶

**é—®é¢˜æè¿°**ï¼š
- ç§’æ€å•†å“åº“å­˜ 100 ä»¶
- æ´»åŠ¨ç»“æŸåï¼Œè®¢å•æ•°é‡ 120 ä¸ª
- åº“å­˜å˜æˆ -20
- ç”¨æˆ·æŠ•è¯‰æ— æ³•å‘è´§

**æ—¶é—´çº¿**ï¼š
```
10:00:00 - ç§’æ€å¼€å§‹ï¼Œåº“å­˜ 100
10:00:01 - 1000 ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶åˆ°è¾¾
10:00:02 - æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡äº†åº“å­˜æ£€æŸ¥
10:00:03 - 120 ä¸ªè®¢å•åˆ›å»ºæˆåŠŸ
10:00:04 - åº“å­˜å˜æˆ -20
```

### 1.2 é—®é¢˜åˆ†æ

**é—®é¢˜ä»£ç **ï¼š

```java
@Service
public class SeckillService {
    
    @Autowired
    private ProductRepository productRepository;
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Transactional
    public Order seckill(Long userId, Long productId) {
        // 1. æŸ¥è¯¢å•†å“
        Product product = productRepository.findById(productId);
        
        // 2. æ£€æŸ¥åº“å­˜
        if (product.getStock() <= 0) {  // âŒ å¹¶å‘é—®é¢˜
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // 3. æ‰£å‡åº“å­˜
        product.setStock(product.getStock() - 1);  // âŒ å¹¶å‘é—®é¢˜
        productRepository.save(product);
        
        // 4. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(userId);
        order.setProductId(productId);
        orderRepository.save(order);
        
        return order;
    }
}
```

**é—®é¢˜åŸå› **ï¼š
- å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–åº“å­˜ï¼ˆéƒ½æ˜¯ 100ï¼‰
- éƒ½é€šè¿‡äº†åº“å­˜æ£€æŸ¥
- éƒ½æ‰§è¡Œäº†æ‰£å‡æ“ä½œ
- å¯¼è‡´è¶…å–

### 1.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ•°æ®åº“ä¹è§‚é”ï¼ˆæ¨èï¼‰**

```sql
-- æ·»åŠ ç‰ˆæœ¬å·å­—æ®µ
ALTER TABLE product ADD COLUMN version INT NOT NULL DEFAULT 0;
```

```java
@Entity
public class Product {
    @Id
    private Long id;
    
    private Integer stock;
    
    @Version  // JPA ä¹è§‚é”
    private Integer version;
}

@Service
public class SeckillService {
    
    @Transactional
    public Order seckill(Long userId, Long productId) {
        // 1. æŸ¥è¯¢å•†å“
        Product product = productRepository.findById(productId);
        
        // 2. æ£€æŸ¥åº“å­˜
        if (product.getStock() <= 0) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // 3. æ‰£å‡åº“å­˜ï¼ˆä¹è§‚é”ï¼‰
        product.setStock(product.getStock() - 1);
        try {
            productRepository.save(product);  // æ›´æ–°æ—¶ä¼šæ£€æŸ¥ version
        } catch (OptimisticLockException e) {
            // ç‰ˆæœ¬å†²çªï¼Œé‡è¯•
            throw new RuntimeException("åº“å­˜ä¸è¶³ï¼Œè¯·é‡è¯•");
        }
        
        // 4. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(userId);
        order.setProductId(productId);
        orderRepository.save(order);
        
        return order;
    }
}
```

**æ–¹æ¡ˆ 2ï¼šæ•°æ®åº“æ‚²è§‚é”**

```java
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    @Lock(LockModeType.PESSIMISTIC_WRITE)  // æ‚²è§‚é”
    @Query("SELECT p FROM Product p WHERE p.id = :id")
    Product findByIdForUpdate(@Param("id") Long id);
}

@Service
public class SeckillService {
    
    @Transactional
    public Order seckill(Long userId, Long productId) {
        // 1. æŸ¥è¯¢å•†å“ï¼ˆåŠ é”ï¼‰
        Product product = productRepository.findByIdForUpdate(productId);
        
        // 2. æ£€æŸ¥åº“å­˜
        if (product.getStock() <= 0) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // 3. æ‰£å‡åº“å­˜
        product.setStock(product.getStock() - 1);
        productRepository.save(product);
        
        // 4. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(userId);
        order.setProductId(productId);
        orderRepository.save(order);
        
        return order;
    }
}
```

**æ–¹æ¡ˆ 3ï¼šRedis åŸå­æ“ä½œï¼ˆæ¨èï¼Œé«˜æ€§èƒ½ï¼‰**

```java
@Service
public class SeckillService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public SeckillResult seckill(Long userId, Long productId) {
        String stockKey = "seckill:stock:" + productId;
        
        // 1. Redis åŸå­æ‰£å‡åº“å­˜
        Long stock = redisTemplate.opsForValue().decrement(stockKey);
        
        if (stock == null || stock < 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š
            redisTemplate.opsForValue().increment(stockKey);
            return SeckillResult.fail("åº“å­˜ä¸è¶³");
        }
        
        // 2. å‘é€ MQ æ¶ˆæ¯ï¼Œå¼‚æ­¥åˆ›å»ºè®¢å•
        SeckillMessage message = new SeckillMessage();
        message.setUserId(userId);
        message.setProductId(productId);
        rabbitTemplate.convertAndSend("seckill.exchange", "seckill.order", message);
        
        return SeckillResult.success("ç§’æ€æˆåŠŸ");
    }
    
    // æ¶ˆè´¹ MQ æ¶ˆæ¯ï¼Œåˆ›å»ºè®¢å•
    @RabbitListener(queues = "seckill.order.queue")
    @Transactional
    public void createOrder(SeckillMessage message) {
        // 1. å†æ¬¡æ£€æŸ¥åº“å­˜ï¼ˆæ•°æ®åº“ï¼‰
        Product product = productRepository.findById(message.getProductId());
        if (product.getStock() <= 0) {
            // åº“å­˜ä¸è¶³ï¼Œå›æ»š Redis
            String stockKey = "seckill:stock:" + message.getProductId();
            redisTemplate.opsForValue().increment(stockKey);
            return;
        }
        
        // 2. æ‰£å‡æ•°æ®åº“åº“å­˜
        int updated = productRepository.decrementStock(message.getProductId());
        if (updated == 0) {
            // æ‰£å‡å¤±è´¥ï¼Œå›æ»š Redis
            String stockKey = "seckill:stock:" + message.getProductId();
            redisTemplate.opsForValue().increment(stockKey);
            return;
        }
        
        // 3. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(message.getUserId());
        order.setProductId(message.getProductId());
        orderRepository.save(order);
    }
}

@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    @Modifying
    @Query("UPDATE Product p SET p.stock = p.stock - 1 " +
           "WHERE p.id = :productId AND p.stock > 0")
    int decrementStock(@Param("productId") Long productId);
}
```

---

## 2. çº¿ç¨‹æ± æ»¡ ğŸ”¥

### 2.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šæ‰¹é‡å¯¼å…¥æ•°æ®ï¼Œç³»ç»Ÿå¡æ­»

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·ä¸Šä¼  10 ä¸‡æ¡æ•°æ®å¯¼å…¥
- ç³»ç»Ÿåˆ›å»º 10 ä¸‡ä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± 
- çº¿ç¨‹æ± é˜Ÿåˆ—æ»¡ï¼Œä»»åŠ¡è¢«æ‹’ç»
- éƒ¨åˆ†æ•°æ®å¯¼å…¥å¤±è´¥

**é”™è¯¯æ—¥å¿—**ï¼š
```
java.util.concurrent.RejectedExecutionException: 
Task rejected from java.util.concurrent.ThreadPoolExecutor
```

### 2.2 é—®é¢˜åˆ†æ

**é—®é¢˜ä»£ç **ï¼š

```java
@Service
public class DataImportService {
    
    // é»˜è®¤çº¿ç¨‹æ± é…ç½®ä¸åˆç†
    private final ExecutorService executor = Executors.newFixedThreadPool(10);
    
    public void importData(List<DataDTO> dataList) {
        for (DataDTO data : dataList) {
            executor.submit(() -> {
                // å¤„ç†æ•°æ®
                processData(data);
            });
        }
    }
}
```

**é—®é¢˜åŸå› **ï¼š
- çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°å¤ªå°‘ï¼ˆ10 ä¸ªï¼‰
- æ²¡æœ‰è®¾ç½®é˜Ÿåˆ—å¤§å°ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—
- æ²¡æœ‰è®¾ç½®æ‹’ç»ç­–ç•¥
- å¤§é‡ä»»åŠ¡å †ç§¯ï¼Œå†…å­˜æº¢å‡º

### 2.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šåˆç†é…ç½®çº¿ç¨‹æ± **

```java
@Configuration
public class ThreadPoolConfig {
    
    @Bean("dataImportThreadPool")
    public ThreadPoolTaskExecutor dataImportThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        
        // æ ¸å¿ƒçº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 2
        int corePoolSize = Runtime.getRuntime().availableProcessors() * 2;
        executor.setCorePoolSize(corePoolSize);
        
        // æœ€å¤§çº¿ç¨‹æ•° = CPU æ ¸å¿ƒæ•° * 4
        executor.setMaxPoolSize(corePoolSize * 2);
        
        // é˜Ÿåˆ—å®¹é‡
        executor.setQueueCapacity(1000);
        
        // çº¿ç¨‹åç§°å‰ç¼€
        executor.setThreadNamePrefix("data-import-");
        
        // æ‹’ç»ç­–ç•¥ï¼šè°ƒç”¨è€…è¿è¡Œ
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        
        // çº¿ç¨‹ç©ºé—²æ—¶é—´
        executor.setKeepAliveSeconds(60);
        
        // å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶
        executor.setAllowCoreThreadTimeOut(true);
        
        executor.initialize();
        return executor;
    }
}

@Service
public class DataImportService {
    
    @Autowired
    @Qualifier("dataImportThreadPool")
    private ThreadPoolTaskExecutor executor;
    
    public void importData(List<DataDTO> dataList) {
        for (DataDTO data : dataList) {
            executor.submit(() -> {
                processData(data);
            });
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šåˆ†æ‰¹å¤„ç†**

```java
@Service
public class DataImportService {
    
    @Autowired
    @Qualifier("dataImportThreadPool")
    private ThreadPoolTaskExecutor executor;
    
    public void importData(List<DataDTO> dataList) {
        int batchSize = 1000;  // æ¯æ‰¹ 1000 æ¡
        
        // åˆ†æ‰¹å¤„ç†
        for (int i = 0; i < dataList.size(); i += batchSize) {
            int end = Math.min(i + batchSize, dataList.size());
            List<DataDTO> batch = dataList.subList(i, end);
            
            // æäº¤æ‰¹æ¬¡ä»»åŠ¡
            executor.submit(() -> {
                processBatch(batch);
            });
            
            // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
            if (executor.getActiveCount() >= executor.getMaxPoolSize()) {
                // çº¿ç¨‹æ± ç¹å¿™ï¼Œç­‰å¾…
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
    
    private void processBatch(List<DataDTO> batch) {
        for (DataDTO data : batch) {
            processData(data);
        }
    }
}
```

**æ–¹æ¡ˆ 3ï¼šç›‘æ§çº¿ç¨‹æ± **

```java
@Component
public class ThreadPoolMonitor {
    
    @Autowired
    @Qualifier("dataImportThreadPool")
    private ThreadPoolTaskExecutor executor;
    
    @Scheduled(fixedDelay = 10000)  // æ¯ 10 ç§’ç›‘æ§ä¸€æ¬¡
    public void monitor() {
        ThreadPoolExecutor threadPool = executor.getThreadPoolExecutor();
        
        int corePoolSize = threadPool.getCorePoolSize();
        int maximumPoolSize = threadPool.getMaximumPoolSize();
        int activeCount = threadPool.getActiveCount();
        int poolSize = threadPool.getPoolSize();
        long taskCount = threadPool.getTaskCount();
        long completedTaskCount = threadPool.getCompletedTaskCount();
        int queueSize = threadPool.getQueue().size();
        
        log.info("çº¿ç¨‹æ± ç›‘æ§: " +
                "æ ¸å¿ƒçº¿ç¨‹æ•°={}, æœ€å¤§çº¿ç¨‹æ•°={}, æ´»è·ƒçº¿ç¨‹æ•°={}, " +
                "å½“å‰çº¿ç¨‹æ•°={}, æ€»ä»»åŠ¡æ•°={}, å®Œæˆä»»åŠ¡æ•°={}, é˜Ÿåˆ—å¤§å°={}",
                corePoolSize, maximumPoolSize, activeCount,
                poolSize, taskCount, completedTaskCount, queueSize);
        
        // å‘Šè­¦
        if (queueSize > 800) {
            log.warn("çº¿ç¨‹æ± é˜Ÿåˆ—å³å°†æ»¡: {}", queueSize);
        }
        
        if (activeCount >= maximumPoolSize * 0.9) {
            log.warn("çº¿ç¨‹æ± ä½¿ç”¨ç‡è¿‡é«˜: {}%", activeCount * 100 / maximumPoolSize);
        }
    }
}
```

---

## 3. å¹¶å‘æ›´æ–°æ•°æ®ä¸ä¸€è‡´ ğŸ”¥

### 3.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šç”¨æˆ·ä½™é¢æ›´æ–°ä¸¢å¤±

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·åˆå§‹ä½™é¢ 100 å…ƒ
- åŒæ—¶å‘èµ· 2 ç¬”å……å€¼ï¼Œå„ 50 å…ƒ
- é¢„æœŸä½™é¢ 200 å…ƒ
- å®é™…ä½™é¢ 150 å…ƒï¼ˆä¸¢å¤±äº†ä¸€ç¬”å……å€¼ï¼‰

**æ—¶é—´çº¿**ï¼š
```
14:00:00 - çº¿ç¨‹ A è¯»å–ä½™é¢ 100
14:00:00 - çº¿ç¨‹ B è¯»å–ä½™é¢ 100
14:00:01 - çº¿ç¨‹ A è®¡ç®—ä½™é¢ 100 + 50 = 150
14:00:01 - çº¿ç¨‹ B è®¡ç®—ä½™é¢ 100 + 50 = 150
14:00:02 - çº¿ç¨‹ A æ›´æ–°ä½™é¢ä¸º 150
14:00:02 - çº¿ç¨‹ B æ›´æ–°ä½™é¢ä¸º 150ï¼ˆè¦†ç›–äº†çº¿ç¨‹ A çš„æ›´æ–°ï¼‰
```

### 3.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šæ•°æ®åº“ä¹è§‚é”**

```java
@Entity
public class Account {
    @Id
    private Long id;
    
    private BigDecimal balance;
    
    @Version
    private Integer version;
}

@Service
public class AccountService {
    
    @Transactional
    public void recharge(Long accountId, BigDecimal amount) {
        int maxRetries = 3;
        int retries = 0;
        
        while (retries < maxRetries) {
            try {
                // 1. æŸ¥è¯¢è´¦æˆ·
                Account account = accountRepository.findById(accountId);
                
                // 2. æ›´æ–°ä½™é¢
                account.setBalance(account.getBalance().add(amount));
                
                // 3. ä¿å­˜ï¼ˆä¹è§‚é”ï¼‰
                accountRepository.save(account);
                
                return;  // æˆåŠŸ
            } catch (OptimisticLockException e) {
                retries++;
                if (retries >= maxRetries) {
                    throw new RuntimeException("å……å€¼å¤±è´¥ï¼Œè¯·é‡è¯•", e);
                }
                // ç­‰å¾…åé‡è¯•
                try {
                    Thread.sleep(50);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šæ•°æ®åº“åŸå­æ“ä½œ**

```java
@Repository
public interface AccountRepository extends JpaRepository<Account, Long> {
    
    @Modifying
    @Query("UPDATE Account a SET a.balance = a.balance + :amount WHERE a.id = :id")
    int addBalance(@Param("id") Long id, @Param("amount") BigDecimal amount);
}

@Service
public class AccountService {
    
    @Transactional
    public void recharge(Long accountId, BigDecimal amount) {
        // åŸå­æ“ä½œï¼Œä¸ä¼šæœ‰å¹¶å‘é—®é¢˜
        int updated = accountRepository.addBalance(accountId, amount);
        
        if (updated == 0) {
            throw new RuntimeException("è´¦æˆ·ä¸å­˜åœ¨");
        }
    }
}
```

**æ–¹æ¡ˆ 3ï¼šåˆ†å¸ƒå¼é”**

```java
@Service
public class AccountService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public void recharge(Long accountId, BigDecimal amount) {
        String lockKey = "account:lock:" + accountId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // è·å–é”
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                // 1. æŸ¥è¯¢è´¦æˆ·
                Account account = accountRepository.findById(accountId);
                
                // 2. æ›´æ–°ä½™é¢
                account.setBalance(account.getBalance().add(amount));
                
                // 3. ä¿å­˜
                accountRepository.save(account);
            } else {
                throw new RuntimeException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("å……å€¼å¤±è´¥", e);
        } finally {
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

---

## 5. æ­»é”é—®é¢˜ ğŸ”¥

### 5.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šè½¬è´¦åŠŸèƒ½å‡ºç°æ­»é”

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ· A å‘ç”¨æˆ· B è½¬è´¦
- åŒæ—¶ç”¨æˆ· B å‘ç”¨æˆ· A è½¬è´¦
- ä¸¤ä¸ªäº‹åŠ¡äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”
- ç³»ç»Ÿå¡æ­»ï¼Œéœ€è¦ç­‰å¾…è¶…æ—¶

**é—®é¢˜ä»£ç **ï¼š
```java
// é”™è¯¯ç¤ºä¾‹ï¼šå¯èƒ½å¯¼è‡´æ­»é”
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // çº¿ç¨‹1: é”å®šè´¦æˆ·Aï¼Œç­‰å¾…è´¦æˆ·B
    // çº¿ç¨‹2: é”å®šè´¦æˆ·Bï¼Œç­‰å¾…è´¦æˆ·A
    Account from = accountRepository.findByIdForUpdate(fromId);
    Account to = accountRepository.findByIdForUpdate(toId);
    
    from.setBalance(from.getBalance().subtract(amount));
    to.setBalance(to.getBalance().add(amount));
    
    accountRepository.save(from);
    accountRepository.save(to);
}
```

### 5.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆï¼šæŒ‰å›ºå®šé¡ºåºåŠ é”**

```java
@Service
public class TransferService {
    
    @Transactional
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        // æŒ‰ ID å¤§å°é¡ºåºåŠ é”ï¼Œé¿å…æ­»é”
        Long firstId = Math.min(fromId, toId);
        Long secondId = Math.max(fromId, toId);
        
        Account first = accountRepository.findByIdForUpdate(firstId);
        Account second = accountRepository.findByIdForUpdate(secondId);
        
        Account from = fromId.equals(firstId) ? first : second;
        Account to = toId.equals(firstId) ? first : second;
        
        // æ£€æŸ¥ä½™é¢
        if (from.getBalance().compareTo(amount) < 0) {
            throw new RuntimeException("ä½™é¢ä¸è¶³");
        }
        
        from.setBalance(from.getBalance().subtract(amount));
        to.setBalance(to.getBalance().add(amount));
        
        accountRepository.save(from);
        accountRepository.save(to);
    }
}
```

---

## 6. CompletableFuture å¼‚å¸¸ä¸¢å¤± ğŸ”¥

### 6.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šå¼‚æ­¥ä»»åŠ¡å¼‚å¸¸è¢«åæ‰

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨ CompletableFuture å¼‚æ­¥å¤„ç†
- ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸
- å¼‚å¸¸è¢«åæ‰ï¼Œæ²¡æœ‰æ—¥å¿—
- é—®é¢˜éš¾ä»¥æ’æŸ¥

**é—®é¢˜ä»£ç **ï¼š
```java
// é”™è¯¯ç¤ºä¾‹ï¼šå¼‚å¸¸è¢«åæ‰
public void processAsync(List<Order> orders) {
    for (Order order : orders) {
        CompletableFuture.runAsync(() -> {
            // å¦‚æœè¿™é‡ŒæŠ›å¼‚å¸¸ï¼Œä¸ä¼šæœ‰ä»»ä½•æç¤º
            processOrder(order);
        });
    }
}
```

### 6.2 è§£å†³æ–¹æ¡ˆ

```java
@Service
public class OrderProcessService {
    
    @Autowired
    private ThreadPoolTaskExecutor taskExecutor;
    
    public void processAsync(List<Order> orders) {
        List<CompletableFuture<Void>> futures = new ArrayList<>();
        
        for (Order order : orders) {
            CompletableFuture<Void> future = CompletableFuture
                .runAsync(() -> processOrder(order), taskExecutor)
                .exceptionally(ex -> {
                    // æ•è·å¼‚å¸¸å¹¶è®°å½•
                    log.error("è®¢å•å¤„ç†å¤±è´¥: {}", order.getOrderNo(), ex);
                    // å¯ä»¥å‘é€å‘Šè­¦
                    alertService.sendAlert("è®¢å•å¤„ç†å¤±è´¥: " + order.getOrderNo());
                    return null;
                });
            
            futures.add(future);
        }
        
        // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .join();
    }
    
    // å¸¦è¶…æ—¶çš„æ‰¹é‡å¤„ç†
    public void processAsyncWithTimeout(List<Order> orders, long timeoutSeconds) {
        List<CompletableFuture<Void>> futures = orders.stream()
            .map(order -> CompletableFuture
                .runAsync(() -> processOrder(order), taskExecutor)
                .orTimeout(timeoutSeconds, TimeUnit.SECONDS)
                .exceptionally(ex -> {
                    if (ex instanceof TimeoutException) {
                        log.error("è®¢å•å¤„ç†è¶…æ—¶: {}", order.getOrderNo());
                    } else {
                        log.error("è®¢å•å¤„ç†å¤±è´¥: {}", order.getOrderNo(), ex);
                    }
                    return null;
                }))
            .collect(Collectors.toList());
        
        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
            .join();
    }
}
```

---

## 7. ThreadLocal å†…å­˜æ³„æ¼ ğŸ”¥

### 7.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šçº¿ç¨‹æ± ä¸­ ThreadLocal æœªæ¸…ç†

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨ ThreadLocal å­˜å‚¨ç”¨æˆ·ä¿¡æ¯
- çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹
- ThreadLocal æœªæ¸…ç†
- å¯¼è‡´æ•°æ®é”™ä¹±æˆ–å†…å­˜æ³„æ¼

**é—®é¢˜ä»£ç **ï¼š
```java
// é”™è¯¯ç¤ºä¾‹ï¼šThreadLocal æœªæ¸…ç†
public class UserContext {
    private static final ThreadLocal<User> userHolder = new ThreadLocal<>();
    
    public static void setUser(User user) {
        userHolder.set(user);
    }
    
    public static User getUser() {
        return userHolder.get();
    }
}

// åœ¨è¿‡æ»¤å™¨ä¸­è®¾ç½®
public class AuthFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
            FilterChain chain) throws IOException, ServletException {
        User user = getUser(request);
        UserContext.setUser(user);
        chain.doFilter(request, response);
        // å¿˜è®°æ¸…ç†ï¼
    }
}
```

### 7.2 è§£å†³æ–¹æ¡ˆ

```java
public class UserContext {
    private static final ThreadLocal<User> userHolder = new ThreadLocal<>();
    
    public static void setUser(User user) {
        userHolder.set(user);
    }
    
    public static User getUser() {
        return userHolder.get();
    }
    
    // å¿…é¡»æä¾›æ¸…ç†æ–¹æ³•
    public static void clear() {
        userHolder.remove();
    }
}

// æ­£ç¡®çš„è¿‡æ»¤å™¨å®ç°
public class AuthFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
            FilterChain chain) throws IOException, ServletException {
        try {
            User user = getUser(request);
            UserContext.setUser(user);
            chain.doFilter(request, response);
        } finally {
            // å¿…é¡»åœ¨ finally ä¸­æ¸…ç†
            UserContext.clear();
        }
    }
}

// ä½¿ç”¨ TransmittableThreadLocal è§£å†³çº¿ç¨‹æ± ä¼ é€’é—®é¢˜
public class UserContext {
    // æ”¯æŒçº¿ç¨‹æ± ä¼ é€’
    private static final TransmittableThreadLocal<User> userHolder = 
        new TransmittableThreadLocal<>();
    
    public static void setUser(User user) {
        userHolder.set(user);
    }
    
    public static User getUser() {
        return userHolder.get();
    }
    
    public static void clear() {
        userHolder.remove();
    }
}
```

---

## 8. å¹¶å‘é›†åˆä½¿ç”¨ä¸å½“ ğŸ”¥

### 8.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šConcurrentHashMap å¤åˆæ“ä½œéåŸå­

**é—®é¢˜æè¿°**ï¼š
- ä½¿ç”¨ ConcurrentHashMap ç»Ÿè®¡è®¿é—®æ¬¡æ•°
- å¤šçº¿ç¨‹å¹¶å‘æ›´æ–°
- ç»Ÿè®¡ç»“æœä¸å‡†ç¡®

**é—®é¢˜ä»£ç **ï¼š
```java
// é”™è¯¯ç¤ºä¾‹ï¼šå¤åˆæ“ä½œéåŸå­
ConcurrentHashMap<String, Integer> counter = new ConcurrentHashMap<>();

public void increment(String key) {
    Integer count = counter.get(key);
    if (count == null) {
        counter.put(key, 1);
    } else {
        counter.put(key, count + 1);  // éåŸå­æ“ä½œï¼
    }
}
```

### 8.2 è§£å†³æ–¹æ¡ˆ

```java
@Service
public class CounterService {
    
    private final ConcurrentHashMap<String, AtomicLong> counter = 
        new ConcurrentHashMap<>();
    
    // æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ AtomicLong
    public void increment(String key) {
        counter.computeIfAbsent(key, k -> new AtomicLong(0))
               .incrementAndGet();
    }
    
    // æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ compute
    public void incrementV2(String key) {
        counter.compute(key, (k, v) -> {
            if (v == null) {
                return new AtomicLong(1);
            }
            v.incrementAndGet();
            return v;
        });
    }
    
    // æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ LongAdderï¼ˆé«˜å¹¶å‘åœºæ™¯æ›´ä¼˜ï¼‰
    private final ConcurrentHashMap<String, LongAdder> adderCounter = 
        new ConcurrentHashMap<>();
    
    public void incrementV3(String key) {
        adderCounter.computeIfAbsent(key, k -> new LongAdder())
                    .increment();
    }
    
    public long getCount(String key) {
        LongAdder adder = adderCounter.get(key);
        return adder == null ? 0 : adder.sum();
    }
}
```

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿè§£å†³è¶…å–é—®é¢˜
- [ ] èƒ½å¤Ÿåˆç†é…ç½®çº¿ç¨‹æ± 
- [ ] èƒ½å¤Ÿç›‘æ§çº¿ç¨‹æ± çŠ¶æ€
- [ ] èƒ½å¤Ÿå¤„ç†å¹¶å‘æ›´æ–°
- [ ] èƒ½å¤Ÿæ­£ç¡®ä½¿ç”¨åˆ†å¸ƒå¼é”
- [ ] èƒ½å¤Ÿé˜²æ­¢æ¥å£é‡å¤æäº¤
- [ ] èƒ½å¤Ÿé¿å…æ­»é”é—®é¢˜
- [ ] èƒ½å¤Ÿæ­£ç¡®å¤„ç†å¼‚æ­¥å¼‚å¸¸
- [ ] èƒ½å¤Ÿæ­£ç¡®ä½¿ç”¨ ThreadLocal
- [ ] èƒ½å¤Ÿæ­£ç¡®ä½¿ç”¨å¹¶å‘é›†åˆ

---

**@author erik.zhou**


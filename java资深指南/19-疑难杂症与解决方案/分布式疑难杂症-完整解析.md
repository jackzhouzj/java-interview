# åˆ†å¸ƒå¼ç–‘éš¾æ‚ç—‡ - å®Œæ•´è§£æ

> ç”Ÿäº§ç¯å¢ƒåˆ†å¸ƒå¼ç³»ç»Ÿé—®é¢˜çš„è¯Šæ–­å’Œè§£å†³
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

åˆ†å¸ƒå¼ç³»ç»Ÿçš„é—®é¢˜å¾€å¾€æ›´åŠ å¤æ‚å’Œéšè”½ã€‚æœ¬æ–‡æ¡£åŸºäºçœŸå®ç”Ÿäº§ç¯å¢ƒæ¡ˆä¾‹ï¼Œè¯¦ç»†ä»‹ç»ï¼š
- ç¼“å­˜ç©¿é€/å‡»ç©¿/é›ªå´©çš„å®æˆ˜è§£å†³
- æ¶ˆæ¯ä¸¢å¤±å’Œé‡å¤æ¶ˆè´¹çš„å¤„ç†
- æœåŠ¡é›ªå´©å’Œç†”æ–­é™çº§
- åˆ†å¸ƒå¼äº‹åŠ¡å¤±è´¥çš„æ’æŸ¥
- æ¥å£å¹‚ç­‰æ€§é—®é¢˜

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] æŒæ¡ç¼“å­˜é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ
- [ ] èƒ½å¤Ÿä¿è¯æ¶ˆæ¯çš„å¯é æ€§
- [ ] èƒ½å¤Ÿé˜²æ­¢æœåŠ¡é›ªå´©
- [ ] èƒ½å¤Ÿå¤„ç†åˆ†å¸ƒå¼äº‹åŠ¡
- [ ] èƒ½å¤Ÿå®ç°æ¥å£å¹‚ç­‰æ€§

---

## 1. ç¼“å­˜ç©¿é€ ğŸ”¥

### 1.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šç”µå•†ç³»ç»Ÿå•†å“è¯¦æƒ…é¡µ

**ç³»ç»Ÿè¡¨ç°**ï¼š
- å¤§é‡è¯·æ±‚æŸ¥è¯¢ä¸å­˜åœ¨çš„å•†å“ ID
- ç¼“å­˜æœªå‘½ä¸­ï¼Œç›´æ¥æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“ CPU é£™é«˜ï¼Œè¿æ¥æ•°æš´å¢
- æ¥å£å“åº”æ—¶é—´ä» 50ms å¢åŠ åˆ° 5s

**ç›‘æ§æ•°æ®**ï¼š
```
æ—¶é—´: 2024-01-15 10:30:00
Redis å‘½ä¸­ç‡: 95% â†’ 30%
æ•°æ®åº“ QPS: 1000 â†’ 10000
æ¥å£å“åº”æ—¶é—´: 50ms â†’ 5000ms
é”™è¯¯ç‡: 0.1% â†’ 15%
```

### 1.2 é—®é¢˜åˆ†æ

**æ ¹æœ¬åŸå› **ï¼š
- æ¶æ„æ”»å‡»ï¼šçˆ¬è™«æˆ–æ”»å‡»è€…æ•…æ„è¯·æ±‚ä¸å­˜åœ¨çš„ ID
- ä¸šåŠ¡æ¼æ´ï¼šå‰ç«¯æœªæ ¡éªŒï¼Œå…è®¸ä»»æ„ ID è¯·æ±‚
- ç¼“å­˜ç­–ç•¥ï¼šæœªç¼“å­˜ç©ºå€¼ï¼Œå¯¼è‡´æ¯æ¬¡éƒ½æŸ¥æ•°æ®åº“

**é—®é¢˜ä»£ç **ï¼š

```java
@Service
public class ProductService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private ProductRepository productRepository;
    
    public Product getProduct(Long productId) {
        // 1. æŸ¥è¯¢ç¼“å­˜
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        // 2. æŸ¥è¯¢æ•°æ®åº“
        Product product = productRepository.findById(productId);
        
        // 3. å†™å…¥ç¼“å­˜
        if (product != null) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), 1, TimeUnit.HOURS);
        }
        // âŒ é—®é¢˜ï¼šå¦‚æœ product ä¸º nullï¼Œä¸ç¼“å­˜ï¼Œä¸‹æ¬¡è¿˜ä¼šæŸ¥æ•°æ®åº“
        
        return product;
    }
}
```

### 1.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šç¼“å­˜ç©ºå€¼ï¼ˆæ¨èï¼‰**

```java
@Service
public class ProductService {
    
    private static final String NULL_VALUE = "NULL";
    
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        
        // ç¼“å­˜å‘½ä¸­
        if (json != null) {
            if (NULL_VALUE.equals(json)) {
                return null;  // ç¼“å­˜çš„ç©ºå€¼
            }
            return JSON.parseObject(json, Product.class);
        }
        
        // æŸ¥è¯¢æ•°æ®åº“
        Product product = productRepository.findById(productId);
        
        if (product != null) {
            // ç¼“å­˜æ­£å¸¸æ•°æ®ï¼Œ1 å°æ—¶è¿‡æœŸ
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), 1, TimeUnit.HOURS);
        } else {
            // ç¼“å­˜ç©ºå€¼ï¼Œ5 åˆ†é’Ÿè¿‡æœŸï¼ˆé¿å…å ç”¨å¤ªå¤šå†…å­˜ï¼‰
            redisTemplate.opsForValue().set(key, NULL_VALUE, 5, TimeUnit.MINUTES);
        }
        
        return product;
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå¸ƒéš†è¿‡æ»¤å™¨ï¼ˆæ¨èï¼‰**

```java
@Configuration
public class BloomFilterConfig {
    
    @Bean
    public BloomFilter<Long> productBloomFilter() {
        // é¢„è®¡ 1000 ä¸‡ä¸ªå•†å“ï¼Œè¯¯åˆ¤ç‡ 0.01%
        BloomFilter<Long> bloomFilter = BloomFilter.create(
            Funnels.longFunnel(),
            10000000,
            0.0001
        );
        
        // åˆå§‹åŒ–ï¼šå°†æ‰€æœ‰å•†å“ ID åŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
        List<Long> productIds = productRepository.findAllIds();
        productIds.forEach(bloomFilter::put);
        
        return bloomFilter;
    }
}

@Service
public class ProductService {
    
    @Autowired
    private BloomFilter<Long> productBloomFilter;
    
    public Product getProduct(Long productId) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!productBloomFilter.mightContain(productId)) {
            // ä¸€å®šä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›
            return null;
        }
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        Product product = productRepository.findById(productId);
        if (product != null) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(product), 1, TimeUnit.HOURS);
        }
        
        return product;
    }
    
    // æ–°å¢å•†å“æ—¶ï¼ŒåŠ å…¥å¸ƒéš†è¿‡æ»¤å™¨
    @Transactional
    public void addProduct(Product product) {
        productRepository.save(product);
        productBloomFilter.put(product.getId());
    }
}
```

**æ–¹æ¡ˆ 3ï¼šæ¥å£é™æµ**

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    @Autowired
    private ProductService productService;
    
    // ä½¿ç”¨ Guava RateLimiter é™æµ
    private final RateLimiter rateLimiter = RateLimiter.create(1000);  // æ¯ç§’ 1000 ä¸ªè¯·æ±‚
    
    @GetMapping("/{id}")
    public Result<Product> getProduct(@PathVariable Long id) {
        // é™æµ
        if (!rateLimiter.tryAcquire()) {
            return Result.fail("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
        }
        
        // å‚æ•°æ ¡éªŒ
        if (id == null || id <= 0) {
            return Result.fail("å•†å“ ID æ— æ•ˆ");
        }
        
        Product product = productService.getProduct(id);
        return Result.success(product);
    }
}
```

---

## 2. ç¼“å­˜å‡»ç©¿ ğŸ”¥

### 2.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šç§’æ€æ´»åŠ¨ï¼Œçƒ­é—¨å•†å“ç¼“å­˜è¿‡æœŸ

**ç³»ç»Ÿè¡¨ç°**ï¼š
- æŸä¸ªçƒ­ç‚¹ key è¿‡æœŸç¬é—´
- å¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶æ‰“åˆ°æ•°æ®åº“
- æ•°æ®åº“ç¬æ—¶å‹åŠ›å·¨å¤§
- éƒ¨åˆ†è¯·æ±‚è¶…æ—¶

**æ—¶é—´çº¿**ï¼š
```
10:00:00 - ç¼“å­˜æ­£å¸¸ï¼ŒQPS 10000ï¼Œå“åº”æ—¶é—´ 50ms
10:00:01 - çƒ­ç‚¹ key è¿‡æœŸ
10:00:02 - 1000 ä¸ªå¹¶å‘è¯·æ±‚åŒæ—¶æŸ¥æ•°æ®åº“
10:00:03 - æ•°æ®åº“è¿æ¥æ± è€—å°½ï¼Œå¤§é‡è¯·æ±‚è¶…æ—¶
10:00:05 - ç¼“å­˜é‡å»ºå®Œæˆï¼Œç³»ç»Ÿæ¢å¤
```

### 2.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šäº’æ–¥é”ï¼ˆæ¨èï¼‰**

```java
@Service
public class ProductService {
    
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        
        // 1. æŸ¥è¯¢ç¼“å­˜
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        // 2. ç¼“å­˜æœªå‘½ä¸­ï¼Œä½¿ç”¨åˆ†å¸ƒå¼é”
        String lockKey = "lock:product:" + productId;
        String lockValue = UUID.randomUUID().toString();
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾… 3 ç§’
            boolean locked = redisTemplate.opsForValue()
                .setIfAbsent(lockKey, lockValue, 10, TimeUnit.SECONDS);
            
            if (locked) {
                // è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“
                Product product = productRepository.findById(productId);
                
                if (product != null) {
                    // ç¼“å­˜æ•°æ®
                    redisTemplate.opsForValue().set(key, 
                        JSON.toJSONString(product), 1, TimeUnit.HOURS);
                }
                
                return product;
            } else {
                // è·å–é”å¤±è´¥ï¼Œç­‰å¾… 100ms åé‡è¯•
                Thread.sleep(100);
                return getProduct(productId);  // é€’å½’é‡è¯•
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            throw new RuntimeException("è·å–å•†å“ä¿¡æ¯å¤±è´¥", e);
        } finally {
            // é‡Šæ”¾é”ï¼ˆä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§ï¼‰
            String script = 
                "if redis.call('get', KEYS[1]) == ARGV[1] then " +
                "    return redis.call('del', KEYS[1]) " +
                "else " +
                "    return 0 " +
                "end";
            redisTemplate.execute(
                new DefaultRedisScript<>(script, Long.class),
                Collections.singletonList(lockKey),
                lockValue
            );
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šæ°¸ä¸è¿‡æœŸï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰**

```java
@Service
public class ProductService {
    
    public Product getProduct(Long productId) {
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        
        if (json != null) {
            ProductCache cache = JSON.parseObject(json, ProductCache.class);
            
            // æ£€æŸ¥é€»è¾‘è¿‡æœŸæ—¶é—´
            if (cache.getExpireTime().isAfter(LocalDateTime.now())) {
                return cache.getProduct();
            }
            
            // é€»è¾‘è¿‡æœŸï¼Œå¼‚æ­¥æ›´æ–°ç¼“å­˜
            CompletableFuture.runAsync(() -> {
                updateCache(productId);
            });
            
            // è¿”å›æ—§æ•°æ®
            return cache.getProduct();
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼ŒåŒæ­¥æŸ¥è¯¢
        return updateCache(productId);
    }
    
    private Product updateCache(Long productId) {
        Product product = productRepository.findById(productId);
        
        if (product != null) {
            ProductCache cache = new ProductCache();
            cache.setProduct(product);
            cache.setExpireTime(LocalDateTime.now().plusHours(1));  // é€»è¾‘è¿‡æœŸæ—¶é—´
            
            // æ°¸ä¸è¿‡æœŸ
            redisTemplate.opsForValue().set("product:" + productId, 
                JSON.toJSONString(cache));
        }
        
        return product;
    }
}

@Data
class ProductCache {
    private Product product;
    private LocalDateTime expireTime;  // é€»è¾‘è¿‡æœŸæ—¶é—´
}
```

---

## 3. ç¼“å­˜é›ªå´© ğŸ”¥

### 2.3 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šåŒåä¸€é›¶ç‚¹ï¼Œå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ

**ç³»ç»Ÿè¡¨ç°**ï¼š
- å‡Œæ™¨ 00:00:00ï¼Œå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ
- æ•°æ®åº“ç¬é—´æ‰¿å—å·¨å¤§å‹åŠ›
- ç³»ç»Ÿæ•´ä½“ä¸å¯ç”¨
- æŒç»­æ—¶é—´ 5-10 åˆ†é’Ÿ

**å½±å“èŒƒå›´**ï¼š
```
å—å½±å“æœåŠ¡: å•†å“æœåŠ¡ã€è®¢å•æœåŠ¡ã€ç”¨æˆ·æœåŠ¡
æ•°æ®åº“ QPS: 1000 â†’ 50000
æ•°æ®åº“è¿æ¥æ•°: 100 â†’ 1000ï¼ˆè¿æ¥æ± è€—å°½ï¼‰
ç³»ç»Ÿå¯ç”¨æ€§: 99.9% â†’ 0%
```

### 2.4 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šè¿‡æœŸæ—¶é—´åŠ éšæœºå€¼**

```java
@Service
public class ProductService {
    
    public void cacheProduct(Product product) {
        String key = "product:" + product.getId();
        
        // åŸºç¡€è¿‡æœŸæ—¶é—´ 1 å°æ—¶ + éšæœº 0-300 ç§’
        int baseExpire = 3600;
        int randomExpire = new Random().nextInt(300);
        int expireTime = baseExpire + randomExpire;
        
        redisTemplate.opsForValue().set(key, 
            JSON.toJSONString(product), expireTime, TimeUnit.SECONDS);
    }
}
```

**æ–¹æ¡ˆ 2ï¼šå¤šçº§ç¼“å­˜**

```java
@Service
public class ProductService {
    
    // æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
    private final LoadingCache<Long, Product> localCache = Caffeine.newBuilder()
        .maximumSize(10000)
        .expireAfterWrite(5, TimeUnit.MINUTES)
        .build(key -> {
            // ä» Redis åŠ è½½
            return getFromRedis(key);
        });
    
    public Product getProduct(Long productId) {
        try {
            // 1. æŸ¥è¯¢æœ¬åœ°ç¼“å­˜
            return localCache.get(productId);
        } catch (Exception e) {
            // 2. æœ¬åœ°ç¼“å­˜å¤±è´¥ï¼Œé™çº§æŸ¥è¯¢æ•°æ®åº“
            log.error("ç¼“å­˜æŸ¥è¯¢å¤±è´¥", e);
            return productRepository.findById(productId);
        }
    }
    
    private Product getFromRedis(Long productId) {
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        // Redis æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
        Product product = productRepository.findById(productId);
        if (product != null) {
            redisTemplate.opsForValue().set(key, 
                JSON.toJSONString(product), 1, TimeUnit.HOURS);
        }
        
        return product;
    }
}
```

**æ–¹æ¡ˆ 3ï¼šRedis é›†ç¾¤ + ç†”æ–­é™çº§**

```java
@Service
public class ProductService {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @Autowired
    private ProductRepository productRepository;
    
    // ç†”æ–­å™¨
    private final CircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults("productService");
    
    public Product getProduct(Long productId) {
        return circuitBreaker.executeSupplier(() -> {
            try {
                return getFromCache(productId);
            } catch (Exception e) {
                log.error("ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œé™çº§æŸ¥è¯¢æ•°æ®åº“", e);
                // é™çº§ï¼šç›´æ¥æŸ¥è¯¢æ•°æ®åº“
                return productRepository.findById(productId);
            }
        });
    }
    
    private Product getFromCache(Long productId) {
        String key = "product:" + productId;
        String json = redisTemplate.opsForValue().get(key);
        
        if (json != null) {
            return JSON.parseObject(json, Product.class);
        }
        
        Product product = productRepository.findById(productId);
        if (product != null) {
            redisTemplate.opsForValue().set(key, 
                JSON.toJSONString(product), 1, TimeUnit.HOURS);
        }
        
        return product;
    }
}
```



---

## 4. æ¶ˆæ¯ä¸¢å¤± ğŸ”¥

### 4.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šè®¢å•æ”¯ä»˜æˆåŠŸï¼Œä½†åº“å­˜æœªæ‰£å‡

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·æ”¯ä»˜æˆåŠŸï¼Œè®¢å•çŠ¶æ€å·²æ›´æ–°
- ä½†åº“å­˜æœåŠ¡æœªæ”¶åˆ°æ‰£å‡æ¶ˆæ¯
- å¯¼è‡´åº“å­˜æ•°æ®ä¸ä¸€è‡´

**æ—¶é—´çº¿**ï¼š
```
14:30:00 - ç”¨æˆ·æ”¯ä»˜æˆåŠŸ
14:30:01 - è®¢å•æœåŠ¡å‘é€ MQ æ¶ˆæ¯
14:30:02 - MQ Broker æ¥æ”¶æ¶ˆæ¯
14:30:03 - åº“å­˜æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯ï¼ˆå¤±è´¥ï¼Œæœª ACKï¼‰
14:30:04 - æ¶ˆæ¯è¢« MQ åˆ é™¤ï¼ˆæ¶ˆæ¯ä¸¢å¤±ï¼‰
```

### 4.2 é—®é¢˜åˆ†æ

**æ¶ˆæ¯ä¸¢å¤±çš„ä¸‰ä¸ªé˜¶æ®µ**ï¼š

**1. ç”Ÿäº§è€…ä¸¢å¤±æ¶ˆæ¯**
- ç½‘ç»œæ•…éšœï¼Œæ¶ˆæ¯æœªå‘é€åˆ° Broker
- Broker å®•æœºï¼Œæ¶ˆæ¯æœªæŒä¹…åŒ–

**2. Broker ä¸¢å¤±æ¶ˆæ¯**
- æ¶ˆæ¯æœªæŒä¹…åŒ–åˆ°ç£ç›˜
- ç£ç›˜æ•…éšœ

**3. æ¶ˆè´¹è€…ä¸¢å¤±æ¶ˆæ¯**
- æ¶ˆè´¹å¤±è´¥ï¼Œä½†å·² ACK
- æ¶ˆè´¹è€…å®•æœºï¼Œæ¶ˆæ¯æœªå¤„ç†

### 4.3 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ï¼ˆRabbitMQï¼‰**

```java
@Configuration
public class RabbitMQConfig {
    
    @Bean
    public RabbitTemplate rabbitTemplate(ConnectionFactory connectionFactory) {
        RabbitTemplate template = new RabbitTemplate(connectionFactory);
        
        // å¼€å¯å‘é€ç¡®è®¤
        template.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ: {}", correlationData);
            } else {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥: {}, åŸå› : {}", correlationData, cause);
                // é‡è¯•æˆ–è®°å½•åˆ°æ•°æ®åº“
            }
        });
        
        // å¼€å¯è¿”å›ç¡®è®¤ï¼ˆæ¶ˆæ¯æ— æ³•è·¯ç”±æ—¶è§¦å‘ï¼‰
        template.setReturnsCallback(returned -> {
            log.error("æ¶ˆæ¯è¢«é€€å›: {}", returned);
            // å¤„ç†é€€å›çš„æ¶ˆæ¯
        });
        
        return template;
    }
}

@Service
public class OrderService {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    @Autowired
    private MessageLogRepository messageLogRepository;
    
    @Transactional
    public void createOrder(Order order) {
        // 1. ä¿å­˜è®¢å•
        orderRepository.save(order);
        
        // 2. ä¿å­˜æ¶ˆæ¯æ—¥å¿—ï¼ˆæœ¬åœ°æ¶ˆæ¯è¡¨ï¼‰
        MessageLog messageLog = new MessageLog();
        messageLog.setMessageId(UUID.randomUUID().toString());
        messageLog.setContent(JSON.toJSONString(order));
        messageLog.setStatus(MessageStatus.PENDING);
        messageLogRepository.save(messageLog);
        
        // 3. å‘é€æ¶ˆæ¯
        CorrelationData correlationData = new CorrelationData(messageLog.getMessageId());
        rabbitTemplate.convertAndSend("order.exchange", "order.created", 
            order, correlationData);
    }
}

// å®šæ—¶ä»»åŠ¡ï¼šé‡å‘å¤±è´¥çš„æ¶ˆæ¯
@Component
public class MessageRetryTask {
    
    @Scheduled(fixedDelay = 60000)  // æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
    public void retryFailedMessages() {
        List<MessageLog> failedMessages = messageLogRepository
            .findByStatusAndRetryCountLessThan(MessageStatus.FAILED, 3);
        
        for (MessageLog message : failedMessages) {
            try {
                rabbitTemplate.convertAndSend("order.exchange", "order.created", 
                    message.getContent());
                
                message.setStatus(MessageStatus.SUCCESS);
                messageLogRepository.save(message);
            } catch (Exception e) {
                message.setRetryCount(message.getRetryCount() + 1);
                messageLogRepository.save(message);
            }
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šæ¶ˆè´¹è€…æ‰‹åŠ¨ ACKï¼ˆRabbitMQï¼‰**

```java
@Configuration
public class RabbitMQConsumerConfig {
    
    @Bean
    public SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory = 
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        
        // æ‰‹åŠ¨ ACK
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        
        // è®¾ç½®å¹¶å‘æ¶ˆè´¹è€…æ•°é‡
        factory.setConcurrentConsumers(5);
        factory.setMaxConcurrentConsumers(10);
        
        return factory;
    }
}

@Service
public class InventoryConsumer {
    
    @RabbitListener(queues = "inventory.queue")
    public void onOrderCreated(Order order, Channel channel, 
            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            // 1. å¹‚ç­‰æ€§æ£€æŸ¥
            if (isProcessed(order.getId())) {
                // å·²å¤„ç†è¿‡ï¼Œç›´æ¥ ACK
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // 2. æ‰£å‡åº“å­˜
            inventoryService.deduct(order.getProductId(), order.getQuantity());
            
            // 3. è®°å½•å·²å¤„ç†
            markAsProcessed(order.getId());
            
            // 4. æ‰‹åŠ¨ ACK
            channel.basicAck(deliveryTag, false);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
            
            try {
                // æ‹’ç»æ¶ˆæ¯ï¼Œé‡æ–°å…¥é˜Ÿ
                channel.basicNack(deliveryTag, false, true);
            } catch (IOException ex) {
                log.error("æ‹’ç»æ¶ˆæ¯å¤±è´¥", ex);
            }
        }
    }
    
    private boolean isProcessed(Long orderId) {
        return redisTemplate.hasKey("order:processed:" + orderId);
    }
    
    private void markAsProcessed(Long orderId) {
        redisTemplate.opsForValue().set("order:processed:" + orderId, 
            "1", 24, TimeUnit.HOURS);
    }
}
```

**æ–¹æ¡ˆ 3ï¼šKafka æ¶ˆæ¯å¯é æ€§**

```java
@Configuration
public class KafkaProducerConfig {
    
    @Bean
    public ProducerFactory<String, String> producerFactory() {
        Map<String, Object> config = new HashMap<>();
        config.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
        
        // ç¡®ä¿æ¶ˆæ¯ä¸ä¸¢å¤±
        config.put(ProducerConfig.ACKS_CONFIG, "all");  // ç­‰å¾…æ‰€æœ‰å‰¯æœ¬ç¡®è®¤
        config.put(ProducerConfig.RETRIES_CONFIG, 3);  // é‡è¯• 3 æ¬¡
        config.put(ProducerConfig.MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION, 1);  // ä¿è¯é¡ºåº
        
        // å¹‚ç­‰æ€§
        config.put(ProducerConfig.ENABLE_IDEMPOTENCE_CONFIG, true);
        
        return new DefaultKafkaProducerFactory<>(config);
    }
}

@Service
public class OrderProducer {
    
    @Autowired
    private KafkaTemplate<String, String> kafkaTemplate;
    
    public void sendOrderMessage(Order order) {
        String topic = "order-created";
        String key = order.getId().toString();
        String value = JSON.toJSONString(order);
        
        // å‘é€æ¶ˆæ¯ï¼Œå¸¦å›è°ƒ
        ListenableFuture<SendResult<String, String>> future = 
            kafkaTemplate.send(topic, key, value);
        
        future.addCallback(
            result -> {
                log.info("æ¶ˆæ¯å‘é€æˆåŠŸ: {}", result.getRecordMetadata());
            },
            ex -> {
                log.error("æ¶ˆæ¯å‘é€å¤±è´¥", ex);
                // ä¿å­˜åˆ°æ•°æ®åº“ï¼Œåç»­é‡è¯•
                saveFailedMessage(order);
            }
        );
    }
    
    private void saveFailedMessage(Order order) {
        MessageLog messageLog = new MessageLog();
        messageLog.setContent(JSON.toJSONString(order));
        messageLog.setStatus(MessageStatus.FAILED);
        messageLogRepository.save(messageLog);
    }
}

@Service
public class InventoryConsumer {
    
    @KafkaListener(topics = "order-created", groupId = "inventory-group")
    public void onOrderCreated(ConsumerRecord<String, String> record) {
        String orderId = record.key();
        String orderJson = record.value();
        
        try {
            // 1. å¹‚ç­‰æ€§æ£€æŸ¥
            if (isProcessed(orderId)) {
                return;
            }
            
            // 2. å¤„ç†ä¸šåŠ¡
            Order order = JSON.parseObject(orderJson, Order.class);
            inventoryService.deduct(order.getProductId(), order.getQuantity());
            
            // 3. è®°å½•å·²å¤„ç†
            markAsProcessed(orderId);
            
        } catch (Exception e) {
            log.error("å¤„ç†æ¶ˆæ¯å¤±è´¥", e);
            // Kafka ä¼šè‡ªåŠ¨é‡è¯•
            throw new RuntimeException("å¤„ç†å¤±è´¥", e);
        }
    }
}
```

---

## 5. æ¶ˆæ¯é‡å¤æ¶ˆè´¹ ğŸ”¥

### 5.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šç”¨æˆ·ä¸‹å•ï¼Œåº“å­˜è¢«é‡å¤æ‰£å‡

**é—®é¢˜æè¿°**ï¼š
- ç”¨æˆ·ä¸‹å• 1 ä»¶å•†å“
- åº“å­˜æœåŠ¡æ”¶åˆ° 2 æ¡ç›¸åŒçš„æ¶ˆæ¯
- åº“å­˜è¢«æ‰£å‡ 2 æ¬¡
- å¯¼è‡´åº“å­˜æ•°æ®é”™è¯¯

**åŸå› åˆ†æ**ï¼š
- ç”Ÿäº§è€…é‡è¯•å¯¼è‡´é‡å¤å‘é€
- æ¶ˆè´¹è€…å¤„ç†æˆåŠŸä½† ACK å¤±è´¥ï¼Œæ¶ˆæ¯é‡æ–°æŠ•é€’
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´æ¶ˆæ¯é‡å¤

### 5.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šå”¯ä¸€ ID + Redis å»é‡**

```java
@Service
public class InventoryConsumer {
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    @KafkaListener(topics = "order-created")
    public void onOrderCreated(ConsumerRecord<String, String> record) {
        String messageId = record.key();  // ä½¿ç”¨æ¶ˆæ¯ key ä½œä¸ºå”¯ä¸€ ID
        String orderJson = record.value();
        
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥
        String lockKey = "message:lock:" + messageId;
        Boolean locked = redisTemplate.opsForValue()
            .setIfAbsent(lockKey, "1", 24, TimeUnit.HOURS);
        
        if (!Boolean.TRUE.equals(locked)) {
            // å·²å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å›
            log.info("æ¶ˆæ¯å·²å¤„ç†: {}", messageId);
            return;
        }
        
        try {
            // 2. å¤„ç†ä¸šåŠ¡
            Order order = JSON.parseObject(orderJson, Order.class);
            inventoryService.deduct(order.getProductId(), order.getQuantity());
            
            log.info("æ¶ˆæ¯å¤„ç†æˆåŠŸ: {}", messageId);
        } catch (Exception e) {
            // å¤„ç†å¤±è´¥ï¼Œåˆ é™¤é”ï¼Œå…è®¸é‡è¯•
            redisTemplate.delete(lockKey);
            throw new RuntimeException("å¤„ç†å¤±è´¥", e);
        }
    }
}
```

**æ–¹æ¡ˆ 2ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ**

```sql
-- åˆ›å»ºæ¶ˆæ¯å¤„ç†è®°å½•è¡¨
CREATE TABLE message_process_log (
    message_id VARCHAR(64) PRIMARY KEY,
    topic VARCHAR(100) NOT NULL,
    content TEXT,
    process_time DATETIME NOT NULL,
    INDEX idx_topic (topic)
) ENGINE=InnoDB;
```

```java
@Service
public class InventoryConsumer {
    
    @Autowired
    private MessageProcessLogRepository messageProcessLogRepository;
    
    @KafkaListener(topics = "order-created")
    @Transactional
    public void onOrderCreated(ConsumerRecord<String, String> record) {
        String messageId = record.key();
        String orderJson = record.value();
        
        try {
            // 1. æ’å…¥å¤„ç†è®°å½•ï¼ˆåˆ©ç”¨å”¯ä¸€çº¦æŸï¼‰
            MessageProcessLog log = new MessageProcessLog();
            log.setMessageId(messageId);
            log.setTopic(record.topic());
            log.setContent(orderJson);
            log.setProcessTime(LocalDateTime.now());
            messageProcessLogRepository.save(log);
            
            // 2. å¤„ç†ä¸šåŠ¡
            Order order = JSON.parseObject(orderJson, Order.class);
            inventoryService.deduct(order.getProductId(), order.getQuantity());
            
        } catch (DataIntegrityViolationException e) {
            // å”¯ä¸€çº¦æŸå†²çªï¼Œè¯´æ˜å·²å¤„ç†è¿‡
            log.info("æ¶ˆæ¯å·²å¤„ç†: {}", messageId);
        }
    }
}
```

**æ–¹æ¡ˆ 3ï¼šä¸šåŠ¡å±‚é¢å¹‚ç­‰æ€§**

```java
@Service
public class InventoryService {
    
    /**
     * å¹‚ç­‰æ€§æ‰£å‡åº“å­˜
     */
    @Transactional
    public void deduct(Long productId, Integer quantity, String orderId) {
        // 1. æŸ¥è¯¢åº“å­˜è®°å½•
        InventoryLog log = inventoryLogRepository
            .findByProductIdAndOrderId(productId, orderId);
        
        if (log != null) {
            // å·²æ‰£å‡è¿‡ï¼Œç›´æ¥è¿”å›
            log.info("åº“å­˜å·²æ‰£å‡: productId={}, orderId={}", productId, orderId);
            return;
        }
        
        // 2. æ‰£å‡åº“å­˜
        int updated = inventoryRepository.deduct(productId, quantity);
        if (updated == 0) {
            throw new RuntimeException("åº“å­˜ä¸è¶³");
        }
        
        // 3. è®°å½•æ‰£å‡æ—¥å¿—
        InventoryLog newLog = new InventoryLog();
        newLog.setProductId(productId);
        newLog.setOrderId(orderId);
        newLog.setQuantity(quantity);
        newLog.setCreateTime(LocalDateTime.now());
        inventoryLogRepository.save(newLog);
    }
}

// Repository
@Repository
public interface InventoryRepository extends JpaRepository<Inventory, Long> {
    
    @Modifying
    @Query("UPDATE Inventory i SET i.quantity = i.quantity - :quantity " +
           "WHERE i.productId = :productId AND i.quantity >= :quantity")
    int deduct(@Param("productId") Long productId, @Param("quantity") Integer quantity);
}
```

---

## 6. æœåŠ¡é›ªå´© ğŸ”¥

### 6.1 é—®é¢˜ç°è±¡

**çœŸå®åœºæ™¯**ï¼šæ”¯ä»˜æœåŠ¡æ•…éšœï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨

**é—®é¢˜æè¿°**ï¼š
- æ”¯ä»˜æœåŠ¡å“åº”æ…¢ï¼ˆ5s â†’ 30sï¼‰
- è®¢å•æœåŠ¡è°ƒç”¨æ”¯ä»˜æœåŠ¡è¶…æ—¶
- è®¢å•æœåŠ¡çº¿ç¨‹æ± è€—å°½
- ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡è¶…æ—¶
- æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨

**é›ªå´©é“¾è·¯**ï¼š
```
æ”¯ä»˜æœåŠ¡æ•…éšœ
  â†“
è®¢å•æœåŠ¡è°ƒç”¨è¶…æ—¶
  â†“
è®¢å•æœåŠ¡çº¿ç¨‹æ± è€—å°½
  â†“
ç”¨æˆ·æœåŠ¡è°ƒç”¨è®¢å•æœåŠ¡è¶…æ—¶
  â†“
ç”¨æˆ·æœåŠ¡çº¿ç¨‹æ± è€—å°½
  â†“
æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨
```

### 6.2 è§£å†³æ–¹æ¡ˆ

**æ–¹æ¡ˆ 1ï¼šSentinel ç†”æ–­é™çº§**

```java
@Configuration
public class SentinelConfig {
    
    @PostConstruct
    public void init() {
        // é…ç½®ç†”æ–­è§„åˆ™
        List<DegradeRule> rules = new ArrayList<>();
        
        DegradeRule rule = new DegradeRule();
        rule.setResource("paymentService");
        rule.setGrade(CircuitBreakerStrategy.ERROR_RATIO.getType());  // å¼‚å¸¸æ¯”ä¾‹
        rule.setCount(0.5);  // å¼‚å¸¸æ¯”ä¾‹é˜ˆå€¼ 50%
        rule.setTimeWindow(10);  // ç†”æ–­æ—¶é•¿ 10 ç§’
        rule.setMinRequestAmount(5);  // æœ€å°è¯·æ±‚æ•°
        rule.setStatIntervalMs(1000);  // ç»Ÿè®¡æ—¶é•¿ 1 ç§’
        
        rules.add(rule);
        DegradeRuleManager.loadRules(rules);
    }
}

@Service
public class OrderService {
    
    @Autowired
    private PaymentServiceClient paymentServiceClient;
    
    @SentinelResource(
        value = "createOrder",
        blockHandler = "createOrderBlockHandler",
        fallback = "createOrderFallback"
    )
    public Order createOrder(OrderDTO orderDTO) {
        // 1. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(orderDTO.getUserId());
        order.setAmount(orderDTO.getAmount());
        orderRepository.save(order);
        
        // 2. è°ƒç”¨æ”¯ä»˜æœåŠ¡
        PaymentResult result = paymentServiceClient.pay(order.getId(), order.getAmount());
        
        if (result.isSuccess()) {
            order.setStatus(OrderStatus.PAID);
        } else {
            order.setStatus(OrderStatus.FAILED);
        }
        
        orderRepository.save(order);
        return order;
    }
    
    // ç†”æ–­é™çº§æ–¹æ³•
    public Order createOrderBlockHandler(OrderDTO orderDTO, BlockException ex) {
        log.error("æœåŠ¡è¢«ç†”æ–­", ex);
        throw new RuntimeException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
    
    // å¼‚å¸¸é™çº§æ–¹æ³•
    public Order createOrderFallback(OrderDTO orderDTO, Throwable ex) {
        log.error("è°ƒç”¨æ”¯ä»˜æœåŠ¡å¤±è´¥", ex);
        
        // é™çº§ç­–ç•¥ï¼šåˆ›å»ºè®¢å•ï¼Œä½†ä¸è°ƒç”¨æ”¯ä»˜æœåŠ¡
        Order order = new Order();
        order.setUserId(orderDTO.getUserId());
        order.setAmount(orderDTO.getAmount());
        order.setStatus(OrderStatus.PENDING);  // å¾…æ”¯ä»˜
        orderRepository.save(order);
        
        return order;
    }
}
```

**æ–¹æ¡ˆ 2ï¼šçº¿ç¨‹æ± éš”ç¦»**

```java
@Configuration
public class ThreadPoolConfig {
    
    // ä¸ºæ¯ä¸ªæœåŠ¡è°ƒç”¨é…ç½®ç‹¬ç«‹çš„çº¿ç¨‹æ± 
    @Bean("paymentThreadPool")
    public ThreadPoolTaskExecutor paymentThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("payment-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
    
    @Bean("inventoryThreadPool")
    public ThreadPoolTaskExecutor inventoryThreadPool() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("inventory-");
        executor.setRejectedExecutionHandler(new ThreadPoolExecutor.CallerRunsPolicy());
        executor.initialize();
        return executor;
    }
}

@Service
public class OrderService {
    
    @Autowired
    @Qualifier("paymentThreadPool")
    private ThreadPoolTaskExecutor paymentThreadPool;
    
    public Order createOrder(OrderDTO orderDTO) {
        // ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹æ± è°ƒç”¨æ”¯ä»˜æœåŠ¡
        CompletableFuture<PaymentResult> paymentFuture = CompletableFuture.supplyAsync(() -> {
            return paymentServiceClient.pay(orderDTO.getOrderId(), orderDTO.getAmount());
        }, paymentThreadPool);
        
        try {
            // è®¾ç½®è¶…æ—¶æ—¶é—´ 3 ç§’
            PaymentResult result = paymentFuture.get(3, TimeUnit.SECONDS);
            // å¤„ç†æ”¯ä»˜ç»“æœ
        } catch (TimeoutException e) {
            log.error("è°ƒç”¨æ”¯ä»˜æœåŠ¡è¶…æ—¶", e);
            // é™çº§å¤„ç†
        }
    }
}
```

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿè§£å†³ç¼“å­˜ç©¿é€é—®é¢˜
- [ ] èƒ½å¤Ÿè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜
- [ ] èƒ½å¤Ÿè§£å†³ç¼“å­˜é›ªå´©é—®é¢˜
- [ ] èƒ½å¤Ÿä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±
- [ ] èƒ½å¤Ÿå¤„ç†æ¶ˆæ¯é‡å¤æ¶ˆè´¹
- [ ] èƒ½å¤Ÿé˜²æ­¢æœåŠ¡é›ªå´©
- [ ] èƒ½å¤Ÿå®ç°æ¥å£å¹‚ç­‰æ€§

---

**@author erik.zhou**


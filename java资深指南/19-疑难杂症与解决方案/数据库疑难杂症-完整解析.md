# æ•°æ®åº“ç–‘éš¾æ‚ç—‡ - å®Œæ•´è§£æ

> ç”Ÿäº§ç¯å¢ƒæ•°æ®åº“é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³
> 
> @author erik.zhou

## ğŸ“š æ¦‚è¿°

æ•°æ®åº“é—®é¢˜æ˜¯ç”Ÿäº§ç¯å¢ƒæœ€å¸¸è§çš„æ€§èƒ½ç“¶é¢ˆä¹‹ä¸€ã€‚æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»ï¼š
- æ…¢æŸ¥è¯¢çš„åˆ†æå’Œä¼˜åŒ–
- æ­»é”çš„å®šä½å’Œè§£å†³
- ä¸»ä»å»¶è¿Ÿçš„å¤„ç†
- è¿æ¥æ± çš„ä¼˜åŒ–
- ç´¢å¼•å¤±æ•ˆçš„æ’æŸ¥

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- [ ] æŒæ¡æ…¢æŸ¥è¯¢çš„åˆ†ææ–¹æ³•
- [ ] èƒ½å¤Ÿä¼˜åŒ– SQL è¯­å¥
- [ ] èƒ½å¤Ÿåˆ†æå’Œè§£å†³æ­»é”
- [ ] èƒ½å¤Ÿå¤„ç†ä¸»ä»å»¶è¿Ÿ
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 
- [ ] èƒ½å¤Ÿæ’æŸ¥ç´¢å¼•å¤±æ•ˆé—®é¢˜

---

## 1. æ…¢æŸ¥è¯¢ ğŸ”¥

### 1.1 é—®é¢˜ç°è±¡

**ç³»ç»Ÿè¡¨ç°**ï¼š
- æ¥å£å“åº”æ…¢
- æ•°æ®åº“ CPU ä½¿ç”¨ç‡é«˜
- å¤§é‡æ…¢æŸ¥è¯¢æ—¥å¿—

**ç›‘æ§è¡¨ç°**ï¼š
- æ¥å£å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼
- æ•°æ®åº“è¿æ¥æ•°å¢åŠ 
- æ…¢æŸ¥è¯¢æ•°é‡å¢åŠ 

### 1.2 é—®é¢˜åˆ†æ

**å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```sql
-- æŸ¥çœ‹æ…¢æŸ¥è¯¢é…ç½®
SHOW VARIABLES LIKE 'slow_query%';
SHOW VARIABLES LIKE 'long_query_time';

-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;  -- è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢è®°å½•ä¸ºæ…¢æŸ¥è¯¢
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow.log';

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢ç»Ÿè®¡
SHOW GLOBAL STATUS LIKE 'Slow_queries';
```

**åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—**ï¼š

```bash
# ä½¿ç”¨ mysqldumpslow åˆ†æ
mysqldumpslow -s t -t 10 /var/log/mysql/slow.log

# å‚æ•°è¯´æ˜ï¼š
# -s: æ’åºæ–¹å¼ï¼ˆt: æ—¶é—´, c: æ¬¡æ•°, l: é”å®šæ—¶é—´ï¼‰
# -t: æ˜¾ç¤ºå‰ N æ¡
```

**æ¡ˆä¾‹ 1ï¼šæœªä½¿ç”¨ç´¢å¼•**

```sql
-- é—®é¢˜ SQL
SELECT * FROM user WHERE name = 'å¼ ä¸‰';  -- âŒ name å­—æ®µæ²¡æœ‰ç´¢å¼•

-- åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM user WHERE name = 'å¼ ä¸‰';

-- è¾“å‡ºï¼š
-- type: ALLï¼ˆå…¨è¡¨æ‰«æï¼‰
-- rows: 1000000ï¼ˆæ‰«æ 100 ä¸‡è¡Œï¼‰
-- Extra: Using where

-- è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ ç´¢å¼•
CREATE INDEX idx_name ON user(name);

-- å†æ¬¡åˆ†æ
EXPLAIN SELECT * FROM user WHERE name = 'å¼ ä¸‰';

-- è¾“å‡ºï¼š
-- type: refï¼ˆç´¢å¼•æŸ¥æ‰¾ï¼‰
-- rows: 1ï¼ˆåªæ‰«æ 1 è¡Œï¼‰
-- Extra: Using index condition
```

**æ¡ˆä¾‹ 2ï¼šSELECT * æŸ¥è¯¢**

```sql
-- é—®é¢˜ SQL
SELECT * FROM user WHERE id = 1;  -- âŒ æŸ¥è¯¢æ‰€æœ‰å­—æ®µ

-- è§£å†³æ–¹æ¡ˆï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT id, name, age FROM user WHERE id = 1;

-- å¥½å¤„ï¼š
-- 1. å‡å°‘æ•°æ®ä¼ è¾“é‡
-- 2. å¯èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•
-- 3. å‡å°‘å†…å­˜å ç”¨
```

**æ¡ˆä¾‹ 3ï¼šæ·±åˆ†é¡µæŸ¥è¯¢**

```sql
-- é—®é¢˜ SQL
SELECT * FROM user ORDER BY id LIMIT 1000000, 10;  -- âŒ æ·±åˆ†é¡µ

-- MySQL éœ€è¦æ‰«æ 1000010 è¡Œï¼Œç„¶åä¸¢å¼ƒå‰ 1000000 è¡Œ

-- è§£å†³æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å­æŸ¥è¯¢
SELECT * FROM user 
WHERE id >= (SELECT id FROM user ORDER BY id LIMIT 1000000, 1)
LIMIT 10;

-- è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨æ¸¸æ ‡ï¼ˆè®°å½•ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ IDï¼‰
SELECT * FROM user 
WHERE id > 1000000  -- ä¸Šæ¬¡æŸ¥è¯¢çš„æœ€å¤§ ID
ORDER BY id 
LIMIT 10;

-- è§£å†³æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ ES ç­‰æœç´¢å¼•æ“
```

**æ¡ˆä¾‹ 4ï¼šJOIN æŸ¥è¯¢ä¼˜åŒ–**

```sql
-- é—®é¢˜ SQL
SELECT u.*, o.* 
FROM user u
LEFT JOIN `order` o ON u.id = o.user_id
WHERE u.status = 1;  -- âŒ å¤§è¡¨ JOIN

-- åˆ†ææ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT u.*, o.* 
FROM user u
LEFT JOIN `order` o ON u.id = o.user_id
WHERE u.status = 1;

-- ä¼˜åŒ–æ–¹æ¡ˆ 1ï¼šç¡®ä¿ JOIN å­—æ®µæœ‰ç´¢å¼•
CREATE INDEX idx_user_id ON `order`(user_id);
CREATE INDEX idx_status ON user(status);

-- ä¼˜åŒ–æ–¹æ¡ˆ 2ï¼šå°è¡¨é©±åŠ¨å¤§è¡¨
-- å¦‚æœ user è¡¨å°ï¼Œorder è¡¨å¤§ï¼Œä½¿ç”¨ LEFT JOIN
-- å¦‚æœ order è¡¨å°ï¼Œuser è¡¨å¤§ï¼Œä½¿ç”¨ RIGHT JOIN æˆ–è°ƒæ•´é¡ºåº

-- ä¼˜åŒ–æ–¹æ¡ˆ 3ï¼šåˆ†æ­¥æŸ¥è¯¢
-- å…ˆæŸ¥è¯¢ user
SELECT * FROM user WHERE status = 1;

-- å†æŸ¥è¯¢ orderï¼ˆåœ¨ä»£ç ä¸­ï¼‰
SELECT * FROM `order` WHERE user_id IN (1, 2, 3, ...);
```

**æ¡ˆä¾‹ 5ï¼šIN æŸ¥è¯¢ä¼˜åŒ–**

```sql
-- é—®é¢˜ SQL
SELECT * FROM user WHERE id IN (1, 2, 3, ..., 10000);  -- âŒ IN æ¡ä»¶è¿‡å¤š

-- è§£å†³æ–¹æ¡ˆ 1ï¼šåˆ†æ‰¹æŸ¥è¯¢
SELECT * FROM user WHERE id IN (1, 2, 3, ..., 1000);
SELECT * FROM user WHERE id IN (1001, 1002, ..., 2000);
-- ...

-- è§£å†³æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¸´æ—¶è¡¨
CREATE TEMPORARY TABLE temp_ids (id BIGINT);
INSERT INTO temp_ids VALUES (1), (2), (3), ..., (10000);

SELECT u.* FROM user u
INNER JOIN temp_ids t ON u.id = t.id;

DROP TEMPORARY TABLE temp_ids;
```

### 1.3 ä¼˜åŒ–æŠ€å·§

**1. ç´¢å¼•ä¼˜åŒ–**

```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_name ON user(name);

-- è”åˆç´¢å¼•ï¼ˆéµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
CREATE INDEX idx_name_age ON user(name, age);

-- å¯ä»¥ä½¿ç”¨ï¼š
-- WHERE name = 'å¼ ä¸‰'
-- WHERE name = 'å¼ ä¸‰' AND age = 20
-- ä¸èƒ½ä½¿ç”¨ï¼š
-- WHERE age = 20

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_name_age_email ON user(name, age, email);

SELECT name, age, email FROM user WHERE name = 'å¼ ä¸‰';
-- ä¸éœ€è¦å›è¡¨ï¼Œç›´æ¥ä»ç´¢å¼•è·å–æ•°æ®
```

**2. æŸ¥è¯¢ä¼˜åŒ–**

```sql
-- é¿å… SELECT *
SELECT id, name FROM user WHERE id = 1;

-- é¿å…åœ¨ WHERE ä¸­ä½¿ç”¨å‡½æ•°
-- âŒ é”™è¯¯
SELECT * FROM user WHERE DATE(create_time) = '2024-01-01';

-- âœ… æ­£ç¡®
SELECT * FROM user 
WHERE create_time >= '2024-01-01 00:00:00' 
AND create_time < '2024-01-02 00:00:00';

-- é¿å…éšå¼ç±»å‹è½¬æ¢
-- âŒ é”™è¯¯ï¼ˆid æ˜¯ BIGINTï¼Œä½†ä¼ å…¥å­—ç¬¦ä¸²ï¼‰
SELECT * FROM user WHERE id = '1';

-- âœ… æ­£ç¡®
SELECT * FROM user WHERE id = 1;

-- ä½¿ç”¨ LIMIT
SELECT * FROM user WHERE status = 1 LIMIT 1000;
```

**3. è¡¨ç»“æ„ä¼˜åŒ–**

```sql
-- é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹
-- âŒ é”™è¯¯
CREATE TABLE user (
    id VARCHAR(50),  -- åº”è¯¥ç”¨ BIGINT
    age VARCHAR(10),  -- åº”è¯¥ç”¨ TINYINT
    amount VARCHAR(20)  -- åº”è¯¥ç”¨ DECIMAL
);

-- âœ… æ­£ç¡®
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    age TINYINT UNSIGNED,
    amount DECIMAL(10, 2)
);

-- å­—æ®µè®¾ç½® NOT NULL
CREATE TABLE user (
    id BIGINT NOT NULL,
    name VARCHAR(50) NOT NULL DEFAULT '',
    age TINYINT NOT NULL DEFAULT 0
);

-- åˆç†ä½¿ç”¨ TEXT å’Œ BLOB
-- å¤§å­—æ®µå•ç‹¬å­˜å‚¨
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    name VARCHAR(50)
);

CREATE TABLE user_detail (
    user_id BIGINT PRIMARY KEY,
    description TEXT,
    FOREIGN KEY (user_id) REFERENCES user(id)
);
```

---

## 2. æ­»é” ğŸ”¥

### 2.1 é—®é¢˜ç°è±¡

**ç³»ç»Ÿè¡¨ç°**ï¼š
- äº‹åŠ¡æ‰§è¡Œå¤±è´¥
- æ—¥å¿—ä¸­å‡ºç°æ­»é”é”™è¯¯
- éƒ¨åˆ†è¯·æ±‚è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Deadlock found when trying to get lock; try restarting transaction
```

### 2.2 é—®é¢˜åˆ†æ

**æŸ¥çœ‹æ­»é”æ—¥å¿—**ï¼š

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„æ­»é”ä¿¡æ¯
SHOW ENGINE INNODB STATUS\G

-- è¾“å‡ºä¸­çš„ LATEST DETECTED DEADLOCK éƒ¨åˆ†
```

**æ­»é”ç¤ºä¾‹**ï¼š

```sql
-- äº‹åŠ¡ 1
START TRANSACTION;
UPDATE user SET name = 'å¼ ä¸‰' WHERE id = 1;  -- è·å– id=1 çš„é”
-- ç­‰å¾…...
UPDATE user SET name = 'æå››' WHERE id = 2;  -- ç­‰å¾… id=2 çš„é”ï¼ˆè¢«äº‹åŠ¡ 2 æŒæœ‰ï¼‰
COMMIT;

-- äº‹åŠ¡ 2
START TRANSACTION;
UPDATE user SET name = 'ç‹äº”' WHERE id = 2;  -- è·å– id=2 çš„é”
-- ç­‰å¾…...
UPDATE user SET name = 'èµµå…­' WHERE id = 1;  -- ç­‰å¾… id=1 çš„é”ï¼ˆè¢«äº‹åŠ¡ 1 æŒæœ‰ï¼‰
COMMIT;

-- ç»“æœï¼šæ­»é”ï¼
```

**æ¡ˆä¾‹ 1ï¼šä¸åŒé¡ºåºæ›´æ–°å¯¼è‡´æ­»é”**

```java
// é—®é¢˜ä»£ç 
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // äº‹åŠ¡ 1ï¼štransfer(1, 2, 100)
    // äº‹åŠ¡ 2ï¼štransfer(2, 1, 50)
    
    // æ‰£å‡è½¬å‡ºè´¦æˆ·
    accountRepository.deduct(fromId, amount);  // äº‹åŠ¡ 1 é”å®š id=1ï¼Œäº‹åŠ¡ 2 é”å®š id=2
    
    // å¢åŠ è½¬å…¥è´¦æˆ·
    accountRepository.add(toId, amount);  // äº‹åŠ¡ 1 ç­‰å¾… id=2ï¼Œäº‹åŠ¡ 2 ç­‰å¾… id=1
    
    // æ­»é”ï¼
}

// è§£å†³æ–¹æ¡ˆï¼šæŒ‰ ID é¡ºåºåŠ é”
@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    // ç¡®ä¿æŒ‰ ID é¡ºåºåŠ é”
    Long firstId = Math.min(fromId, toId);
    Long secondId = Math.max(fromId, toId);
    
    // å…ˆé”å®š ID å°çš„
    Account first = accountRepository.findByIdForUpdate(firstId);
    // å†é”å®š ID å¤§çš„
    Account second = accountRepository.findByIdForUpdate(secondId);
    
    // æ‰§è¡Œè½¬è´¦
    if (first.getId().equals(fromId)) {
        first.setBalance(first.getBalance().subtract(amount));
        second.setBalance(second.getBalance().add(amount));
    } else {
        second.setBalance(second.getBalance().subtract(amount));
        first.setBalance(first.getBalance().add(amount));
    }
    
    accountRepository.save(first);
    accountRepository.save(second);
}
```

**æ¡ˆä¾‹ 2ï¼šé—´éš™é”å¯¼è‡´æ­»é”**

```sql
-- è¡¨ç»“æ„
CREATE TABLE user (
    id BIGINT PRIMARY KEY,
    name VARCHAR(50),
    age INT,
    INDEX idx_age (age)
);

-- æ•°æ®
INSERT INTO user VALUES (1, 'å¼ ä¸‰', 20);
INSERT INTO user VALUES (5, 'æå››', 25);
INSERT INTO user VALUES (10, 'ç‹äº”', 30);

-- äº‹åŠ¡ 1
START TRANSACTION;
SELECT * FROM user WHERE age = 23 FOR UPDATE;  -- é”å®š (20, 25) é—´éš™
-- ç­‰å¾…...
INSERT INTO user VALUES (3, 'èµµå…­', 22);  -- ç­‰å¾…æ’å…¥

-- äº‹åŠ¡ 2
START TRANSACTION;
SELECT * FROM user WHERE age = 24 FOR UPDATE;  -- é”å®š (20, 25) é—´éš™
-- ç­‰å¾…...
INSERT INTO user VALUES (4, 'å­™ä¸ƒ', 23);  -- ç­‰å¾…æ’å…¥

-- ç»“æœï¼šæ­»é”ï¼
```

### 2.3 è§£å†³æ–¹æ¡ˆ

**1. é¿å…æ­»é”**

```java
// 1. æŒ‰ç›¸åŒé¡ºåºè®¿é—®èµ„æº
// 2. ç¼©å°äº‹åŠ¡èŒƒå›´
// 3. é™ä½äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼ˆå¦‚æœä¸šåŠ¡å…è®¸ï¼‰
// 4. ä½¿ç”¨ä¹è§‚é”ä»£æ›¿æ‚²è§‚é”

// ä¹è§‚é”ç¤ºä¾‹
@Entity
public class Account {
    @Id
    private Long id;
    
    private BigDecimal balance;
    
    @Version  // ä¹è§‚é”ç‰ˆæœ¬å·
    private Integer version;
}

@Transactional
public void transfer(Long fromId, Long toId, BigDecimal amount) {
    Account from = accountRepository.findById(fromId);
    Account to = accountRepository.findById(toId);
    
    from.setBalance(from.getBalance().subtract(amount));
    to.setBalance(to.getBalance().add(amount));
    
    accountRepository.save(from);  // æ›´æ–°æ—¶æ£€æŸ¥ version
    accountRepository.save(to);
    
    // å¦‚æœ version ä¸åŒ¹é…ï¼ŒæŠ›å‡º OptimisticLockException
}
```

**2. æ­»é”é‡è¯•**

```java
@Service
public class TransferService {
    
    private static final int MAX_RETRIES = 3;
    
    public void transfer(Long fromId, Long toId, BigDecimal amount) {
        int retries = 0;
        
        while (retries < MAX_RETRIES) {
            try {
                doTransfer(fromId, toId, amount);
                return;  // æˆåŠŸ
            } catch (DeadlockLoserDataAccessException e) {
                retries++;
                if (retries >= MAX_RETRIES) {
                    throw new RuntimeException("è½¬è´¦å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•", e);
                }
                // ç­‰å¾…éšæœºæ—¶é—´åé‡è¯•
                try {
                    Thread.sleep((long) (Math.random() * 100));
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                }
            }
        }
    }
    
    @Transactional
    private void doTransfer(Long fromId, Long toId, BigDecimal amount) {
        // è½¬è´¦é€»è¾‘
    }
}
```

---

## 3. ä¸»ä»å»¶è¿Ÿ ğŸ”¥

### 3.1 é—®é¢˜ç°è±¡

**ç³»ç»Ÿè¡¨ç°**ï¼š
- åˆšå†™å…¥çš„æ•°æ®æŸ¥è¯¢ä¸åˆ°
- æ•°æ®ä¸ä¸€è‡´
- ä»åº“æ•°æ®æ»å

**ç›‘æ§è¡¨ç°**ï¼š
- Seconds_Behind_Master > 0
- ä¸»ä»å»¶è¿Ÿæ—¶é—´å¢åŠ 

### 3.2 é—®é¢˜åˆ†æ

**æŸ¥çœ‹ä¸»ä»å»¶è¿Ÿ**ï¼š

```sql
-- åœ¨ä»åº“æ‰§è¡Œ
SHOW SLAVE STATUS\G

-- å…³é”®å­—æ®µï¼š
-- Seconds_Behind_Master: å»¶è¿Ÿç§’æ•°
-- Slave_IO_Running: IO çº¿ç¨‹æ˜¯å¦è¿è¡Œ
-- Slave_SQL_Running: SQL çº¿ç¨‹æ˜¯å¦è¿è¡Œ
```

**å¸¸è§åŸå› **ï¼š

1. **ä¸»åº“å†™å…¥å‹åŠ›å¤§**
2. **ä»åº“é…ç½®ä½**
3. **å¤§äº‹åŠ¡**
4. **ç½‘ç»œå»¶è¿Ÿ**
5. **ä»åº“æœ‰æ…¢æŸ¥è¯¢**

### 3.3 è§£å†³æ–¹æ¡ˆ

**1. è¯»å†™åˆ†ç¦»æ—¶å¤„ç†å»¶è¿Ÿ**

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private StringRedisTemplate redisTemplate;
    
    /**
     * å†™æ“ä½œï¼šå†™ä¸»åº“ + å†™ç¼“å­˜
     */
    @Transactional
    public void updateUser(User user) {
        // 1. æ›´æ–°ä¸»åº“
        userRepository.save(user);
        
        // 2. æ›´æ–°ç¼“å­˜
        String key = "user:" + user.getId();
        redisTemplate.opsForValue().set(key, JSON.toJSONString(user), 5, TimeUnit.MINUTES);
    }
    
    /**
     * è¯»æ“ä½œï¼šå…ˆè¯»ç¼“å­˜ï¼Œå†è¯»ä»åº“
     */
    @Transactional(readOnly = true)
    public User getUser(Long id) {
        // 1. å…ˆä»ç¼“å­˜è¯»å–
        String key = "user:" + id;
        String json = redisTemplate.opsForValue().get(key);
        if (json != null) {
            return JSON.parseObject(json, User.class);
        }
        
        // 2. ä»ä»åº“è¯»å–
        User user = userRepository.findById(id);
        
        // 3. å†™å…¥ç¼“å­˜
        if (user != null) {
            redisTemplate.opsForValue().set(key, JSON.toJSONString(user), 5, TimeUnit.MINUTES);
        }
        
        return user;
    }
}
```

**2. å¼ºåˆ¶è¯»ä¸»åº“**

```java
@Service
public class UserService {
    
    /**
     * å†™æ“ä½œåç«‹å³è¯»å–ï¼Œå¼ºåˆ¶è¯»ä¸»åº“
     */
    public User updateAndGet(User user) {
        // 1. æ›´æ–°ï¼ˆå†™ä¸»åº“ï¼‰
        userRepository.save(user);
        
        // 2. ç«‹å³è¯»å–ï¼ˆå¼ºåˆ¶è¯»ä¸»åº“ï¼‰
        return userRepository.findByIdFromMaster(user.getId());
    }
}

// Repository å®ç°
@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    // é»˜è®¤è¯»ä»åº“
    User findById(Long id);
    
    // å¼ºåˆ¶è¯»ä¸»åº“
    @Transactional(readOnly = false)  // å¼ºåˆ¶ä½¿ç”¨ä¸»åº“
    @Query("SELECT u FROM User u WHERE u.id = :id")
    User findByIdFromMaster(@Param("id") Long id);
}
```

**3. ä¼˜åŒ–ä¸»ä»åŒæ­¥**

```sql
-- 1. å¹¶è¡Œå¤åˆ¶ï¼ˆMySQL 5.7+ï¼‰
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';
SET GLOBAL slave_parallel_workers = 4;  -- è®¾ç½®å¹¶è¡Œçº¿ç¨‹æ•°

-- 2. åŠåŒæ­¥å¤åˆ¶
-- ä¸»åº“é…ç½®
INSTALL PLUGIN rpl_semi_sync_master SONAME 'semisync_master.so';
SET GLOBAL rpl_semi_sync_master_enabled = 1;
SET GLOBAL rpl_semi_sync_master_timeout = 1000;  -- è¶…æ—¶æ—¶é—´ 1 ç§’

-- ä»åº“é…ç½®
INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';
SET GLOBAL rpl_semi_sync_slave_enabled = 1;

-- 3. ä¼˜åŒ–ä»åº“é…ç½®
-- å¢åŠ ä»åº“å†…å­˜
innodb_buffer_pool_size = 8G

-- å…³é—­ä»åº“çš„ binlogï¼ˆå¦‚æœä¸éœ€è¦ï¼‰
skip-log-bin

-- ä½¿ç”¨ SSD ç£ç›˜
```

---

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] èƒ½å¤Ÿåˆ†ææ…¢æŸ¥è¯¢
- [ ] èƒ½å¤Ÿä¼˜åŒ– SQL è¯­å¥
- [ ] èƒ½å¤Ÿåˆ›å»ºåˆé€‚çš„ç´¢å¼•
- [ ] èƒ½å¤Ÿåˆ†ææ­»é”
- [ ] èƒ½å¤Ÿé¿å…æ­»é”
- [ ] èƒ½å¤Ÿå¤„ç†ä¸»ä»å»¶è¿Ÿ
- [ ] èƒ½å¤Ÿä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 

---

**@author erik.zhou**


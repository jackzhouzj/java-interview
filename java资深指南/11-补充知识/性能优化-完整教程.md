# Javaæ€§èƒ½ä¼˜åŒ– å®Œæ•´æ•™ç¨‹

## ğŸ“‹ ç›®å½•
- [æŠ€æœ¯æ¦‚è¿°](#æŠ€æœ¯æ¦‚è¿°)
- [å­¦ä¹ ç›®æ ‡](#å­¦ä¹ ç›®æ ‡)
- [JVMæ€§èƒ½ä¼˜åŒ–](#jvmæ€§èƒ½ä¼˜åŒ–)
- [ä»£ç å±‚é¢ä¼˜åŒ–](#ä»£ç å±‚é¢ä¼˜åŒ–)
- [æ•°æ®åº“ä¼˜åŒ–](#æ•°æ®åº“ä¼˜åŒ–)
- [å¹¶å‘ä¼˜åŒ–](#å¹¶å‘ä¼˜åŒ–)
- [ç¼“å­˜ä¼˜åŒ–](#ç¼“å­˜ä¼˜åŒ–)
- [æ€§èƒ½åˆ†æå·¥å…·](#æ€§èƒ½åˆ†æå·¥å…·)
- [å®æˆ˜æ¡ˆä¾‹](#å®æˆ˜æ¡ˆä¾‹)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
- [ç›¸å…³èµ„æº](#ç›¸å…³èµ„æº)
- [å­¦ä¹ æ£€æŸ¥æ¸…å•](#å­¦ä¹ æ£€æŸ¥æ¸…å•)

## ğŸ“š æŠ€æœ¯æ¦‚è¿°
- **ç‰ˆæœ¬**: Java 8+
- **å‚è€ƒä¹¦ç±**: ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹ã€ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹
- **å­¦ä¹ éš¾åº¦**: â­â­â­â­â­ (5æ˜Ÿ)
- **é‡è¦ç¨‹åº¦**: â­â­â­â­â­ (5æ˜Ÿ)
- **å‰ç½®çŸ¥è¯†**: JavaåŸºç¡€ã€JVMã€å¤šçº¿ç¨‹ã€æ•°æ®åº“
- **æ–‡æ¡£æ¥æº**: ç»å…¸æ€§èƒ½ä¼˜åŒ–ä¹¦ç± + å®æˆ˜ç»éªŒ
- **æ›´æ–°æ—¶é—´**: 2024-01-04
- **ä½œè€…**: @author erik.zhou

## ğŸ¯ å­¦ä¹ ç›®æ ‡
- [ ] æŒæ¡JVMæ€§èƒ½è°ƒä¼˜æ–¹æ³•
- [ ] ç†è§£å¸¸è§æ€§èƒ½é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
- [ ] ç†Ÿç»ƒä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·
- [ ] æŒæ¡æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] ç†è§£ç¼“å­˜ç­–ç•¥å’Œåº”ç”¨
- [ ] èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿæ€§èƒ½è¯Šæ–­å’Œä¼˜åŒ–

## ğŸ”¥ JVMæ€§èƒ½ä¼˜åŒ–

### 1.1 JVMå‚æ•°é…ç½® ğŸ”¥

#### å †å†…å­˜é…ç½®
```bash
# åˆå§‹å †å¤§å°
-Xms2g

# æœ€å¤§å †å¤§å°
-Xmx2g

# æ–°ç”Ÿä»£å¤§å°
-Xmn1g

# å…ƒç©ºé—´å¤§å°ï¼ˆJDK 8+ï¼‰
-XX:MetaspaceSize=256m
-XX:MaxMetaspaceSize=512m

# çº¿ç¨‹æ ˆå¤§å°
-Xss256k
```

#### GCé…ç½®
```bash
# ä½¿ç”¨G1åƒåœ¾æ”¶é›†å™¨ï¼ˆæ¨èï¼‰
-XX:+UseG1GC

# G1æœ€å¤§åœé¡¿æ—¶é—´
-XX:MaxGCPauseMillis=200

# å¹¶è¡ŒGCçº¿ç¨‹æ•°
-XX:ParallelGCThreads=8

# æ‰“å°GCæ—¥å¿—
-XX:+PrintGCDetails
-XX:+PrintGCDateStamps
-Xloggc:/path/to/gc.log

# GCæ—¥å¿—æ–‡ä»¶æ»šåŠ¨
-XX:+UseGCLogFileRotation
-XX:NumberOfGCLogFiles=10
-XX:GCLogFileSize=100M
```

#### æ€§èƒ½ç›‘æ§å‚æ•°
```bash
# å¼€å¯JMXç›‘æ§
-Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=9999
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false

# æ‰“å°JVMé…ç½®
-XX:+PrintFlagsFinal
```

### 1.2 GCè°ƒä¼˜ï¼ˆâš ï¸ éš¾ç‚¹ï¼‰

#### GCç±»å‹é€‰æ‹©

| GCç±»å‹ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|--------|---------|------|------|
| Serial GC | å•æ ¸CPUã€å°å†…å­˜ | ç®€å• | åœé¡¿æ—¶é—´é•¿ |
| Parallel GC | å¤šæ ¸CPUã€ååé‡ä¼˜å…ˆ | é«˜ååé‡ | åœé¡¿æ—¶é—´è¾ƒé•¿ |
| CMS | ä½å»¶è¿Ÿè¦æ±‚ | åœé¡¿æ—¶é—´çŸ­ | ç¢ç‰‡åŒ– |
| G1 GC | å¤§å†…å­˜ã€å¯é¢„æµ‹åœé¡¿ | å¹³è¡¡ | å¤æ‚ |
| ZGC | è¶…å¤§å†…å­˜ã€æä½å»¶è¿Ÿ | åœé¡¿æ—¶é—´æçŸ­ | JDK 11+ |

#### G1 GCè°ƒä¼˜ç¤ºä¾‹
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
-Xms4g
-Xmx4g
-XX:+UseG1GC
-XX:MaxGCPauseMillis=200
-XX:G1HeapRegionSize=16m
-XX:InitiatingHeapOccupancyPercent=45
-XX:G1ReservePercent=10
-XX:+ParallelRefProcEnabled
```

### 1.3 å†…å­˜æ³„æ¼æ’æŸ¥

```java
/**
 * å†…å­˜æ³„æ¼ç¤ºä¾‹
 * @author erik.zhou
 */
public class MemoryLeakExample {
    // é”™è¯¯ï¼šé™æ€é›†åˆæŒæœ‰å¯¹è±¡å¼•ç”¨
    private static final List<Object> CACHE = new ArrayList<>();
    
    public void addToCache(Object obj) {
        CACHE.add(obj); // å¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶
    }
    
    // é”™è¯¯ï¼šThreadLocalæœªæ¸…ç†
    private static final ThreadLocal<byte[]> THREAD_LOCAL = new ThreadLocal<>();
    
    public void useThreadLocal() {
        THREAD_LOCAL.set(new byte[1024 * 1024]); // 1MB
        // æœªè°ƒç”¨remove()ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨åæ¸…ç†
    public void useThreadLocalCorrectly() {
        try {
            THREAD_LOCAL.set(new byte[1024 * 1024]);
            // ä½¿ç”¨ThreadLocal
        } finally {
            THREAD_LOCAL.remove(); // å¿…é¡»æ¸…ç†
        }
    }
}
```

## ğŸ”¥ ä»£ç å±‚é¢ä¼˜åŒ–

### 2.1 å­—ç¬¦ä¸²ä¼˜åŒ–

```java
/**
 * å­—ç¬¦ä¸²ä¼˜åŒ–
 * @author erik.zhou
 */
public class StringOptimization {
    // é”™è¯¯ï¼šå¾ªç¯ä¸­æ‹¼æ¥å­—ç¬¦ä¸²
    public String badConcat(List<String> list) {
        String result = "";
        for (String str : list) {
            result += str; // æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
        }
        return result;
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨StringBuilder
    public String goodConcat(List<String> list) {
        StringBuilder sb = new StringBuilder(list.size() * 16);
        for (String str : list) {
            sb.append(str);
        }
        return sb.toString();
    }
    
    // æ›´å¥½ï¼šä½¿ç”¨String.joinï¼ˆJDK 8+ï¼‰
    public String bestConcat(List<String> list) {
        return String.join("", list);
    }
}
```

### 2.2 é›†åˆä¼˜åŒ–

```java
import java.util.*;

/**
 * é›†åˆä¼˜åŒ–
 * @author erik.zhou
 */
public class CollectionOptimization {
    // é”™è¯¯ï¼šæœªæŒ‡å®šåˆå§‹å®¹é‡
    public List<String> badInit() {
        List<String> list = new ArrayList<>(); // é»˜è®¤å®¹é‡10
        for (int i = 0; i < 1000; i++) {
            list.add("item" + i); // å¤šæ¬¡æ‰©å®¹
        }
        return list;
    }
    
    // æ­£ç¡®ï¼šæŒ‡å®šåˆå§‹å®¹é‡
    public List<String> goodInit() {
        List<String> list = new ArrayList<>(1000);
        for (int i = 0; i < 1000; i++) {
            list.add("item" + i);
        }
        return list;
    }
    
    // é”™è¯¯ï¼šä½¿ç”¨é”™è¯¯çš„é›†åˆç±»å‹
    public void badRemove(List<String> list) {
        for (int i = 0; i < list.size(); i++) {
            if (list.get(i).startsWith("remove")) {
                list.remove(i); // ArrayListåˆ é™¤æ…¢
            }
        }
    }
    
    // æ­£ç¡®ï¼šä½¿ç”¨Iteratoræˆ–removeIf
    public void goodRemove(List<String> list) {
        list.removeIf(s -> s.startsWith("remove"));
    }
}
```

### 2.3 å¯¹è±¡åˆ›å»ºä¼˜åŒ–

```java
/**
 * å¯¹è±¡åˆ›å»ºä¼˜åŒ–
 * @author erik.zhou
 */
public class ObjectCreationOptimization {
    // é”™è¯¯ï¼šå¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡
    public void badCreate() {
        for (int i = 0; i < 10000; i++) {
            String str = new String("test"); // æ¯æ¬¡åˆ›å»ºæ–°å¯¹è±¡
        }
    }
    
    // æ­£ç¡®ï¼šå¤ç”¨å¯¹è±¡
    public void goodCreate() {
        String str = "test"; // å­—ç¬¦ä¸²å¸¸é‡æ± 
        for (int i = 0; i < 10000; i++) {
            // ä½¿ç”¨str
        }
    }
    
    // ä½¿ç”¨å¯¹è±¡æ± 
    private static final List<byte[]> BUFFER_POOL = new ArrayList<>();
    
    public byte[] getBuffer() {
        if (BUFFER_POOL.isEmpty()) {
            return new byte[1024];
        }
        return BUFFER_POOL.remove(BUFFER_POOL.size() - 1);
    }
    
    public void returnBuffer(byte[] buffer) {
        BUFFER_POOL.add(buffer);
    }
}
```

### 2.4 å¼‚å¸¸å¤„ç†ä¼˜åŒ–

```java
/**
 * å¼‚å¸¸å¤„ç†ä¼˜åŒ–
 * @author erik.zhou
 */
public class ExceptionOptimization {
    // é”™è¯¯ï¼šä½¿ç”¨å¼‚å¸¸æ§åˆ¶æµç¨‹
    public int badParse(String str) {
        try {
            return Integer.parseInt(str);
        } catch (NumberFormatException e) {
            return 0; // å¼‚å¸¸å¼€é”€å¤§
        }
    }
    
    // æ­£ç¡®ï¼šå…ˆåˆ¤æ–­å†è§£æ
    public int goodParse(String str) {
        if (str == null || str.isEmpty()) {
            return 0;
        }
        try {
            return Integer.parseInt(str);
        } catch (NumberFormatException e) {
            return 0;
        }
    }
    
    // é”™è¯¯ï¼šç©ºcatchå—
    public void badCatch() {
        try {
            // ä¸šåŠ¡é€»è¾‘
        } catch (Exception e) {
            // åæ‰å¼‚å¸¸
        }
    }
    
    // æ­£ç¡®ï¼šè®°å½•æ—¥å¿—
    public void goodCatch() {
        try {
            // ä¸šåŠ¡é€»è¾‘
        } catch (Exception e) {
            // è®°å½•æ—¥å¿—
            System.err.println("é”™è¯¯ï¼š" + e.getMessage());
        }
    }
}
```

## ğŸ”¥ æ•°æ®åº“ä¼˜åŒ–

### 3.1 SQLä¼˜åŒ– ğŸ”¥

```sql
-- é”™è¯¯ï¼šSELECT *
SELECT * FROM user WHERE id = 1;

-- æ­£ç¡®ï¼šæŒ‡å®šå­—æ®µ
SELECT id, name, email FROM user WHERE id = 1;

-- é”™è¯¯ï¼šæœªä½¿ç”¨ç´¢å¼•
SELECT * FROM order_info WHERE DATE(create_time) = '2024-01-01';

-- æ­£ç¡®ï¼šä½¿ç”¨ç´¢å¼•
SELECT * FROM order_info 
WHERE create_time BETWEEN '2024-01-01 00:00:00' AND '2024-01-01 23:59:59';

-- é”™è¯¯ï¼šORæ¡ä»¶
SELECT * FROM user WHERE name = 'zhangsan' OR age = 25;

-- æ­£ç¡®ï¼šä½¿ç”¨UNION
SELECT * FROM user WHERE name = 'zhangsan'
UNION
SELECT * FROM user WHERE age = 25;

-- é”™è¯¯ï¼šINå­æŸ¥è¯¢
SELECT * FROM order_info WHERE user_id IN (SELECT id FROM user WHERE status = 1);

-- æ­£ç¡®ï¼šä½¿ç”¨JOIN
SELECT o.* FROM order_info o
INNER JOIN user u ON o.user_id = u.id
WHERE u.status = 1;
```

### 3.2 ç´¢å¼•ä¼˜åŒ–ï¼ˆâš ï¸ éš¾ç‚¹ï¼‰

```sql
-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_user_name ON user(name);

-- ç»„åˆç´¢å¼•ï¼ˆéµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ï¼‰
CREATE INDEX idx_user_name_age ON user(name, age);

-- å¯ä»¥ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT * FROM user WHERE name = 'zhangsan'; -- ä½¿ç”¨ç´¢å¼•
SELECT * FROM user WHERE name = 'zhangsan' AND age = 25; -- ä½¿ç”¨ç´¢å¼•

-- ä¸èƒ½ä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢
SELECT * FROM user WHERE age = 25; -- ä¸ä½¿ç”¨ç´¢å¼•ï¼ˆä¸æ»¡è¶³æœ€å·¦å‰ç¼€ï¼‰

-- è¦†ç›–ç´¢å¼•
CREATE INDEX idx_user_name_email ON user(name, email);
SELECT name, email FROM user WHERE name = 'zhangsan'; -- è¦†ç›–ç´¢å¼•ï¼Œä¸å›è¡¨
```

### 3.3 åˆ†é¡µä¼˜åŒ–

```sql
-- é”™è¯¯ï¼šæ·±åˆ†é¡µ
SELECT * FROM order_info ORDER BY id LIMIT 1000000, 20;

-- æ­£ç¡®ï¼šä½¿ç”¨å­æŸ¥è¯¢
SELECT * FROM order_info 
WHERE id >= (SELECT id FROM order_info ORDER BY id LIMIT 1000000, 1)
ORDER BY id LIMIT 20;

-- æ›´å¥½ï¼šä½¿ç”¨æ¸¸æ ‡
SELECT * FROM order_info WHERE id > 1000000 ORDER BY id LIMIT 20;
```

### 3.4 æ‰¹é‡æ“ä½œä¼˜åŒ–

```java
import java.sql.*;
import java.util.List;

/**
 * æ‰¹é‡æ“ä½œä¼˜åŒ–
 * @author erik.zhou
 */
public class BatchOptimization {
    // é”™è¯¯ï¼šé€æ¡æ’å…¥
    public void badInsert(Connection conn, List<User> users) throws SQLException {
        String sql = "INSERT INTO user(name, email) VALUES(?, ?)";
        PreparedStatement ps = conn.prepareStatement(sql);
        
        for (User user : users) {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
            ps.executeUpdate(); // æ¯æ¬¡éƒ½æ‰§è¡Œ
        }
    }
    
    // æ­£ç¡®ï¼šæ‰¹é‡æ’å…¥
    public void goodInsert(Connection conn, List<User> users) throws SQLException {
        String sql = "INSERT INTO user(name, email) VALUES(?, ?)";
        PreparedStatement ps = conn.prepareStatement(sql);
        
        for (User user : users) {
            ps.setString(1, user.getName());
            ps.setString(2, user.getEmail());
            ps.addBatch(); // æ·»åŠ åˆ°æ‰¹æ¬¡
        }
        ps.executeBatch(); // æ‰¹é‡æ‰§è¡Œ
    }
}
```

## ğŸ”¥ å¹¶å‘ä¼˜åŒ–

### 4.1 çº¿ç¨‹æ± ä¼˜åŒ–

```java
import java.util.concurrent.*;

/**
 * çº¿ç¨‹æ± ä¼˜åŒ–
 * @author erik.zhou
 */
public class ThreadPoolOptimization {
    // é”™è¯¯ï¼šä½¿ç”¨Executorsåˆ›å»ºçº¿ç¨‹æ± 
    public void badThreadPool() {
        ExecutorService executor = Executors.newFixedThreadPool(10);
        // é—®é¢˜ï¼šæ— æ³•æ§åˆ¶é˜Ÿåˆ—å¤§å°ï¼Œå¯èƒ½OOM
    }
    
    // æ­£ç¡®ï¼šæ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± 
    public void goodThreadPool() {
        int corePoolSize = Runtime.getRuntime().availableProcessors();
        int maxPoolSize = corePoolSize * 2;
        long keepAliveTime = 60L;
        
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
            corePoolSize,
            maxPoolSize,
            keepAliveTime,
            TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000), // é™åˆ¶é˜Ÿåˆ—å¤§å°
            new ThreadPoolExecutor.CallerRunsPolicy() // æ‹’ç»ç­–ç•¥
        );
    }
    
    // CPUå¯†é›†å‹ä»»åŠ¡
    public ThreadPoolExecutor cpuIntensivePool() {
        int threadCount = Runtime.getRuntime().availableProcessors() + 1;
        return new ThreadPoolExecutor(
            threadCount,
            threadCount,
            0L,
            TimeUnit.MILLISECONDS,
            new LinkedBlockingQueue<>(100)
        );
    }
    
    // IOå¯†é›†å‹ä»»åŠ¡
    public ThreadPoolExecutor ioIntensivePool() {
        int threadCount = Runtime.getRuntime().availableProcessors() * 2;
        return new ThreadPoolExecutor(
            threadCount,
            threadCount,
            60L,
            TimeUnit.SECONDS,
            new LinkedBlockingQueue<>(1000)
        );
    }
}
```

### 4.2 é”ä¼˜åŒ–

```java
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

/**
 * é”ä¼˜åŒ–
 * @author erik.zhou
 */
public class LockOptimization {
    private final Lock lock = new ReentrantLock();
    private int count = 0;
    
    // é”™è¯¯ï¼šé”ç²’åº¦è¿‡å¤§
    public synchronized void badMethod() {
        // å¤§é‡éä¸´ç•ŒåŒºä»£ç 
        System.out.println("éä¸´ç•ŒåŒº1");
        
        // ä¸´ç•ŒåŒºä»£ç 
        count++;
        
        // å¤§é‡éä¸´ç•ŒåŒºä»£ç 
        System.out.println("éä¸´ç•ŒåŒº2");
    }
    
    // æ­£ç¡®ï¼šç¼©å°é”èŒƒå›´
    public void goodMethod() {
        // éä¸´ç•ŒåŒºä»£ç 
        System.out.println("éä¸´ç•ŒåŒº1");
        
        // ä¸´ç•ŒåŒºä»£ç 
        synchronized (this) {
            count++;
        }
        
        // éä¸´ç•ŒåŒºä»£ç 
        System.out.println("éä¸´ç•ŒåŒº2");
    }
    
    // ä½¿ç”¨è¯»å†™é”
    private final java.util.concurrent.locks.ReadWriteLock rwLock = 
        new java.util.concurrent.locks.ReentrantReadWriteLock();
    private String data = "";
    
    public String read() {
        rwLock.readLock().lock();
        try {
            return data;
        } finally {
            rwLock.readLock().unlock();
        }
    }
    
    public void write(String newData) {
        rwLock.writeLock().lock();
        try {
            this.data = newData;
        } finally {
            rwLock.writeLock().unlock();
        }
    }
}
```

## ğŸ”¥ ç¼“å­˜ä¼˜åŒ–

### 5.1 æœ¬åœ°ç¼“å­˜

```java
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.TimeUnit;

/**
 * æœ¬åœ°ç¼“å­˜å®ç°
 * @author erik.zhou
 */
public class LocalCache<K, V> {
    private final ConcurrentHashMap<K, CacheEntry<V>> cache = new ConcurrentHashMap<>();
    private final long expireMillis;
    
    public LocalCache(long expireTime, TimeUnit unit) {
        this.expireMillis = unit.toMillis(expireTime);
    }
    
    public void put(K key, V value) {
        long expireTime = System.currentTimeMillis() + expireMillis;
        cache.put(key, new CacheEntry<>(value, expireTime));
    }
    
    public V get(K key) {
        CacheEntry<V> entry = cache.get(key);
        if (entry == null) {
            return null;
        }
        if (entry.isExpired()) {
            cache.remove(key);
            return null;
        }
        return entry.value;
    }
    
    private static class CacheEntry<V> {
        private final V value;
        private final long expireTime;
        
        public CacheEntry(V value, long expireTime) {
            this.value = value;
            this.expireTime = expireTime;
        }
        
        public boolean isExpired() {
            return System.currentTimeMillis() > expireTime;
        }
    }
}
```

### 5.2 ç¼“å­˜ç­–ç•¥

```java
/**
 * ç¼“å­˜ç­–ç•¥
 * @author erik.zhou
 */
public class CacheStrategy {
    // ç¼“å­˜ç©¿é€ï¼šæŸ¥è¯¢ä¸å­˜åœ¨çš„æ•°æ®
    // è§£å†³æ–¹æ¡ˆï¼šç¼“å­˜ç©ºå€¼æˆ–ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨
    public String getWithBloomFilter(String key) {
        // 1. å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
        if (!bloomFilter.mightContain(key)) {
            return null;
        }
        
        // 2. æŸ¥è¯¢ç¼“å­˜
        String value = cache.get(key);
        if (value != null) {
            return value;
        }
        
        // 3. æŸ¥è¯¢æ•°æ®åº“
        value = database.query(key);
        if (value != null) {
            cache.put(key, value);
        }
        return value;
    }
    
    // ç¼“å­˜å‡»ç©¿ï¼šçƒ­ç‚¹æ•°æ®è¿‡æœŸ
    // è§£å†³æ–¹æ¡ˆï¼šäº’æ–¥é”æˆ–æ°¸ä¸è¿‡æœŸ
    private final Lock lock = new ReentrantLock();
    
    public String getWithLock(String key) {
        // 1. æŸ¥è¯¢ç¼“å­˜
        String value = cache.get(key);
        if (value != null) {
            return value;
        }
        
        // 2. åŠ é”æŸ¥è¯¢æ•°æ®åº“
        lock.lock();
        try {
            // åŒé‡æ£€æŸ¥
            value = cache.get(key);
            if (value != null) {
                return value;
            }
            
            value = database.query(key);
            if (value != null) {
                cache.put(key, value);
            }
            return value;
        } finally {
            lock.unlock();
        }
    }
    
    // ç¼“å­˜é›ªå´©ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ
    // è§£å†³æ–¹æ¡ˆï¼šéšæœºè¿‡æœŸæ—¶é—´
    public void putWithRandomExpire(String key, String value) {
        int baseExpire = 3600; // 1å°æ—¶
        int randomExpire = (int) (Math.random() * 300); // 0-5åˆ†é’Ÿ
        cache.put(key, value, baseExpire + randomExpire);
    }
}
```

## ğŸ”¥ æ€§èƒ½åˆ†æå·¥å…·

### 6.1 JDKè‡ªå¸¦å·¥å…·

```bash
# jpsï¼šæŸ¥çœ‹Javaè¿›ç¨‹
jps -l

# jstatï¼šæŸ¥çœ‹GCç»Ÿè®¡
jstat -gc <pid> 1000 10  # æ¯ç§’è¾“å‡ºä¸€æ¬¡ï¼Œå…±10æ¬¡

# jmapï¼šæŸ¥çœ‹å †å†…å­˜
jmap -heap <pid>
jmap -dump:format=b,file=heap.bin <pid>

# jstackï¼šæŸ¥çœ‹çº¿ç¨‹æ ˆ
jstack <pid> > thread.txt

# jinfoï¼šæŸ¥çœ‹JVMå‚æ•°
jinfo -flags <pid>
```

### 6.2 å¯è§†åŒ–å·¥å…·

- **JConsole**: JDKè‡ªå¸¦ï¼Œç›‘æ§å†…å­˜ã€çº¿ç¨‹ã€ç±»åŠ è½½
- **VisualVM**: åŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒæ’ä»¶
- **JProfiler**: å•†ä¸šå·¥å…·ï¼ŒåŠŸèƒ½å…¨é¢
- **Arthas**: é˜¿é‡Œå¼€æºï¼Œåœ¨çº¿è¯Šæ–­å·¥å…·

### 6.3 Arthasä½¿ç”¨ç¤ºä¾‹

```bash
# å¯åŠ¨Arthas
java -jar arthas-boot.jar

# æŸ¥çœ‹æœ€ç¹å¿™çš„çº¿ç¨‹
thread -n 3

# æŸ¥çœ‹æ–¹æ³•è°ƒç”¨è€—æ—¶
trace com.example.UserService getUser

# æŸ¥çœ‹æ–¹æ³•å‚æ•°å’Œè¿”å›å€¼
watch com.example.UserService getUser "{params,returnObj}"

# åç¼–è¯‘ç±»
jad com.example.UserService

# æŸ¥çœ‹JVMå‚æ•°
sysprop
```

## ğŸ’» å®æˆ˜æ¡ˆä¾‹

### 7.1 æ¥å£å“åº”æ…¢ä¼˜åŒ–

```java
/**
 * æ¥å£ä¼˜åŒ–æ¡ˆä¾‹
 * @author erik.zhou
 */
public class APIOptimization {
    // é—®é¢˜ï¼šä¸²è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡
    public UserInfo badGetUserInfo(Long userId) {
        User user = userService.getUser(userId);           // 100ms
        List<Order> orders = orderService.getOrders(userId); // 200ms
        Address address = addressService.getAddress(userId); // 150ms
        // æ€»è€—æ—¶ï¼š450ms
        
        return new UserInfo(user, orders, address);
    }
    
    // ä¼˜åŒ–ï¼šå¹¶è¡Œè°ƒç”¨
    public UserInfo goodGetUserInfo(Long userId) throws Exception {
        ExecutorService executor = Executors.newFixedThreadPool(3);
        
        Future<User> userFuture = executor.submit(() -> 
            userService.getUser(userId));
        Future<List<Order>> ordersFuture = executor.submit(() -> 
            orderService.getOrders(userId));
        Future<Address> addressFuture = executor.submit(() -> 
            addressService.getAddress(userId));
        
        User user = userFuture.get();
        List<Order> orders = ordersFuture.get();
        Address address = addressFuture.get();
        // æ€»è€—æ—¶ï¼š200msï¼ˆæœ€æ…¢çš„é‚£ä¸ªï¼‰
        
        executor.shutdown();
        return new UserInfo(user, orders, address);
    }
}
```

## âœ¨ æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–åŸåˆ™

1. **å…ˆæµ‹é‡å†ä¼˜åŒ–**: ä½¿ç”¨å·¥å…·å®šä½ç“¶é¢ˆ
2. **ä¼˜å…ˆä¼˜åŒ–çƒ­ç‚¹**: 80%çš„æ—¶é—´èŠ±åœ¨20%çš„ä»£ç ä¸Š
3. **æƒè¡¡å–èˆ**: æ€§èƒ½vså¯è¯»æ€§vsç»´æŠ¤æ€§
4. **é¿å…è¿‡æ—©ä¼˜åŒ–**: å…ˆä¿è¯æ­£ç¡®æ€§

### 2. æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] JVMå‚æ•°æ˜¯å¦åˆç†
- [ ] æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼
- [ ] æ•°æ®åº“æŸ¥è¯¢æ˜¯å¦ä¼˜åŒ–
- [ ] æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„ç¼“å­˜
- [ ] çº¿ç¨‹æ± é…ç½®æ˜¯å¦åˆç†
- [ ] æ˜¯å¦å­˜åœ¨ä¸å¿…è¦çš„å¯¹è±¡åˆ›å»º
- [ ] é›†åˆåˆå§‹å®¹é‡æ˜¯å¦æŒ‡å®š
- [ ] æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„æ•°æ®ç»“æ„

## â“ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å®šä½æ€§èƒ½ç“¶é¢ˆï¼Ÿ
A: ä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·ï¼ˆJProfilerã€Arthasï¼‰ï¼ŒæŸ¥çœ‹CPUã€å†…å­˜ã€IOä½¿ç”¨æƒ…å†µï¼Œå®šä½çƒ­ç‚¹ä»£ç ã€‚

### Q2: å†…å­˜æº¢å‡ºå¦‚ä½•æ’æŸ¥ï¼Ÿ
A: ä½¿ç”¨jmapå¯¼å‡ºå †dumpï¼Œç”¨MATåˆ†æï¼ŒæŸ¥æ‰¾å ç”¨å†…å­˜æœ€å¤šçš„å¯¹è±¡ã€‚

### Q3: å¦‚ä½•é€‰æ‹©åˆé€‚çš„GCï¼Ÿ
A: å°å†…å­˜ç”¨Serial GCï¼Œå¤§å†…å­˜ç”¨G1 GCï¼Œè¶…å¤§å†…å­˜ç”¨ZGCï¼Œä½å»¶è¿Ÿç”¨CMSæˆ–ZGCã€‚

### Q4: æ•°æ®åº“æ…¢æŸ¥è¯¢å¦‚ä½•ä¼˜åŒ–ï¼Ÿ
A: æ·»åŠ ç´¢å¼•ã€ä¼˜åŒ–SQLã€åˆ†åº“åˆ†è¡¨ã€ä½¿ç”¨ç¼“å­˜ã€‚

### Q5: å¦‚ä½•æé«˜å¹¶å‘æ€§èƒ½ï¼Ÿ
A: ä½¿ç”¨çº¿ç¨‹æ± ã€å‡å°‘é”ç«äº‰ã€ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ã€å¼‚æ­¥å¤„ç†ã€‚

## ğŸ”— ç›¸å…³èµ„æº

- [ã€ŠJavaæ€§èƒ½æƒå¨æŒ‡å—ã€‹](https://book.douban.com/subject/26740520/)
- [ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºã€‹](https://book.douban.com/subject/34907497/)
- [ã€Šé«˜æ€§èƒ½MySQLã€‹](https://book.douban.com/subject/23008813/)
- [Arthaså®˜æ–¹æ–‡æ¡£](https://arthas.aliyun.com/doc/)

## ğŸ“ å­¦ä¹ æ£€æŸ¥æ¸…å•

- [ ] æŒæ¡JVMå‚æ•°é…ç½®
- [ ] ç†è§£GCåŸç†å’Œè°ƒä¼˜
- [ ] èƒ½å¤Ÿæ’æŸ¥å†…å­˜æ³„æ¼
- [ ] æŒæ¡ä»£ç å±‚é¢ä¼˜åŒ–æŠ€å·§
- [ ] ç†Ÿç»ƒè¿›è¡ŒSQLä¼˜åŒ–
- [ ] ç†è§£ç¼“å­˜ç­–ç•¥
- [ ] ç†Ÿç»ƒä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·
- [ ] èƒ½å¤Ÿè¿›è¡Œç³»ç»Ÿæ€§èƒ½è¯Šæ–­

---

**å­¦ä¹ å»ºè®®**ï¼š
1. å…ˆç†è§£åŸç†ï¼Œå†å­¦ä¹ å·¥å…·
2. å¤šä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·å®è·µ
3. å…³æ³¨ç”Ÿäº§ç¯å¢ƒæ€§èƒ½æŒ‡æ ‡
4. å­¦ä¹ ä¼˜ç§€å¼€æºé¡¹ç›®çš„ä¼˜åŒ–æŠ€å·§
5. å»ºç«‹æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†åº“

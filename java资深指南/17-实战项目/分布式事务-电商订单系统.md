# åˆ†å¸ƒå¼äº‹åŠ¡ - ç”µå•†è®¢å•ç³»ç»Ÿå®æˆ˜

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### ä¸šåŠ¡åœºæ™¯
ç”µå•†ä¸‹å•åœºæ™¯ï¼Œæ¶‰åŠå¤šä¸ªå¾®æœåŠ¡ï¼š
- **è®¢å•æœåŠ¡**: åˆ›å»ºè®¢å•
- **åº“å­˜æœåŠ¡**: æ‰£å‡åº“å­˜
- **è´¦æˆ·æœåŠ¡**: æ‰£å‡ä½™é¢
- **ç§¯åˆ†æœåŠ¡**: å¢åŠ ç§¯åˆ†

**æ ¸å¿ƒéš¾ç‚¹**: å¦‚ä½•ä¿è¯è¿™4ä¸ªæ“ä½œçš„æ•°æ®ä¸€è‡´æ€§ï¼Ÿ

### æŠ€æœ¯æŒ‘æˆ˜ âš ï¸

#### éš¾ç‚¹1: åˆ†å¸ƒå¼äº‹åŠ¡ä¸€è‡´æ€§
**é—®é¢˜æè¿°**:
- è®¢å•åˆ›å»ºæˆåŠŸï¼Œä½†åº“å­˜æ‰£å‡å¤±è´¥
- åº“å­˜æ‰£å‡æˆåŠŸï¼Œä½†ä½™é¢æ‰£å‡å¤±è´¥
- éƒ¨åˆ†æœåŠ¡æˆåŠŸï¼Œéƒ¨åˆ†æœåŠ¡å¤±è´¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**ä¸šåŠ¡å½±å“**:
- ç”¨æˆ·æ‰£æ¬¾ä½†æ²¡æœ‰å•†å“
- åº“å­˜æ‰£å‡ä½†è®¢å•æœªåˆ›å»º
- æ•°æ®ä¸ä¸€è‡´å¯¼è‡´è´¢åŠ¡å¯¹è´¦å›°éš¾

#### éš¾ç‚¹2: æ€§èƒ½ä¸ä¸€è‡´æ€§çš„å¹³è¡¡
**é—®é¢˜æè¿°**:
- å¼ºä¸€è‡´æ€§æ–¹æ¡ˆï¼ˆ2PC/3PCï¼‰æ€§èƒ½å·®ï¼ŒRTé«˜
- æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆå¤æ‚åº¦é«˜ï¼Œéœ€è¦è¡¥å¿æœºåˆ¶
- é«˜å¹¶å‘åœºæ™¯ä¸‹å¦‚ä½•ä¿è¯æ€§èƒ½

#### éš¾ç‚¹3: å¼‚å¸¸åœºæ™¯å¤„ç†
**é—®é¢˜æè¿°**:
- ç½‘ç»œè¶…æ—¶å¦‚ä½•å¤„ç†
- æœåŠ¡å®•æœºå¦‚ä½•æ¢å¤
- æ¶ˆæ¯ä¸¢å¤±å¦‚ä½•è¡¥å¿

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„
```
ç”¨æˆ· â†’ APIç½‘å…³ â†’ è®¢å•æœåŠ¡ â†’ Seata TC
                    â†“
              [åº“å­˜æœåŠ¡ã€è´¦æˆ·æœåŠ¡ã€ç§¯åˆ†æœåŠ¡]
                    â†“
                 MySQLé›†ç¾¤
```

### æŠ€æœ¯é€‰å‹
- **åˆ†å¸ƒå¼äº‹åŠ¡**: Seata ATæ¨¡å¼
- **æ¶ˆæ¯é˜Ÿåˆ—**: RocketMQäº‹åŠ¡æ¶ˆæ¯
- **æ•°æ®åº“**: MySQL 8.0
- **ç¼“å­˜**: Redis
- **æ¡†æ¶**: Spring Cloud Alibaba

## ğŸ”¥ æ ¸å¿ƒå®ç°

### æ–¹æ¡ˆä¸€: Seata ATæ¨¡å¼ï¼ˆæ¨èï¼‰

#### 1.1 Seataé…ç½®

```yaml
# application.yml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_test_tx_group
  service:
    vgroup-mapping:
      my_test_tx_group: default
    grouplist:
      default: 127.0.0.1:8091
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: seata
      group: SEATA_GROUP
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: seata
      group: SEATA_GROUP
```

#### 1.2 è®¢å•æœåŠ¡å®ç°

```java
/**
 * è®¢å•æœåŠ¡ - Seataåˆ†å¸ƒå¼äº‹åŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class OrderServiceImpl implements OrderService {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private StorageServiceClient storageClient;
    
    @Autowired
    private AccountServiceClient accountClient;
    
    @Autowired
    private PointServiceClient pointClient;
    
    /**
     * åˆ›å»ºè®¢å• - åˆ†å¸ƒå¼äº‹åŠ¡
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. ä½¿ç”¨@GlobalTransactionalå¼€å¯å…¨å±€äº‹åŠ¡
     * 2. Seataè‡ªåŠ¨ç®¡ç†åˆ†æ”¯äº‹åŠ¡çš„æäº¤å’Œå›æ»š
     * 3. æ— éœ€æ‰‹åŠ¨ç¼–å†™è¡¥å¿é€»è¾‘
     */
    @Override
    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public Order createOrder(OrderDTO orderDTO) {
        log.info("å¼€å§‹åˆ›å»ºè®¢å•: {}", orderDTO);
        
        try {
            // 1. åˆ›å»ºè®¢å•ï¼ˆæœ¬åœ°äº‹åŠ¡ï¼‰
            Order order = buildOrder(orderDTO);
            orderMapper.insert(order);
            log.info("è®¢å•åˆ›å»ºæˆåŠŸ: orderId={}", order.getId());
            
            // 2. æ‰£å‡åº“å­˜ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
            boolean stockResult = storageClient.deduct(
                orderDTO.getProductId(),
                orderDTO.getCount()
            );
            if (!stockResult) {
                throw new BusinessException("åº“å­˜ä¸è¶³");
            }
            log.info("åº“å­˜æ‰£å‡æˆåŠŸ");
            
            // 3. æ‰£å‡è´¦æˆ·ä½™é¢ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
            boolean accountResult = accountClient.deduct(
                orderDTO.getUserId(),
                order.getTotalAmount()
            );
            if (!accountResult) {
                throw new BusinessException("ä½™é¢ä¸è¶³");
            }
            log.info("ä½™é¢æ‰£å‡æˆåŠŸ");
            
            // 4. å¢åŠ ç§¯åˆ†ï¼ˆè¿œç¨‹è°ƒç”¨ï¼‰
            boolean pointResult = pointClient.add(
                orderDTO.getUserId(),
                calculatePoints(order.getTotalAmount())
            );
            if (!pointResult) {
                throw new BusinessException("ç§¯åˆ†å¢åŠ å¤±è´¥");
            }
            log.info("ç§¯åˆ†å¢åŠ æˆåŠŸ");
            
            // 5. æ›´æ–°è®¢å•çŠ¶æ€
            order.setStatus(OrderStatus.SUCCESS);
            orderMapper.updateById(order);
            
            log.info("è®¢å•åˆ›å»ºå®Œæˆ: orderId={}", order.getId());
            return order;
            
        } catch (Exception e) {
            log.error("è®¢å•åˆ›å»ºå¤±è´¥ï¼Œäº‹åŠ¡å›æ»š: {}", orderDTO, e);
            throw e;
        }
    }
    
    private Order buildOrder(OrderDTO orderDTO) {
        Order order = new Order();
        order.setUserId(orderDTO.getUserId());
        order.setProductId(orderDTO.getProductId());
        order.setCount(orderDTO.getCount());
        order.setTotalAmount(orderDTO.getTotalAmount());
        order.setStatus(OrderStatus.PENDING);
        order.setCreateTime(new Date());
        return order;
    }
    
    private Integer calculatePoints(BigDecimal amount) {
        // æ¯æ¶ˆè´¹1å…ƒè·å¾—1ç§¯åˆ†
        return amount.intValue();
    }
}
```

#### 1.3 åº“å­˜æœåŠ¡å®ç°

```java
/**
 * åº“å­˜æœåŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class StorageServiceImpl implements StorageService {
    
    @Autowired
    private StorageMapper storageMapper;
    
    /**
     * æ‰£å‡åº“å­˜
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. ä½¿ç”¨æ•°æ®åº“è¡Œé”é˜²æ­¢è¶…å–
     * 2. Seataä¼šè‡ªåŠ¨è®°å½•undo_logç”¨äºå›æ»š
     * 3. æ— éœ€æ‰‹åŠ¨å®ç°è¡¥å¿é€»è¾‘
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deduct(Long productId, Integer count) {
        log.info("å¼€å§‹æ‰£å‡åº“å­˜: productId={}, count={}", productId, count);
        
        // æŸ¥è¯¢åº“å­˜ï¼ˆåŠ è¡Œé”ï¼‰
        Storage storage = storageMapper.selectByIdForUpdate(productId);
        
        if (storage == null) {
            throw new BusinessException("å•†å“ä¸å­˜åœ¨");
        }
        
        if (storage.getStock() < count) {
            throw new BusinessException("åº“å­˜ä¸è¶³");
        }
        
        // æ‰£å‡åº“å­˜
        storage.setStock(storage.getStock() - count);
        storage.setUsed(storage.getUsed() + count);
        storage.setUpdateTime(new Date());
        
        int updated = storageMapper.updateById(storage);
        
        if (updated > 0) {
            log.info("åº“å­˜æ‰£å‡æˆåŠŸ: productId={}, å‰©ä½™åº“å­˜={}", 
                productId, storage.getStock());
            return true;
        }
        
        throw new BusinessException("åº“å­˜æ‰£å‡å¤±è´¥");
    }
}

/**
 * åº“å­˜Mapper
 * @author erik.zhou
 */
@Mapper
public interface StorageMapper extends BaseMapper<Storage> {
    
    /**
     * æŸ¥è¯¢åº“å­˜å¹¶åŠ è¡Œé”
     */
    @Select("SELECT * FROM storage WHERE product_id = #{productId} FOR UPDATE")
    Storage selectByIdForUpdate(@Param("productId") Long productId);
}
```

#### 1.4 è´¦æˆ·æœåŠ¡å®ç°

```java
/**
 * è´¦æˆ·æœåŠ¡
 * @author erik.zhou
 */
@Service
@Slf4j
public class AccountServiceImpl implements AccountService {
    
    @Autowired
    private AccountMapper accountMapper;
    
    /**
     * æ‰£å‡ä½™é¢
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. ä½¿ç”¨ä¹è§‚é”é˜²æ­¢å¹¶å‘é—®é¢˜
     * 2. è®°å½•è´¦æˆ·æµæ°´ä¾¿äºå¯¹è´¦
     * 3. Seataè‡ªåŠ¨ç®¡ç†äº‹åŠ¡å›æ»š
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public boolean deduct(Long userId, BigDecimal amount) {
        log.info("å¼€å§‹æ‰£å‡ä½™é¢: userId={}, amount={}", userId, amount);
        
        // æŸ¥è¯¢è´¦æˆ·
        Account account = accountMapper.selectById(userId);
        
        if (account == null) {
            throw new BusinessException("è´¦æˆ·ä¸å­˜åœ¨");
        }
        
        if (account.getBalance().compareTo(amount) < 0) {
            throw new BusinessException("ä½™é¢ä¸è¶³");
        }
        
        // æ‰£å‡ä½™é¢ï¼ˆä½¿ç”¨ä¹è§‚é”ï¼‰
        account.setBalance(account.getBalance().subtract(amount));
        account.setUsed(account.getUsed().add(amount));
        account.setVersion(account.getVersion() + 1);
        account.setUpdateTime(new Date());
        
        int updated = accountMapper.updateByIdWithVersion(account);
        
        if (updated == 0) {
            throw new BusinessException("ä½™é¢æ‰£å‡å¤±è´¥ï¼Œè¯·é‡è¯•");
        }
        
        // è®°å½•è´¦æˆ·æµæ°´
        saveAccountLog(userId, amount, "è®¢å•æ‰£æ¬¾");
        
        log.info("ä½™é¢æ‰£å‡æˆåŠŸ: userId={}, å‰©ä½™ä½™é¢={}", 
            userId, account.getBalance());
        
        return true;
    }
    
    private void saveAccountLog(Long userId, BigDecimal amount, String remark) {
        AccountLog log = new AccountLog();
        log.setUserId(userId);
        log.setAmount(amount);
        log.setType(LogType.DEDUCT);
        log.setRemark(remark);
        log.setCreateTime(new Date());
        accountLogMapper.insert(log);
    }
}
```

### æ–¹æ¡ˆäºŒ: RocketMQäº‹åŠ¡æ¶ˆæ¯ï¼ˆé«˜æ€§èƒ½åœºæ™¯ï¼‰

#### 2.1 ä¸ºä»€ä¹ˆé€‰æ‹©äº‹åŠ¡æ¶ˆæ¯ï¼Ÿ

**Seataçš„å±€é™æ€§**:
- RTè¾ƒé«˜ï¼ˆéœ€è¦ç­‰å¾…æ‰€æœ‰åˆ†æ”¯äº‹åŠ¡å®Œæˆï¼‰
- å¯¹æ•°æ®åº“æœ‰ä¾µå…¥ï¼ˆéœ€è¦undo_logè¡¨ï¼‰
- ä¸é€‚åˆè¶…é«˜å¹¶å‘åœºæ™¯

**äº‹åŠ¡æ¶ˆæ¯çš„ä¼˜åŠ¿**:
- æ€§èƒ½é«˜ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
- æœ€ç»ˆä¸€è‡´æ€§
- é€‚åˆé«˜å¹¶å‘åœºæ™¯

#### 2.2 äº‹åŠ¡æ¶ˆæ¯å®ç°

```java
/**
 * è®¢å•æœåŠ¡ - RocketMQäº‹åŠ¡æ¶ˆæ¯
 * @author erik.zhou
 */
@Service
@Slf4j
public class OrderServiceWithMQ implements OrderService {
    
    @Autowired
    private RocketMQTemplate rocketMQTemplate;
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * åˆ›å»ºè®¢å• - äº‹åŠ¡æ¶ˆæ¯
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. ä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯ä¿è¯è®¢å•åˆ›å»ºå’Œæ¶ˆæ¯å‘é€çš„ä¸€è‡´æ€§
     * 2. é€šè¿‡æ¶ˆæ¯é©±åŠ¨å…¶ä»–æœåŠ¡å¼‚æ­¥å¤„ç†
     * 3. å®ç°äº‹åŠ¡å›æŸ¥æœºåˆ¶é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
     */
    @Override
    public Order createOrder(OrderDTO orderDTO) {
        log.info("å¼€å§‹åˆ›å»ºè®¢å•: {}", orderDTO);
        
        // æ„å»ºè®¢å•æ¶ˆæ¯
        OrderMessage message = OrderMessage.builder()
            .userId(orderDTO.getUserId())
            .productId(orderDTO.getProductId())
            .count(orderDTO.getCount())
            .totalAmount(orderDTO.getTotalAmount())
            .build();
        
        // å‘é€äº‹åŠ¡æ¶ˆæ¯
        TransactionSendResult result = rocketMQTemplate.sendMessageInTransaction(
            "order-topic",
            MessageBuilder.withPayload(message).build(),
            orderDTO
        );
        
        if (result.getLocalTransactionState() == LocalTransactionState.COMMIT_MESSAGE) {
            log.info("è®¢å•åˆ›å»ºæˆåŠŸ");
            return getOrderByMessage(message);
        }
        
        throw new BusinessException("è®¢å•åˆ›å»ºå¤±è´¥");
    }
}
```

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04


```java
/**
 * äº‹åŠ¡æ¶ˆæ¯ç›‘å¬å™¨
 * @author erik.zhou
 */
@RocketMQTransactionListener
@Slf4j
public class OrderTransactionListener implements RocketMQLocalTransactionListener {
    
    @Autowired
    private OrderMapper orderMapper;
    
    @Autowired
    private TransactionLogMapper transactionLogMapper;
    
    /**
     * æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. åœ¨æœ¬åœ°äº‹åŠ¡ä¸­åˆ›å»ºè®¢å•
     * 2. è®°å½•äº‹åŠ¡æ—¥å¿—ç”¨äºå›æŸ¥
     * 3. è¿”å›äº‹åŠ¡çŠ¶æ€å†³å®šæ¶ˆæ¯æ˜¯å¦å‘é€
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public RocketMQLocalTransactionState executeLocalTransaction(
            Message msg, Object arg) {
        
        OrderDTO orderDTO = (OrderDTO) arg;
        String transactionId = msg.getHeaders().get("transactionId", String.class);
        
        try {
            log.info("æ‰§è¡Œæœ¬åœ°äº‹åŠ¡: transactionId={}", transactionId);
            
            // 1. åˆ›å»ºè®¢å•
            Order order = buildOrder(orderDTO);
            orderMapper.insert(order);
            
            // 2. è®°å½•äº‹åŠ¡æ—¥å¿—ï¼ˆç”¨äºå›æŸ¥ï¼‰
            TransactionLog txLog = new TransactionLog();
            txLog.setTransactionId(transactionId);
            txLog.setOrderId(order.getId());
            txLog.setStatus(TxStatus.COMMIT);
            txLog.setCreateTime(new Date());
            transactionLogMapper.insert(txLog);
            
            log.info("æœ¬åœ°äº‹åŠ¡æ‰§è¡ŒæˆåŠŸ: orderId={}", order.getId());
            
            // 3. æäº¤æ¶ˆæ¯
            return RocketMQLocalTransactionState.COMMIT;
            
        } catch (Exception e) {
            log.error("æœ¬åœ°äº‹åŠ¡æ‰§è¡Œå¤±è´¥: transactionId={}", transactionId, e);
            
            // è®°å½•å¤±è´¥æ—¥å¿—
            TransactionLog txLog = new TransactionLog();
            txLog.setTransactionId(transactionId);
            txLog.setStatus(TxStatus.ROLLBACK);
            txLog.setErrorMsg(e.getMessage());
            txLog.setCreateTime(new Date());
            transactionLogMapper.insert(txLog);
            
            // 4. å›æ»šæ¶ˆæ¯
            return RocketMQLocalTransactionState.ROLLBACK;
        }
    }
    
    /**
     * äº‹åŠ¡å›æŸ¥
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. é€šè¿‡äº‹åŠ¡æ—¥å¿—åˆ¤æ–­æœ¬åœ°äº‹åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸ
     * 2. é˜²æ­¢æ¶ˆæ¯ä¸¢å¤±
     * 3. ä¿è¯æœ€ç»ˆä¸€è‡´æ€§
     */
    @Override
    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) {
        String transactionId = msg.getHeaders().get("transactionId", String.class);
        
        log.info("äº‹åŠ¡å›æŸ¥: transactionId={}", transactionId);
        
        // æŸ¥è¯¢äº‹åŠ¡æ—¥å¿—
        TransactionLog txLog = transactionLogMapper
            .selectByTransactionId(transactionId);
        
        if (txLog == null) {
            log.warn("äº‹åŠ¡æ—¥å¿—ä¸å­˜åœ¨ï¼Œå›æ»šæ¶ˆæ¯: transactionId={}", transactionId);
            return RocketMQLocalTransactionState.ROLLBACK;
        }
        
        if (TxStatus.COMMIT.equals(txLog.getStatus())) {
            log.info("æœ¬åœ°äº‹åŠ¡å·²æäº¤ï¼Œæäº¤æ¶ˆæ¯: transactionId={}", transactionId);
            return RocketMQLocalTransactionState.COMMIT;
        }
        
        log.info("æœ¬åœ°äº‹åŠ¡å·²å›æ»šï¼Œå›æ»šæ¶ˆæ¯: transactionId={}", transactionId);
        return RocketMQLocalTransactionState.ROLLBACK;
    }
}

/**
 * è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…
 * @author erik.zhou
 */
@Component
@RocketMQMessageListener(
    topic = "order-topic",
    consumerGroup = "order-consumer-group"
)
@Slf4j
public class OrderMessageConsumer implements RocketMQListener<OrderMessage> {
    
    @Autowired
    private StorageServiceClient storageClient;
    
    @Autowired
    private AccountServiceClient accountClient;
    
    @Autowired
    private PointServiceClient pointClient;
    
    @Autowired
    private OrderMapper orderMapper;
    
    /**
     * æ¶ˆè´¹è®¢å•æ¶ˆæ¯
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. å¹‚ç­‰æ€§å¤„ç†ï¼ˆé˜²æ­¢é‡å¤æ¶ˆè´¹ï¼‰
     * 2. å¼‚å¸¸é‡è¯•æœºåˆ¶
     * 3. è¡¥å¿æœºåˆ¶ï¼ˆå¤±è´¥åå¦‚ä½•å¤„ç†ï¼‰
     */
    @Override
    public void onMessage(OrderMessage message) {
        log.info("æ”¶åˆ°è®¢å•æ¶ˆæ¯: {}", message);
        
        String orderId = message.getOrderId();
        
        try {
            // 1. å¹‚ç­‰æ€§æ£€æŸ¥
            if (isProcessed(orderId)) {
                log.info("è®¢å•å·²å¤„ç†ï¼Œè·³è¿‡: orderId={}", orderId);
                return;
            }
            
            // 2. æ‰£å‡åº“å­˜
            boolean stockResult = storageClient.deduct(
                message.getProductId(),
                message.getCount()
            );
            if (!stockResult) {
                handleFailure(orderId, "åº“å­˜æ‰£å‡å¤±è´¥");
                return;
            }
            
            // 3. æ‰£å‡ä½™é¢
            boolean accountResult = accountClient.deduct(
                message.getUserId(),
                message.getTotalAmount()
            );
            if (!accountResult) {
                // è¡¥å¿ï¼šå›æ»šåº“å­˜
                storageClient.rollback(message.getProductId(), message.getCount());
                handleFailure(orderId, "ä½™é¢æ‰£å‡å¤±è´¥");
                return;
            }
            
            // 4. å¢åŠ ç§¯åˆ†
            boolean pointResult = pointClient.add(
                message.getUserId(),
                calculatePoints(message.getTotalAmount())
            );
            if (!pointResult) {
                // è¡¥å¿ï¼šå›æ»šåº“å­˜å’Œä½™é¢
                storageClient.rollback(message.getProductId(), message.getCount());
                accountClient.rollback(message.getUserId(), message.getTotalAmount());
                handleFailure(orderId, "ç§¯åˆ†å¢åŠ å¤±è´¥");
                return;
            }
            
            // 5. æ›´æ–°è®¢å•çŠ¶æ€
            updateOrderStatus(orderId, OrderStatus.SUCCESS);
            
            // 6. æ ‡è®°å·²å¤„ç†
            markAsProcessed(orderId);
            
            log.info("è®¢å•å¤„ç†æˆåŠŸ: orderId={}", orderId);
            
        } catch (Exception e) {
            log.error("è®¢å•å¤„ç†å¤±è´¥: orderId={}", orderId, e);
            // æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
            throw new RuntimeException("è®¢å•å¤„ç†å¤±è´¥", e);
        }
    }
    
    /**
     * å¹‚ç­‰æ€§æ£€æŸ¥
     */
    private boolean isProcessed(String orderId) {
        String key = "order:processed:" + orderId;
        return redisTemplate.hasKey(key);
    }
    
    /**
     * æ ‡è®°å·²å¤„ç†
     */
    private void markAsProcessed(String orderId) {
        String key = "order:processed:" + orderId;
        redisTemplate.opsForValue().set(key, "1", 7, TimeUnit.DAYS);
    }
    
    /**
     * å¤„ç†å¤±è´¥
     */
    private void handleFailure(String orderId, String reason) {
        log.error("è®¢å•å¤„ç†å¤±è´¥: orderId={}, reason={}", orderId, reason);
        updateOrderStatus(orderId, OrderStatus.FAILED);
        // å‘é€å‘Šè­¦é€šçŸ¥
        sendAlert(orderId, reason);
    }
}
```

## ğŸ”¥ éš¾ç‚¹æ·±åº¦è§£æ

### éš¾ç‚¹1: å¦‚ä½•ä¿è¯åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€è‡´æ€§ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
è®¢å•æœåŠ¡åˆ›å»ºè®¢å•æˆåŠŸ âœ“
åº“å­˜æœåŠ¡æ‰£å‡åº“å­˜æˆåŠŸ âœ“
è´¦æˆ·æœåŠ¡æ‰£å‡ä½™é¢å¤±è´¥ âœ—  â† æ­¤æ—¶å¦‚ä½•å›æ»šï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¸€è‡´æ€§ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|--------|---------|
| Seata AT | å¼ºä¸€è‡´ | ä¸­ | ä½ | å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜ |
| äº‹åŠ¡æ¶ˆæ¯ | æœ€ç»ˆä¸€è‡´ | é«˜ | ä¸­ | é«˜å¹¶å‘åœºæ™¯ |
| TCC | å¼ºä¸€è‡´ | ä½ | é«˜ | é‡‘èåœºæ™¯ |
| Saga | æœ€ç»ˆä¸€è‡´ | é«˜ | é«˜ | é•¿æµç¨‹åœºæ™¯ |

#### å®é™…é€‰æ‹©å»ºè®®
```java
/**
 * æ ¹æ®ä¸šåŠ¡åœºæ™¯é€‰æ‹©æ–¹æ¡ˆ
 * @author erik.zhou
 */
public class TransactionStrategySelector {
    
    public TransactionStrategy select(OrderDTO order) {
        // 1. é‡‘é¢è¾ƒå¤§çš„è®¢å•ï¼Œä½¿ç”¨Seataä¿è¯å¼ºä¸€è‡´æ€§
        if (order.getTotalAmount().compareTo(new BigDecimal("1000")) > 0) {
            return TransactionStrategy.SEATA_AT;
        }
        
        // 2. ç§’æ€ç­‰é«˜å¹¶å‘åœºæ™¯ï¼Œä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯
        if (order.isSeckill()) {
            return TransactionStrategy.TRANSACTION_MESSAGE;
        }
        
        // 3. æ™®é€šè®¢å•ï¼Œä½¿ç”¨äº‹åŠ¡æ¶ˆæ¯ï¼ˆæ€§èƒ½æ›´å¥½ï¼‰
        return TransactionStrategy.TRANSACTION_MESSAGE;
    }
}
```

### éš¾ç‚¹2: å¦‚ä½•å¤„ç†ç½‘ç»œè¶…æ—¶ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
è®¢å•æœåŠ¡è°ƒç”¨åº“å­˜æœåŠ¡
    â†“
ç½‘ç»œè¶…æ—¶ï¼ˆ3ç§’æœªå“åº”ï¼‰
    â†“
ä¸çŸ¥é“åº“å­˜æ˜¯å¦æ‰£å‡æˆåŠŸ
    â†“
å¦‚ä½•å¤„ç†ï¼Ÿé‡è¯•ï¼Ÿæ”¾å¼ƒï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆ

```java
/**
 * è¶…æ—¶å¤„ç†ç­–ç•¥
 * @author erik.zhou
 */
@Service
@Slf4j
public class TimeoutHandler {
    
    @Autowired
    private StorageServiceClient storageClient;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * å¸¦è¶…æ—¶é‡è¯•çš„åº“å­˜æ‰£å‡
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. ä½¿ç”¨å¹‚ç­‰æ€§tokené˜²æ­¢é‡å¤æ‰£å‡
     * 2. è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´å’Œé‡è¯•æ¬¡æ•°
     * 3. è®°å½•æ“ä½œæ—¥å¿—ä¾¿äºæ’æŸ¥
     */
    @Retryable(
        value = {TimeoutException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000)
    )
    public boolean deductStockWithRetry(Long productId, Integer count) {
        // 1. ç”Ÿæˆå¹‚ç­‰æ€§token
        String idempotentToken = generateToken(productId, count);
        
        try {
            // 2. è°ƒç”¨åº“å­˜æœåŠ¡ï¼ˆè®¾ç½®è¶…æ—¶æ—¶é—´ï¼‰
            boolean result = storageClient.deductWithToken(
                productId,
                count,
                idempotentToken
            );
            
            log.info("åº“å­˜æ‰£å‡æˆåŠŸ: productId={}, token={}", 
                productId, idempotentToken);
            
            return result;
            
        } catch (TimeoutException e) {
            log.warn("åº“å­˜æ‰£å‡è¶…æ—¶ï¼Œå‡†å¤‡é‡è¯•: productId={}, token={}", 
                productId, idempotentToken);
            
            // 3. æŸ¥è¯¢æ˜¯å¦å·²ç»æ‰£å‡æˆåŠŸ
            if (checkIfDeducted(idempotentToken)) {
                log.info("åº“å­˜å·²æ‰£å‡ï¼Œæ— éœ€é‡è¯•: token={}", idempotentToken);
                return true;
            }
            
            // 4. æŠ›å‡ºå¼‚å¸¸ï¼Œè§¦å‘é‡è¯•
            throw e;
        }
    }
    
    /**
     * ç”Ÿæˆå¹‚ç­‰æ€§token
     */
    private String generateToken(Long productId, Integer count) {
        return DigestUtils.md5Hex(
            productId + "_" + count + "_" + System.currentTimeMillis()
        );
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦å·²æ‰£å‡
     */
    private boolean checkIfDeducted(String token) {
        String key = "stock:deducted:" + token;
        return Boolean.TRUE.equals(redisTemplate.hasKey(key));
    }
}
```

### éš¾ç‚¹3: å¦‚ä½•å®ç°è¡¥å¿æœºåˆ¶ï¼Ÿ

#### é—®é¢˜åœºæ™¯
```
è®¢å•åˆ›å»ºæˆåŠŸ âœ“
åº“å­˜æ‰£å‡æˆåŠŸ âœ“
ä½™é¢æ‰£å‡å¤±è´¥ âœ—
    â†“
éœ€è¦å›æ»šåº“å­˜
    â†“
å¦‚ä½•ä¿è¯å›æ»šæˆåŠŸï¼Ÿ
```

#### è§£å†³æ–¹æ¡ˆ

```java
/**
 * è¡¥å¿æœºåˆ¶å®ç°
 * @author erik.zhou
 */
@Service
@Slf4j
public class CompensationService {
    
    @Autowired
    private CompensationLogMapper compensationLogMapper;
    
    @Autowired
    private StorageServiceClient storageClient;
    
    /**
     * è®°å½•è¡¥å¿æ—¥å¿—
     */
    public void recordCompensation(String orderId, String action, String params) {
        CompensationLog log = new CompensationLog();
        log.setOrderId(orderId);
        log.setAction(action);
        log.setParams(params);
        log.setStatus(CompensationStatus.PENDING);
        log.setRetryCount(0);
        log.setCreateTime(new Date());
        
        compensationLogMapper.insert(log);
    }
    
    /**
     * æ‰§è¡Œè¡¥å¿
     * 
     * éš¾ç‚¹è§£å†³ï¼š
     * 1. å¼‚æ­¥æ‰§è¡Œè¡¥å¿ï¼Œä¸é˜»å¡ä¸»æµç¨‹
     * 2. æ”¯æŒé‡è¯•æœºåˆ¶
     * 3. è®°å½•è¡¥å¿ç»“æœä¾¿äºæ’æŸ¥
     */
    @Scheduled(fixedDelay = 10000) // æ¯10ç§’æ‰§è¡Œä¸€æ¬¡
    public void executeCompensation() {
        // æŸ¥è¯¢å¾…è¡¥å¿çš„è®°å½•
        List<CompensationLog> logs = compensationLogMapper
            .selectPendingLogs(100);
        
        for (CompensationLog log : logs) {
            try {
                // æ‰§è¡Œè¡¥å¿
                boolean success = doCompensate(log);
                
                if (success) {
                    log.setStatus(CompensationStatus.SUCCESS);
                    log.setCompleteTime(new Date());
                } else {
                    log.setRetryCount(log.getRetryCount() + 1);
                    
                    // è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ ‡è®°ä¸ºå¤±è´¥
                    if (log.getRetryCount() >= 5) {
                        log.setStatus(CompensationStatus.FAILED);
                        // å‘é€å‘Šè­¦
                        sendAlert(log);
                    }
                }
                
                compensationLogMapper.updateById(log);
                
            } catch (Exception e) {
                log.error("è¡¥å¿æ‰§è¡Œå¤±è´¥: logId={}", log.getId(), e);
            }
        }
    }
    
    /**
     * æ‰§è¡Œå…·ä½“çš„è¡¥å¿æ“ä½œ
     */
    private boolean doCompensate(CompensationLog log) {
        switch (log.getAction()) {
            case "ROLLBACK_STOCK":
                return rollbackStock(log.getParams());
            case "ROLLBACK_ACCOUNT":
                return rollbackAccount(log.getParams());
            default:
                log.warn("æœªçŸ¥çš„è¡¥å¿æ“ä½œ: action={}", log.getAction());
                return false;
        }
    }
    
    private boolean rollbackStock(String params) {
        // è§£æå‚æ•°
        JSONObject json = JSON.parseObject(params);
        Long productId = json.getLong("productId");
        Integer count = json.getInteger("count");
        
        // å›æ»šåº“å­˜
        return storageClient.rollback(productId, count);
    }
}
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•åœºæ™¯
- å¹¶å‘ç”¨æˆ·: 10000
- æµ‹è¯•æ—¶é•¿: 60ç§’
- è®¢å•é‡‘é¢: 100å…ƒ

### æµ‹è¯•ç»“æœ

| æ–¹æ¡ˆ | TPS | å¹³å‡RT | P99 RT | æˆåŠŸç‡ |
|------|-----|--------|--------|--------|
| Seata AT | 2000 | 150ms | 500ms | 99.9% |
| äº‹åŠ¡æ¶ˆæ¯ | 8000 | 50ms | 150ms | 99.95% |

### ç»“è®º
- **Seata AT**: é€‚åˆå¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯
- **äº‹åŠ¡æ¶ˆæ¯**: é€‚åˆé«˜å¹¶å‘åœºæ™¯ï¼Œæ€§èƒ½æ˜¯Seataçš„4å€

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆ

```java
/**
 * æ–¹æ¡ˆé€‰æ‹©å†³ç­–æ ‘
 */
if (å¯¹ä¸€è‡´æ€§è¦æ±‚æé«˜ && å¹¶å‘é‡ä¸å¤§) {
    ä½¿ç”¨ Seata ATæ¨¡å¼;
} else if (é«˜å¹¶å‘ && å¯æ¥å—æœ€ç»ˆä¸€è‡´æ€§) {
    ä½¿ç”¨ RocketMQäº‹åŠ¡æ¶ˆæ¯;
} else if (é‡‘èåœºæ™¯ && éœ€è¦ä¸¥æ ¼æ§åˆ¶) {
    ä½¿ç”¨ TCCæ¨¡å¼;
} else {
    ä½¿ç”¨ Sagaæ¨¡å¼;
}
```

### 2. åšå¥½ç›‘æ§å‘Šè­¦

```java
/**
 * ç›‘æ§æŒ‡æ ‡
 */
- äº‹åŠ¡æˆåŠŸç‡
- äº‹åŠ¡å¹³å‡è€—æ—¶
- è¡¥å¿æ‰§è¡Œæ¬¡æ•°
- è¶…æ—¶æ¬¡æ•°
- å›æ»šæ¬¡æ•°
```

### 3. è®¾è®¡åˆç†çš„è¶…æ—¶æ—¶é—´

```yaml
# è¶…æ—¶é…ç½®å»ºè®®
feign:
  client:
    config:
      default:
        connectTimeout: 2000    # è¿æ¥è¶…æ—¶2ç§’
        readTimeout: 5000       # è¯»å–è¶…æ—¶5ç§’
        
seata:
  client:
    tm:
      commit-retry-count: 3     # æäº¤é‡è¯•3æ¬¡
      rollback-retry-count: 3   # å›æ»šé‡è¯•3æ¬¡
    rm:
      report-retry-count: 5     # ä¸ŠæŠ¥é‡è¯•5æ¬¡
```

---

**ä½œè€…**: erik.zhou  
**æœ€åæ›´æ–°**: 2024-01-04
